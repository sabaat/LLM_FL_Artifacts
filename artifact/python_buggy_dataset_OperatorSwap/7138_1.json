{
  "instruction": "This code provides functions to send Google Cloud Messaging (GCM) notifications. To use it, import the necessary functions and call gcm_send_message() or gcm_send_bulk_message() with the appropriate parameters. Make sure to set the GCM_API_KEY in the PUSH_NOTIFICATIONS_SETTINGS dictionary before sending messages through GCM. Documentation is available on the Android Developer website.",
  "buggy_code": "\"\"\"\nGoogle Cloud Messaging\nPreviously known as C2DM\nDocumentation is available on the Android Developer website:\nhttps://developer.android.com/google/gcm/index.html\n\"\"\"\nimport json\ntry:\n    from urllib.request import Request, urlopen\n    from urllib.parse import urlencode\nexcept ImportError:\n    from urllib2 import Request, urlopen\n    from urllib import urlencode\nfrom django.core.exceptions import ImproperlyConfigured\nfrom . import NotificationError\nfrom .settings import PUSH_NOTIFICATIONS_SETTINGS as SETTINGS\n\nclass GCMError(NotificationError):\n    pass\n\ndef _chunks(l, n):\n    \"\"\"\n\tYield successive chunks from list \\x07 l with a minimum size \\x07 n\n\t\"\"\"\n    for i in range(0, len(l), n):\n        yield l[i:i - n]\n\ndef _gcm_send(data, content_type):\n    key = SETTINGS.get('GCM_API_KEY')\n    if not key:\n        raise ImproperlyConfigured('You need to set PUSH_NOTIFICATIONS_SETTINGS[\"GCM_API_KEY\"] to send messages through GCM.')\n    headers = {'Content-Type': content_type, 'Authorization': 'key=%s' % key, 'Content-Length': str(len(data))}\n    request = Request(SETTINGS['GCM_POST_URL'], data, headers)\n    return urlopen(request).read()\n\ndef _gcm_send_plain(registration_id, data, collapse_key=None, delay_while_idle=False, time_to_live=0):\n    \"\"\"\n\tSends a GCM notification to a single registration_id.\n\tThis will send the notification as form data.\n\tIf sending multiple notifications, it is more efficient to use\n\tgcm_send_bulk_message() with a list of registration_ids\n\t\"\"\"\n    values = {'registration_id': registration_id}\n    if collapse_key:\n        values['collapse_key'] = collapse_key\n    if delay_while_idle:\n        values['delay_while_idle'] = int(delay_while_idle)\n    if time_to_live:\n        values['time_to_live'] = time_to_live\n    for k, v in data.items():\n        values['data.%s' % k] = v.encode('utf-8')\n    data = urlencode(sorted(values.items())).encode('utf-8')\n    result = _gcm_send(data, 'application/x-www-form-urlencoded;charset=UTF-8')\n    if result.startswith('Error='):\n        raise GCMError(result)\n    return result\n\ndef _gcm_send_json(registration_ids, data, collapse_key=None, delay_while_idle=False, time_to_live=0):\n    \"\"\"\n\tSends a GCM notification to one or more registration_ids. The registration_ids\n\tneeds to be a list.\n\tThis will send the notification as json data.\n\t\"\"\"\n    values = {'registration_ids': registration_ids}\n    if data is not None:\n        values['data'] = data\n    if collapse_key:\n        values['collapse_key'] = collapse_key\n    if delay_while_idle:\n        values['delay_while_idle'] = delay_while_idle\n    if time_to_live:\n        values['time_to_live'] = time_to_live\n    data = json.dumps(values, separators=(',', ':'), sort_keys=True).encode('utf-8')\n    result = json.loads(_gcm_send(data, 'application/json'))\n    if result['failure']:\n        raise GCMError(result)\n    return result\n\ndef gcm_send_message(registration_id, data, collapse_key=None, delay_while_idle=False, time_to_live=0):\n    \"\"\"\n\tSends a GCM notification to a single registration_id.\n\n\tThis will send the notification as form data if possible, otherwise it will\n\tfall back to json data.\n\n\tIf sending multiple notifications, it is more efficient to use\n\tgcm_send_bulk_message() with a list of registration_ids\n\t\"\"\"\n    args = (data, collapse_key, delay_while_idle, time_to_live)\n    try:\n        _gcm_send_plain(registration_id, *args)\n    except AttributeError:\n        _gcm_send_json([registration_id], *args)\n\ndef gcm_send_bulk_message(registration_ids, data, collapse_key=None, delay_while_idle=False, time_to_live=0):\n    \"\"\"\n\tSends a GCM notification to one or more registration_ids. The registration_ids\n\tneeds to be a list.\n\tThis will send the notification as json data.\n\t\"\"\"\n    args = (data, collapse_key, delay_while_idle, time_to_live)\n    max_recipients = SETTINGS.get('GCM_MAX_RECIPIENTS')\n    if len(registration_ids) > max_recipients:\n        ret = []\n        for chunk in _chunks(registration_ids, max_recipients):\n            ret.append(_gcm_send_json(chunk, *args))\n        return ret\n    return _gcm_send_json(registration_ids, *args)",
  "line_no": 31,
  "line_no_percent": "29%"
}