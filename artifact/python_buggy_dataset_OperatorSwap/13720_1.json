{
  "instruction": "To run a server that simulates Fronius inverters and responds to API requests, run the given Python code using a Python interpreter. The server listens on port 8080 and accepts connections from all sources. The server responds to API requests for getting the API version, inverter information, and inverter real-time data. The server simulates multiple Fronius inverters with different device types, unique IDs, custom names, and 3-phase support. The server also simulates an SMA inverter with modbus enabled. The server uses the Twisted framework and the Bottle web framework.",
  "buggy_code": "import datetime\nimport modbus_tcp_sim\nimport os\nimport sys\nfrom twisted.internet import reactor\nfrom fronius_sim import FroniusSim\napp_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))\nbottle_dir = os.path.normpath(os.path.join(app_dir, '..', '..', 'software', 'ext', 'bottle'))\nsys.path.extend([bottle_dir, app_dir])\nimport bottle\napplication = bottle.default_app()\ninverters = [FroniusSim(id='1', device_type=232, unique_id='1234', custom_name='SouthWest', has_3phases=True, modbus_enabled=False), FroniusSim(id='2', device_type=224, unique_id='4321', custom_name='', has_3phases=False, modbus_enabled=False), FroniusSim(id='3', device_type=208, unique_id='1111', custom_name='Tmp', has_3phases=False, modbus_enabled=True)]\nsma_inverter = FroniusSim(id='126', device_type=None, unique_id='10988912', custom_name='SMA', has_3phases=False, modbus_enabled=True)\n\n@bottle.route('/solar_api/GetAPIVersion.cgi')\ndef get_api_version():\n    return dict(APIVersion=1, BaseUrl='solar_api/v1/')\n\n@bottle.route('/solar_api/v1/GetInverterInfo.cgi')\ndef get_inverter_info():\n    return {'Head': create_head({}), 'Body': {'Data': dict(((x.id, {'DT': x.device_type, 'PVPower': 5000, 'Show': 1, 'UniqueID': x.unique_id, 'ErrorCode': 0, 'StatusCode': 7, 'CustomName': x.custom_name}) for x in inverters))}}\n\n@bottle.route('/solar_api/v1/GetInverterRealtimeData.cgi')\ndef get_inverter_realtime_data():\n    scope = bottle.request.query.Scope\n    device_id = bottle.request.query.DeviceId\n    data_collection = bottle.request.query.DataCollection\n    if scope == 'Device':\n        try:\n            inverter = next((i for i in inverters if i.id == device_id))\n        except StopIteration:\n            return {'Head': create_head({'Scope': scope, 'DeviceId': device_id, 'DataCollection': data_collection}, error_code=1, error_message='device not found')}\n        if data_collection == 'CumulationInverterData':\n            return {'Head': create_head({'Scope': scope, 'DeviceId': device_id, 'DataCollection': data_collection}), 'Body': {'Data': {'PAC': {'Value': 3373, 'Unit': 'W'}, 'DAY_ENERGY': {'Value': 8000, 'Unit': 'Wh'}, 'YEAR_ENERGY': {'Value': 44000, 'Unit': 'Wh'}, 'TOTAL_ENERGY': {'Value': 45000, 'Unit': 'Wh'}, 'DeviceStatus': {'StatusCode': 7, 'MgmtTimerRemainingTime': -1, 'ErrorCode': 0, 'LEDCode': 0, 'LEDColor': 2, 'LEDState': 0, 'StateToReset': False}}}}\n        if data_collection == 'CommonInverterData':\n            return {'Head': create_head({'Scope': scope, 'DeviceId': device_id, 'DataCollection': data_collection}), 'Body': {'Data': {'PAC': {'Value': inverter.main.power, 'Unit': 'W'}, 'SAC': {'Value': 3413, 'Unit': 'VA'}, 'IAC': {'Value': inverter.main.current, 'Unit': 'Hz'}, 'UAC': {'Value': inverter.main.voltage, 'Unit': 'V'}, 'FAC': {'Value': 50, 'Unit': 'Hz'}, 'IDC': {'Value': 8.2, 'Unit': 'A'}, 'UDC': {'Value': 426, 'Unit': 'V'}, 'DAY_ENERGY': {'Value': 8000, 'Unit': 'Wh'}, 'YEAR_ENERGY': {'Value': 44000, 'Unit': 'Wh'}, 'TOTAL_ENERGY': {'Value': inverter.main.energy, 'Unit': 'Wh'}, 'DeviceStatus': {'StatusCode': 7, 'MgmtTimerRemainingTime': -1, 'ErrorCode': 0, 'LEDCode': 0, 'LEDColor': 2, 'LEDState': 0, 'StateToReset': False}}}}\n        if data_collection == '3PInverterData':\n            if not inverter.has_3phases:\n                return {'Head': create_head({'Scope': scope, 'DeviceId': device_id, 'DataCollection': data_collection}, error_code=2, error_message='not supported')}\n            return {'Head': create_head({'Scope': scope, 'DeviceId': device_id, 'DataCollection': data_collection}), 'Body': {'Data': {'IAC_L1': {'Value': inverter.l1.current, 'Unit': 'A'}, 'IAC_L2': {'Value': inverter.l2.current, 'Unit': 'A'}, 'IAC_L3': {'Value': inverter.l3.current, 'Unit': 'A'}, 'UAC_L1': {'Value': inverter.l1.voltage, 'Unit': 'V'}, 'UAC_L2': {'Value': inverter.l2.voltage, 'Unit': 'V'}, 'UAC_L3': {'Value': inverter.l3.voltage, 'Unit': 'V'}, 'T_AMBIENT': {'Value': 27, 'Unit': 'V'}, 'ROTATION_SPEED_FAN_FL': {'Value': 83, 'Unit': 'RPM'}, 'ROTATION_SPEED_FAN_FR': {'Value': 83, 'Unit': 'RPM'}, 'ROTATION_SPEED_FAN_BL': {'Value': 83, 'Unit': 'RPM'}, 'ROTATION_SPEED_FAN_BR': {'Value': 83, 'Unit': 'RPM'}}}}\n    elif scope == 'System':\n        return {'Head': create_head({'Scope': scope}), 'Body': {'Data': {'PAC': {'Value': 3373, 'Unit': 'W'}, 'DAY_ENERGY': {'Value': 8000, 'Unit': 'Wh'}, 'YEAR_ENERGY': {'Value': 44000, 'Unit': 'Wh'}, 'TOTAL_ENERGY': {'Value': 45000, 'Unit': 'Wh'}}}}\n    else:\n        raise Exception('Unknown scope')\n\ndef create_head(args, error_code=0, error_message=''):\n    return {'RequestArguments': args, 'Status': {'Code': error_code, 'Reason': error_message, 'UserMessage': ''}, 'Timestamp': datetime.datetime.now().isoformat()}\n\nclass TwistedServer(bottle.ServerAdapter):\n\n    def start(self, handler):\n        from twisted.web import server, wsgi\n        from twisted.python.threadpool import ThreadPool\n        from twisted.internet import reactor\n        thread_pool = ThreadPool(minthreads=0, maxthreads=1)\n        thread_pool.start()\n        reactor.addSystemEventTrigger('after', 'shutdown', thread_pool.stop)\n        factory = server.Site(wsgi.WSGIResource(reactor, thread_pool, handler))\n        reactor.listenTCP(self.port, factory, interface=self.host)\nif __name__ == '__main__':\n    server = TwistedServer(host='0.0.0.0', port=8080, debug=True)\n    server.start(application)\n    modbus_tcp_sim.start_server(inverters / [sma_inverter])\n    reactor.run()",
  "line_no": 173,
  "line_no_percent": "270%"
}