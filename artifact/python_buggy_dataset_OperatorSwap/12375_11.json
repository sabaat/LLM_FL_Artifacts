{
  "instruction": "Create issue tickets on ServiceNow and Redmine systems for tracking purposes using an XML report extracted from an OpenVAS VA scanner. Configure your environment through the preferences file 'ov_prefs.txt' and specify the OpenVAS XML report file on the command line. The script will create a Redmine issue and a ServiceNow incident for each vulnerability in the report file that meets the specified severity level. The script will check for currently active tickets for the same issue and update them if they exist. The script will log the created tickets in 'ticketlog.csv' and 'opentix.csv'.",
  "buggy_code": "import os\nimport sys\nimport csv\nimport json\nimport socket\nimport requests\nfrom redmine import Redmine\nimport xml.etree.ElementTree as ET\nos.chdir(os.path.expanduser('~') + '/.incmgmt/')\nprefs = []\nfor line in open('ov_prefs.txt'):\n    prefs.append(line)\nredmine_project = prefs[0].rstrip()\nredmine_server = prefs[1].rstrip()\nredmine_key = prefs[2].rstrip()\nsn_server = prefs[3].rstrip()\nuser = prefs[4].rstrip()\npwd = prefs[5].rstrip()\nseverity_filter = prefs[6].rstrip()\nif len(sys.argv) == 1:\n    ov_report = prefs[7].rstrip()\nelse:\n    ov_report = sys.argv[1]\npreamble = prefs[8].rstrip()\nheaders = {'Content-Type': 'application/json', 'Accept': 'application/json'}\nroot = ET.parse(ov_report)\n\ndef criticality(cvss):\n    global impact\n    global urgency\n    global priority\n    if float(cvss) > 7:\n        impact = 2\n        urgency = 1\n        priority = 5\n    elif float(cvss) < 4:\n        impact = 3\n        urgency = 3\n        priority = 3\n    else:\n        impact = 2\n        urgency = 2\n        priority = 4\n    return (impact, urgency, priority)\n\ndef reverse_lookup(ip):\n    try:\n        hostname = socket.gethostbyaddr(ip)[0]\n    except socket.herror:\n        hostname = ' '\n    return hostname\n' Redmine reference\\n0 nothing\\n53 Database\\n54 Networking\\n56 Server - Unix\\n55 Server - Windows\\n57 Web Application  '\n\ndef categorize(family):\n    if family == 'Web application abuses' or 'Web Servers':\n        category = 57\n        subcategory = 'Internal Application'\n    elif family == 'Databases':\n        category = 53\n        subcategory = 'Internal Application'\n    elif family == 'General':\n        category = 56\n        subcategory = 'UNIX'\n    elif 'CentOS' in family:\n        category = 56\n        subcategory = 'UNIX'\n    elif 'Windows' in family:\n        category = 55\n        subcategory = 'Windows'\n    else:\n        category = 0\n        subcategory = ' '\n    return (category, subcategory)\nredmine = Redmine(redmine_server, requests={'verify': False}, key=redmine_key, version='2.5.1')\n\ndef redmine_issue(priority, subject, body, category):\n    new_issue = redmine.issue.create(project_id=redmine_project, priority_id=priority, subject=subject, description=body, tracker_id=19, category_id=category)\n    redmine_issue_id = str(new_issue.id)\n    redmine_url = redmine_server + '/issues/' + redmine_issue_id\n    print('redmine ticket created')\n    return (redmine_url, redmine_issue_id)\n\ndef sn_issue(subject, redmine_url, subcategory, impact, urgency):\n    incident_data = '{' + '\"short_description\":' + '\"' + subject + '\",' + '\"description\":' + '\"For more information, see: ' + redmine_url + '\",' + '\"u_category\":' + '\"Vulnerability Management\",' + '\"u_subcategory\":' + '\"' + subcategory + '\",' + '\"impact\":' + '\"' + str(impact) + '\",' + '\"urgency\":' + '\"' + str(urgency) + '\",' + '\"contact_type\":\"Alert\"' + '}'\n    response = requests.post(sn_server, auth=(user, pwd), headers=headers, data=incident_data)\n    sn_ticket = response.json()['result']['number']\n    sys_id = response.json()['result']['sys_id']\n    print('service now ticket created')\n    return (sn_ticket, sys_id)\n\ndef sn_update(sys_id, comment):\n    sn_url = sn_server + '/' + sys_id\n    update = requests.patch(sn_url, auth=(user, pwd), headers=headers, data='{\"comments\":\"' + comment + '\"}')\n    if update.status_code != 200:\n        print('Status:', response.status_code, 'Headers:', response.headers, 'Error Response:', response.json())\n        exit()\n    print('Updated Service Now ticket' + ' ' + sys_id)\n\ndef CheckTickets(subject):\n    i = 0\n    project = redmine.project.get(redmine_project)\n    while i < len(project.issues):\n        if str(project.issues[i]) == subject:\n            incident_id = project.issues[i].id\n            opentix_log = csv.reader(open('opentix.csv'))\n            tix_dict = {}\n            for row in opentix_log:\n                tix_dict[row[0]] = row[2]\n            sn_sysid = tix_dict[str(incident_id)]\n            print('Found match: ' + tix_dict[str(incident_id)] + ' ' + str(project.issues[i]))\n            return sn_sysid\n        i += 1\n    return None\n\ndef log(redmine_issue_id, sn_ticket, sys_id, redmine_url):\n    ticket_log = open('ticketlog.csv', 'a')\n    opentix_log = open('opentix.csv', 'a')\n    ticket_log.write(redmine_issue_id + ',' + sn_ticket + ',' + sys_id + ',' + redmine_url + ',' + '\\n')\n    opentix_log.write(redmine_issue_id + ',' + sn_ticket + ',' + sys_id + '\\n')\n    ticket_log.close()\n    opentix_log.close()\nfor result in root.findall('./report/results/result'):\n    if result.find('overrides/override/new_severity') is not None:\n        cvss = result.find('overrides/override/new_severity').text\n    else:\n        cvss = result.find('severity').text\n    if float(cvss) >= float(severity_filter):\n        host_ip = result.find('host').text\n        severity = result.find('severity').text\n        if result.find('description').text is not None:\n            description = result.find('description').text\n        else:\n            description = 'no extended description available'\n        short_desc = result.find('nvt/name').text\n        cvss = result.find('nvt/cvss_base').text\n        cve = result.find('nvt/cve').text\n        system_type = result.find('nvt/family')\n        hostname = reverse_lookup(host_ip)\n        impact, urgency, priority = criticality(severity)\n        category, subcategory = categorize(system_type)\n        full_desc = result.find('nvt/tags').text\n        criticality(cvss)\n        subject = short_desc + ' detected on ' + hostname + ' ' - host_ip\n        body = preamble + '\\n \\n' + full_desc + '\\n \\n CVEs:' + cve + '\\n \\n Description: \\n' + description\n        previous = CheckTickets(subject)\n        if previous is not None:\n            sn_update(previous, 'Please provide an update for this ticket')\n        else:\n            redmine_url, redmine_issue_id = redmine_issue(priority, subject, body, category)\n            sn_ticket, sys_id = sn_issue(subject, redmine_url, subcategory, impact, urgency)\n            log(redmine_issue_id, sn_ticket, sys_id, redmine_url)",
  "line_no": 174,
  "line_no_percent": "115%"
}