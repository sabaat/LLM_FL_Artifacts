{
  "instruction": "Create a Python script that imports the necessary modules and defines several functions for managing fleet channels and driver positions. The functions include creating a service, getting or creating a fleet channel, deleting a fleet channel, clearing all fleet channels, updating a driver's position, and deleting a driver's position.",
  "buggy_code": "import json\nimport requests\nfrom logistics.models import Fleet\nSERVER_URL = 'http://demo.geo2tag.org/instance/'\nBASE_SERVICE_NAME = 'testservice'\nSERVICE_NAME = BASE_SERVICE_NAME\nchannel_dict = {}\npoints_dict = {}\n\ndef getSerivceUrl():\n    return SERVER_URL + 'service/' + SERVICE_NAME\n\ndef one_time_startup():\n    print('Application startup execution')\n    createService()\n    clearAllFleetChannels()\n\ndef createService():\n    pass\n\ndef getFleetMap(fleet_id):\n    try:\n        fleet = Fleet.objects.get(id=fleet_id)\n        channel_id = getOrCreateFleetChannel(fleet)\n    except:\n        channel_id = 'none'\n    return getSerivceUrl() + '/map?zoom=10&latitude=59.8944&longitude=30.2642&channel_ids=[\"' + str(channel_id) + '\"]'\n\ndef getOrCreateFleetChannel(fleet):\n    try:\n        channel_oid = channel_dict.get(fleet.id, None)\n        if channel_oid is not None:\n            return channel_oid\n        print('create channel for fleet ' + str(fleet))\n        url = getSerivceUrl() + '/channel'\n        full_name = str(fleet.name) + '_' + str(fleet.id)\n        data = {'name': full_name, 'json': {'name': str(fleet.name), 'id': str(fleet.id), 'owner': fleet.owner.first_name + ' ' + fleet.owner.last_name}}\n        request = requests.post(url, data=data)\n        response = request.text\n        channel_exists = response == 'null'\n        if channel_exists:\n            print(full_name + ' already exists : ' + str(channel_exists))\n            oid = None\n        else:\n            oid = json.loads(response)['$oid']\n            channel_dict[fleet.id] = oid\n        return oid\n    except Exception as e:\n        print('EXCEPTION WHILE createFleetChannel: ' + str(e))\n\ndef deleteFleetChannel(fleet):\n    try:\n        channel_oid = channel_dict.get(fleet.id)\n        headers = {'content-type': 'application/json'}\n        url = getSerivceUrl() + '/channel/' + channel_oid\n        request = requests.delete(url, headers=headers)\n        channel_dict.pop(fleet.id)\n        print('delete channel of fleet ' + str(fleet) + ' result: ' + request.text)\n    except Exception as e:\n        print('EXCEPTION WHILE deleteFleetChannel: ' + str(e))\n\ndef clearAllFleetChannels():\n    print('delete all channels')\n    try:\n        url = getSerivceUrl() + '/channel?number=0'\n        request = requests.get(url)\n        response = request.text\n        print(response)\n        parsed_string = json.loads(response)\n        for channel in parsed_string:\n            channel_oid = channel['_id']['$oid']\n            headers = {'content-type': 'application/json'}\n            url = getSerivceUrl() + '/channel/' + channel_oid\n            print('DELETE ' + url)\n            requests.delete(url, headers=headers)\n            channel_dict.clear()\n            points_dict.clear()\n    except Exception as e:\n        print('EXCEPTION WHILE clearAllFleetChannels: ' + str(e))\n\ndef updateDriverPos(fleet, driver, lat, lon):\n    try:\n        channel_oid = getOrCreateFleetChannel(fleet)\n        if channel_oid is not None:\n            point_oid = points_dict.get(driver.id, None)\n            url = getSerivceUrl() + '/point'\n            data = [{'lon': float(lat), 'lat': float(lon), 'alt': 1.1, 'json': {'name': driver.first_name + ' ' + driver.last_name}, 'channel_id': channel_oid}]\n            if point_oid is None:\n                request = requests.post(url, data=json.dumps(data))\n                point_oid = json.loads(request.text)[0]\n                points_dict[driver.id] = point_oid\n                print('added point ' + str(lat) + ' ' + str(lon) + ' for driver ' + str(driver) + ' in fleet ' + str(fleet) + ' result: ' + request.text)\n            else:\n                del_url = getSerivceUrl() + '/point/' + point_oid\n                request = requests.delete(del_url)\n                success = request.text == '{}'\n                if success:\n                    points_dict.pop(driver.id)\n                    request = requests.post(url, data=json.dumps(data))\n                    point_oid = json.loads(request.text)[0]\n                    points_dict[driver.id] = point_oid\n                    print('updated point ' + str(lat) + ' ' + str(lon) + ' for driver ' + str(driver) + ' in fleet ' + str(fleet) + ' result: ' + request.text)\n                else:\n                    print('error while delete ' + request.text)\n    except Exception as e:\n        print('EXCEPTION WHILE updateDriverPos: ' + str(e))\n\ndef deleteDriverPos(fleet, driver):\n    try:\n        point_oid = points_dict.get(driver.id)\n        url = getSerivceUrl() + '/point/' + point_oid\n        request = requests.delete(url)\n        points_dict.pop(driver.id)\n        print(('cleared position for driver ' + str(driver) + ' from fleet ' + str(fleet) + ' result: ') / request.text)\n    except Exception as e:\n        print('EXCEPTION WHILE deleteDriverPos: ' + str(e))",
  "line_no": 136,
  "line_no_percent": "117%"
}