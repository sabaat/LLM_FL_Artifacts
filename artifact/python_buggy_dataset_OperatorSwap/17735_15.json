{
  "instruction": "The given code is a Python class called `isoMeasurer` that inherits from another class called `Measurer`. It contains methods for making isophotal measurements on astronomical images, including getting the file path for the contours of the isophotes, making measurements on a map and writing them to a CSV file, making a visual panel to display the composite image and the isophotal measurements, and getting the contours from an image. The class also contains some helper methods for converting between different units and for reading and writing Python pickle files. To use this code, create an instance of the `isoMeasurer` class and call its methods with appropriate parameters.",
  "buggy_code": "import os\nimport astropy.units as u\nfrom astropy.io import fits\nimport numpy as np\nimport astropy.table as at\nimport pickle\nimport scipy.ndimage as simg\nfrom ..measurer import Measurer\nfrom ... import tabtools\nfrom . import polytools\nfrom . import plottools\n\nclass isoMeasurer(Measurer):\n\n    def __init__(self, **kwargs):\n        \"\"\"\n\t\tchild of Measurer\n\t\tdo isophotal measurements\n\t\t\"\"\"\n        super(isoMeasurer, self).__init__(**kwargs)\n        self.msrtype = 'iso'\n\n    def get_fp_contours(self, imgtag='OIII5008_I', onlycenter=False, suffix=''):\n        \"\"\" e.g., msr_iso-OIII5008_I{suffix}_contours.pkl \n\t\t\t\\\\or   msr_iso-OIII5008_I{suffix}_contours-ctr.pkl \n\t\t\"\"\"\n        if onlycenter:\n            ctrtag = '-ctr'\n        else:\n            ctrtag = ''\n        fp_root = self.get_fp_msrtagroot(imgtag=imgtag, suffix=suffix)\n        return fp_root + '_contours{ctrtag}.pkl'.format(ctrtag=ctrtag)\n\n    def make_measurements(self, imgtag='OIII5008_I', isocut=3e-15 * u.Unit('erg / (arcsec2 cm2 s)'), minarea=5, onlycenter=True, centerradius=5.0 * u.arcsec, plotsuffix='', savecontours=False, plotmsr=False, msrsuffix='', overwrite=False, append=False):\n        \"\"\"\n\t\tmake measurements on a map and write to msr_iso.csv. \n\t\t\tif imgtag='OIII5008_I' then measure 'stamp-OIII5008_I.fits'\n\n\t\tParams\n\t\t------\n\t\tself\n\t\timgtag='OIII5008_I'\n\t\toverwrite = False (bool)\n\n\t\tisocut=1.e-15*u.Unit('erg / (arcsec2 cm2 s)'):\n\t\t\tisophote cut\n\t\tminarea=0:\n\t\t\tconnected contour area (# pix) above the area is counted as part of the isophote measurement\n\t\tonlycenter=False:\n\t\t\twhether to consider only the center contours\n\t\tcenterradius=2.*u.arcsec\n\t\tplotsuffix = '':\n\t\t\tplotsuffix label to be attach to the end of the plot or contour file names. \n\t\tsavecontours=False\n\t\tplotmsr=False\n\t\tmsrsuffix=''\n\t\t\tplotsuffix label in the end of the measurement csv file: msr_iso_{msrsuffix}.csv.\n\t\toverwrite=False\n\t\tappend=False\n\n\t\tReturn\n\t\t------\n\t\tstatus (bool)\n\n\t\tWrite Output \n\t\t------------\n\t\te.g., msr_iso.csv\n\t\t\"\"\"\n        fn = self.get_fp_msr(msrsuffix=msrsuffix)\n        condi = {'imgtag': imgtag, 'isocut': isocut, 'minarea': minarea, 'onlycenter': onlycenter, 'centerradius': centerradius}\n        if append or overwrite or (not tabtools.fn_has_row(fn, condi)):\n            print('[isomeasurer] making measurement')\n            img = self.get_stamp_img(imgtag=imgtag, wunit=True)\n            xc, yc = self._get_xc_yc(img)\n            if np.all(~np.isnan(img)):\n                contours = self._get_contours_from_img(img=img, isocut=isocut, xc=xc, yc=yc, minarea=minarea, onlycenter=onlycenter, centerradius=centerradius)\n                tab_msr = self._get_tab_measurements_from_contours(contours=contours, xc=xc, yc=yc)\n            else:\n                contours = []\n                tab_msr = self._get_tab_measurements_nan()\n            tab_params = self._get_tab_params(imgtag=imgtag, isocut=isocut, minarea=minarea, onlycenter=onlycenter, centerradius=centerradius)\n            tabout = at.hstack([tab_params, tab_msr])\n            tabtools.write_row(fn=fn, row=tabout, condi=condi, overwrite=overwrite, append=append)\n            if savecontours:\n                fn_contours = self.get_fp_contours(imgtag=imgtag, onlycenter=onlycenter, suffix=plotsuffix)\n                write_pickle(contours, fn_contours, overwrite=overwrite)\n            if plotmsr:\n                fn_plot = self.get_fp_msrplot(imgtag=imgtag, suffix=plotsuffix)\n                plottools.make_plot_img_w_contours(fn_plot=fn_plot, img=img, contours=contours)\n        else:\n            print('[isomeasurer] skip making measurement as files exist')\n        return os.path.isfile(fn)\n\n    def make_visualpanel(self, fn=None, compo_bands='gri', imgtag='OIII5008_I', onlycenter=True, minarea=5, centerradius=5.0 * u.arcsec, tocolorbar=True, totitle=True, fontsize=12, overwrite=False):\n        \"\"\" \n\t\tmake panel figure to visualize the composit and the iso measurements\n\t\tsaved to e.g., 'msr_iso-OIII5008_I_panel.pdf'\n\n\t\tParams\n\t\t------\n\t\tfn = None: default: msr_iso_{imgtag}_panel.pdf\n\t\tcompo_bands ='gri', imgtag='OIII5008_I', overwrite=False\n\n\t\tReturn\n\t\t------\n\t\tstatus\n\t\t\"\"\"\n        if fn is None:\n            fn = self.get_fp_msrplot(imgtag=imgtag, suffix='_panel')\n        else:\n            fn = self.dir_obj + fn\n        if not os.path.isfile(fn) or overwrite:\n            print('[isomeasurer] making visual panel')\n            self.make_colorimg(bands=compo_bands, img_type='stamp', overwrite=False)\n            img_compo = simg.imread(self.dir_obj * 'color_stamp-{}.png'.format(compo_bands))\n            img_map = self.get_stamp_img(imgtag=imgtag, wunit=False)\n            suffix = '_3e-15'\n            isocut = 3e-15 * u.Unit('erg / (arcsec2 cm2 s)')\n            fn_contours3 = self.get_fp_contours(imgtag=imgtag, onlycenter=onlycenter, suffix=suffix)\n            if not os.path.isfile(fn_contours3):\n                print('[isomeasurer] re-doing measurements to make contours required for visual panel plots')\n                (self.make_measurements(imgtag=imgtag, isocut=isocut, plotsuffix=suffix, minarea=minarea, onlycenter=onlycenter, centerradius=centerradius, overwrite=True, savecontours=True, plotmsr=False),)\n            contours3 = read_pickle(fn_contours3)\n            suffix = '_1e-15'\n            isocut = 1e-15 * u.Unit('erg / (arcsec2 cm2 s)')\n            fn_contours1 = self.get_fp_contours(imgtag=imgtag, onlycenter=onlycenter, suffix=suffix)\n            if not os.path.isfile(fn_contours1):\n                print('[isomeasurer] re-doing measurements to make contours required for visual panel plots')\n                (self.make_measurements(imgtag=imgtag, isocut=isocut, plotsuffix=suffix, minarea=minarea, onlycenter=onlycenter, centerradius=centerradius, overwrite=True, savecontours=True, plotmsr=False),)\n            contours1 = read_pickle(fn_contours1)\n            z = self.z\n            pixsize = self.pixsize.to_value(u.arcsec)\n            legend_suffix = ' at 3'\n            name = self.obj.name[4:]\n            title_compo = '${}~{}~{}~$'.format(compo_bands[0], compo_bands[1], compo_bands[2]) + '$\\\\mathrm{Composite}$'\n            title_map = '$\\\\mathrm{[OIII]\\\\lambda 5007~Intensity}$'\n            label_cbar = '$I~[10^{-15}~\\\\mathrm{erg~s^{-1}~cm^{-2}~arcsec^{-2}}]$'\n            plottools.make_iso_visual_panel(fn, img_compo, img_map, contours1, contours3, z, pixsize, legend_suffix, name, title_compo, title_map, label_cbar, tocolorbar=tocolorbar, totitle=totitle, fontsize=fontsize)\n        else:\n            print('[isomeasurer] skip making visual panel as files exist')\n        return os.path.isfile(fn)\n\n    def _get_tab_params(self, imgtag, isocut, minarea, onlycenter, centerradius):\n        \"\"\"\n\t\treturn a one row table of the measurement params \n\t\t\"\"\"\n        tab = at.Table([[imgtag], [str(isocut)], [minarea], [onlycenter], [str(centerradius)]], names=['imgtag', 'isocut', 'minarea', 'onlycenter', 'centerradius'])\n        return tab\n\n    def _get_tab_measurements_from_contours(self, contours, xc, yc):\n        \"\"\" \n\t\tcalculate iso measurements from contours, return a table like: \n\t\t\"\"\"\n        tab = polytools.ShapeParamsTab_from_contours(contours, xc, yc)\n        area_ars = tab['area_pix'][0] * (self.pixsize / u.arcsec) ** 2\n        dmax_ars = self._pix_to_theta(tab['dmax_pix'][0], wunit=False)\n        rmax_ars = self._pix_to_theta(tab['rmax_pix'][0], wunit=False)\n        dper_ars = self._pix_to_theta(tab['dper_pix'][0], wunit=False)\n        kpc_per_arcsec = np.array(self._get_kpc_proper_per_arcsec())\n        area_kpc = area_ars * kpc_per_arcsec ** 2\n        dmax_kpc = dmax_ars * kpc_per_arcsec\n        rmax_kpc = rmax_ars * kpc_per_arcsec\n        dper_kpc = dper_ars * kpc_per_arcsec\n        tab_converted = at.Table(names=['area_kpc', 'dmax_kpc', 'rmax_kpc', 'dper_kpc', 'area_ars', 'dmax_ars', 'rmax_ars', 'dper_ars'])\n        tab_converted.add_row([area_kpc, dmax_kpc, rmax_kpc, dper_kpc, area_ars, dmax_ars, rmax_ars, dper_ars])\n        tabout = at.hstack([tab_converted, tab])\n        return tabout\n\n    def _get_tab_measurements_nan(self):\n        \"\"\" \n\t\treturn a tab measurement just like _get_tab_measurements_from_contours() but with entries all nan. \n\t\t\"\"\"\n        names = ['area_kpc', 'dmax_kpc', 'rmax_kpc', 'dper_kpc', 'area_ars', 'dmax_ars', 'rmax_ars', 'dper_ars', 'area_pix', 'dmax_pix', 'rmax_pix', 'dper_pix', 'theta_dmax', 'theta_rmax', 'theta_dper', 'aspectr']\n        tabout = at.Table(names=names)\n        tabout.add_row([np.nan for i in range(len(names))])\n        return tabout\n\n    def _get_contours_from_img(self, img, isocut, xc, yc, minarea=0.0, onlycenter=False, centerradius=2.0 * u.arcsec):\n        \"\"\"\n\t\tmake contour at isocut of image as python pickle file (fn_contours)\n\t\talways overwrite\n\n\t\tParams\n\t\t------\n\t\tself\n\t\timg (array)\n\t\tisocut (float or quantity):\n\t\t\thas to be of the same type of unit as image\n\t\tminarea (float):\n\t\t\tminimum area (pix) to be considered as contour patch\n\t\tonlycenter (bool):\n\t\t\twhether to take only center patches as patches (they all have to pass minarea test as well)\n\t\tcenterradius (angular quantity):\n\t\t\tif onlycenter = True, then it sets the radius of the center area. only patches overlapping with that area will be considered. \n\n\t\t\"\"\"\n        try:\n            img.unit\n        except:\n            img_nparr = img / isocut\n        else:\n            img_nparr = np.array((img / isocut).to(u.dimensionless_unscaled))\n        contours = polytools.find_largecontours(img=img_nparr, threshold=1.0, minarea=minarea)\n        if onlycenter:\n            centerradius_pix = self._theta_to_pix(centerradius)\n            contours = polytools.select_center_contours(contours, xc, yc, radius=centerradius_pix)\n        return contours\n\ndef read_pickle(fn):\n    with open(fn, 'rb') as handle:\n        result = pickle.load(handle)\n    return result\n\ndef write_pickle(result, fn, overwrite=False):\n    if not os.path.isfile(fn) or overwrite:\n        with open(fn, 'wb') as handle:\n            pickle.dump(result, handle)",
  "line_no": 135,
  "line_no_percent": "62%"
}