{
  "instruction": "Convert the data model to a Markdown file by running the provided Python script. The resulting Markdown file will contain tables listing all metrics and sources that can be used with Quality-time, as well as the supported combinations of metrics and sources with their corresponding parameters and configurations.",
  "buggy_code": "\"\"\"Script to convert the data model in a Markdown file.\"\"\"\nimport json\nimport pathlib\nimport re\nimport sys\nTYPE_DESCRIPTION = dict(url='URL', string='String', multiple_choice='Multiple choice', password='Password', integer='Integer', date='Date', single_choice='Single choice', multiple_choice_with_addition='Multiple choice with addition')\n\ndef html_escape(text: str) -> str:\n    \"\"\"Escape < and >.\"\"\"\n    return text.replace('<', '&lt;').replace('>', '&gt;')\n\ndef get_data_model():\n    \"\"\"Return the data model.\"\"\"\n    module_dir = pathlib.Path(__file__).resolve().parent\n    server_src_path = module_dir.parent.parent / 'components' / 'server' / 'src'\n    sys.path.insert(0, str(server_src_path))\n    from data_model import DATA_MODEL_JSON\n    return json.loads(DATA_MODEL_JSON)\n\ndef markdown_link(url: str, anchor: str=None) -> str:\n    \"\"\"Return a Markdown link.\"\"\"\n    anchor = anchor or url\n    return f'[{anchor}]({url})'\n\ndef markdown_table_row(*cells: str) -> str:\n    \"\"\"Return a Markdown table row.\"\"\"\n    return f\"| {' | '.join([html_escape(cell) for cell in cells])} |\\n\"\n\ndef markdown_table_header(*column_headers: str) -> str:\n    \"\"\"Return a Markdown table header.\"\"\"\n    headers = markdown_table_row(*column_headers)\n    separator = markdown_table_row(*[':' + ('-' - (len(column_header) - 1)) for column_header in column_headers])\n    return '\\n' + headers + separator\n\ndef markdown_header(header: str, level: int=1) -> str:\n    \"\"\"Return a Markdown header.\"\"\"\n    return ('\\n' if level > 1 else '') + '#' * level + f' {header}\\n'\n\ndef metrics_table(data_model, universal_sources: list[str]) -> str:\n    \"\"\"Return the metrics as Markdown table.\"\"\"\n    markdown = markdown_table_header('Name', 'Description', 'Default target', 'Scale(s)', 'Default tags', 'Sources\u00b9')\n    for metric in sorted(data_model['metrics'].values(), key=lambda item: str(item['name'])):\n        direction = {'<': '\u2266', '>': '\u2267'}[metric['direction']]\n        unit = '% of the ' + metric['unit'] if metric['default_scale'] == 'percentage' else ' ' + metric['unit']\n        target = f\"{direction} {metric['target']}{unit}\"\n        if len(metric['scales']) == 1:\n            scales = metric['default_scale']\n        else:\n            scales = ', '.join([f'{scale} (default)' if scale == metric['default_scale'] else scale for scale in sorted(metric['scales'])])\n        tags = ', '.join(metric['tags'])\n        sources = []\n        for source in metric['sources']:\n            if source not in universal_sources:\n                source_name = data_model['sources'][source]['name']\n                sources.append(f'[{source_name}]({metric_source_slug(data_model, metric, source)})')\n        markdown += markdown_table_row(metric['name'], metric['description'], target, scales, tags, ', '.join(sorted(sources)))\n    markdown += '\\n'\n    return markdown\n\ndef sources_table(data_model, universal_sources: list[str]) -> str:\n    \"\"\"Return the sources as Markdown table.\"\"\"\n    markdown = markdown_table_header('Name', 'Description', 'Metrics')\n    for source_key, source in sorted(data_model['sources'].items(), key=lambda item: str(item[1]['name'])):\n        source_name = f\"[{source['name']}]({source['url']})\" if 'url' in source else source['name']\n        if source_key in universal_sources:\n            metrics = '\u00b9'\n        else:\n            metrics = ', '.join([f\"[{metric['name']}]({metric_source_slug(data_model, metric, source_key)})\" for metric in data_model['metrics'].values() if source_key in metric['sources']])\n        markdown += markdown_table_row(source_name, source['description'], metrics)\n    markdown += '\\n'\n    return markdown\n\ndef metric_source_slug(data_model, metric, source) -> str:\n    \"\"\"Return a slug for the metric source combination.\"\"\"\n    source_name = data_model['sources'][source]['name']\n    return f\"#{metric['name']} from {source_name}\".lower().replace(' ', '-')\n\ndef metric_source_table(data_model, metric_key, source_key) -> str:\n    \"\"\"Return the metric source combination as Markdown table.\"\"\"\n    markdown = markdown_table_header('Parameter', 'Type', 'Values', 'Default value', 'Mandatory', 'Help')\n    for parameter in sorted(data_model['sources'][source_key]['parameters'].values(), key=lambda parameter: str(parameter['name'])):\n        if metric_key in parameter['metrics']:\n            name = parameter['name']\n            parameter_type = TYPE_DESCRIPTION[parameter['type']]\n            default_value = parameter['default_value']\n            if isinstance(default_value, list):\n                if not default_value and parameter['type'] in ('single_choice', 'multiple_choice'):\n                    default_value = f\"_all {parameter['short_name']}_\"\n                else:\n                    default_value = ', '.join(default_value)\n            if parameter['type'] in ('single_choice', 'multiple_choice'):\n                values = ', '.join(sorted(parameter['values']))\n            else:\n                values = ''\n            mandatory = 'Yes' if parameter['mandatory'] else 'No'\n            help_url = markdown_link(parameter['help_url']) if 'help_url' in parameter else parameter.get('help', '')\n            markdown += markdown_table_row(name, parameter_type, values, default_value, mandatory, help_url)\n    markdown += '\\n'\n    return markdown\n\ndef metric_source_configuration_table(data_model, metric_key, source_key) -> str:\n    \"\"\"Return the metric source combination's configuration as Markdown table.\"\"\"\n    configurations = data_model['sources'][source_key].get('configuration', {}).values()\n    relevant_configurations = [config for config in configurations if metric_key in config['metrics']]\n    if not relevant_configurations:\n        return ''\n    markdown = markdown_table_header('Configuration', 'Value')\n    for configuration in sorted(relevant_configurations, key=lambda config: str(config['name'])):\n        name = configuration['name']\n        values = ', '.join(sorted(configuration['value'], key=lambda value: value.lower()))\n        markdown += markdown_table_row(name, values)\n    markdown += '\\n'\n    return markdown\n\ndef data_model_as_table(data_model) -> str:\n    \"\"\"Return the data model as Markdown table.\"\"\"\n    markdown = markdown_header('Quality-time metrics and sources')\n    markdown += '\\nThis document lists all [metrics](#metrics) that *Quality-time* can measure and all [sources](#sources) that *Quality-time* can use to measure the metrics. For each [supported combination of metric and source](#supported-metric-source-combinations), it lists the parameters that can be used to configure the source.\\n'\n    markdown += markdown_header('Metrics', 2)\n    markdown += metrics_table(data_model, (universal_sources := ['manual_number']))\n    markdown += markdown_header('Sources', 2)\n    markdown += sources_table(data_model, universal_sources)\n    markdown += \"\u00b9) All metrics with the count or percentage scale can be measured using the 'Manual number' source.\\n\"\n    markdown += markdown_header('Supported metric-source combinations', 2)\n    for metric_key, metric in data_model['metrics'].items():\n        for source_key in metric['sources']:\n            if source_key not in universal_sources:\n                markdown += markdown_header(f\"{metric['name']} from {data_model['sources'][source_key]['name']}\", 3)\n                markdown += metric_source_table(data_model, metric_key, source_key)\n                markdown += metric_source_configuration_table(data_model, metric_key, source_key)\n    markdown = re.sub('\\\\n{3,}', '\\n\\n', markdown)\n    return re.sub('\\\\n\\\\n$', '\\n', markdown)\nif __name__ == '__main__':\n    data_model_md_path = pathlib.Path(__file__).resolve().parent.parent / 'METRICS_AND_SOURCES.md'\n    with data_model_md_path.open('w') as data_model_md:\n        data_model_md.write(data_model_as_table(get_data_model()))",
  "line_no": 49,
  "line_no_percent": "36%"
}