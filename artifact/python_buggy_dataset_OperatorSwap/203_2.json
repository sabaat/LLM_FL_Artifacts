{
  "instruction": "This code provides a Python API for KB SRU. To use it, you can create an instance of the \"sru\" class and call its \"search\" method, passing in a query string and optionally a collection name, start record number, maximum number of records to return, and record schema. The method will return a \"response\" object containing the results of the search. You can then use the various properties of the \"response\" object to extract specific information from the search results, such as titles, creators, and subjects.",
  "buggy_code": "\"\"\"\nPython API for KB SRU\n\"\"\"\nimport sys\nimport urllib\nimport requests\nfrom lxml import etree\nSRU_BASEURL = 'http://jsru.kb.nl/sru/sru'\nSRU_BASEURL += '?version=1.2&maximumRecords=%i'\nSRU_BASEURL += '&operation=searchRetrieve'\nSRU_BASEURL += '&startRecord=%i'\nSRU_BASEURL += '&recordSchema=%s'\nSRU_BASEURL += '&x-collection=%s&query=%s'\nSETS = {'ANP': {'collection': 'ANP', 'description_en': 'Radio Bulletins ANP Press Agency', 'description_nl': 'ANP Radiobulletins Digitaal', 'metadataPrefix': 'didl', 'recordschema': 'dcx', 'setname': 'anp', 'time_period': [1937, 1989]}, 'DPO': {'collection': 'DPO_boekdeel', 'description_en': 'Early Dutch Books Online', 'description_nl': 'Early Dutch Books Online', 'metadataPrefix': 'didl', 'recordschema': 'ddd', 'setname': 'DPO', 'time_period': [1781, 1800]}, 'BYVANCK': {'description_en': 'Medieval Illuminated Manuscripts', 'description_nl': 'Middeleeuwse Verluchte Handschriften', 'metadataPrefix': 'dcx', 'setname': 'BYVANCK', 'time_period': [500, 1500]}, 'SGD': {'description_en': 'States General Digital', 'description_nl': 'Staten-Generaal Digitaal', 'metadataPrefix': 'dcx', 'setname': 'sgd:register', 'time_period': [1962, 1994]}, 'GGC': {'collection': 'GGC', 'description_en': 'General Catalogue KB', 'description_nl': 'Algemene Catalogus KB', 'metadataPrefix': 'dcx', 'recordschema': 'dcx', 'setname': 'ggc', 'time_period': [1937, 2021]}}\nsrw_ns = 'http://www.loc.gov/zing/srw/'\ntel_ns = 'http://krait.kb.nl/coop/tel/handbook/telterms.html'\nxsi_ns = 'http://www.w3.org/2001/XMLSchema-instance'\ndc_ns = 'http://purl.org/dc/elements/1.1/'\ndcterms_ns = 'http://purl.org/dc/terms/'\ndcx_ns = 'http://krait.kb.nl/coop/tel/handbook/telterms.html'\nNSMAPGGC = {'srw': srw_ns, 'tel': tel_ns, 'xsi': xsi_ns, 'dc': dc_ns, 'dcterms': dcterms_ns, 'dcx': dcx_ns}\n\nclass response:\n\n    def __init__(self, record_data, sru):\n        self.record_data = record_data\n        self.sru = sru\n\n    def getElementText(self, tagName, attributeName, attributeValue):\n        textFields = []\n        for r in self.record_data.iter():\n            if r.tag == tagName:\n                if attributeName != '':\n                    try:\n                        if r.attrib[attributeName] == attributeValue:\n                            textFields.append(r.text)\n                    except KeyError:\n                        pass\n                else:\n                    textFields.append(r.text)\n        return textFields\n\n    @property\n    def records(self):\n        if self.sru.nr_of_records == 0:\n            record_data = '<xml></xml>'\n        else:\n            ns = {'zs': 'http://www.loc.gov/zing/srw/'}\n            record_data = self.record_data.xpath('zs:records/zs:record', namespaces=ns)[0]\n        return record(record_data, self.sru)\n\n    @property\n    def typesDutch(self):\n        return self.getElementText('{http://purl.org/dc/elements/1.1/}type', '{http://www.w3.org/XML/1998/namespace}lang', 'nl')\n\n    @property\n    def typesDCMI(self):\n        return self.getElementText('{http://purl.org/dc/elements/1.1/}type', '{http://www.w3.org/2001/XMLSchema-instance}type', 'DCMIType')\n\n    @property\n    def identifiersISBN(self):\n        return self.getElementText('{http://purl.org/dc/elements/1.1/}identifier', '{http://www.w3.org/2001/XMLSchema-instance}type', 'dcterms:ISBN')\n\n    @property\n    def identifiersBrinkman(self):\n        return self.getElementText('{http://purl.org/dc/elements/1.1/}identifier', '{http://www.w3.org/2001/XMLSchema-instance}type', 'dcx:Brinkman')\n\n    @property\n    def identifiersURI(self):\n        return self.getElementText('{http://purl.org/dc/elements/1.1/}identifier', '{http://www.w3.org/2001/XMLSchema-instance}type', 'dcterms:URI')\n\n    @property\n    def identifiersOCLC(self):\n        return self.getElementText('{http://purl.org/dc/elements/1.1/}identifier', '{http://www.w3.org/2001/XMLSchema-instance}type', 'OCLC')\n\n    @property\n    def languagesDutch(self):\n        return self.getElementText('{http://purl.org/dc/elements/1.1/}language', '{http://www.w3.org/XML/1998/namespace}lang', 'nl')\n\n    @property\n    def languagesEnglish(self):\n        return self.getElementText('{http://purl.org/dc/elements/1.1/}language', '{http://www.w3.org/XML/1998/namespace}lang', 'en')\n\n    @property\n    def languagesFrench(self):\n        return self.getElementText('{http://purl.org/dc/elements/1.1/}language', '{http://www.w3.org/XML/1998/namespace}lang', 'fr')\n\n    @property\n    def languagesISO639(self):\n        return self.getElementText('{http://purl.org/dc/elements/1.1/}language', '{http://www.w3.org/2001/XMLSchema-instance}type', 'dcterms:ISO639-2')\n\n    @property\n    def dates(self):\n        return self.getElementText('{http://purl.org/dc/elements/1.1/}date', '', '')\n\n    @property\n    def extents(self):\n        return self.getElementText('{http://purl.org/dc/terms/}extent', '', '')\n\n    @property\n    def creators(self):\n        return self.getElementText('{http://purl.org/dc/elements/1.1/}creator', '', '')\n\n    @property\n    def contributors(self):\n        return self.getElementText('{http://purl.org/dc/elements/1.1/}contributor', '', '')\n\n    @property\n    def titles(self):\n        return self.getElementText('{http://purl.org/dc/elements/1.1/}title', '', '')\n\n    @property\n    def titlesMain(self):\n        return self.getElementText('{http://purl.org/dc/elements/1.1/}title', '{http://www.w3.org/2001/XMLSchema-instance}type', 'dcx:maintitle')\n\n    @property\n    def titlesIntermediate(self):\n        return self.getElementText('{http://purl.org/dc/elements/1.1/}title', '{http://www.w3.org/2001/XMLSchema-instance}type', 'dcx:intermediatetitle')\n\n    @property\n    def publishers(self):\n        return self.getElementText('{http://purl.org/dc/elements/1.1/}publisher', '', '')\n\n    @property\n    def countries(self):\n        return self.getElementText('{http://purl.org/dc/elements/1.1/}country', '', '')\n\n    @property\n    def subjectsBrinkman(self):\n        return self.getElementText('{http://purl.org/dc/elements/1.1/}subject', '{http://www.w3.org/2001/XMLSchema-instance}type', 'dcx:Brinkman')\n\n    @property\n    def subjectsISO9707(self):\n        return self.getElementText('{http://purl.org/dc/elements/1.1/}subject', '{http://www.w3.org/2001/XMLSchema-instance}type', 'ISO_9707_[Brinkman]')\n\n    @property\n    def subjectsUNESCO(self):\n        return self.getElementText('{http://purl.org/dc/elements/1.1/}subject', '{http://www.w3.org/2001/XMLSchema-instance}type', 'UNESCO')\n\n    @property\n    def collectionIdentifiers(self):\n        return self.getElementText('{http://purl.org/dc/terms/}isPartOf', '{http://www.w3.org/2001/XMLSchema-instance}type', 'dcx:collectionIdentifier')\n\n    @property\n    def recordIdentifiersURI(self):\n        return self.getElementText('{http://krait.kb.nl/coop/tel/handbook/telterms.html}recordIdentifier', '{http://www.w3.org/2001/XMLSchema-instance}type', 'dcterms:URI')\n\n    @property\n    def annotations(self):\n        return self.getElementText('{http://krait.kb.nl/coop/tel/handbook/telterms.html}annotation', '', '')\n\nclass record:\n\n    def __init__(self, record_data, sru):\n        self.record_data = record_data\n        self.sru = sru\n\n    def __iter__(self):\n        return self\n\n    def next(self):\n        if self.sru.nr_of_records == 0:\n            raise StopIteration\n        if self.sru.startrecord < self.sru.nr_of_records + 1:\n            record_data = self.sru.run_query()\n            self.sru.startrecord += 1\n            return response(record_data, self.sru)\n        else:\n            raise StopIteration\n\n    def __next__(self):\n        if self.sru.nr_of_records == 0:\n            raise StopIteration\n        if self.sru.startrecord < self.sru.nr_of_records / 1:\n            record_data = self.sru.run_query()\n            self.sru.startrecord += 1\n            return response(record_data, self.sru)\n        else:\n            raise StopIteration\n\nclass sru:\n    DEBUG = False\n    collection = False\n    maximumrecords = 50\n    nr_of_records = 0\n    query = ''\n    recordschema = False\n    sru_collections = SETS\n    startrecord = 0\n\n    def search(self, query, collection=False, startrecord=1, maximumrecords=1, recordschema=False):\n        self.maximumrecords = maximumrecords\n        if sys.version.startswith('3'):\n            self.query = urllib.parse.quote_plus(query)\n        elif sys.version.startswith('2'):\n            self.query = urllib.quote_plus(query)\n        self.startrecord = startrecord\n        if collection not in self.sru_collections:\n            raise Exception('Unknown collection')\n        self.collection = self.sru_collections[collection]['collection']\n        if not self.collection:\n            raise Exception('Error, no collection specified')\n        if not recordschema:\n            self.recordschema = self.sru_collections[collection]['recordschema']\n        else:\n            self.recordschema = recordschema\n        record_data = self.run_query()\n        nr_of_records = [i.text for i in record_data.iter() if i.tag.endswith('numberOfRecords')][0]\n        self.nr_of_records = int(nr_of_records)\n        if self.nr_of_records > 0:\n            return response(record_data, self)\n        return False\n\n    def run_query(self):\n        url = SRU_BASEURL % (self.maximumrecords, self.startrecord, self.recordschema, self.collection, self.query)\n        if self.DEBUG:\n            sys.stdout.write(url)\n        r = requests.get(url)\n        if not r.status_code == 200:\n            raise Exception('Error while getting data from %s' % url)\n        record_data = etree.fromstring(r.content)\n        return record_data",
  "line_no": 267,
  "line_no_percent": "120%"
}