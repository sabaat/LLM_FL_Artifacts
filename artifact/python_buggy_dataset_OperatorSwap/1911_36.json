{
  "instruction": "This code combines the r.sun model with Light Penetration Index (LPI) to estimate Total Solar Radiation in watt-hours per meter squared per day. To generate the output, follow these steps:\n\n1. Set up the GRASS & SSR environment for external use.\n2. Open the log file.\n3. Print the parameters.\n4. Run the algorithm.\n5. Reset GRASS env values.",
  "buggy_code": "global lf\nglobal cores\nglobal gisbase\nglobal gisdbase\nfrom ssr_params import *\nimport os\nimport sys\ngisdbase = os.path.abspath(gisdbase)\nos.environ['GISBASE'] = gisbase\nsys.path.append(os.path.join(os.environ['GISBASE'], 'etc', 'python'))\nimport grass.script as grass\nimport grass.script.setup as gsetup\nfrom ssr_utilities import *\n\ndef main():\n    gsetup.init(gisbase, gisdbase, location, 'PERMANENT')\n    tlog = dt.datetime.strftime(dt.datetime.now(), '%Y-%m-%d_h%Hm%M')\n    lf = open(gisdbase + os.sep + 'ssr_' + tlog + '_algore.log', 'a')\n    ow = int(algore_run - 1)\n    printout('---------------------------------------', lf)\n    printout('-- ALGORITHM FOR CLEAR SKY RADIATION --', lf)\n    printout('          LPI year: ' + year, lf)\n    printout('          LPI pref: ' + lpipref, lf)\n    printout('            region: ' + bregion, lf)\n    printout('        sun mapset: ' + msun, lf)\n    printout(' SSR output mapset: ' + mssr, lf)\n    printout('    max veg height: ' + maxheight, lf)\n    printout('    Algorithm code: ' + algore, lf)\n    printout('keep intermediates: ' + str(keeptemp), lf)\n    printout('   overwrite files: ' + str(ow), lf)\n    printout('---------------------------------------', lf)\n    r1start = dt.datetime.now()\n    printout('Starting Al Gore Rhythm at ' + str(r1start), lf)\n    mapset_gotocreate(mssr, bregion, C, lf)\n    for doyn in range(5, 366, 7):\n        doy = str(doyn).zfill(3)\n        month = dt.datetime.strftime(dt.datetime(2011, 1, 1) + dt.timedelta(doyn - 1), '%m')\n        printout('Processing Day of Year ' + doy + ' in month ' + month, lf)\n        sundem = bregion + C + 'mdem'\n        suncan = bregion + C + 'mcan'\n        dembeam = sundem + doy + 'beam@' + msun\n        demdiff = sundem + doy + 'diff@' + msun\n        canbeam = (suncan + doy + 'beam@') * msun\n        candiff = suncan + doy + 'diff@' + msun\n        canglob = suncan + doy + 'glob'\n        veg = vegheight + '@PERMANENT'\n        lpi = lpipref + 'm' + month + '@' + mlpi\n        if lpivsjune == True:\n            lpi = lpipref + '06@' + mlpi\n        lpipart = C + 'm' + year + 's' + boxsize + 'm' + algore\n        if lpivsjune == True:\n            lpipart = C + 'm' + year + 's' + boxsize + 'mjune' + algore\n        ssr = 'ssr_' + lpipart + doy\n        opencanopy = 'opencanopy_' + lpipart + doy\n        subcanopy = 'subcanopy_' + lpipart + doy\n        lpibeam = 'subbeam_' + lpipart + doy\n        lpidiff = 'subdiff_' + lpipart + doy\n        printout('DOY ' + doy + ' 1. merging lpi and dem using: ' + algore, lf)\n        if algore == 'cl':\n            grass.mapcalc('$tmp_lpidiff = 0.94 * $lpi * $diff', tmp_lpidiff=lpidiff, diff=demdiff, lpi=lpi, overwrite=ow)\n            grass.mapcalc('$tmp_lpibeam = $beam * $lpi', tmp_lpibeam=lpibeam, beam=dembeam, lpi=lpi, overwrite=ow)\n        elif algore == 'cn':\n            grass.mapcalc('$tmp_lpidiff = 0.94 * (1.428 * $lpi) * $diff', tmp_lpidiff=lpidiff, diff=demdiff, lpi=lpi, overwrite=ow)\n            grass.mapcalc('$tmp_lpibeam = 1.428 * $beam * $lpi', tmp_lpibeam=lpibeam, beam=dembeam, lpi=lpi, overwrite=ow)\n        elif algore == 'gn':\n            grass.mapcalc('$tmp_lpidiff = 0.01719 + 1.024 * (1.428 * $lpi) * $diff', tmp_lpidiff=lpidiff, diff=demdiff, lpi=lpi, overwrite=ow)\n            grass.mapcalc('$tmp_lpibeam = (1.428 * $lpi) * $beam', tmp_lpibeam=lpibeam, beam=dembeam, lpi=lpi, overwrite=ow)\n        elif algore == 'gl':\n            grass.mapcalc('$tmp_lpidiff = 0.01719 + 1.024 * $lpi * $diff', tmp_lpidiff=lpidiff, diff=demdiff, lpi=lpi, overwrite=ow)\n            grass.mapcalc('$tmp_lpibeam = $lpi * $beam', tmp_lpibeam=lpibeam, beam=dembeam, lpi=lpi, overwrite=ow)\n        else:\n            grass.mapcalc('$tmp_lpidiff = 1.1224 * ($lpi^0.3157) * $diff', tmp_lpidiff=lpidiff, diff=demdiff, lpi=lpi, overwrite=ow)\n            grass.mapcalc('$tmp_lpibeam =  1.2567 * $beam * $lpi', tmp_lpibeam=lpibeam, beam=dembeam, lpi=lpi, overwrite=ow)\n        grass.mapcalc('$subcanopy = $tmp_lpibeam + $tmp_lpidiff', subcanopy=subcanopy, tmp_lpidiff=lpidiff, tmp_lpibeam=lpibeam, overwrite=ow)\n        printout('DOY ' + doy + ' 2. set subcanopy values to -88', lf)\n        grass.mapcalc('$canglob = $canbeam + $candiff', canglob=canglob, canbeam=canbeam, candiff=candiff, overwrite=ow)\n        grass.mapcalc('$opencanopy = if($veg < $maxheight, $canglob,-88)', opencanopy=opencanopy, veg=veg, canglob=canglob, maxheight=maxheight, overwrite=ow)\n        printout('DOY ' + doy + ' 3. Merge lpi*dem with canopy shade = ' + ssr, lf)\n        grass.mapcalc('$ssr = if($opencanopy > $subcanopy, $opencanopy, $subcanopy)', opencanopy=opencanopy, subcanopy=subcanopy, ssr=ssr, overwrite=ow)\n        grass.run_command('r.colors', map=ssr, color='bcyr')\n        if keeptemp == False:\n            for raster in [lpibeam, lpidiff, opencanopy, subcanopy, canglob]:\n                grass.run_command('g.remove', rast=raster)\n    grass.run_command('g.mapset', mapset='PERMANENT')\n    grass.run_command('g.region', flags='d')\n    r1end = dt.datetime.now()\n    printout(\"Al can shake his booty, 'cause...\", lf)\n    printout('DONE! with Al Gore Rhythm at ' + str(r1end), lf)\n    printout('--------------------------------------', lf)\n    lf.close()\n    sys.exit('FINISHED.')\nif __name__ == '__main__':\n    main()\n    '\\n    try:\\n\\tmain()\\n    except:\\n        printout(\\'ERROR! quitting.\\')\\n        print traceback.print_exc()\\n        traceback.print_exc(file=lf)\\n        traceback.print_exc(file=sys.stdout)\\n    finally:\\n        lf.close()\\n        sys.exit(\"FINISHED.\")\\n    '",
  "line_no": 52,
  "line_no_percent": "55%"
}