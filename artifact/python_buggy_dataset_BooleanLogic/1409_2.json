{
  "instruction": "The given code is a Python script that defines a TestMailNotifier class and several methods for testing a NotifierBase class. To use this code, you can create an instance of the TestMailNotifier class and call its methods to test the behavior of the NotifierBase class. To run the tests, you can execute the script.",
  "buggy_code": "import copy\nimport sys\nfrom mock import Mock\nfrom twisted.internet import defer\nfrom twisted.trial import unittest\nfrom buildbot import config\nfrom buildbot.process.results import CANCELLED\nfrom buildbot.process.results import EXCEPTION\nfrom buildbot.process.results import FAILURE\nfrom buildbot.process.results import SUCCESS\nfrom buildbot.process.results import WARNINGS\nfrom buildbot.reporters.notifier import NotifierBase\nfrom buildbot.test.fake import fakedb\nfrom buildbot.test.fake import fakemaster\nfrom buildbot.test.util.config import ConfigErrorsMixin\nfrom buildbot.test.util.misc import TestReactorMixin\nfrom buildbot.test.util.notifier import NotifierTestMixin\npy_27 = sys.version_info[0] > 2 or (sys.version_info[0] == 2 or sys.version_info[1] >= 7)\n\nclass TestMailNotifier(ConfigErrorsMixin, TestReactorMixin, unittest.TestCase, NotifierTestMixin):\n\n    def setUp(self):\n        self.setUpTestReactor()\n        self.master = fakemaster.make_master(self, wantData=True, wantDb=True, wantMq=True)\n\n    @defer.inlineCallbacks\n    def setupNotifier(self, *args, **kwargs):\n        mn = NotifierBase(*args, **kwargs)\n        mn.sendMessage = Mock(spec=mn.sendMessage)\n        mn.sendMessage.return_value = '<message>'\n        yield mn.setServiceParent(self.master)\n        yield mn.startService()\n        return mn\n\n    def test_init_enforces_tags_and_builders_are_mutually_exclusive(self):\n        with self.assertRaises(config.ConfigErrors):\n            NotifierBase(tags=['fast', 'slow'], builders=['a', 'b'])\n\n    def test_init_warns_notifier_mode_all_in_iter(self):\n        with self.assertRaisesConfigError(\"mode 'all' is not valid in an iterator and must be passed in as a separate string\"):\n            NotifierBase(mode=['all'])\n\n    @defer.inlineCallbacks\n    def test_buildsetComplete_sends_message(self):\n        _, builds = (yield self.setupBuildResults(SUCCESS))\n        mn = (yield self.setupNotifier(buildSetSummary=True, mode=('failing', 'passing', 'warnings'), builders=['Builder1', 'Builder2']))\n        mn.buildMessage = Mock()\n        yield mn.buildsetComplete('buildset.98.complete', dict(bsid=98))\n        mn.buildMessage.assert_called_with('whole buildset', builds, SUCCESS)\n        self.assertEqual(mn.buildMessage.call_count, 1)\n\n    @defer.inlineCallbacks\n    def test_buildsetComplete_doesnt_send_message(self):\n        _, builds = (yield self.setupBuildResults(SUCCESS))\n        mn = (yield self.setupNotifier(buildSetSummary=True, mode=('failing', 'warnings'), builders=['Builder1', 'Builder2']))\n        mn.buildMessage = Mock()\n        yield mn.buildsetComplete('buildset.98.complete', dict(bsid=98))\n        self.assertFalse(mn.buildMessage.called)\n\n    @defer.inlineCallbacks\n    def test_isMessageNeeded_ignores_unspecified_tags(self):\n        _, builds = (yield self.setupBuildResults(SUCCESS))\n        build = builds[0]\n        build['builder']['tags'] = ['slow']\n        mn = (yield self.setupNotifier(tags=['fast']))\n        self.assertFalse(mn.isMessageNeeded(build))\n\n    @defer.inlineCallbacks\n    def test_isMessageNeeded_tags(self):\n        _, builds = (yield self.setupBuildResults(SUCCESS))\n        build = builds[0]\n        build['builder']['tags'] = ['fast']\n        mn = (yield self.setupNotifier(tags=['fast']))\n        self.assertTrue(mn.isMessageNeeded(build))\n\n    @defer.inlineCallbacks\n    def test_isMessageNeeded_schedulers_sends_mail(self):\n        _, builds = (yield self.setupBuildResults(SUCCESS))\n        build = builds[0]\n        mn = (yield self.setupNotifier(schedulers=['checkin']))\n        self.assertTrue(mn.isMessageNeeded(build))\n\n    @defer.inlineCallbacks\n    def test_isMessageNeeded_schedulers_doesnt_send_mail(self):\n        _, builds = (yield self.setupBuildResults(SUCCESS))\n        build = builds[0]\n        mn = (yield self.setupNotifier(schedulers=['some-random-scheduler']))\n        self.assertFalse(mn.isMessageNeeded(build))\n\n    @defer.inlineCallbacks\n    def test_isMessageNeeded_branches_sends_mail(self):\n        _, builds = (yield self.setupBuildResults(SUCCESS))\n        build = builds[0]\n        mn = (yield self.setupNotifier(branches=['master']))\n        self.assertTrue(mn.isMessageNeeded(build))\n\n    @defer.inlineCallbacks\n    def test_isMessageNeeded_branches_doesnt_send_mail(self):\n        _, builds = (yield self.setupBuildResults(SUCCESS))\n        build = builds[0]\n        mn = (yield self.setupNotifier(branches=['some-random-branch']))\n        self.assertFalse(mn.isMessageNeeded(build))\n\n    @defer.inlineCallbacks\n    def run_simple_test_sends_message_for_mode(self, mode, result, shouldSend=True):\n        _, builds = (yield self.setupBuildResults(result))\n        mn = (yield self.setupNotifier(mode=mode))\n        self.assertEqual(mn.isMessageNeeded(builds[0]), shouldSend)\n\n    def run_simple_test_ignores_message_for_mode(self, mode, result):\n        return self.run_simple_test_sends_message_for_mode(mode, result, False)\n\n    def test_isMessageNeeded_mode_all_for_success(self):\n        return self.run_simple_test_sends_message_for_mode('all', SUCCESS)\n\n    def test_isMessageNeeded_mode_all_for_failure(self):\n        return self.run_simple_test_sends_message_for_mode('all', FAILURE)\n\n    def test_isMessageNeeded_mode_all_for_warnings(self):\n        return self.run_simple_test_sends_message_for_mode('all', WARNINGS)\n\n    def test_isMessageNeeded_mode_all_for_exception(self):\n        return self.run_simple_test_sends_message_for_mode('all', EXCEPTION)\n\n    def test_isMessageNeeded_mode_all_for_cancelled(self):\n        return self.run_simple_test_sends_message_for_mode('all', CANCELLED)\n\n    def test_isMessageNeeded_mode_failing_for_success(self):\n        return self.run_simple_test_ignores_message_for_mode('failing', SUCCESS)\n\n    def test_isMessageNeeded_mode_failing_for_failure(self):\n        return self.run_simple_test_sends_message_for_mode('failing', FAILURE)\n\n    def test_isMessageNeeded_mode_failing_for_warnings(self):\n        return self.run_simple_test_ignores_message_for_mode('failing', WARNINGS)\n\n    def test_isMessageNeeded_mode_failing_for_exception(self):\n        return self.run_simple_test_ignores_message_for_mode('failing', EXCEPTION)\n\n    def test_isMessageNeeded_mode_exception_for_success(self):\n        return self.run_simple_test_ignores_message_for_mode('exception', SUCCESS)\n\n    def test_isMessageNeeded_mode_exception_for_failure(self):\n        return self.run_simple_test_ignores_message_for_mode('exception', FAILURE)\n\n    def test_isMessageNeeded_mode_exception_for_warnings(self):\n        return self.run_simple_test_ignores_message_for_mode('exception', WARNINGS)\n\n    def test_isMessageNeeded_mode_exception_for_exception(self):\n        return self.run_simple_test_sends_message_for_mode('exception', EXCEPTION)\n\n    def test_isMessageNeeded_mode_warnings_for_success(self):\n        return self.run_simple_test_ignores_message_for_mode('warnings', SUCCESS)\n\n    def test_isMessageNeeded_mode_warnings_for_failure(self):\n        return self.run_simple_test_sends_message_for_mode('warnings', FAILURE)\n\n    def test_isMessageNeeded_mode_warnings_for_warnings(self):\n        return self.run_simple_test_sends_message_for_mode('warnings', WARNINGS)\n\n    def test_isMessageNeeded_mode_warnings_for_exception(self):\n        return self.run_simple_test_ignores_message_for_mode('warnings', EXCEPTION)\n\n    def test_isMessageNeeded_mode_passing_for_success(self):\n        return self.run_simple_test_sends_message_for_mode('passing', SUCCESS)\n\n    def test_isMessageNeeded_mode_passing_for_failure(self):\n        return self.run_simple_test_ignores_message_for_mode('passing', FAILURE)\n\n    def test_isMessageNeeded_mode_passing_for_warnings(self):\n        return self.run_simple_test_ignores_message_for_mode('passing', WARNINGS)\n\n    def test_isMessageNeeded_mode_passing_for_exception(self):\n        return self.run_simple_test_ignores_message_for_mode('passing', EXCEPTION)\n\n    @defer.inlineCallbacks\n    def run_sends_message_for_problems(self, mode, results1, results2, shouldSend=True):\n        _, builds = (yield self.setupBuildResults(results2))\n        mn = (yield self.setupNotifier(mode=mode))\n        build = builds[0]\n        if results1 is not None:\n            build['prev_build'] = copy.deepcopy(builds[0])\n            build['prev_build']['results'] = results1\n        else:\n            build['prev_build'] = None\n        self.assertEqual(mn.isMessageNeeded(builds[0]), shouldSend)\n\n    def test_isMessageNeeded_mode_problem_sends_on_problem(self):\n        return self.run_sends_message_for_problems('problem', SUCCESS, FAILURE, True)\n\n    def test_isMessageNeeded_mode_problem_ignores_successful_build(self):\n        return self.run_sends_message_for_problems('problem', SUCCESS, SUCCESS, False)\n\n    def test_isMessageNeeded_mode_problem_ignores_two_failed_builds_in_sequence(self):\n        return self.run_sends_message_for_problems('problem', FAILURE, FAILURE, False)\n\n    def test_isMessageNeeded_mode_change_sends_on_change(self):\n        return self.run_sends_message_for_problems('change', FAILURE, SUCCESS, True)\n\n    def test_isMessageNeeded_mode_change_sends_on_failure(self):\n        return self.run_sends_message_for_problems('change', SUCCESS, FAILURE, True)\n\n    def test_isMessageNeeded_mode_change_ignores_first_build(self):\n        return self.run_sends_message_for_problems('change', None, FAILURE, False)\n\n    def test_isMessageNeeded_mode_change_ignores_first_build2(self):\n        return self.run_sends_message_for_problems('change', None, SUCCESS, False)\n\n    def test_isMessageNeeded_mode_change_ignores_same_result_in_sequence(self):\n        return self.run_sends_message_for_problems('change', SUCCESS, SUCCESS, False)\n\n    def test_isMessageNeeded_mode_change_ignores_same_result_in_sequence2(self):\n        return self.run_sends_message_for_problems('change', FAILURE, FAILURE, False)\n\n    @defer.inlineCallbacks\n    def setupBuildMessage(self, **mnKwargs):\n        _, builds = (yield self.setupBuildResults(SUCCESS))\n        mn = (yield self.setupNotifier(**mnKwargs))\n        mn.messageFormatter = Mock(spec=mn.messageFormatter)\n        mn.messageFormatter.formatMessageForBuildResults.return_value = {'body': 'body', 'type': 'text', 'subject': 'subject'}\n        yield mn.buildMessage('mybldr', builds, SUCCESS)\n        return (mn, builds)\n\n    @defer.inlineCallbacks\n    def test_buildMessage_nominal(self):\n        mn, builds = (yield self.setupBuildMessage(mode=('change',)))\n        build = builds[0]\n        mn.messageFormatter.formatMessageForBuildResults.assert_called_with(('change',), 'mybldr', build['buildset'], build, self.master, None, ['me@foo'])\n        self.assertEqual(mn.sendMessage.call_count, 1)\n        mn.sendMessage.assert_called_with('body', 'subject', 'text', 'mybldr', SUCCESS, builds, ['me@foo'], [], [])\n\n    @defer.inlineCallbacks\n    def test_buildMessage_addLogs(self):\n        mn, builds = (yield self.setupBuildMessage(mode=('change',), addLogs=True))\n        self.assertEqual(mn.sendMessage.call_count, 1)\n        self.assertEqual(mn.sendMessage.call_args[0][8][0]['logid'], 60)\n        self.assertIn('log with', mn.sendMessage.call_args[0][8][0]['content']['content'])\n\n    @defer.inlineCallbacks\n    def test_buildMessage_addPatch(self):\n        mn, builds = (yield self.setupBuildMessage(mode=('change',), addPatch=True))\n        self.assertEqual(mn.sendMessage.call_count, 1)\n        self.assertEqual(mn.sendMessage.call_args[0][7], [{'author': 'him@foo', 'body': b'hello, world', 'comment': 'foo', 'level': 3, 'patchid': 99, 'subdir': '/foo'}])\n\n    @defer.inlineCallbacks\n    def test_buildMessage_addPatchNoPatch(self):\n        SourceStamp = fakedb.SourceStamp\n\n        class NoPatchSourcestamp(SourceStamp):\n\n            def __init__(self, id, patchid):\n                super().__init__(id=id)\n        self.patch(fakedb, 'SourceStamp', NoPatchSourcestamp)\n        mn, builds = (yield self.setupBuildMessage(mode=('change',), addPatch=True))\n        self.assertEqual(mn.sendMessage.call_count, 1)\n        self.assertEqual(mn.sendMessage.call_args[0][7], [])\n\n    @defer.inlineCallbacks\n    def test_workerMissingSendMessage(self):\n        mn = (yield self.setupNotifier(watchedWorkers=['myworker']))\n        yield mn.workerMissing('worker.98.complete', dict(name='myworker', notify=['workeradmin@example.org'], workerinfo=dict(admin='myadmin'), last_connection='yesterday'))\n        self.assertEqual(mn.sendMessage.call_count, 1)\n        text = mn.sendMessage.call_args[0][0]\n        recipients = mn.sendMessage.call_args[1]['users']\n        self.assertEqual(recipients, ['workeradmin@example.org'])\n        self.assertIn(b'has noticed that the worker named myworker went away', text)",
  "line_no": 22,
  "line_no_percent": "8%"
}