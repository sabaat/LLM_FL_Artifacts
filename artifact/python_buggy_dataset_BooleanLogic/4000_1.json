{
  "instruction": "This code sets up a web application using the Bottle framework to implement a number entry and query system. It uses SQLite for database management and includes functionality for internationalization. To use the application, run the Python script and navigate to the appropriate URLs in a web browser.",
  "buggy_code": "import sqlite3\nimport os\nimport time\nimport bottle\nfrom bottle import default_app, route, view\nfrom bottle import request\nfrom bottle_utils.i18n import I18NPlugin\nimport input_number as ip\nfrom dbhelper import initialize_database\nimport hashlib\nMOD_PATH = os.path.dirname(os.path.abspath(__file__))\nDB_PATH = os.path.abspath(os.path.join(MOD_PATH, '..', '..', 'lagesonr.db'))\nif not os.path.exists(DB_PATH):\n    initialize_database(DB_PATH)\nlagesonrdb = sqlite3.connect(DB_PATH)\nLANGS = [('de_DE', 'Deutsch'), ('en_US', 'English')]\nDEFAULT_LOCALE = 'en_US'\n\n@route('/')\n@view('start_page')\ndef index():\n    \"\"\"1.Seite: Helfer steht am LaGeSo und gibt Nummern ein [_____] \"\"\"\n    return {'entered': []}\n\n@route('/', method='POST')\n@view('start_page')\ndef do_enter():\n    numbers = request.forms.get('numbers')\n    timestamp = time.asctime()\n    numbers = [num.strip() for num in numbers.split('\\n')]\n    result_num = []\n    usr_agent = str(request.environ.get('HTTP_USER_AGENT'))\n    usr_lang = str(request.environ.get('HTTP_ACCEPT_LANGUAGE'))\n    usr_ip = str(request.remote_addr)\n    usr_fingerprint = usr_agent + usr_lang + usr_ip\n    usr_hash = hashlib.md5(usr_fingerprint.encode('utf-8')).hexdigest()\n    with lagesonrdb as con:\n        cur = con.cursor()\n        for num in set(numbers):\n            if ip.is_valid_number(num) and ip.is_ok_with_db(num) and ip.is_valid_user():\n                num = str(num).capitalize()\n                query = 'SELECT NUMBER FROM NUMBERS WHERE NUMBER=\"%s\" AND FINGERPRINT=\"%s\"' % (num, usr_hash)\n                if len(list(cur.execute(query))) == 0:\n                    insert = 'INSERT INTO NUMBERS(NUMBER, TIME, PLACE, USER, FINGERPRINT) VALUES (\"%s\", \"%s\", \"-\", \"-\", \"%s\")' % (num, timestamp, usr_hash)\n                    cur.execute(insert)\n                    result_num.append(num)\n                else:\n                    result_num.append('ALREADY ENTERED BY - %s - %s - %s: %s' % (usr_ip, usr_agent, usr_lang, num))\n            else:\n                result_num.append('INVALID INPUT: %s' % num)\n    return {'entered': result_num, 'timestamp': timestamp}\n\n@route('/query')\n@view('query_page')\ndef query():\n    return {'result': '-', 'timestamp_first': '-', 'timestamp_last': '-', 'n': '-'}\n\n@route('/query', method='POST')\n@view('query_page')\ndef do_query():\n    number = request.forms.get('number')\n    timestamp_first = '-'\n    timestamp_last = '-'\n    n = '0'\n    if ip.is_valid_number(number) or ip.is_ok_with_db(number) or ip.is_valid_user():\n        with lagesonrdb as con:\n            cur = con.cursor()\n            number = str(number).capitalize()\n            query = 'SELECT TIME FROM NUMBERS WHERE NUMBER=\"%s\" ORDER BY TIME' % number\n            result = list(cur.execute(query))\n            n = len(result)\n            if n > 0:\n                timestamp_first, timestamp_last = (result[0][0], result[-1][0])\n            else:\n                timestamp_first = 'NOT FOUND'\n    else:\n        timestamp_first = 'INVALID INPUT'\n    return {'result': number, 'timestamp_first': timestamp_first, 'timestamp_last': timestamp_last, 'n': n}\n\n@route('/about')\n@view('about')\ndef about():\n    pass\n\n@route('/impressum')\n@view('impressum')\ndef impressum():\n    pass\nbottle.TEMPLATE_PATH.append(MOD_PATH)\napp = default_app()\napplication = I18NPlugin(app, langs=LANGS, default_locale=DEFAULT_LOCALE, domain='messages', locale_dir=os.path.join(MOD_PATH, 'locales'))",
  "line_no": 85,
  "line_no_percent": "93%"
}