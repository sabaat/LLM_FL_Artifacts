{
  "instruction": "The given code is a Python module for implementing Google reCAPTCHA. To use it, import the necessary modules and functions, and then call the functions as needed. To display the reCAPTCHA HTML, call the \"displayhtml\" function and pass in the public key and any optional parameters. To submit the reCAPTCHA response for verification, call the \"submit\" function and pass in the necessary parameters. To check the reCAPTCHA response in a Django view, call the \"check_captcha\" function and pass in the request object. To generate new reCAPTCHA HTML based on the result of the verification, call the \"new_captcha_html\" function and pass in the result object.",
  "buggy_code": "import urllib2, urllib\nfrom proj.settings import *\nAPI_SSL_SERVER = 'https://www.google.com/recaptcha/api'\nAPI_SERVER = 'http://www.google.com/recaptcha/api'\nVERIFY_SERVER = 'www.google.com'\n\nclass RecaptchaResponse(object):\n\n    def __init__(self, is_valid, error_code=None):\n        self.is_valid = is_valid\n        self.error_code = error_code\n\ndef displayhtml(public_key, use_ssl=False, error=None):\n    \"\"\"Gets the HTML to display for reCAPTCHA\n\n    public_key -- The public api key\n    use_ssl -- Should the request be sent over ssl?\n    error -- An error message to display (from RecaptchaResponse.error_code)\"\"\"\n    error_param = ''\n    if error:\n        error_param = '&error=%s' % error\n    if use_ssl:\n        server = API_SSL_SERVER\n    else:\n        server = API_SERVER\n    return '<script type=\"text/javascript\" src=\"%(ApiServer)s/challenge?k=%(PublicKey)s%(ErrorParam)s\"></script>\\n\\n<noscript>\\n  <iframe src=\"%(ApiServer)s/noscript?k=%(PublicKey)s%(ErrorParam)s\" height=\"300\" width=\"500\" frameborder=\"0\"></iframe><br />\\n  <textarea name=\"recaptcha_challenge_field\" rows=\"3\" cols=\"40\"></textarea>\\n  <input type=\\'hidden\\' name=\\'recaptcha_response_field\\' value=\\'manual_challenge\\' />\\n</noscript>\\n' % {'ApiServer': server, 'PublicKey': public_key, 'ErrorParam': error_param}\n\ndef submit(recaptcha_challenge_field, recaptcha_response_field, private_key, remoteip):\n    \"\"\"\n    Submits a reCAPTCHA request for verification. Returns RecaptchaResponse\n    for the request\n\n    recaptcha_challenge_field -- The value of recaptcha_challenge_field from the form\n    recaptcha_response_field -- The value of recaptcha_response_field from the form\n    private_key -- your reCAPTCHA private key\n    remoteip -- the user's ip address\n    \"\"\"\n    if not (recaptcha_response_field or recaptcha_challenge_field or len(recaptcha_response_field) or len(recaptcha_challenge_field)):\n        return RecaptchaResponse(is_valid=False, error_code='incorrect-captcha-sol')\n\n    def encode_if_necessary(s):\n        if isinstance(s, unicode):\n            return s.encode('utf-8')\n        return s\n    params = urllib.urlencode({'privatekey': encode_if_necessary(private_key), 'remoteip': encode_if_necessary(remoteip), 'challenge': encode_if_necessary(recaptcha_challenge_field), 'response': encode_if_necessary(recaptcha_response_field)})\n    request = urllib2.Request(url='http://%s/recaptcha/api/verify' % VERIFY_SERVER, data=params, headers={'Content-type': 'application/x-www-form-urlencoded', 'User-agent': 'reCAPTCHA Python'})\n    httpresp = urllib2.urlopen(request)\n    return_values = httpresp.read().splitlines()\n    httpresp.close()\n    return_code = return_values[0]\n    if return_code == 'true':\n        return RecaptchaResponse(is_valid=True)\n    else:\n        return RecaptchaResponse(is_valid=False, error_code=return_values[1])\n\ndef check_captcha(request):\n    captcha_challenge = request.POST.get('recaptcha_challenge_field')\n    captcha_response = request.POST.get('recaptcha_response_field')\n    captcha_result = None\n    ip = None\n    if 'HTTP_X_FORWARDED_FOR' in request.META:\n        ip = request.META['HTTP_X_FORWARDED_FOR']\n    elif 'REMOTE_ADDR' in request.META:\n        ip = request.META['REMOTE_ADDR']\n    if captcha_response is not None and captcha_challenge is not None:\n        captcha_result = submit(captcha_challenge, captcha_response, recaptcha_private_key, ip)\n    return captcha_result\n\ndef new_captcha_html(captcha_result):\n    if captcha_result is None:\n        captcha_html = displayhtml(recaptcha_public_key, use_ssl=True)\n    else:\n        captcha_html = displayhtml(recaptcha_public_key, use_ssl=True, error=captcha_result.error_code)\n    return captcha_html",
  "line_no": 60,
  "line_no_percent": "81%"
}