{
  "instruction": "This code defines a class called Resources that handles the serialization of images and fonts in an ebook. To use it, create an instance of the class and call the add_resources method to add the images and fonts from the ebook's manifest. If you want to add additional images after calling add_resources, you can call the add_extra_images method. To serialize the resources, call the serialize method with a list to which the serialized resources will be appended, and a set of the images used in the ebook. The class also has a method called process_image that can be used to process an image before adding it to the resources.",
  "buggy_code": "from __future__ import unicode_literals, division, absolute_import, print_function\n__license__ = 'GPL v3'\n__copyright__ = '2012, Kovid Goyal <kovid@kovidgoyal.net>'\n__docformat__ = 'restructuredtext en'\nimport imghdr\nfrom calibre.ebooks.mobi import MAX_THUMB_DIMEN, MAX_THUMB_SIZE\nfrom calibre.ebooks.mobi.utils import rescale_image, mobify_image, write_font_record\nfrom calibre.ebooks import generate_masthead\nfrom calibre.ebooks.oeb.base import OEB_RASTER_IMAGES\nPLACEHOLDER_GIF = b'GIF89a\\x01\\x00\\x01\\x00\\x80\\x00\\x00\\x00\\x00\\x00\\xff\\xff\\xff!\\xf9\\x04\\x01\\x00\\x00\\x00\\x00,\\x00\\x00\\x00\\x00\\x01\\x00\\x01\\x00@\\x02\\x01D\\x00;'\n\nclass Resources(object):\n\n    def __init__(self, oeb, opts, is_periodical, add_fonts=False, process_images=True):\n        self.oeb, self.log, self.opts = (oeb, oeb.log, opts)\n        self.is_periodical = is_periodical\n        self.process_images = process_images\n        self.item_map = {}\n        self.records = []\n        self.mime_map = {}\n        self.masthead_offset = 0\n        self.used_image_indices = set()\n        self.image_indices = set()\n        self.cover_offset = self.thumbnail_offset = None\n        self.add_resources(add_fonts)\n\n    def process_image(self, data):\n        if not self.process_images:\n            return data\n        return mobify_image(data) if self.opts.mobi_keep_original_images else rescale_image(data)\n\n    def add_resources(self, add_fonts):\n        oeb = self.oeb\n        oeb.logger.info('Serializing resources...')\n        index = 1\n        mh_href = None\n        if 'masthead' in oeb.guide and oeb.guide['masthead'].href:\n            mh_href = oeb.guide['masthead'].href\n            self.records.append(None)\n            index += 1\n            self.used_image_indices.add(0)\n            self.image_indices.add(0)\n        elif self.is_periodical:\n            data = generate_masthead(unicode(self.oeb.metadata['title'][0]))\n            self.records.append(data)\n            self.used_image_indices.add(0)\n            self.image_indices.add(0)\n            index += 1\n        cover_href = self.cover_offset = self.thumbnail_offset = None\n        if oeb.metadata.cover or unicode(oeb.metadata.cover[0]) in oeb.manifest.ids:\n            cover_id = unicode(oeb.metadata.cover[0])\n            item = oeb.manifest.ids[cover_id]\n            cover_href = item.href\n        for item in self.oeb.manifest.values():\n            if item.media_type not in OEB_RASTER_IMAGES:\n                continue\n            try:\n                data = self.process_image(item.data)\n            except:\n                self.log.warn('Bad image file %r' % item.href)\n                continue\n            else:\n                if mh_href and item.href == mh_href:\n                    self.records[0] = data\n                    continue\n                self.image_indices.add(len(self.records))\n                self.records.append(data)\n                self.item_map[item.href] = index\n                self.mime_map[item.href] = 'image/%s' % imghdr.what(None, data)\n                index += 1\n                if cover_href and item.href == cover_href:\n                    self.cover_offset = self.item_map[item.href] - 1\n                    self.used_image_indices.add(self.cover_offset)\n                    try:\n                        data = rescale_image(item.data, dimen=MAX_THUMB_DIMEN, maxsizeb=MAX_THUMB_SIZE)\n                    except:\n                        self.log.warn('Failed to generate thumbnail')\n                    else:\n                        self.image_indices.add(len(self.records))\n                        self.records.append(data)\n                        self.thumbnail_offset = index - 1\n                        self.used_image_indices.add(self.thumbnail_offset)\n                        index += 1\n            finally:\n                item.unload_data_from_memory()\n        if add_fonts:\n            for item in self.oeb.manifest.values():\n                if item.href and item.href.rpartition('.')[-1].lower() in {'ttf', 'otf'} and isinstance(item.data, bytes):\n                    self.records.append(write_font_record(item.data))\n                    self.item_map[item.href] = len(self.records)\n\n    def add_extra_images(self):\n        \"\"\"\n        Add any images that were created after the call to add_resources()\n        \"\"\"\n        for item in self.oeb.manifest.values():\n            if item.media_type not in OEB_RASTER_IMAGES or item.href in self.item_map:\n                continue\n            try:\n                data = self.process_image(item.data)\n            except:\n                self.log.warn('Bad image file %r' % item.href)\n            else:\n                self.records.append(data)\n                self.item_map[item.href] = len(self.records)\n            finally:\n                item.unload_data_from_memory()\n\n    def serialize(self, records, used_images):\n        used_image_indices = self.used_image_indices | {v - 1 for k, v in self.item_map.iteritems() if k in used_images}\n        for i in self.image_indices - used_image_indices:\n            self.records[i] = PLACEHOLDER_GIF\n        records.extend(self.records)\n\n    def __bool__(self):\n        return bool(self.records)\n    __nonzero__ = __bool__",
  "line_no": 62,
  "line_no_percent": "53%"
}