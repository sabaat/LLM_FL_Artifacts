{
  "instruction": "Create a genealogy program called Gramps using GTK+/GNOME. The program is licensed under the GNU General Public License. The program allows users to create family trees and view them on a map. The map displays all events with a latitude and longitude associated with them. The program also allows users to edit families, persons, and events. The program has a menu bar, toolbar, and specific entry in the navigation menu. The program has a sidebar and bottom bar that display the \"Family Filter\" gramplet.",
  "buggy_code": "\"\"\"\nGeography for one family\n\"\"\"\nimport operator\nfrom gi.repository import Gdk\nKEY_TAB = Gdk.KEY_Tab\nfrom gi.repository import Gtk\n\nimport logging\n_LOG = logging.getLogger(\"GeoGraphy.geofamily\")\n\nfrom gramps.gen.const import GRAMPS_LOCALE as glocale\n_ = glocale.translation.gettext\nfrom gramps.gen.lib import EventRoleType, EventType\nfrom gramps.gen.config import config\nfrom gramps.gen.datehandler import displayer\nfrom gramps.gen.display.name import displayer as _nd\nfrom gramps.gen.display.place import displayer as _pd\nfrom gramps.gen.utils.place import conv_lat_lon\nfrom gramps.gui.views.bookmarks import FamilyBookmarks\nfrom gramps.plugins.lib.maps.geography import GeoGraphyView\n\n\n_UI_DEF = '''\\\n<ui>\n<menubar name=\"MenuBar\">\n<menu action=\"GoMenu\">\n  <placeholder name=\"CommonGo\">\n    <menuitem action=\"Back\"/>\n    <menuitem action=\"Forward\"/>\n    <separator/>\n  </placeholder>\n</menu>\n<menu action=\"EditMenu\">\n  <placeholder name=\"CommonEdit\">\n    <menuitem action=\"PrintView\"/>\n  </placeholder>\n</menu>\n<menu action=\"BookMenu\">\n  <placeholder name=\"AddEditBook\">\n    <menuitem action=\"AddBook\"/>\n    <menuitem action=\"EditBook\"/>\n  </placeholder>\n</menu>\n</menubar>\n<toolbar name=\"ToolBar\">\n<placeholder name=\"CommonNavigation\">\n  <toolitem action=\"Back\"/>\n  <toolitem action=\"Forward\"/>\n</placeholder>\n<placeholder name=\"CommonEdit\">\n  <toolitem action=\"PrintView\"/>\n</placeholder>\n</toolbar>\n</ui>\n'''\n\n\nclass GeoFamily(GeoGraphyView):\n    \"\"\"\n    The view used to render family map.\n    \"\"\"\n\n    def __init__(self, pdata, dbstate, uistate, nav_group=0):\n        GeoGraphyView.__init__(self, _('Family places map'),\n                                      pdata, dbstate, uistate,\n                                      FamilyBookmarks,\n                                      nav_group)\n        self.dbstate = dbstate\n        self.uistate = uistate\n        self.place_list = []\n        self.place_without_coordinates = []\n        self.minlat = self.maxlat = self.minlon = self.maxlon = 0.0\n        self.minyear = 9999\n        self.maxyear = 0\n        self.nbplaces = 0\n        self.nbmarkers = 0\n        self.sort = []\n        self.additional_uis.append(self.additional_ui())\n        self.no_show_places_in_status_bar = False\n        self.cal = None\n\n    def get_title(self):\n        \"\"\"\n        Used to set the titlebar in the configuration window.\n        \"\"\"\n        return _('GeoFamily')\n\n    def get_stock(self):\n        \"\"\"\n        Returns the name of the stock icon to use for the display.\n        This assumes that this icon has already been registered\n        as a stock icon.\n        \"\"\"\n        return 'geo-show-family'\n\n    def get_viewtype_stock(self):\n        \"\"\"Type of view in category\n        \"\"\"\n        return 'geo-show-family'\n\n    def additional_ui(self):\n        return\n        \"\"\"\n        Specifies the UIManager XML code that defines the menus and buttons\n        associated with the interface.\n        \"\"\"\n        return _UI_DEF\n\n    def navigation_type(self):\n        \"\"\"\n        Indicates the navigation type. Navigation type can be the string\n        name of any of the primary objects.\n        \"\"\"\n        return 'Family'\n\n    def goto_handle(self, handle=None):\n        \"\"\"\n        Rebuild the tree with the given person handle as the root.\n        \"\"\"\n        self.build_tree()\n\n    def build_tree(self):\n        \"\"\"\n        This is called by the parent class when the view becomes visible. Since\n        all handling of visibility is now in rebuild_trees, see that for more\n        information.\n        \"\"\"\n        if not self.dbstate.is_open():\n            return\n        if self.uistate.get_active('Family'):\n            self._createmap(self.uistate.get_active('Family'))\n        else:\n            self._createmap(self.uistate.get_active('Person'))\n\n    def _createpersonmarkers(self, dbstate, person, comment, fam_id):\n        \"\"\"\n        Create all markers for the specified person.\n        \"\"\"\n        self.cal = config.get('preferences.calendar-format-report')\n        latitude = longitude = \"\"\n        if person:\n            for event_ref in person.get_event_ref_list():\n                if not event_ref:\n                    continue\n                role = event_ref.get_role()\n                event = dbstate.db.get_event_from_handle(event_ref.ref)\n                eyear = event.get_date_object().to_calendar(self.cal).get_year()\n                place_handle = event.get_place_handle()\n                if place_handle:\n                    place = dbstate.db.get_place_from_handle(place_handle)\n                    if place:\n                        longitude = place.get_longitude()\n                        latitude = place.get_latitude()\n                        latitude, longitude = conv_lat_lon(latitude,\n                                                           longitude, \"D.D8\")\n                        descr = _pd.display(dbstate.db, place)\n                        evt = EventType(event.get_type())\n                        descr1 = _(\"%(eventtype)s : %(name)s\") % {\n                                        'eventtype': evt,\n                                        'name': _nd.display(person)}\n                        if longitude and latitude:\n                            if not self._present_in_places_list(2,\n                                                str(descr1 + descr + str(evt))):\n                                self._append_to_places_list(descr,\n                                    str(descr1 + descr + str(evt)),\n                                    _nd.display(person),\n                                    latitude, longitude,\n                                    role, eyear,\n                                    event.get_type(),\n                                    person.gramps_id,\n                                    place.gramps_id,\n                                    event.gramps_id,\n                                    fam_id\n                                    )\n                        else:\n                            self._append_to_places_without_coord(\n                                                        place.gramps_id, descr)\n            family_list = person.get_family_handle_list()\n            for family_hdl in family_list:\n                family = self.dbstate.db.get_family_from_handle(family_hdl)\n                if family is not None:\n                    for event_ref in family.get_event_ref_list():\n                        if event_ref:\n                            event = dbstate.db.get_event_from_handle(\n                                                                  event_ref.ref)\n                            role = event_ref.get_role()\n                            if event.get_place_handle():\n                                place_handle = event.get_place_handle()\n                                if place_handle:\n                                    place = dbstate.db.get_place_from_handle(\n                                                                   place_handle)\n                                    if place:\n                                        longitude = place.get_longitude()\n                                        latitude = place.get_latitude()\n                                        (latitude,\n                                         longitude) = conv_lat_lon(latitude,\n                                                                   longitude,\n                                                                   \"D.D8\")\n                                        descr = _pd.display(dbstate.db, place)\n                                        evt = EventType(event.get_type())\n                                        (father_name,\n                          mother_name) = self._get_father_and_mother_name(event)\n                                        descr1 = \"%s : %s - \" % (evt,\n                                                                 father_name)\n                                        descr1 = \"%s%s\" % (descr1, mother_name)\n                                        eyear = event.get_date_object().to_calendar(self.cal).get_year()\n                                        if longitude and latitude:\n                                            if not self._present_in_places_list(\n                                             2, str(descr1 + descr + str(evt))):\n                                                self._append_to_places_list(\n                                                 descr,\n                                                 str(descr1 + descr + str(evt)),\n                                                 _nd.display(person),\n                                                 latitude, longitude,\n                                                 role, eyear,\n                                                 event.get_type(),\n                                                 person.gramps_id,\n                                                 place.gramps_id,\n                                                 event.gramps_id,\n                                                 family.gramps_id\n                                                 )\n                                        else:\n                                            self._append_to_places_without_coord(place.gramps_id, descr)\n\n    def family_label(self, family):\n        \"\"\"\n        Create the family label depending on existence of the father and mother\n        \"\"\"\n        if family is None:\n            return \"Unknown\"\n        father = mother = None\n        hdl = family.get_father_handle()\n        if hdl:\n            father = self.dbstate.db.get_person_from_handle(hdl)\n        hdl = family.get_mother_handle()\n        if hdl:\n            mother = self.dbstate.db.get_person_from_handle(hdl)\n        if father and mother:\n            label = _(\"%(gramps_id)s : %(father)s and %(mother)s\") % {\n                'father' : _nd.display(father),\n                'mother' : _nd.display(mother),\n                'gramps_id' : family.gramps_id,\n                }\n        elif father:\n            label = \"%(gramps_id)s : %(father)s\" % {\n                'father' : _nd.display(father),\n                'gramps_id' : family.gramps_id,\n                }\n        elif mother:\n            label = \"%(gramps_id)s : %(mother)s\" % {\n                'mother' : _nd.display(mother),\n                'gramps_id' : family.gramps_id,\n                }\n        else:\n            label = \"%(gramps_id)s :\" % {\n                'gramps_id' : family.gramps_id,\n                }\n        return label\n\n    def _createmap_for_one_family(self, family):\n        \"\"\"\n        Create all markers for one family : all event's places with a lat/lon.\n        \"\"\"\n        dbstate = self.dbstate\n        self.message_layer.add_message(\n                          _(\"Family places for %s\") % self.family_label(family))\n        person = None\n        if family:\n            person = dbstate.db.get_person_from_handle(\n                                                     family.get_father_handle())\n        else:\n            return\n        family_id = family.gramps_id\n        if person is None: # family without father ?\n            handle = family.get_mother_handle()\n            if handle:\n                person = dbstate.db.get_person_from_handle(handle)\n        if person is None:\n            handle = self.uistate.get_active('Person')\n            if handle:\n                person = dbstate.db.get_person_from_handle(handle)\n        if person is not None:\n            family_list = person.get_family_handle_list()\n            if len(family_list) > 0:\n                fhandle = family_list[0] # first is primary\n                fam = dbstate.db.get_family_from_handle(fhandle)\n                father = mother = None\n                handle = fam.get_father_handle()\n                if handle:\n                    father = dbstate.db.get_person_from_handle(handle)\n                if father:\n                    comment = _(\"Father : %(id)s : %(name)s\") % {\n                                                   'id': father.gramps_id,\n                                                   'name': _nd.display(father)}\n                    self._createpersonmarkers(dbstate, father,\n                                              comment, family_id)\n                handle = fam.get_mother_handle()\n                if handle:\n                    mother = dbstate.db.get_person_from_handle(handle)\n                if mother:\n                    comment = _(\"Mother : %(id)s : %(name)s\") % {\n                                                   'id': mother.gramps_id,\n                                                   'name': _nd.display(mother)}\n                    self._createpersonmarkers(dbstate, mother,\n                                              comment, family_id)\n                index = 0\n                child_ref_list = fam.get_child_ref_list()\n                if child_ref_list:\n                    for child_ref in child_ref_list:\n                        child = dbstate.db.get_person_from_handle(child_ref.ref)\n                        if child:\n                            index += 1\n                            comment = _(\"Child : %(id)s - %(index)d \"\n                                        \": %(name)s\") % {\n                                            'id'    : child.gramps_id,\n                                            'index' : index,\n                                            'name'  : _nd.display(child)\n                                         }\n                            self._createpersonmarkers(dbstate, child,\n                                                      comment, family_id)\n            else:\n                comment = _(\"Person : %(id)s %(name)s has no family.\") % {\n                                'id' : person.gramps_id,\n                                'name' : _nd.display(person)\n                                }\n                self._createpersonmarkers(dbstate, person, comment, family_id)\n\n    def _createmap(self, handle):\n        \"\"\"\n        Create all markers for each people's event in the database which has\n        a lat/lon.\n        \"\"\"\n        if not handle:\n            return\n        self.place_list = []\n        self.place_without_coordinates = []\n        self.places_found = []\n        self.nbplaces = 0\n        self.nbmarkers = 0\n        self.minlat = self.maxlat = self.minlon = self.maxlon = 0.0\n        self.minyear = 9999\n        self.maxyear = 0\n        self.message_layer.clear_messages()\n        if self.dbstate.db.has_family_handle(handle):\n            family = self.dbstate.db.get_family_from_handle(handle)\n            self._createmap_for_one_family(family)\n        else:\n            person = self.dbstate.db.get_person_from_handle(handle)\n            if not person:\n                return\n            family_list = person.get_family_handle_list()\n            for family_hdl in family_list:\n                family = self.dbstate.db.get_family_from_handle(family_hdl)\n                if family is not None:\n                    self._createmap_for_one_family(family)\n        self.sort = sorted(self.place_list,\n                           key=operator.itemgetter(3, 4, 6)\n                          )\n        self._create_markers()\n\n    def add_event_bubble_message(self, event, lat, lon, mark, menu):\n        \"\"\"\n        Add an item to the popup menu.\n        \"\"\"\n        self.itemoption = Gtk.Menu()\n        itemoption = self.itemoption\n        itemoption.show()\n        menu.set_submenu(itemoption)\n        modify = Gtk.MenuItem(label=_(\"Edit Family\"))\n        modify.show()\n        modify.connect(\"activate\", self.edit_family, event, lat, lon, mark)\n        itemoption.append(modify)\n        modify = Gtk.MenuItem(label=_(\"Edit Person\"))\n        modify.show()\n        modify.connect(\"activate\", self.edit_person, event, lat, lon, mark)\n        itemoption.append(modify)\n        modify = Gtk.MenuItem(label=_(\"Edit Event\"))\n        modify.show()\n        modify.connect(\"activate\", self.edit_event, event, lat, lon, mark)\n        itemoption.append(modify)\n        center = Gtk.MenuItem(label=_(\"Center on this place\"))\n        center.show()\n        center.connect(\"activate\", self.center_here, event, lat, lon, mark)\n        itemoption.append(center)\n\n    def bubble_message(self, event, lat, lon, marks):\n        \"\"\"\n        Add the popup menu.\n        \"\"\"\n        self.menu = Gtk.Menu()\n        menu = self.menu\n        menu.set_title(\"family\")\n        message = \"\"\n        oldplace = \"\"\n        prevmark = None\n        for mark in marks:\n            if message != \"\":\n                add_item = Gtk.MenuItem(label=message)\n                add_item.show()\n                menu.append(add_item)\n                self.add_event_bubble_message(event, lat, lon,\n                                              prevmark, add_item)\n            if mark[0] != oldplace:\n                message = \"%s :\" % mark[0]\n                self.add_place_bubble_message(event, lat, lon,\n                                              marks, menu, message, mark)\n                oldplace = mark[0]\n            evt = self.dbstate.db.get_event_from_gramps_id(mark[10])\n            date = displayer.display(evt.get_date_object())\n            if date == \"\":\n                date = _(\"Unknown\")\n            if mark[5] == EventRoleType.PRIMARY:\n                message = \"(%s) %s : %s\" % (date, mark[7], mark[1])\n            elif mark[5] == EventRoleType.FAMILY:\n                evt = self.dbstate.db.get_event_from_gramps_id(mark[10])\n                (father_name,\n                 mother_name) = self._get_father_and_mother_name(evt)\n                message = \"(%s) %s : %s - %s\" % (date, mark[7],\n                                                 father_name, mother_name)\n            else:\n                evt = self.dbstate.db.get_event_from_gramps_id(mark[10])\n                descr = evt.get_description()\n                if descr == \"\":\n                    descr = _('No description')\n                message = \"(%s) %s => %s\" % (date, mark[5], descr)\n            prevmark = mark\n        add_item = Gtk.MenuItem(label=message)\n        add_item.show()\n        menu.append(add_item)\n        self.add_event_bubble_message(event, lat, lon, prevmark, add_item)\n        menu.popup(None, None, None,\n                   None, event.button, event.time)\n        return 1\n\n    def add_specific_menu(self, menu, event, lat, lon):\n        \"\"\"\n        Add specific entry to the navigation menu.\n        \"\"\"\n        return\n\n    def get_default_gramplets(self):\n        \"\"\"\n        Define the default gramplets for the sidebar and bottombar.\n        \"\"\"\n        return ((\"Family Filter\",),\n                ())\n",
  "line_no": 103,
  "line_no_percent": "23%"
}