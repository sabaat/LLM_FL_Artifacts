{
  "instruction": "This code collects information about CVMFS probes and writes the results to SSB columns. To use, run the `c4s()` function.",
  "buggy_code": "import urllib, json, datetime\nfrom xml.parsers import expat\n\nclass c4s :\n\n  def __init__(self):\n    self.cvmfsBaseVersionFile = 'cvmfsVersion.txt'\n    self.requestedVersion = ''\n    self.myVO = 'LHCb'\n    self.cvmfsColumnNo = 202\n    self.wlcgTopoColumnNo = 144\n    self.topoDict = {'WLCG':{}, self.myVO:{}}\n    self.ssbTimePat = '%Y-%m-%dT%H:%M:%S'\n    self.dontpanic = 'http://www.adluge.com/wp-content/uploads/2013/09/homer-simpson-doh.gif'\n    self.topologyURL = 'http://lhcb-web-dirac.cern.ch/topology/lhcb_topology.xml'\n    self.wlcgBaseUrl = 'http://wlcg-mon.cern.ch/dashboard/request.py/'\n    self.wlcgGetUrl = self.wlcgBaseUrl+'getplotdata?columnid=%d&time=24&sites=all&batch=1'\n    self.wlcgSiteBaseLink = 'http://lhcb-web-dirac.cern.ch/DIRAC/LHCb-Production/undefined/grid/SiteStatus/display?name='\n    self.ssbMetrics = ['CvmfsVersion','CvmfsRepoRevision','CvmfsMountPoint','CvmfsCondDBMountPoint', 'CvmfsProbeTime', 'CvmfsStratumOnes', 'CvmfsNumSquids', 'CvmfsProbeNoInfo', 'CvmfsProbeLink']\n    self.ssbData = {}\n    for k in self.ssbMetrics : self.ssbData[k] = {}\n\n\n\n  def evalCvmfsProbeLink(self, val, site):\n    return (val, 'green')\n\n  def evalCvmfsProbeNoInfo(self, val, site) :\n    if self.ssbData['CvmfsProbeTime'][site] == 'no probe' : return ('n/a (no probe)', 'grey')\n    if self.ssbData['CvmfsVersion'][site] == 'not installed' : return ('n/a (not installed)', 'grey')\n    we = val.split(':')[0]\n    if we == 'WARNING' : return (val, 'orange')\n    if we == 'ERROR' : return (val, 'red')\n    return (val, 'green')\n\n  def evalCvmfsVersion(self, val, site): \n    if self.ssbData['CvmfsProbeTime'][site] == 'no probe' : return ('n/a (no probe)', 'grey')\n    if val == 'nfs' : return (val, 'green')\n    if val in ('n/a', 'not installed') : return (val, 'red')\n    x = 2\n    maxDiff = range(x+1)\n    deplV = map(lambda x: int(x), val.split('.'))\n    reqV = map(lambda x: int(x), self.requestedVersion.split('.'))\n    if deplV[1] == reqV[1] and deplV[0] == reqV[0] : \n      if (reqV[2] - deplV[2]) in maxDiff : return (val, 'green')\n      else : return (val, 'orange')\n    else : return (val, 'red')\n\n  def evalCvmfsRepoRevision(self, val, site):\n    if self.ssbData['CvmfsProbeTime'][site] == 'no probe' : return ('n/a (no probe)', 'grey')\n    vers = self.ssbData['CvmfsVersion'][site]\n    if  vers in ('nfs', 'not installed') : return ('n/a (%s)'%vers, 'grey')\n    return (val, 'green')\n\n  def evalCvmfsMountPoint(self, val, site):\n    if self.ssbData['CvmfsProbeTime'][site] == 'no probe' : return ('n/a (no probe)', 'grey')\n    vers = self.ssbData['CvmfsVersion'][site]\n    if  vers in ('not installed') : return ('n/a (%s)'%vers, 'grey')\n    if val and val == '/cvmfs/lhcb.cern.ch' : return (val, 'green')\n    else : return (val, 'orange')\n\n  def evalCvmfsCondDBMountPoint(self, val, site):\n    if self.ssbData['CvmfsProbeTime'][site] == 'no probe' : return ('n/a (no probe)', 'grey')\n    if  self.ssbData['CvmfsVersion'][site] == 'not installed' : return ('n/a (not installed)', 'grey')\n    if val == 'yes' : return (val, 'orange')\n    else : return (val, 'green')\n\n  def evalCvmfsProbeTime(self, val, site):\n    if val == 'no probe' : return (val, 'red')\n    pTime = datetime.datetime.strptime(val,self.ssbTimePat)\n    curTime = datetime.datetime.now()\n    delta = (curTime - pTime).seconds\n    if delta < 21600 : return (val, 'green')\n    elif delta < 43200 : return (val, 'orange')\n    else : return (val, 'red')\n\n  def evalCvmfsStratumOnes(self, val, site) :\n    if self.ssbData['CvmfsProbeTime'][site] == 'no probe' : return ('n/a (no probe)', 'grey')\n    vers = self.ssbData['CvmfsVersion'][site]\n    if  vers in ('nfs', 'not installed') : return ('n/a (%s)'%vers, 'grey')\n    if val : return (val, 'green')\n    else: return ('none', 'red')\n\n  def evalCvmfsNumSquids(self, val, site):\n    if self.ssbData['CvmfsProbeTime'][site] == 'no probe' : return ('n/a (no probe)', 'grey')\n    vers = self.ssbData['CvmfsVersion'][site]\n    if  vers in ('nfs', 'not installed') : return ('n/a (%s)'%vers, 'grey')\n    if val :\n      if int(val) > 1 : return (val, 'green')\n      else : return (val, 'orange')\n    else: return (val , 'red')\n\n\n  def getValCvmfsProbeLink(self, site, probe, metric):\n    self.ssbData['CvmfsProbeLink'][site]=metric['URL']\n\n  def getValCvmfsProbeNoInfo(self, site, probe, metric): \n    val = 'none'\n    pat = 'INFO: Mandatory tests exectuted successfully, now continuing with testing optional repositories'\n    for line in probe :\n      we = line.split(':')[0]\n      if line[:len(pat)] == pat : break\n      elif we == 'WARNING' and val.split(':')[0] != 'ERROR' : val = line\n      elif we == 'ERROR' : val = line\n    self.ssbData['CvmfsProbeNoInfo'][site] = val\n\n  def getValCvmfsVersion(self, site, probe, metric):\n    return\n    pat1 = 'INFO: CVMFS version installed '\n    pat2 = 'INFO: Mandatory mount point /cvmfs/lhcb.cern.ch is nfs mount point'\n    pat3 = 'INFO: No cvmfs rpms found on WN, checking if this WN uses nfs mounting of CVMFS repositories'\n    ver = 'n/a'\n    noCVMFS = False\n    cvmfsViaNFS = False\n    for line in probe :\n      if line[:len(pat1)] == pat1 :\n        ver = line[len(pat1):]\n      elif line[:len(pat2)] == pat2 :\n        ver = 'nfs'\n        cvmfsViaNFS = True\n      elif line[:len(pat3)] == pat3 : \n        noCVMFS = True\n    if noCVMFS and not cvmfsViaNFS : ver = 'not installed'\n    self.ssbData['CvmfsVersion'][site] = ver\n    \n  def getValCvmfsRepoRevision(self, site, probe, metric):\n    pat = 'INFO: repository revision '\n    rev = 'n/a'\n    for line in probe :\n      if line[:len(pat)] == pat :\n        rev = line[len(pat):]\n        break \n    self.ssbData['CvmfsRepoRevision'][site] = rev\n\n  def getValCvmfsMountPoint(self, site, probe, metric):\n    pat1 = 'INFO: Variable VO_LHCB_SW_DIR points to CVMFS mount point '\n    pat2 = 'INFO: Mandatory mount point /cvmfs/lhcb.cern.ch is nfs mount point'\n    mp = 'n/a'\n    for line in probe :\n      if line[:len(pat1)] == pat1 :\n        mp = line[len(pat1):]\n      elif line[:len(pat2)] == pat2 :\n        mp = '/cvmfs/lhcb.cern.ch'\n    self.ssbData['CvmfsMountPoint'][site] = mp\n\n  def getValCvmfsCondDBMountPoint(self, site, probe, metric):\n    pat = 'INFO: repository /cvmfs/lhcb-conddb.cern.ch available'\n    cm = 'no'\n    for line in probe :\n      if line[:len(pat)] == pat :\n        cm = 'yes'\n    self.ssbData['CvmfsCondDBMountPoint'][site] = cm\n\n  def getValCvmfsProbeTime(self, site, probe, metric):\n    self.ssbData['CvmfsProbeTime'][site] = metric['URL'].split('&')[1].split('=')[1][:-1]\n\n  def getValCvmfsStratumOnes(self, site, probe, metric) :\n    strats = []\n    pat = 'INFO: Servers: '\n    for line in probe :\n      if line[:len(pat)] == pat :\n        stratumL = line[len(pat):]\n        for serv in stratumL.split() :\n          strats.append('.'.join(serv.split('/')[2].split(':')[0].split('.')[-2:]))\n        break\n    self.ssbData['CvmfsStratumOnes'][site] = ' '.join(strats)\n\n  def getValCvmfsNumSquids(self, site, probe, metric) :\n    numSq = 0\n    pat = 'INFO: Proxies: '\n    for line in probe :\n      if line[:len(pat)] == pat :\n        numSq = len(line[len(pat):].split())\n        break\n    self.ssbData['CvmfsNumSquids'][site] = numSq\n\n\n  def xmlStartElement(self, name, attrs):\n    if name == 'atp_site' : self.currWLCGSite = attrs['name']\n    if name == 'group' and attrs['type'] == 'LHCb_Site' : \n      self.topoDict['WLCG'][attrs['name']] = self.currWLCGSite\n\n  def bootstrap(self):\n    topo = json.loads(urllib.urlopen(self.wlcgGetUrl%self.wlcgTopoColumnNo).read())\n    for ent in topo['csvdata'] : self.topoDict[self.myVO][ent['SiteId']] = ent['Status']\n    f = open(self.cvmfsBaseVersionFile, 'r')\n    self.requestedVersion = f.read()\n    f.close()\n    topo = urllib.urlopen(self.topologyURL).read()\n    p = expat.ParserCreate()\n    p.StartElementHandler = self.xmlStartElement\n    p.Parse(topo)\n\n  def clearSsbData(self, site):\n    for metric in self.ssbMetrics : \n      self.ssbData[metric][site] = ''\n\n  def collectInfo(self):\n    info = json.loads(urllib.urlopen(self.wlcgGetUrl%self.cvmfsColumnNo).read())\n    for metricInf in info['csvdata'] :\n      site = self.topoDict[self.myVO][metricInf['SiteId']]\n      tTime = datetime.datetime.strptime(metricInf['Time'], self.ssbTimePat)\n      dTime = self.ssbData['CvmfsProbeTime'].get(site)\n      if ( not dTime ) or ( datetime.datetime.strptime(dTime, self.ssbTimePat) < tTime ) :  \n        if dTime : self.clearSsbData(site)\n        tl = urllib.urlopen(self.wlcgBaseUrl+metricInf['URL']).read().split('\\n')\n        for metr in self.ssbMetrics : eval('self.getVal'+metr)(site, tl, metricInf)\n    for site in self.topoDict['WLCG'].keys() : \n      if not self.ssbData['CvmfsProbeTime'].get(site) : \n        for metric in self.ssbMetrics : self.ssbData[metric][site] = ''\n        self.ssbData['CvmfsProbeTime'][site] = 'no probe'\n              \n  def writeSSBColumns(self):\n    for k in self.ssbMetrics :\n      fun = 'self.eval'+k\n      colData = self.ssbData[k]\n      f = open(k+'.ssb.txt', 'w')\n      for site in colData.keys() :\n        now = str(datetime.datetime.now())\n        (val, color) = eval(fun)(colData[site], site)\n        url = self.dontpanic\n        if self.ssbData['CvmfsProbeLink'].get(site): url = self.wlcgBaseUrl+self.ssbData['CvmfsProbeLink'][site]\n        f.write('%s\\t%s\\t%s\\t%s\\t%s\\n' % (now, site, val, color, url))\n      f.close()\n\n  def createWLCGLHCbMapping(self):\n    f = open('WLCGSiteMapping.ssb.txt','w')\n    for site in self.topoDict['WLCG'].keys() :\n      now = str(datetime.datetime.now())\n      val = self.topoDict['WLCG'][site]\n      color = 'white'\n      url = self.wlcgSiteBaseLink+site\n      f.write('%s\\t%s\\t%s\\t%s\\t%s\\n' % (now, site, val, color, url))\n\n  def run(self):\n    self.bootstrap()\n    self.collectInfo()\n    self.writeSSBColumns()\n    self.createWLCGLHCbMapping()\n\nif __name__ == '__main__' :\n  c4s().run()\n",
  "line_no": 108,
  "line_no_percent": "45%"
}