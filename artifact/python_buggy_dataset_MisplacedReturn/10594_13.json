{
  "instruction": "The code provided is a Python script that can be used to interact with the APN-OS Policy Optimizer integration. To use the script, you need to create an instance of the `Client` class and pass in the required parameters. Once you have an instance of the `Client` class, you can call the various methods to interact with the APN-OS Policy Optimizer integration. \n\nTo use the script, you need to perform the following steps:\n\n1. Import the `hash",
  "buggy_code": "import hashlib\n\nfrom CommonServerPython import *\n\n\nclass Client:\n    \"\"\"\n    Client to use in the APN-OS Policy Optimizer integration.\n    \"\"\"\n\n    def __init__(self, url: str, username: str, password: str, vsys: str, device_group: str, verify: bool, tid: int):\n        self.session_metadata: Dict[str, Any] = {'panorama': url, 'base_url': url, 'username': username,\n                                                 'password': password, 'tid': tid}\n        if device_group and vsys:\n            raise DemistoException(\n                'Cannot configure both vsys and Device group. Set vsys for firewall, set Device group for Panorama.')\n        if not device_group and not vsys:\n            raise DemistoException('Set vsys for firewall or Device group for Panorama.')\n\n        self.machine = vsys if vsys else device_group\n        self.verify = verify\n        handle_proxy()\n        self.session = requests.Session()\n\n    def session_post(self, url: str, json_cmd: dict) -> dict:\n        response = self.session.post(url=url, json=json_cmd, verify=self.verify)\n        json_response = json.loads(response.text)\n        if 'type' in json_response and json_response['type'] == 'exception':\n            if 'message' in json_response:\n                raise Exception(f'Operation to PAN-OS failed. with: {str(json_response[\"message\"])}')\n            raise Exception(f'Operation to PAN-OS failed. with: {str(json_response)}')\n        return json_response\n\n    def login(self) -> str:\n        login_data = {\n            'prot': 'https:',\n            'server': self.session_metadata['panorama'],\n            'authType': 'init',\n            'challengeCookie': '',\n            'user': self.session_metadata['username'],\n            'passwd': self.session_metadata['password'],\n            'challengePwd': '',\n            'ok': 'Log In'\n        }\n        try:\n            self.session.post(url=f'{self.session_metadata[\"base_url\"]}/php/login.php?', data=login_data,\n                              verify=self.verify)\n            response = self.session.post(url=f'{self.session_metadata[\"base_url\"]}/', verify=self.verify)\n        except Exception as err:\n            raise Exception(f'Failed to login. Please double-check the credentials and the server URL. {str(err)}')\n        match = re.search(r'(?:window\\.Pan\\.st\\.st\\.st[0-9]+\\s=\\s\\\")(\\w+)(?:\\\")', response.text)\n        if not match:\n            raise Exception('Failed to login. Please double-check the credentials and the server URL.')\n        return match.group(1)\n\n    def logout(self):\n        self.session.post(url=f'{self.session_metadata[\"base_url\"]}/php/logout.php?', verify=False)\n\n    def token_generator(self) -> str:\n        \"\"\"\n        The PHP Security Token (Data String) is generated with the TID (counter) and a special session \"cookie\"\n        :return: hash token\n        \"\"\"\n        data_code = f'{self.session_metadata[\"cookie\"]}{str(self.session_metadata[\"tid\"])}'\n        data_hash = hashlib.md5(data_code.encode())  # Use the hashlib library function to calculate the MD5\n        data_string = data_hash.hexdigest()  # Convert the hash to a proper hex string\n        return data_string\n\n    def get_policy_optimizer_statistics(self) -> dict:\n        self.session_metadata['tid'] += 1  # Increment TID\n        json_cmd = {\n            \"action\": \"PanDirect\", \"method\": \"run\", \"data\": [\n                self.token_generator(),\n                \"PoliciesDirect.getRuleCountInRuleUsage\",\n                [{\"type\": \"security\", \"position\": \"main\", \"vsysName\": self.machine}]\n            ],\n            \"type\": \"rpc\", \"tid\": self.session_metadata['tid']\n        }\n\n        return self.session_post(\n            url=f'{self.session_metadata[\"base_url\"]}/php/utils/router.php/PoliciesDirect.getRuleCountInRuleUsage',\n            json_cmd=json_cmd)\n\n    def policy_optimizer_no_apps(self) -> dict:\n        self.session_metadata['tid'] += 1  # Increment TID\n        json_cmd = {\n            \"action\": \"PanDirect\", \"method\": \"run\",\n            \"data\": [\n                self.token_generator(),\n                \"PoliciesDirect.getPoliciesByUsage\", [\n                    {\n                        \"type\": \"security\",\n                        \"position\": \"main\",\n                        \"vsysName\": self.machine,\n                        \"isCmsSelected\": False,\n                        \"isMultiVsys\": False,\n                        \"showGrouped\": False,\n                        \"usageAttributes\": {\n                            \"timeframeTag\": \"30\",\n                            \"application/member\": \"any\",\n                            \"apps-seen-count\": \"geq \\'1\\'\",\n                            \"action\": \"allow\"\n                        },\n                        \"pageContext\": \"app_usage\",\n                        \"field\": \"$.bytes\",\n                        \"direction\": \"DESC\"\n                    }\n                ]\n            ],\n            \"type\": \"rpc\",\n            \"tid\": self.session_metadata['tid']}\n\n        return self.session_post(\n            url=f'{self.session_metadata[\"base_url\"]}/php/utils/router.php/PoliciesDirect.getPoliciesByUsage',\n            json_cmd=json_cmd)\n\n    def policy_optimizer_get_unused_apps(self) -> dict:\n        self.session_metadata['tid'] += 1  # Increment TID\n        json_cmd = {\n            \"action\": \"PanDirect\", \"method\": \"run\",\n            \"data\": [\n                self.token_generator(),\n                \"PoliciesDirect.getPoliciesByUsage\",\n                [\n                    {\n                        \"type\": \"security\",\n                        \"position\": \"main\",\n                        \"vsysName\": self.machine,\n                        \"serialNumber\": \"\",\n                        \"isCmsSelected\": False,\n                        \"isMultiVsys\": False,\n                        \"showGrouped\": False,\n                        \"usageAttributes\": {\n                            \"timeframeTag\": \"30\",\n                            \"application/member\": \"unused\",\n                            \"action\": \"allow\"\n                        },\n                        \"pageContext\": \"app_usage\",\n                        \"field\": \"$.bytes\",\n                        \"direction\": \"DESC\"\n                    }\n                ]\n            ],\n            \"type\": \"rpc\",\n            \"tid\": self.session_metadata['tid']}\n\n        return self.session_post(\n            url=f'{self.session_metadata[\"base_url\"]}/php/utils/router.php/PoliciesDirect.getPoliciesByUsage',\n            json_cmd=json_cmd)\n\n    def policy_optimizer_get_rules(self, timeframe: str, usage: str, exclude: bool) -> dict:\n        self.session_metadata['tid'] += 1  # Increment TID\n        json_cmd = {\n            \"action\": \"PanDirect\", \"method\": \"run\",\n            \"data\": [\n                self.token_generator(),\n                \"PoliciesDirect.getPoliciesByUsage\",\n                [\n                    {\n                        \"type\": \"security\",\n                        \"position\": \"main\",\n                        \"vsysName\": self.machine,\n                        \"isCmsSelected\": False,\n                        \"isMultiVsys\": False,\n                        \"showGrouped\": False,\n                        \"usageAttributes\": {\n                            \"timeframe\": timeframe,\n                            \"usage\": usage, \"exclude\": exclude,\n                            \"exclude-reset-text\": \"90\"\n                        },\n                        \"pageContext\": \"rule_usage\"\n                    }\n                ]\n            ], \"type\": \"rpc\",\n            \"tid\": self.session_metadata['tid']}\n\n        return self.session_post(\n            url=f'{self.session_metadata[\"base_url\"]}/php/utils/router.php/PoliciesDirect.getPoliciesByUsage',\n            json_cmd=json_cmd)\n\n    def policy_optimizer_app_and_usage(self, rule_uuid: str) -> dict:\n        self.session_metadata['tid'] += 1  # Increment TID\n        json_cmd = {\"action\": \"PanDirect\", \"method\": \"run\",\n                    \"data\": [\n                        self.token_generator(),\n                        \"PoliciesDirect.getAppDetails\",\n                        [\n                            {\n                                \"type\": \"security\",\n                                \"vsysName\": self.machine,\n                                \"position\": \"main\",\n                                \"ruleUuidList\": [rule_uuid],\n                                \"summary\": \"no\",\n                                \"resultfields\":\n                                    \"<member>apps-seen</member>\"\n                                    \"<member>last-app-seen-since-count\"\n                                    \"</member><member>days-no-new-app-count</member>\",\n                                \"appsSeenTimeframe\": \"any\",\n                                \"trafficTimeframe\": 30\n                            }\n                        ]\n                    ],\n                    \"type\": \"rpc\",\n                    \"tid\": self.session_metadata['tid']}\n\n        return self.session_post(\n            url=f'{self.session_metadata[\"base_url\"]}/php/utils/router.php/PoliciesDirect.getAppDetails',\n            json_cmd=json_cmd)\n\n    def policy_optimizer_get_dag(self, dag: str) -> dict:\n        self.session_metadata['tid'] += 1  # Increment TID\n        json_cmd = {\n            \"action\": \"PanDirect\",\n            \"method\": \"execute\",\n            \"data\": [\n                self.token_generator(),\n                \"AddressGroup.showDynamicAddressGroup\", {\n                    \"id\": dag,\n                    \"vsysName\": self.machine\n                }\n            ],\n            \"type\": \"rpc\",\n            \"tid\": self.session_metadata['tid']}\n\n        return self.session_post(\n            url=f'{self.session_metadata[\"base_url\"]}/php/utils/router.php/AddressGroup.showDynamicAddressGroup',\n            json_cmd=json_cmd)\n\n\ndef get_policy_optimizer_statistics_command(client: Client) -> CommandResults:\n    \"\"\"\n    Gets the Policy Optimizer Statistics as seen from the User Interface\n    \"\"\"\n    outputs_stats = {}\n    raw_response = client.get_policy_optimizer_statistics()\n\n    stats = raw_response['result']\n    if '@status' in stats and stats['@status'] == 'error':\n        raise Exception(f'Operation Failed with: {str(stats)}')\n\n    stats = stats['result']\n    for i in stats['entry']:\n        outputs_stats[i['@name']] = i['text']\n\n    return CommandResults(\n        outputs_prefix='PanOS.PolicyOptimizer.Stats',\n        outputs=outputs_stats,\n        readable_output=tableToMarkdown(name='Policy Optimizer Statistics:', t=stats['entry'], removeNull=True),\n        raw_response=raw_response\n    )\n\n\ndef policy_optimizer_no_apps_command(client: Client) -> CommandResults:\n    return\n    \"\"\"\n    Gets the Policy Optimizer Statistics as seen from the User Interface\n    \"\"\"\n    raw_response = client.policy_optimizer_no_apps()\n\n    stats = raw_response['result']\n    if '@status' in stats and stats['@status'] == 'error':\n        raise Exception(f'Operation Failed with: {str(stats)}')\n\n    stats = stats['result']\n    if '@count' in stats and stats['@count'] == '0':\n        return CommandResults(readable_output='No Rules without apps were found.', raw_response=raw_response)\n\n    rules_no_apps = stats['entry']\n    if not isinstance(rules_no_apps, list):\n        rules_no_apps = rules_no_apps[0]\n\n    headers = ['@name', '@uuid', 'action', 'description', 'source', 'destination']\n\n    return CommandResults(\n        outputs_prefix='PanOS.PolicyOptimizer.NoApps',\n        outputs_key_field='@uuid',\n        outputs=rules_no_apps,\n        readable_output=tableToMarkdown(name='Policy Optimizer No App Specified:', t=rules_no_apps, headers=headers,\n                                        removeNull=True),\n        raw_response=raw_response\n    )\n\n\ndef policy_optimizer_get_unused_apps_command(client: Client) -> CommandResults:\n    \"\"\"\n    Gets the Policy Optimizer Statistics as seen from the User Interface\n    \"\"\"\n    raw_response = client.policy_optimizer_get_unused_apps()\n\n    stats = raw_response['result']\n    if '@status' in stats and stats['@status'] == 'error':\n        raise Exception(f'Operation Failed with: {str(stats)}')\n\n    stats = stats['result']\n    if '@count' in stats and stats['@count'] == '0':\n        return CommandResults(readable_output='No Rules with unused apps were found.', raw_response=raw_response)\n\n    return CommandResults(\n        outputs_prefix='PanOS.PolicyOptimizer.UnusedApps',\n        outputs_key_field='Stats',\n        outputs=stats,\n        readable_output=tableToMarkdown(name='Policy Optimizer Unused Apps:', t=stats['entry'], removeNull=True),\n        raw_response=raw_response\n    )\n\n\ndef policy_optimizer_get_rules_command(client: Client, args: dict) -> CommandResults:\n    \"\"\"\n    Gets the unused rules Statistics as seen from the User Interface\n    \"\"\"\n    timeframe = str(args.get('timeframe'))\n    usage = str(args.get('usage'))\n    exclude = argToBoolean(args.get('exclude'))\n\n    raw_response = client.policy_optimizer_get_rules(timeframe, usage, exclude)\n    stats = raw_response['result']\n    if '@status' in stats and stats['@status'] == 'error':\n        raise Exception(f'Operation Failed with: {str(stats)}')\n\n    stats = stats['result']\n    if '@count' in stats and stats['@count'] == '0':\n        return CommandResults(readable_output=f'No {usage} rules where found.', raw_response=raw_response)\n\n    rules = stats['entry']\n    if not isinstance(rules, list):\n        rules = rules[0]\n\n    headers = ['@name', '@uuid', 'action', 'description', 'source', 'destination']\n\n    return CommandResults(\n        outputs_prefix=f'PanOS.PolicyOptimizer.{usage}Rules',\n        outputs_key_field='@uuid',\n        outputs=rules,\n        readable_output=tableToMarkdown(name=f'PolicyOptimizer {usage}Rules:', t=rules, headers=headers,\n                                        removeNull=True),\n        raw_response=raw_response\n    )\n\n\ndef policy_optimizer_app_and_usage_command(client: Client, args: dict) -> CommandResults:\n    \"\"\"\n    Gets the Policy Optimizer Statistics as seen from the User Interface\n    \"\"\"\n    rule_uuid = str(args.get('rule_uuid'))\n\n    raw_response = client.policy_optimizer_app_and_usage(rule_uuid)\n\n    stats = raw_response['result']\n    if '@status' in stats and stats['@status'] == 'error':\n        raise Exception(f'Operation Failed with: {str(stats)}')\n\n    stats = stats['result']\n    if '@count' in stats and stats['@count'] == '0':\n        return CommandResults(readable_output=f'Rule with UUID:{rule_uuid} does not use apps.', raw_response=raw_response)\n\n    rule_stats = stats['rules']['entry'][0]\n\n    return CommandResults(\n        outputs_prefix='PanOS.PolicyOptimizer.AppsAndUsage',\n        outputs_key_field='@uuid',\n        outputs=rule_stats,\n        readable_output=tableToMarkdown(name='Policy Optimizer Apps and Usage:', t=rule_stats, removeNull=True),\n        raw_response=raw_response\n    )\n\n\ndef policy_optimizer_get_dag_command(client: Client, args: dict) -> CommandResults:\n    \"\"\"\n    Gets the DAG\n    \"\"\"\n    dag = str(args.get('dag'))\n    raw_response = client.policy_optimizer_get_dag(dag)\n    result = raw_response['result']\n    if '@status' in result and result['@status'] == 'error':\n        raise Exception(f'Operation Failed with: {str(result)}')\n\n    try:\n        result = result['result']['dyn-addr-grp']['entry'][0]['member-list']['entry']\n    except KeyError:\n        raise Exception(f'Dynamic Address Group: {dag} was not found.')\n\n    return CommandResults(\n        outputs_prefix='PanOS.PolicyOptimizer.DAG',\n        outputs_key_field='Stats',\n        outputs=result,\n        readable_output=tableToMarkdown(name='Policy Optimizer Dynamic Address Group:', t=result, removeNull=True),\n        raw_response=raw_response\n    )\n\n\ndef main():\n    command = demisto.command()\n    params = demisto.params()\n    args = demisto.args()\n    demisto.debug(f'Command being called is: {command}')\n    client: Client = None  # type: ignore\n    try:\n        client = Client(url=params.get('server_url'), username=params['credentials']['identifier'],\n                        password=params['credentials']['password'], vsys=params.get('vsys'),\n                        device_group=params.get('device_group'), verify=not params.get('insecure'), tid=50)\n        client.session_metadata['cookie'] = client.login()  # Login to PAN-OS and return the GUI cookie value\n\n        if command == 'test-module':\n            return_results('ok')  # if login was successful, instance configuration is ok.\n        elif command == 'pan-os-po-get-stats':\n            return_results(get_policy_optimizer_statistics_command(client))\n        elif command == 'pan-os-po-no-apps':\n            return_results(policy_optimizer_no_apps_command(client))\n        elif command == 'pan-os-po-unused-apps':\n            return_results(policy_optimizer_get_unused_apps_command(client))\n        elif command == 'pan-os-po-get-rules':\n            return_results(policy_optimizer_get_rules_command(client, args))\n        elif command == 'pan-os-po-app-and-usage':\n            return_results(policy_optimizer_app_and_usage_command(client, args))\n        elif command == 'pan-os-get-dag':\n            return_results(policy_optimizer_get_dag_command(client, args))\n        else:\n            raise NotImplementedError(f'Command {command} was not implemented.')\n\n    except Exception as err:\n        return_error(f'{str(err)}.\\n Trace:{traceback.format_exc()}')\n\n    finally:\n        try:\n            client.logout()  # Logout of PAN-OS\n        except Exception as err:\n            return_error(f'{str(err)}.\\n Trace:{traceback.format_exc()}')\n\n\nif __name__ in (\"__builtin__\", \"builtins\", '__main__'):\n    main()\n",
  "line_no": 254,
  "line_no_percent": "59%"
}