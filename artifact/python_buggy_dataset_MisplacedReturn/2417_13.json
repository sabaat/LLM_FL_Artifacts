{
  "instruction": "The given code is a Python script that defines a SupportTicket class and several functions. To use this code, import the necessary modules and create an instance of the SupportTicket class. The class has several methods that can be called to get the sender, subject, and content of a support ticket, as well as to update the status and send an email notification. There are also several helper functions for setting the status of a ticket, assigning tickets to users, and re-enabling user accounts. To use these functions, call them with the appropriate arguments.",
  "buggy_code": "from __future__ import unicode_literals\nimport frappe\n\nfrom erpnext.utilities.transaction_base import TransactionBase\nfrom frappe.utils import now, extract_email_id\nimport json\nimport requests\n\n\nSTANDARD_USERS = (\"Guest\", \"Administrator\")\n\nclass SupportTicket(TransactionBase):\n\n\tdef get_sender(self, comm):\n\t\treturn frappe.db.get_value('Support Email Settings',None,'support_email')\n\n\tdef get_subject(self, comm):\n\t\treturn '[' + self.name + '] ' + (comm.subject or 'No Subject Specified')\n\n\tdef get_content(self, comm):\n\t\tsignature = frappe.db.get_value('Support Email Settings',None,'support_signature')\n\t\tcontent = comm.content\n\t\tif signature:\n\t\t\tcontent += '<p>' + signature + '</p>'\n\t\treturn content\n\n\tdef get_portal_page(self):\n\t\treturn \"ticket\"\n\n\tdef on_update1(self):\n\t\tfrom frappe.utils import get_url, cstr\n\t\tfrappe.errprint(get_url())\n\t\tif get_url()=='http://tailorpad.com':\n\t\t\tpass\n\t\telse:\n\t\t\tpr2 = frappe.db.sql(\"\"\"select name from `tabSupport Ticket`\"\"\")\n\t\t\tfrappe.errprint(pr2)\n\t\t\tfrappe.errprint(\"is feed back saved\")\n\t\t\tif pr2:\n\t\t\t\tfrappe.errprint(\"in if for creation support ticket\")\n\t\t\t\ttest = {}\n\t\t\t\tsupport_ticket = self.get_ticket_details()\n\t\t\t\tself.call_del_keys(support_ticket)\n\t\t\t\tself.login()\n\t\t\t\tfrappe.errprint(\"support_ticket\")\n\t\t\t\tfrappe.errprint(support_ticket)\n\t\t\t\tself.tenent_based_ticket_creation(support_ticket)\n\n\n\tdef send_email(self):\n\t\tfrappe.errprint(\"in the sendmail\")\n\t\tfrom frappe.utils.user import get_user_fullname\n\t\tfrom frappe.utils import get_url\n\t\tif self.get(\"__islocal\") and get_url()=='http://tailorpad.com':\n\t\t\t\n\n\t\t\tfull_name = get_user_fullname(frappe.session['user'])\n\t\t\tif full_name == \"Guest\":\n\t\t\t\tfull_name = \"Administrator\"\n\n\t\t\tfirst_name = frappe.db.sql_list(\"\"\"select first_name from `tabUser` where name='%s'\"\"\"%(self.raised_by))\n\t\t\tfrappe.errprint(first_name[0])\n\n\t\t\tmsg=\"Dear  \"+first_name[0]+\"!<br><br>Support Ticket is created successfully for '\"+self.subject+\"'<br><br>Your Support Ticket Number is '\"+self.name+\"' <br><br>Please note for further information. <br><br>Regards, <br>Team TailorPad.\"\n\t\t\tsender = frappe.session.user not in STANDARD_USERS and frappe.session.user or None\n\t\t\tfrappe.sendmail(recipients=self.raised_by, sender=sender, subject=self.subject,\n\t\t\t\tmessage=msg)\n\n\n\tdef login(self):\n\t\tlogin_details = {'usr': 'Administrator', 'pwd': 'admin'}\n\t\turl = 'http://tailorpad.com/api/method/login'\n\t\theaders = {'content-type': 'application/x-www-form-urlencoded'}\n\t\tfrappe.errprint([url, 'data='+json.dumps(login_details)])\n\t\tresponse = requests.post(url, data='data='+json.dumps(login_details), headers=headers)\n\n\tdef get_ticket_details(self):\n\t\tresponse = requests.get(\"\"\"%(url)s/api/resource/Support Ticket/SUP-00001\"\"\"%{'url':get_url()})\n\t\t\n\t\tfrappe.errprint(response.text)\n\t\treturn eval(response.text).get('data')\n\n\tdef call_del_keys(self, support_ticket):\n\t\tif support_ticket:\n\t\t\tif isinstance(support_ticket, dict):\n\t\t\t\tself.del_keys(support_ticket)\n\n\t\t\tif isinstance(support_ticket, list):\n\t\t\t\tfor comm in support_ticket:\n\t\t\t\t\tself.del_keys(comm)\n\n\tdef del_keys(self, support_ticket):\n\t\tfrappe.errprint(type(support_ticket))\n\t\tdel support_ticket['name']\n\t\tdel support_ticket['creation']\n\t\tdel support_ticket['modified']\n\t\tdel support_ticket['company']\n\n\tdef tenent_based_ticket_creation(self, support_ticket):\n\t\tfrappe.errprint(support_ticket)\n\t\turl = 'http://tailorpad.com/api/resource/Support Ticket'\n\t\theaders = {'content-type': 'application/x-www-form-urlencoded'}\n\t\tfrappe.errprint('data='+json.dumps(support_ticket))\n\t\tresponse = requests.post(url, data='data='+json.dumps(support_ticket), headers=headers)\n\n\t\tfrappe.errprint(response)\n\t\tfrappe.errprint(response.text)\n\n\tdef validate(self):\n\t\t\n\t\tself.update_status()\n\t\tself.set_lead_contact(self.raised_by)\n\n\t\tif self.status == \"Closed\":\n\t\t\tfrom frappe.widgets.form.assign_to import clear\n\t\t\tclear(self.doctype, self.name)\n\t\tself.send_email()\n\n\tdef set_lead_contact(self, email_id):\n\t\treturn\n\t\timport email.utils\n\t\temail_id = email.utils.parseaddr(email_id)\n\t\tif email_id:\n\t\t\tif not self.lead:\n\t\t\t\tself.lead = frappe.db.get_value(\"Lead\", {\"email_id\": email_id})\n\t\t\tif not self.contact:\n\t\t\t\tself.contact = frappe.db.get_value(\"Contact\", {\"email_id\": email_id})\n\n\t\t\tif not self.company:\n\t\t\t\tself.company = frappe.db.get_value(\"Lead\", self.lead, \"company\") or \\\n\t\t\t\t\tfrappe.db.get_default(\"company\")\n\n\tdef update_status(self):\n\t\tstatus = frappe.db.get_value(\"Support Ticket\", self.name, \"status\")\n\t\tif self.status!=\"Open\" and status ==\"Open\" and not self.first_responded_on:\n\t\t\tself.first_responded_on = now()\n\t\tif self.status==\"Closed\" and status !=\"Closed\":\n\t\t\tself.resolution_date = now()\n\t\tif self.status==\"Open\" and status !=\"Open\":\n\t\t\tself.resolution_date = None\n\n@frappe.whitelist()\ndef set_status(name, status):\n\tst = frappe.get_doc(\"Support Ticket\", name)\n\tst.status = status\n\tst.save()\n\n@frappe.whitelist()\ndef get_admin(name):\n\tadmin = frappe.db.sql(\"select email_id_admin from tabUser  where name='administrator'\")\n\tfrappe.errprint(admin)\n\tfrappe.errprint(frappe.session.get('user'))\n\tif admin:\n\t\tfrappe.errprint(\"if\")\n\t\treturn admin[0][0]\n\telse:\n\t\tfrappe.errprint(\"else\")\n\t  \treturn frappe.session.get('user')\n\n\n@frappe.whitelist()\ndef assing_future(name, assign_in_future,raised_by,assign_to):\n  \tfrappe.errprint(\"in assign future\")\n  \tfrom frappe.utils import get_url, cstr\n\tif get_url()=='http://tailorpad.com':\n\t\tcheck_entry = frappe.db.sql(\"\"\"select assign_to from `tabAssing Master` where name = %s \"\"\", raised_by)\n\t\tfrappe.errprint(\"in assign\")\n\t\tif check_entry :\n\t\t\tfrappe.errprint(\"chk\")\n\t\t\tif assign_in_future=='No':\n\t\t\t\tfrappe.errprint(\"no\")\n\t\t\t\tfrappe.db.sql(\"\"\"delete from `tabAssing Master` where name = %s \"\"\", raised_by)\t\n\t\t\telse :\n\t\t\t\tfrappe.errprint(\"Yes\")\n\t\t\t\tfrappe.db.sql(\"\"\"update `tabAssing Master` set assign_to=%s where name = %s \"\"\",(assign_to,raised_by))\n\t\telse :\n\t\t\tfrappe.errprint(\"not chk\")\n\t\t\tif assign_in_future=='Yes':\n\t\t\t\tfrappe.errprint(\"Yes\")\n\t\t\t\tam = frappe.new_doc(\"Assing Master\")\n\t\t\t\tam.update({\n\t\t\t\t\"name\": raised_by,\n\t\t\t\t\"assign_to\": assign_to,\n\t\t\t\t\"raised_by\":raised_by\n\t\t\t})\n\t\t\tam.insert()\n\ndef auto_close_tickets():\n\tfrappe.db.sql(\"\"\"update `tabSupport Ticket` set status = 'Closed'\n\t\twhere status = 'Replied'\n\t\tand date_sub(curdate(),interval 15 Day) > modified\"\"\")\n\n\n@frappe.whitelist()\ndef reenable(name):\n\tfrappe.errprint(\"calling superadmin\")\n        from frappe.utils import get_url, cstr\n\tfrappe.errprint(get_url())\n\tif get_url()!='http://tailorpad.com':\n\t  frappe.errprint(\"in reenable\")\n  \t  from frappe.utils import get_url, cstr,add_months\n  \t  from frappe import msgprint, throw, _\n  \t  res = frappe.db.sql(\"select validity from `tabUser` where name='Administrator' and no_of_users >0\")\n\t  if  res:\n\t\tres1 = frappe.db.sql(\"select validity_end_date from `tabUser` where '\"+cstr(name)+\"' and validity_end_date <CURDATE()\")\n\t\tif res1:\n\t\t\tbc=\"update `tabUser` set validity_end_date=DATE_ADD((nowdate(), INTERVAL \"+cstr(res[0][0])+\" MONTH) where name = '\"+cstr(name)+\"'\"\n\t\t\tfrappe.db.sql(bc)\n\t  \t\tfrappe.db.sql(\"update `tabUser`set no_of_users=no_of_users-1  where name='Administrator'\")\n\t\telse:\n\t\t\tab=\"update `tabUser` set validity_end_date=DATE_ADD(validity_end_date,INTERVAL \"+cstr(res[0][0])+\" MONTH) where name = '\"+cstr(name)+\"' \"\n\t\t\tfrappe.errprint(ab)\n\t\t\tfrappe.db.sql(ab)\n\t  \t\tfrappe.db.sql(\"update `tabUser`set no_of_users=no_of_users-1  where name='Administrator'\")\n\t  else:\n\t\t    frappe.throw(_(\"Your subscription plan expired .Please purchase an subscription plan and enable user.\"))\n",
  "line_no": 120,
  "line_no_percent": "56%"
}