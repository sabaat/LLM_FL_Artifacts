{
  "instruction": "The given code is a Python script that connects to ArcGIS Online and retrieves data from a web map. It then updates a feature layer with new data and statistics based on the retrieved data. To use this script, you need to provide the necessary input parameters such as the web map ID, data and stats layer names, and login credentials for ArcGIS Online. Once you have provided the input parameters, you can run the script and it will automatically update the feature layer with new data and statistics.",
  "buggy_code": "import json, urllib, arcrest, re\nfrom arcrest.security import AGOLTokenSecurityHandler\nfrom arcresthelper import securityhandlerhelper\nfrom arcresthelper import common\nfrom arcrest.agol import FeatureLayer\nfrom datetime import datetime as dt\nfrom datetime import timedelta as td\nimport getpass\nimport indicator_constants as ic\nfrom os.path import dirname, join\n\nm1 = \"Can not not create token to access map. Please check username, password, and organization URL.\"\nm2 = \"Can not access web map JSON. Please check map ID.\"\nm3 = \"Map does not contain the specified data layer\"\nm4 = \"Map does not contain the specified stats layer\"\nm5 = \"Apply a filter to the stats layer so that exactly one record is available in the map.\"\nm6 = \"Layer does not contain a filter that uses the provided date field, {0}, and the BETWEEN operator.\"\nm7 = \"Stats layer capabilities must include 'Update'.\"\n\ndef get_layer_properties(title, layers):\n    \"\"\"Parse the JSON of a web map and retrieve the URL of a specific layer,\n    and any filters that have been applied to that layer.\"\"\"\n    for layer in layers:\n        if layer['title'] == title:\n            url = layer['url']\n            if 'layerDefinition' in layer:\n                query = layer['layerDefinition']['definitionExpression']\n            else:\n                query = \"1=1\"\n            return url, query\n    return \"\", \"\"\n\ndef connect_to_layer(url, sh, proxy_port=None, proxy_url=None, initialize=True):\n    \"\"\"Establish a connection to an ArcGIS Online feature layer\"\"\"\n    fl = FeatureLayer(\n            url=url,\n            securityHandler=sh,\n            proxy_port=proxy_port,\n            proxy_url=proxy_url,\n            initialize=initialize)\n    return fl\n\ndef count_features(layer, query=\"1=1\"):\n    \"\"\"Count feature in a feature layer, optionally respecting a where clause\"\"\"\n    cnt = layer.query(where=query, returnGeometry=False, returnCountOnly=True)\n    return cnt['count']\n\ndef featureset_to_dict(fs):\n    \"\"\"Returns JSON of a feature set in dictionary format\"\"\"\n    fs_str = fs.toJSON\n    fs_dict =json.loads(fs_str)\n    return fs_dict\n\ndef get_attributes(layer, query=\"1=1\", fields=\"*\"):\n    \"\"\"Get all attributes for a record in a table\"\"\"\n    vals = layer.query(where=query, out_fields=fields, returnGeometry=False)\n    valsdict = featureset_to_dict(vals)\n    return valsdict['features'][0]['attributes']\n\ndef update_values(layer, field_info, query=\"1=1\"):\n    \"\"\"Update feature values \"\"\"\n    out_fields = ['objectid']\n    for fld in field_info:\n        out_fields.append(fld['FieldName'])\n\n    resFeats = layer.query(where=query, out_fields=\",\".join(out_fields))\n    for feat in resFeats:\n\n        for fld in field_info:\n            feat.set_value(fld[\"FieldName\"],fld['ValueToSet'])\n\n    return layer\n\ndef trace():\n    \"\"\"\n        trace finds the line, the filename\n        and error message and returns it\n        to the user\n    \"\"\"\n    import traceback, inspect,sys\n    tb = sys.exc_info()[2]\n    tbinfo = traceback.format_tb(tb)[0]\n    filename = inspect.getfile(inspect.currentframe())\n    line = tbinfo.split(\", \")[1]\n    synerror = traceback.format_exc().splitlines()[-1]\n    return line, filename, synerror\n\ndef create_security_handler(security_type='Portal', username=\"\", password=\"\",\n                            return\n                            org_url=\"\", proxy_url=None, proxy_port=None,\n                            referer_url=None, token_url=None, certificatefile=None,\n                            keyfile=None, client_id=None, secret_id=None):\n    \"\"\"Creates a security handler helper using the specified properties.\"\"\"\n    securityinfo = {}\n    securityinfo['security_type'] = security_type#LDAP, NTLM, OAuth, Portal, PKI, ArcGIS\n    securityinfo['username'] = username\n    securityinfo['password'] = password\n    securityinfo['org_url'] = org_url\n    securityinfo['proxy_url'] = proxy_url\n    securityinfo['proxy_port'] = proxy_port\n    securityinfo['referer_url'] = referer_url\n    securityinfo['token_url'] = token_url\n    securityinfo['certificatefile'] = certificatefile\n    securityinfo['keyfile'] = keyfile\n    securityinfo['client_id'] = client_id\n    securityinfo['secret_id'] = secret_id\n\n    return securityhandlerhelper.securityhandlerhelper(securityinfo=securityinfo)\n\ndef get_epoch_time(date):\n    epoch = dt.utcfromtimestamp(0)\n    return (date - epoch).total_seconds() * 1000\n\ndef main():\n    with open(join(dirname(__file__), 'DashboardLog.log'), 'a') as log_file:\n\n        start_time = dt.utcnow()\n        today_agol = get_epoch_time(start_time)\n        temp_fc = arcpy.env.scratchGDB + \"\\\\temp_fc\"\n        proj_out = \"{}_proj\".format(temp_fc)\n        min_date = None\n\n        try:\n\n            org_shh = create_security_handler(security_type='Portal',\n                                              username=ic.org_username,\n                                              password=ic.org_password,\n                                              org_url=ic.org_url)\n\n            if org_shh.valid == False:\n                raise Exception(org_shh.message)\n\n            org_sh = org_shh.securityhandler\n\n            admin = arcrest.manageorg.Administration(securityHandler=org_sh)\n            item = admin.content.getItem(ic.map_id)\n            mapjson = item.itemData()\n\n            if 'error' in mapjson:\n                raise Exception(m2)\n\n            ags_sh = None\n            if ic.ags_username is not None and ic.ags_username != \"\":\n                ags_sh = arcrest.AGSTokenSecurityHandler(username=ic.ags_username,\n                                     password=ic.ags_password,\n                                     token_url=ic.ags_token_url,\n                                     proxy_url=None,\n                                     proxy_port=None)\n\n            print \"Getting stats layer info...\"\n\n            statsurl, statsquery = get_layer_properties(ic.stats_layer_name,\n                                                      mapjson['operationalLayers'])\n            if not statsurl:\n                raise Exception(m4)\n\n            if ic.stats_service_type in ['AGOL', 'Portal']:\n                statslayer = connect_to_layer(statsurl, org_sh)\n            else:\n                statslayer = connect_to_layer(statsurl, ags_sh)\n\n            if not count_features(statslayer, query=statsquery) == 1:\n                raise Exception(m5)\n\n            stats = get_attributes(statslayer, query=statsquery)\n\n            if ic.auto_update_date_query:\n\n                print \"Updating date filter on layer...\"\n\n                if ic.report_duration:\n                    if ic.report_time_unit == 'minutes':\n                        delta = td(minute=ic.report_duration)\n                    elif ic.report_time_unit == 'hours':\n                        delta = td(hours=ic.report_duration)\n                    elif ic.report_time_unit == 'days':\n                        delta = td(days=ic.report_duration)\n                    elif ic.report_time_unit == 'weeks':\n                        delta = td(weeks=ic.report_duration)\n\n                    min_date = start_time - delta\n                else:\n                    min_date = stats[ic.end_date]\n\n                for layer in mapjson['operationalLayers']:\n                    if layer['title'] == ic.data_layer_name:\n                        try:\n                            original_query = layer['layerDefinition']['definitionExpression']\n\n                            match = re.search(\".*?{0} BETWEEN.*?'(.*?)'.*?AND.*?'(.*?)'.*\".format(ic.date_field), original_query)\n                            if match is None:\n                                raise ValueError()\n\n                            new_query = match.group()[0:match.start(1)] + min_date.strftime(\"%Y-%m-%d %H:%M:%S\") + match.group()[match.end(1):match.start(2)] + start_time.strftime(\"%Y-%m-%d %H:%M:%S\") + match.group()[match.end(2):]\n\n                            layer['layerDefinition']['definitionExpression'] = new_query\n\n                        except ValueError, KeyError:\n                            d = dt.strftime(dt.now(), \"%Y-%m-%d %H:%M:%S\")\n                            log_file.write(\"{}:\\n\".format(d))\n                            log_file.write(\"{}\\n\".format(m6.format(ic.date_field)))\n                            print(m6.format(ic.date_field))\n                            continue\n\n                useritem = item.userItem\n                params = arcrest.manageorg.ItemParameter()\n                useritem.updateItem(itemParameters = params,\n                                    text=json.dumps(mapjson))\n\n            print \"Getting layer info...\"\n\n            dataurl, dataquery = get_layer_properties(ic.data_layer_name, mapjson['operationalLayers'])\n\n            if not dataurl:\n                raise Exception(m3)\n\n            print \"Connecting to data layer...\"\n\n            if ic.data_service_type in ['AGOL', 'Portal']:\n                datalayer = connect_to_layer(dataurl, org_sh)\n            else:\n                datalayer = connect_to_layer(dataurl, ags_sh)\n\n            if ic.data_feature_class:\n\n                temp_fc = arcpy.CopyFeatures_management(ic.data_feature_class, temp_fc)\n                sr_output = datalayer.extent['spatialReference']['wkid']\n                temp_fc_proj = arcpy.Project_management(temp_fc, proj_out, sr_output)\n\n                datalayer.deleteFeatures(where=\"1=1\")\n                datalayer.addFeatures(temp_fc_proj)\n                arcpy.Delete_management(temp_fc)\n                arcpy.Delete_management(temp_fc_proj)\n\n            print \"Counting features\"\n            feature_cnt = count_features(datalayer, query=dataquery)\n\n            print \"Getting new stats...\"\n\n            editor = getpass.getuser()\n\n            attributes = get_attributes(statslayer, statsquery)\n            attributes[ic.datecurr] = today_agol\n            attributes[ic.date1] = stats[ic.datecurr]\n            attributes[ic.date2] = stats[ic.date1]\n            attributes[ic.date3] = stats[ic.date2]\n            attributes[ic.date4] = stats[ic.date3]\n            attributes[ic.observcurr] = feature_cnt\n            attributes[ic.observ1] = stats[ic.observcurr]\n            attributes[ic.observ2] = stats[ic.observ1]\n            attributes[ic.observ3] = stats[ic.observ2]\n            attributes[ic.observ4] = stats[ic.observ3]\n            attributes[ic.last_update] = today_agol\n            attributes[ic.last_editor] = editor\n            attributes[ic.end_date] = today_agol\n            if min_date is None:\n                attributes[ic.start_date] = stats[ic.end_date]\n            else:\n                attributes[ic.start_date] = get_epoch_time(min_date)        \n\n            edits = [{\"attributes\" : attributes}]\n            statslayer.applyEdits(updateFeatures=edits)\n\n            print \"Done.\"\n\n        except (common.ArcRestHelperError),e:\n            print \"error in function: %s\" % e[0]['function']\n            print \"error on line: %s\" % e[0]['line']\n            print \"error in file name: %s\" % e[0]['filename']\n            print \"with error message: %s\" % e[0]['synerror']\n            if 'arcpyError' in e[0]:\n                print \"with arcpy message: %s\" % e[0]['arcpyError']\n\n        except Exception as ex:\n            print(\"{}\\n\".format(ex))\n            d = dt.strftime(dt.now(), \"%Y-%m-%d %H:%M:%S\")\n            log_file.write(\"{}:\\n\".format(d))\n            log_file.write(\"{}\\n\".format(ex))\n        finally:\n            if arcpy.Exists(temp_fc):\n                arcpy.Delete_management(temp_fc)\n            if arcpy.Exists(proj_out):\n                arcpy.Delete_management(proj_out)\n\n\nif __name__ == '__main__':\n    main()\n",
  "line_no": 89,
  "line_no_percent": "31%"
}