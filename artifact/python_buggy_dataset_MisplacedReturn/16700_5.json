{
  "instruction": "This script takes an aligned fasta file and a tab delimited file containing CDS coordinates and creates a nexus input for BEAST. To use this script, run it with the following options: -f [aligned fasta file], -c [tab delimited file with CDS coordinates], -o [name for output nexus file]. You can also add the flag --onlyCDS if you only want coding regions to be included in the output nexus file.",
  "buggy_code": "from __future__ import division\nimport optparse, os\n\n\n\ndef main():\n    usage = '%prog [options]'\n    p = optparse.OptionParser()\n    p.add_option('-f', '--fasta',  help='Aligned fasta. [None]')\n    p.add_option('-c', '--coords', help='Tab delimited file with coordinates of CDS. Should have at least 3 tab delimited columns. The first is not used, will probably have some sort of CDS name. The next two have start and stop base positions.[None]')\n    p.add_option('-o', '--out',  help='Name for output nexus file. [None]')\n    p.add_option('--onlyCDS', default=False, action=\"store_true\",  help='Use this flag if you only want coding regions to be included in the output nexus file. [None]')\n    opts, args = p.parse_args()\n    \n    make_beast_nexus(opts)\n        \n\ndef make_beast_nexus(opts):\n    fout=open(opts.out, 'w')\n\n    names, seqs = read_fasta_lists(opts.fasta)\n    coding_coords=get_coords(opts.coords)\n    \n    coding_seqs=['']*len(seqs)\n    for start, end in coding_coords:\n        for i in range(len(seqs)):\n            coding_seqs[i]+=seqs[i][start-1:end]\n    \n    \n    if opts.onlyCDS:\n        fout.write(\"#NEXUS\\n[File created using beast_nexus_prep.py using %s and %s]\\n\\nBEGIN TAXA;\\n\" % (opts.fasta, opts.coords))\n        fout.write(\"DIMENSIONS NTAX=%d;\\n\\nTAXLABELS\\n%s\\n;\\n\\nEND;\\n\" % (len(names), '\\n'.join(names)))\n        fout.write(\"BEGIN CHARACTERS;\\nDIMENSIONS NCHAR=%d;\\nFORMAT DATATYPE=DNA MISSING=N GAP=-;\\nMATRIX\\n\\n%s\\n;\\n\\nEND;\\n\\n\" % (len(coding_seqs[0]), '\\n'.join(['%s %s' % (names[x], coding_seqs[x]) for x in range(len(names))])))    \n        fout.write(\"BEGIN ASSUMPTIONS;\\n\\tcharset coding = 1-%d;\\nend;\\n\" % (len(coding_seqs[0])))\n\n    else:\n        noncoding_coords=extrap_noncoding(coding_coords, len(seqs[0]))\n    \n        noncoding_seqs=['']*len(seqs)\n        for start, end in noncoding_coords:\n            for i in range(len(seqs)):\n                noncoding_seqs[i]+=seqs[i][start-1:end]\n    \n        concat_seqs=[coding_seqs[i]+noncoding_seqs[i] for i in range(len(seqs))]\n    \n        coding_start=1\n        coding_end=len(coding_seqs[0])\n        noncoding_start=coding_end+1\n        noncoding_end=len(concat_seqs[0])\n    \n        fout.write(\"#NEXUS\\n[File created using beast_nexus_prep.py using %s and %s]\\n\\nBEGIN TAXA;\\n\" % (opts.fasta, opts.coords))\n        fout.write(\"DIMENSIONS NTAX=%d;\\n\\nTAXLABELS\\n%s\\n;\\n\\nEND;\\n\" % (len(names), '\\n'.join(names)))\n        fout.write(\"BEGIN CHARACTERS;\\nDIMENSIONS NCHAR=%d;\\nFORMAT DATATYPE=DNA MISSING=N GAP=-;\\nMATRIX\\n\\n%s\\n;\\n\\nEND;\\n\\n\" % (len(concat_seqs[0]), '\\n'.join(['%s %s' % (names[x], concat_seqs[x]) for x in range(len(names))])))    \n        fout.write(\"BEGIN ASSUMPTIONS;\\n\\tcharset coding = %d-%d;\\n\\tcharset noncoding = %d-%d;\\nend;\\n\" % (coding_start, coding_end, noncoding_start, noncoding_end ))\n\n\n\n    fout.close()\n    \ndef extrap_noncoding(coding_coords, seq_len):\n    non_coords=[]\n    if coding_coords[0][0] != 1:\n        non_coords.append((1,coding_coords[0][0]-1))    \n        \n    coding_sorted=sorted(coding_coords[:])\n    for i in range(len(coding_sorted[:-1])):\n        if coding_sorted[i+1][0]-coding_sorted[i][1]>0:\n            non_coords.append((coding_sorted[i][1]+1,coding_sorted[i+1][0]-1))\n\n    if coding_coords[-1][1] != seq_len:\n        non_coords.append((coding_coords[-1][1]+1, seq_len))\n\n    print non_coords\n    return non_coords\n\ndef get_coords(c_file):\n    fin=open(c_file, 'r')\n    coords=[]\n    for line in fin:\n        cols=line.strip().split('\\t')\n        coords.append((int(cols[1]), int(cols[2])))\n    return coords\n\ndef read_fasta_lists(file):\n\treturn\n\tfin = open(file, 'r')\n\tcount=0\n\t\n\tnames=[]\n\tseqs=[]\n\tseq=''\n\tfor line in fin:\n\t\tline=line.strip()\n\t\tif line and line[0] == '>':                #indicates the name of the sequence\n\t\t\tcount+=1\n\t\t\tnames.append(line[1:])\n\t\t\tif count>1:\n\t\t\t\tseqs.append(seq)\n\t\t\tseq=''\n\t\telse: seq +=line\n\tseqs.append(seq)\n\t\n\treturn names, seqs\n\n\nif __name__ == \"__main__\":\n    main()\n",
  "line_no": 85,
  "line_no_percent": "79%"
}