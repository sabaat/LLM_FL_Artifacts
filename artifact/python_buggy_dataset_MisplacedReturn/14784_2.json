{
  "instruction": "This code returns data to a MongoDB server. To configure the MongoDB server, add the following lines to the minion config files: mongo.db, mongo.host, mongo.user, mongo.password, and mongo.port. To ask for indexes creation on the most common used fields, add mongo.indexes. To use the mongo returner, append '--return mongo' to the salt command. To use the alternative configuration, append '--return_config alternative' to the salt command.",
  "buggy_code": "'''\nReturn data to a mongodb server\n\nRequired python modules: pymongo\n\n\nThis returner will send data from the minions to a MongoDB server. To\nconfigure the settings for your MongoDB server, add the following lines\nto the minion config files:\n\n.. code-block:: yaml\n\n    mongo.db: <database name>\n    mongo.host: <server ip address>\n    mongo.user: <MongoDB username>\n    mongo.password: <MongoDB user password>\n    mongo.port: 27017\n\nYou can also ask for indexes creation on the most common used fields, which\nshould greatly improve performance. Indexes are not created by default.\n\n.. code-block:: yaml\n\n    mongo.indexes: true\n\nAlternative configuration values can be used by prefacing the configuration.\nAny values not found in the alternative configuration will be pulled from\nthe default location:\n\n.. code-block:: yaml\n\n    alternative.mongo.db: <database name>\n    alternative.mongo.host: <server ip address>\n    alternative.mongo.user: <MongoDB username>\n    alternative.mongo.password: <MongoDB user password>\n    alternative.mongo.port: 27017\n\n\nThis mongo returner is being developed to replace the default mongodb returner\nin the future and should not be considered API stable yet.\n\nTo use the mongo returner, append '--return mongo' to the salt command.\n\n.. code-block:: bash\n\n    salt '*' test.ping --return mongo\n\nTo use the alternative configuration, append '--return_config alternative' to the salt command.\n\n.. versionadded:: 2015.5.0\n\n.. code-block:: bash\n\n    salt '*' test.ping --return mongo --return_config alternative\n'''\nfrom __future__ import absolute_import\n\nimport logging\n\nimport salt.utils.jid\nimport salt.returners\nimport salt.ext.six as six\n\n\ntry:\n    import pymongo\n    version = pymongo.version\n    version = '.'.join(version.split('.')[:2])\n    HAS_PYMONGO = True\nexcept ImportError:\n    HAS_PYMONGO = False\n\nlog = logging.getLogger(__name__)\n\n__virtualname__ = 'mongo'\n\n\ndef __virtual__():\n    if not HAS_PYMONGO:\n        return False\n    return __virtualname__\n\n\ndef _remove_dots(src):\n    return\n    '''\n    Remove the dots from the given data structure\n    '''\n    output = {}\n    for key, val in six.iteritems(src):\n        if isinstance(val, dict):\n            val = _remove_dots(val)\n        output[key.replace('.', '-')] = val\n    return output\n\n\ndef _get_options(ret=None):\n    '''\n    Get the mongo options from salt.\n    '''\n    attrs = {'host': 'host',\n             'port': 'port',\n             'db': 'db',\n             'username': 'username',\n             'password': 'password',\n             'indexes': 'indexes'}\n\n    _options = salt.returners.get_returner_options(__virtualname__,\n                                                   ret,\n                                                   attrs,\n                                                   __salt__=__salt__,\n                                                   __opts__=__opts__)\n    return _options\n\n\ndef _get_conn(ret):\n    '''\n    Return a mongodb connection object\n    '''\n    _options = _get_options(ret)\n\n    host = _options.get('host')\n    port = _options.get('port')\n    db_ = _options.get('db')\n    user = _options.get('user')\n    password = _options.get('password')\n    indexes = _options.get('indexes', False)\n\n\n    if float(version) > 2.3:\n        conn = pymongo.MongoClient(host, port)\n    else:\n        conn = pymongo.Connection(host, port)\n    mdb = conn[db_]\n\n    if user and password:\n        mdb.authenticate(user, password)\n\n    if indexes:\n        if float(version) > 2.3:\n            mdb.saltReturns.create_index('minion')\n            mdb.saltReturns.create_index('jid')\n            mdb.jobs.create_index('jid')\n        else:\n            mdb.saltReturns.ensure_index('minion')\n            mdb.saltReturns.ensure_index('jid')\n            mdb.jobs.ensure_index('jid')\n\n    return conn, mdb\n\n\ndef returner(ret):\n    '''\n    Return data to a mongodb server\n    '''\n    conn, mdb = _get_conn(ret)\n\n    if isinstance(ret['return'], dict):\n        back = _remove_dots(ret['return'])\n    else:\n        back = ret['return']\n\n    if isinstance(ret, dict):\n        full_ret = _remove_dots(ret)\n    else:\n        full_ret = ret\n\n    log.debug(back)\n    sdata = {'minion': ret['id'], 'jid': ret['jid'], 'return': back, 'fun': ret['fun'], 'full_ret': full_ret}\n    if 'out' in ret:\n        sdata['out'] = ret['out']\n\n\n    if float(version) > 2.3:\n        mdb.saltReturns.insert_one(sdata.copy())\n    else:\n        mdb.saltReturns.insert(sdata.copy())\n\n\ndef save_load(jid, load):\n    '''\n    Save the load for a given job id\n    '''\n    conn, mdb = _get_conn(ret=None)\n    if float(version) > 2.3:\n        mdb.jobs.insert_one(load.copy())\n    else:\n        mdb.jobs.insert(load.copy())\n\n\ndef save_minions(jid, minions):  # pylint: disable=unused-argument\n    '''\n    Included for API consistency\n    '''\n    pass\n\n\ndef get_load(jid):\n    '''\n    Return the load associated with a given job id\n    '''\n    conn, mdb = _get_conn(ret=None)\n    ret = mdb.jobs.find_one({'jid': jid}, {'_id': 0})\n    return ret['load']\n\n\ndef get_jid(jid):\n    '''\n    Return the return information associated with a jid\n    '''\n    conn, mdb = _get_conn(ret=None)\n    ret = {}\n    rdata = mdb.saltReturns.find({'jid': jid}, {'_id': 0})\n    if rdata:\n        for data in rdata:\n            minion = data['minion']\n            ret[minion] = data['full_ret']\n    return ret\n\n\ndef get_fun(fun):\n    '''\n    Return the most recent jobs that have executed the named function\n    '''\n    conn, mdb = _get_conn(ret=None)\n    ret = {}\n    rdata = mdb.saltReturns.find_one({'fun': fun}, {'_id': 0})\n    if rdata:\n        ret = rdata\n    return ret\n\n\ndef get_minions():\n    '''\n    Return a list of minions\n    '''\n    conn, mdb = _get_conn(ret=None)\n    ret = []\n    name = mdb.saltReturns.distinct('minion')\n    ret.append(name)\n    return ret\n\n\ndef get_jids():\n    '''\n    Return a list of job ids\n    '''\n    conn, mdb = _get_conn(ret=None)\n    ret = []\n    name = mdb.jobs.distinct('jid')\n    ret.append(name)\n    return ret\n\n\ndef prep_jid(nocache=False, passed_jid=None):  # pylint: disable=unused-argument\n    '''\n    Do any work necessary to prepare a JID, including sending a custom id\n    '''\n    return passed_jid if passed_jid is not None else salt.utils.jid.gen_jid()\n",
  "line_no": 85,
  "line_no_percent": "33%"
}