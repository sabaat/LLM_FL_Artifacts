{
  "instruction": "The given code is a Python function that downloads GLEAM ET data. The function is named \"DownloadData\" and takes in several parameters such as the directory to save the data, start and end dates, latitude and longitude limits, the number of cores to use, and a waitbar flag. The function checks the start and end dates and sets them if not provided. It then creates an array of days for which the ET data is taken. The function downloads the GLEAM data from the website and returns the data and latitude and longitude in meters of those tiles. It then passes variables to a parallel function and runs it. Finally, the function removes all .nc files.",
  "buggy_code": "\"\"\"\nAuthors: Tim Hessels\n         UNESCO-IHE 2016\nContact: t.hessels@unesco-ihe.org\nRepository: https://github.com/wateraccounting/wa\nModule: Collect/GLEAM\n\"\"\"\n\nimport os\nimport numpy as np\nimport pandas as pd\nimport glob\nfrom joblib import Parallel, delayed\nimport paramiko\nimport calendar\nfrom netCDF4 import Dataset\n\nimport wa.General.data_conversions as DC\nfrom wa import WebAccounts\n\ndef DownloadData(Dir, Startdate, Enddate, latlim, lonlim, Waitbar, cores, TimeCase):\n    \"\"\"\n    This function downloads GLEAM ET data\n\n    Keyword arguments:\n    Dir -- 'C:/file/to/path/'\n    Startdate -- 'yyyy-mm-dd'\n    Enddate -- 'yyyy-mm-dd'\n    latlim -- [ymin, ymax] (values must be between -50 and 50)\n    lonlim -- [xmin, xmax] (values must be between -180 and 180)\n    cores -- The number of cores used to run the routine. It can be 'False'\n             to avoid using parallel computing routines.\n    Waitbar -- 1 (Default) will print a waitbar             \n    \"\"\"\n    if not Startdate:\n        Startdate = pd.Timestamp('2003-01-01')\n    if not Enddate: \n        Enddate = pd.Timestamp('2015-12-31')\n\n    YearsDownloadstart = str(Startdate[0:4])\n    YearsDownloadend = str(Enddate[0:4])\n    Years = range(int(YearsDownloadstart),int(YearsDownloadend)+1)  \n\n    if TimeCase == 'daily':\n        VarCode = 'ET_GLEAM.V3.1b_mm-day-1_daily'\n        FTPprefix = 'data/v3.1b/'\n        TimeFreq = 'D'\n        Folder_name = 'Daily'        \n        \n    elif TimeCase == 'monthly':\n        VarCode = 'ET_GLEAM.V3.1b_mm-month-1_monthly'\n        FTPprefix = 'data/v3.1b/'\n        TimeFreq = 'M'\n        Folder_name = 'Monthly'\n        \n        monthDownloadend = str(Enddate[5:7])\n        End_month = calendar.monthrange(int(YearsDownloadend),int(monthDownloadend))[1]\n        Enddate = '%d-%02d-%d' %(int(YearsDownloadend),int(monthDownloadend),int(End_month)) \n    else:\n        raise KeyError(\"The input time interval is not supported\")\n             \n    Dates = pd.date_range(Startdate, Enddate, freq = TimeFreq)\n   \n    output_folder=os.path.join(Dir,'Evaporation', 'GLEAM', Folder_name)\n    if not os.path.exists(output_folder):\n        os.makedirs(output_folder)\n    \n    if latlim[0] < -50 or latlim[1] > 50:\n        print ('Latitude above 50N or below 50S is not possible.'\n               ' Value set to maximum')\n        latlim[0] = np.max(latlim[0], -50)\n        latlim[1] = np.min(lonlim[1], 50)\n    if lonlim[0] < -180 or lonlim[1] > 180:\n        print ('Longitude must be between 180E and 180W.'\n               ' Now value is set to maximum')\n        lonlim[0] = np.max(latlim[0], -180)\n        lonlim[1] = np.min(lonlim[1], 180)\n\n    try:\n        Collect_data(FTPprefix, Years, output_folder, Waitbar)\n    except:\n        print \"Was not able to download the file\"  \n\n    print '\\nProcess the GLEAM data'\n    if Waitbar == 1:\n        import wa.Functions.Start.WaitbarConsole as WaitbarConsole\n        total_amount = len(Dates)\n        amount = 0\n        WaitbarConsole.printWaitBar(amount, total_amount, prefix = 'Progress:', suffix = 'Complete', length = 50)\n\n    args = [output_folder, latlim, lonlim, VarCode, TimeCase]\n    if not cores:\n        for Date in Dates:\n            RetrieveData(Date, args)\n            if Waitbar == 1:\n                amount += 1\n                WaitbarConsole.printWaitBar(amount, total_amount, prefix = 'Progress:', suffix = 'Complete', length = 50)\n        results = True\n    else:\n        results = Parallel(n_jobs=cores)(delayed(RetrieveData)(Date, args)\n                                         for Date in Dates)\n                               \n    os.chdir(output_folder)\n    files = glob.glob(\"*.nc\")\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n    for f in files:\n        os.remove(os.path.join(output_folder, f))        \n\t\t\t\t\t\t\t\t\t\n\treturn(results)\t\t\n\ndef RetrieveData(Date, args):\n    \"\"\"\n    This function retrieves GLEAM ET data for a given date from the\n    www.gleam.eu server.\n\n    Keyword arguments:\n    Date -- 'yyyy-mm-dd'\n    args -- A list of parameters defined in the DownloadData function.\n    \"\"\"\n    [output_folder, latlim, lonlim, VarCode, TimeCase] = args\n\n    latlim1=[latlim[1]*-1, latlim[0]*-1]\n    \n    Ystart=int(np.floor((latlim1[0]+90)/0.25))\n    Yend=int(np.ceil((latlim1[1]+90)/0.25))\n    Xstart=int(np.floor((lonlim[0]+180)/0.25))\n    Xend=int(np.ceil((lonlim[1]+180)/0.25))    \n       \n    Year=Date.year\n    Month=Date.month   \n    \n    filename='E_' + str(Year) + '_GLEAM_v3.1b.nc'\n    local_filename = os.path.join(output_folder, filename)\n\n    f = Dataset(local_filename,mode='r')\n    \n    if TimeCase == 'monthly':\n\n        Datesend1=str(Date)\n        Datesend2=Datesend1.replace(Datesend1[8:10],\"01\")\n        Datesend3=Datesend2[0:10]\n        Datesend4=Datesend1[0:10]\n        Datestart = pd.date_range(Datesend3,Datesend4,freq = 'MS')\n        \n        DOY=int(Datestart[0].strftime('%j'))\n        DOYend=int(Date.strftime('%j'))\n        DOYDownload=DOY-1\n        Day = 1\n \n        Data = f.variables['E'][DOYDownload:DOYend,Xstart:Xend,Ystart:Yend]\n        data=np.array(Data)\n        f.close()\n\n        dataSum=sum(data,1)\n        dataSum[dataSum<-100]=-999.000\n        dataCor=np.swapaxes(dataSum,0,1)\n       \n    if TimeCase == 'daily':  \n        Day = Date.day    \n\n        DOY=int(Date.strftime('%j'))\n        DOYDownload=DOY-1\n\n        Data = f.variables['E'][DOYDownload,Xstart:Xend,Ystart:Yend]\n        data=np.array(Data)\n        f.close()\n    \n        data[data<-100]=-999.000\n        dataCor=np.swapaxes(data,0,1)\n        \n    geo_in=[lonlim[0], 0.25, 0.0, latlim[1], 0.0, -0.25]   \n\n    dataset_name=VarCode + '_' + str(Year) + '.' + str(Month).zfill(2)  + '.' + str(Day).zfill(2) + '.tif'\n    output_file=os.path.join(output_folder, dataset_name)\n        \n    DC.Save_as_tiff(name=output_file, data=dataCor, geo=geo_in, projection=\"WGS84\")\n\n    return True\n\n    \ndef Collect_data(FTPprefix,Years,output_folder, Waitbar):\n    return\n    '''\n    This function downloads all the needed GLEAM files from hydras.ugent.be as a nc file.\n\n    Keywords arguments:\n    FTPprefix -- FTP path to the GLEAM data\n    Date -- 'yyyy-mm-dd' \t\t\t\t\n    output_folder -- 'C:/file/to/path/'\t\n    '''\n    server='hydras.ugent.be'\n    portnumber=2225\n\n    username, password = WebAccounts.Accounts(Type='GLEAM')\n  \n    print '\\nDownload GLEAM data'\n    if Waitbar == 1:\n        import wa.Functions.Start.WaitbarConsole as WaitbarConsole\n        total_amount2 = len(Years)\n        amount2 = 0\n        WaitbarConsole.printWaitBar(amount2, total_amount2, prefix = 'Progress:', suffix = 'Complete', length = 50)\n\n    \n    for year in Years:\n        directory = os.path.join(FTPprefix, '%d' %year)  \n        ssh=paramiko.SSHClient()\n        ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())\n        ssh.connect(server, port=portnumber, username=username, password=password)\n        ftp=ssh.open_sftp()\n        ftp.chdir(directory)\n    \n        filename='E_' + str(year) + '_GLEAM_v3.1b.nc'\n        local_filename = os.path.join(output_folder, filename)\n        \n        if not os.path.exists(local_filename):\n            ftp.get(filename, local_filename)\n            \n        if Waitbar == 1:       \n            amount2 += 1\n            WaitbarConsole.printWaitBar(amount2, total_amount2, prefix = 'Progress:', suffix = 'Complete', length = 50)\n    \n    \n    ftp.close()\n    ssh.close()\n\t\t\t\t\n    return()\n",
  "line_no": 181,
  "line_no_percent": "80%"
}