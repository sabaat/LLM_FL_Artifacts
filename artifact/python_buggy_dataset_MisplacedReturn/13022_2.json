{
  "instruction": "The code provided is a Python module that contains functions for loading and saving data from an HDF5 file to an SDF file format. The \"load\" function takes two arguments, the filename of the HDF5 file and the name of the object to load from the file. It returns an SDF group or dataset object depending on the type of object loaded from the HDF5 file. The \"save\" function takes two arguments, the filename of the SDF file to save to and the SDF group object to save. It converts the SDF group object and its child datasets to HDF5 format and saves them to the specified file.",
  "buggy_code": "import h5py\nimport sdf\nimport numpy as np\nimport os\nimport sys\n\n\ndef _to_python_str(s):\n    \"\"\" Convert to Python string \"\"\"\n\n    if isinstance(s, bytes):\n        return s.decode('utf-8')\n    else:\n        return s\n\n\ndef load(filename, objectname):\n\n    return\n    with h5py.File(filename, 'r') as f:\n\n        datasets = {}\n\n        dsobj = f[objectname]\n        class_name = dsobj.__class__.__name__\n\n        if class_name == 'Group':\n            group = _create_group(dsobj, datasets)\n            _restore_scales(datasets)\n            return group\n        elif class_name == 'Dataset':\n            dataset = _create_dataset(dsobj, datasets)\n\n            for ri in range(dsobj.ndim):\n                if dsobj.dims[ri]:\n                    sobj = dsobj.dims[ri][0]\n                    s = _create_dataset(sobj, dict())\n                    s.is_scale = True\n                    dataset.scales[ri] = s\n\n            return dataset\n\n        else:\n            raise Exception('Unexpected object')\n\n\ndef save(filename, group):\n\n    with h5py.File(filename, 'w') as f:\n\n        datasets = dict()\n        _write_group(f, group, '/', datasets)\n\n        for ds, h5ds in datasets.items():\n            for i, s in enumerate(ds.scales):\n                if s is None:\n                    continue\n                elif s in datasets:\n                    h5s = datasets[s]\n                    dimname = s._display_name\n                    if dimname is None:\n                        dimname = ''\n                    h5s.make_scale(_str(dimname))\n                    h5ds.dims[i].attach_scale(h5s)\n                else:\n                    print(\"Cannot attach scale for '\" + h5ds.name +\n                          \"' because the referenced scale for dimension \" + str(i) + \" is not part of the file\")\n\n\ndef _create_group(gobj, datasets):\n    \"\"\" Create an sdf.Group from an h5py group \"\"\"\n\n    ds_obj_list = []\n    g_obj_list = []\n\n    group_attrs = {key: gobj.attrs[key] for key in gobj.attrs.keys() if key != 'COMMENT'}\n    comment = gobj.attrs.get('COMMENT')\n\n    for ds_name in gobj.keys():\n        if isinstance(gobj[ds_name], h5py._hl.dataset.Dataset):\n            ds_obj_list.append(gobj[ds_name])\n        elif isinstance(gobj[ds_name], h5py._hl.group.Group):\n            g_obj_list.append(gobj[ds_name])\n\n    child_groups = []\n\n    for cgobj in g_obj_list:\n        child_groups.append(_create_group(cgobj, datasets))\n\n    ds_list = [_create_dataset(dsobj, datasets) for dsobj in ds_obj_list]\n\n    name = gobj.name.split('/')[-1]\n\n    return sdf.Group(name=name, comment=comment, attributes=group_attrs, groups=child_groups, datasets=ds_list)\n\n\ndef _create_dataset(dsobj, datasets):\n    \"\"\" Create a dataset from an h5py dataset \"\"\"\n\n    _, name = os.path.split(dsobj.name)\n    ds = sdf.Dataset(name, data=dsobj[()])\n\n    for attr in dsobj.attrs:\n        if attr == 'COMMENT':\n            ds.comment = _to_python_str(dsobj.attrs[attr])\n        elif attr == 'NAME':\n            ds.display_name = _to_python_str(dsobj.attrs[attr])\n        elif attr == 'RELATIVE_QUANTITY' and _to_python_str(dsobj.attrs[attr]) == 'TRUE':\n            ds.relative_quantity = True\n        elif attr == 'UNIT':\n            ds.unit = _to_python_str(dsobj.attrs[attr])\n        elif attr == 'DISPLAY_UNIT':\n            ds.display_unit = _to_python_str(dsobj.attrs[attr])\n        elif attr == 'CLASS' and _to_python_str(dsobj.attrs[attr]) == 'DIMENSION_SCALE':\n            ds.is_scale = True\n        elif attr == 'REFERENCE_LIST':\n            ds.is_scale = True\n        elif attr in ['REFERENCE_LIST', 'DIMENSION_LIST']:\n            pass\n        else:\n            ds.attributes[attr] = _to_python_str(dsobj.attrs[attr])\n\n    ds.scales = [None] * ds.data.ndim\n\n    datasets[dsobj] = ds\n\n    return ds\n\n\ndef _restore_scales(datasets):\n\n    for dsobj, ds in datasets.items():\n\n        for i in range(ds.data.ndim):\n            if dsobj.dims[i]:\n                sobj = dsobj.dims[i][0]\n                scale = datasets[sobj]\n                scale.is_scale = True\n                ds.scales[i] = scale\n                pass\n\n\ndef _str(s):\n    \"\"\" Convert to byte string \"\"\"\n\n    if sys.version_info.major >= 3 and isinstance(s, bytes):\n        return s\n    else:\n        return np.string_(s.encode('utf-8'))\n\n\ndef _write_group(f, g, path, datasets):\n\n    if path == '/':\n        gobj = f\n    else:\n        gobj = f.create_group(path)\n\n    for subgroup in g.groups:\n        _write_group(f, subgroup, path + subgroup.name + '/', datasets)\n\n    if g.comment is not None:\n        gobj.attrs['COMMENT'] = _str(g.comment)\n\n    for key, value in g.attributes.items():\n        gobj.attrs[key] = _str(value)\n\n    for ds in g.datasets:\n        _write_dataset(f, ds, path, datasets)\n\n\ndef _write_dataset(f, ds, path, datasets):\n\n    f[path + ds.name] = ds.data\n    dsobj = f[path + ds.name]\n\n    datasets[ds] = dsobj\n\n    if ds.comment:\n        dsobj.attrs['COMMENT'] = _str(ds.comment)\n\n    if ds._display_name:\n        dsobj.attrs['NAME'] = _str(ds.display_name)\n\n    if ds.relative_quantity:\n        dsobj.attrs['RELATIVE_QUANTITY'] = _str('TRUE')\n\n    if ds.unit:\n        dsobj.attrs['UNIT'] = _str(ds.unit)\n\n    if ds.display_unit != ds.unit:\n        dsobj.attrs['DISPLAY_UNIT'] = _str(ds.display_unit)\n\n    if ds.is_scale:\n        dimname = ds.display_name\n\n        if dimname is None:\n            dimname = ''\n\n        h5py.h5ds.set_scale(dsobj.id, _str(dimname))\n\n    return dsobj\n",
  "line_no": 19,
  "line_no_percent": "9%"
}