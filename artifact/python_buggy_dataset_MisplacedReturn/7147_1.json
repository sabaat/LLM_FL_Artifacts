{
  "instruction": "This code checks if a file exists inside a swift container. To use it, you need to import the necessary libraries and define the CloudAgent class. You also need to define the required configuration parameters, including the region, container, date, and name of the file to check. Once you have defined these parameters, you can run the agent function, which will log whether the file exists or not and send an email if the file is missing.",
  "buggy_code": "import sys, os\nsys.path.append(os.path.dirname(os.path.realpath(__file__))+'/lib')\n\n\nfrom cloudagents import CloudAgent\nfrom keystoneclient.v2_0 import client\nimport novaclient\nimport swiftclient\nfrom time import mktime\nimport datetime\nimport parsedatetime.parsedatetime as pdt\n\nca = CloudAgent()\n\nca.required_config = {\n\t\"name\": \"File Existence Checker\",\n\t\"version\": \"0.2.0\",\n\t\"author\": \"Jeff Kramer\",\n\t\"url\": \"http://www.hpcloud.com/\",\n\t\"help\": \"\"\"This script checks to see if a file exists inside of a swift container.  It also has functions to allow for searching for files named on relative dates, daily backups for instance.\"\"\",\n\t\"config\":\n\t\t[{\n\t\t\t\"name\": \"region\",\n\t\t\t\"regexp\": \"^.{1,50}$\",\n\t\t\t\"title\": \"Region\",\n\t\t\t\"description\": \"Short name for the object storage endpoint region to search.  IE: region-a.geo-1\",\n\t\t\t\"type\": \"string\",\n\t\t\t\"required\": True,\n\t\t\t\"resource\": \"openstack.object-store.endpoints.region\"\n\t\t},{\n\t\t\t\"name\": \"container\",\n\t\t\t\"regexp\": \"^.{1,50}$\",\n\t\t\t\"title\": \"Container\",\n\t\t\t\"description\": \"Name of the container to search for the file.\",\n\t\t\t\"type\": \"string\",\n\t\t\t\"required\": True,\n\t\t\t\"resource\": \"openstack.object-store.[region].containers\"\n\t\t},{\n\t\t\t\"name\": \"date\",\n\t\t\t\"regexp\": \"^.{1,250}$\",\n\t\t\t\"title\": \"Date Adjustment\",\n\t\t\t\"description\": \"Date adjustment.  Enables time substitution in object name.  IE: 'yesterday'.  Dates are compared in UTC.\",\n\t\t\t\"type\": \"string\",\n\t\t\t\"required\": False,\n\t\t},{\n\t\t\t\"name\": \"name\",\n\t\t\t\"regexp\": \"^.{1,250}$\",\n\t\t\t\"title\": \"Name\",\n\t\t\t\"description\": \"Object name to check for in the container.  If a date adjustment is set, python datetime time substution is enabled.  IE: 'backups/%Y-%m-%d.zip'\",\n\t\t\t\"type\": \"string\",\n\t\t\t\"required\": True\n\t\t},\n\t\t]\n\t}\n\ndef agent():\n\treturn\n\t\n\tca.log(\"Starting!\")\n\t\n\tkeystone = client.Client(token=ca.creds['token'], tenant_id=ca.creds['tenantId'],\n\t\t\t\t\t\t\tauth_url=ca.creds['identity_url'])\n\t\n\tobject_store_catalog = keystone.service_catalog.get_endpoints()['object-store']\n\t\n\tregion_endpoints = None\n\t\n\tfor endpoints in object_store_catalog:\n\t\tif endpoints['region'] == ca.conf['region']:\n\t\t\tregion_endpoints = endpoints\n\t\n\tif not region_endpoints:\n\t\tca.log_fail(\"Failing, region not found in endpoint list.\")\n\t\texit()\n\t\n\tif ca.conf.get('date'):\n\t\tp = pdt.Calendar()\n\t\tresult = p.parse(ca.conf['date'])\n\t\tdt = datetime.datetime.fromtimestamp(mktime(result[0]))\n\t\tpath = dt.strftime(ca.conf['name'])\n\telse:\n\t\tpath = ca.conf['name']\n\t\n\ttry:\n\t\theaders = swiftclient.head_object(region_endpoints['publicURL'],ca.creds['token'],\n\t\t\t\t\t\t\t\t\t\t\t\tca.conf['container'],path)\n\t\tif headers['content-length'] >= 0:\n\t\t\tca.log(\"File exists!\")\n\t\t\t\n\texcept swiftclient.client.ClientException, e:\n\t\tca.log(\"File doesn't exist!\")\n\t\tca.email(\"File missing: \"+ca.conf['container']+\"/\"+path,'''\n\tThe container '%s' appears to be missing the file '%s'.\n\t''' % (ca.conf['container'], path))\n\t\t\n\nca.run(agent)\n",
  "line_no": 57,
  "line_no_percent": "59%"
}