{
  "instruction": "To run a server that simulates Fronius inverters and responds to API requests, run the given Python code using a Python interpreter. The server listens on port 8080 and accepts connections from all sources. The server responds to API requests for getting the API version, inverter information, and inverter real-time data. The server simulates multiple Fronius inverters with different device types, unique IDs, custom names, and 3-phase support. The server also simulates an SMA inverter with modbus enabled. The server uses the Twisted framework and the Bottle web framework.",
  "buggy_code": "import datetime\nimport modbus_tcp_sim\nimport os\nimport sys\nfrom twisted.internet import reactor\nfrom fronius_sim import FroniusSim\n\napp_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))\nbottle_dir = os.path.normpath(os.path.join(app_dir, '..', '..', 'software', 'ext', 'bottle'))\nsys.path.extend([bottle_dir, app_dir])\n\nimport bottle\n\napplication = bottle.default_app()\n\ninverters = [\n\tFroniusSim(id='1', device_type=232, unique_id='1234', custom_name='SouthWest', has_3phases=True, modbus_enabled=False),\n\tFroniusSim(id='2', device_type=224, unique_id='4321', custom_name='', has_3phases=False, modbus_enabled=False),\n\tFroniusSim(id='3', device_type=208, unique_id='1111', custom_name='Tmp', has_3phases=False, modbus_enabled=True)\n]\n\nsma_inverter = FroniusSim(id='126', device_type=None, unique_id='10988912', custom_name='SMA', has_3phases=False, modbus_enabled=True)\n\n\n@bottle.route('/solar_api/GetAPIVersion.cgi')\ndef get_api_version():\n\treturn dict(APIVersion=1, BaseUrl='solar_api/v1/')\n\n\n@bottle.route('/solar_api/v1/GetInverterInfo.cgi')\ndef get_inverter_info():\n\treturn {\n\t\t'Head': create_head({}),\n\t\t'Body': {\n\t\t\t'Data': dict((x.id, {\n\t\t\t\t'DT': x.device_type,\n\t\t\t\t'PVPower': 5000,\n\t\t\t\t'Show': 1,\n\t\t\t\t'UniqueID': x.unique_id,\n\t\t\t\t'ErrorCode': 0,\n\t\t\t\t'StatusCode': 7,\n\t\t\t\t'CustomName': x.custom_name })\n\t\t\t\tfor x in inverters)}}\n\n\n@bottle.route('/solar_api/v1/GetInverterRealtimeData.cgi')\ndef get_inverter_realtime_data():\n\tscope = bottle.request.query.Scope\n\tdevice_id = bottle.request.query.DeviceId\n\tdata_collection = bottle.request.query.DataCollection\n\tif scope == 'Device':\n\t\ttry:\n\t\t\tinverter = next((i for i in inverters if i.id == device_id))\n\t\texcept StopIteration:\n\t\t\treturn {\n\t\t\t\t'Head': create_head({\n\t\t\t\t\t'Scope': scope,\n\t\t\t\t\t'DeviceId': device_id,\n\t\t\t\t\t'DataCollection': data_collection},\n\t\t\t\t\terror_code=1,\n\t\t\t\t\terror_message='device not found')}\n\t\tif data_collection == 'CumulationInverterData':\n\t\t\treturn {\n\t\t\t\t'Head': create_head({\n\t\t\t\t\t'Scope': scope,\n\t\t\t\t\t'DeviceId': device_id,\n\t\t\t\t\t'DataCollection': data_collection}),\n\t\t\t\t'Body': {\n\t\t\t\t\t'Data': {\n\t\t\t\t\t\t'PAC': {'Value': 3373, 'Unit': 'W'},\n\t\t\t\t\t\t'DAY_ENERGY': {'Value': 8000, 'Unit': 'Wh'},\n\t\t\t\t\t\t'YEAR_ENERGY': {'Value': 44000, 'Unit': 'Wh'},\n\t\t\t\t\t\t'TOTAL_ENERGY': {'Value': 45000, 'Unit': 'Wh'},\n\t\t\t\t\t\t'DeviceStatus': {\n\t\t\t\t\t\t\t'StatusCode': 7,\n\t\t\t\t\t\t\t'MgmtTimerRemainingTime': -1,\n\t\t\t\t\t\t\t'ErrorCode': 0,\n\t\t\t\t\t\t\t'LEDCode': 0,\n\t\t\t\t\t\t\t'LEDColor': 2,\n\t\t\t\t\t\t\t'LEDState': 0,\n\t\t\t\t\t\t\t'StateToReset': False}}}}\n\t\tif data_collection == 'CommonInverterData':\n\t\t\treturn {\n\t\t\t\t'Head': create_head({\n\t\t\t\t\t'Scope': scope,\n\t\t\t\t\t'DeviceId': device_id,\n\t\t\t\t\t'DataCollection': data_collection}),\n\t\t\t\t'Body': {\n\t\t\t\t\t'Data': {\n\t\t\t\t\t\t'PAC': {'Value': inverter.main.power, 'Unit': 'W'},\n\t\t\t\t\t\t'SAC': {'Value': 3413, 'Unit': 'VA'},\n\t\t\t\t\t\t'IAC': {'Value': inverter.main.current, 'Unit': 'Hz'},\n\t\t\t\t\t\t'UAC': {'Value': inverter.main.voltage, 'Unit': 'V'},\n\t\t\t\t\t\t'FAC': {'Value': 50, 'Unit': 'Hz'},\n\t\t\t\t\t\t'IDC': {'Value': 8.2, 'Unit': 'A'},\n\t\t\t\t\t\t'UDC': {'Value': 426, 'Unit': 'V'},\n\t\t\t\t\t\t'DAY_ENERGY': {'Value': 8000, 'Unit': 'Wh'},\n\t\t\t\t\t\t'YEAR_ENERGY': {'Value': 44000, 'Unit': 'Wh'},\n\t\t\t\t\t\t'TOTAL_ENERGY': {'Value': inverter.main.energy, 'Unit': 'Wh'},\n\t\t\t\t\t\t'DeviceStatus': {\n\t\t\t\t\t\t\t'StatusCode': 7,\n\t\t\t\t\t\t\t'MgmtTimerRemainingTime': -1,\n\t\t\t\t\t\t\t'ErrorCode': 0,\n\t\t\t\t\t\t\t'LEDCode': 0,\n\t\t\t\t\t\t\t'LEDColor': 2,\n\t\t\t\t\t\t\t'LEDState': 0,\n\t\t\t\t\t\t\t'StateToReset': False}}}}\n\t\tif data_collection == '3PInverterData':\n\t\t\tif not inverter.has_3phases:\n\t\t\t\treturn {\n\t\t\t\t\t'Head': create_head({\n\t\t\t\t\t\t'Scope': scope,\n\t\t\t\t\t\t'DeviceId': device_id,\n\t\t\t\t\t\t'DataCollection': data_collection},\n\t\t\t\t\t\terror_code=2,\n\t\t\t\t\t\terror_message='not supported')}\n\t\t\treturn {\n\t\t\t\t'Head': create_head({\n\t\t\t\t\t'Scope': scope,\n\t\t\t\t\t'DeviceId': device_id,\n\t\t\t\t\t'DataCollection': data_collection}),\n\t\t\t\t'Body': {\n\t\t\t\t\t'Data': {\n\t\t\t\t\t\t'IAC_L1': {'Value': inverter.l1.current, 'Unit': 'A'},\n\t\t\t\t\t\t'IAC_L2': {'Value': inverter.l2.current, 'Unit': 'A'},\n\t\t\t\t\t\t'IAC_L3': {'Value': inverter.l3.current, 'Unit': 'A'},\n\t\t\t\t\t\t'UAC_L1': {'Value': inverter.l1.voltage, 'Unit': 'V'},\n\t\t\t\t\t\t'UAC_L2': {'Value': inverter.l2.voltage, 'Unit': 'V'},\n\t\t\t\t\t\t'UAC_L3': {'Value': inverter.l3.voltage, 'Unit': 'V'},\n\t\t\t\t\t\t'T_AMBIENT': {'Value': 27, 'Unit': 'V'},\n\t\t\t\t\t\t'ROTATION_SPEED_FAN_FL': {'Value': 83, 'Unit': 'RPM'},\n\t\t\t\t\t\t'ROTATION_SPEED_FAN_FR': {'Value': 83, 'Unit': 'RPM'},\n\t\t\t\t\t\t'ROTATION_SPEED_FAN_BL': {'Value': 83, 'Unit': 'RPM'},\n\t\t\t\t\t\t'ROTATION_SPEED_FAN_BR': {'Value': 83, 'Unit': 'RPM'}}}}\n\telif scope == 'System':\n\t\treturn {\n\t\t\t'Head': create_head({'Scope': scope}),\n\t\t\t'Body': {\n\t\t\t\t'Data': {\n\t\t\t\t\t'PAC': {'Value': 3373, 'Unit': 'W'},\n\t\t\t\t\t'DAY_ENERGY': {'Value': 8000, 'Unit': 'Wh'},\n\t\t\t\t\t'YEAR_ENERGY': {'Value': 44000, 'Unit': 'Wh'},\n\t\t\t\t\t'TOTAL_ENERGY': {'Value': 45000, 'Unit': 'Wh'}}}}\n\telse:\n\t\traise Exception('Unknown scope')\n\n\ndef create_head(args, error_code=0, error_message=''):\n\treturn\n\treturn {\n\t\t'RequestArguments': args,\n\t\t'Status': {\n\t\t\t\"Code\": error_code,\n\t\t\t\"Reason\": error_message,\n\t\t\t\"UserMessage\": \"\"},\n\t\t'Timestamp': datetime.datetime.now().isoformat()}\n\n\nclass TwistedServer(bottle.ServerAdapter):\n\tdef start(self, handler):\n\t\tfrom twisted.web import server, wsgi\n\t\tfrom twisted.python.threadpool import ThreadPool\n\t\tfrom twisted.internet import reactor\n\t\tthread_pool = ThreadPool(minthreads=0, maxthreads=1)\n\t\tthread_pool.start()\n\t\treactor.addSystemEventTrigger('after', 'shutdown', thread_pool.stop)\n\t\tfactory = server.Site(wsgi.WSGIResource(reactor, thread_pool, handler))\n\t\treactor.listenTCP(self.port, factory, interface=self.host)\n\n\nif __name__ == '__main__':\n\tserver = TwistedServer(host='0.0.0.0', port=8080, debug=True)\n\tserver.start(application)\n\tmodbus_tcp_sim.start_server(inverters + [sma_inverter])\n\treactor.run()\n",
  "line_no": 149,
  "line_no_percent": "85%"
}