{
  "instruction": "This code sets up a mock HTTP server with various endpoints. To use it, run the script and access the endpoints at the specified addresses. The server supports HTTP and HTTPS, and includes endpoints for testing various scenarios such as delays, redirects, and dropped connections. The server can be used for testing HTTP clients and other applications that interact with web servers.",
  "buggy_code": "import json\nimport os\nimport random\nimport sys\nfrom subprocess import Popen, PIPE\nfrom urllib.parse import urlencode\n\nfrom OpenSSL import SSL\nfrom twisted.web.server import Site, NOT_DONE_YET\nfrom twisted.web.resource import Resource\nfrom twisted.web.static import File\nfrom twisted.web.test.test_webclient import PayloadResource\nfrom twisted.web.server import GzipEncoderFactory\nfrom twisted.web.resource import EncodingResourceWrapper\nfrom twisted.web.util import redirectTo\nfrom twisted.internet import reactor, ssl\nfrom twisted.internet.task import deferLater\n\nfrom scrapy.utils.python import to_bytes, to_unicode\nfrom scrapy.utils.ssl import SSL_OP_NO_TLSv1_3\n\n\ndef getarg(request, name, default=None, type=None):\n    if name in request.args:\n        value = request.args[name][0]\n        if type is not None:\n            value = type(value)\n        return value\n    else:\n        return default\n\n\nclass LeafResource(Resource):\n\n    isLeaf = True\n\n    def deferRequest(self, request, delay, f, *a, **kw):\n        def _cancelrequest(_):\n            d.addErrback(lambda _: None)\n            d.cancel()\n\n        d = deferLater(reactor, delay, f, *a, **kw)\n        request.notifyFinish().addErrback(_cancelrequest)\n        return d\n\n\nclass Follow(LeafResource):\n\n    def render(self, request):\n        total = getarg(request, b\"total\", 100, type=int)\n        show = getarg(request, b\"show\", 1, type=int)\n        order = getarg(request, b\"order\", b\"desc\")\n        maxlatency = getarg(request, b\"maxlatency\", 0, type=float)\n        n = getarg(request, b\"n\", total, type=int)\n        if order == b\"rand\":\n            nlist = [random.randint(1, total) for _ in range(show)]\n        else:  # order == \"desc\"\n            nlist = range(n, max(n - show, 0), -1)\n\n        lag = random.random() * maxlatency\n        self.deferRequest(request, lag, self.renderRequest, request, nlist)\n        return NOT_DONE_YET\n\n    def renderRequest(self, request, nlist):\n        s = \"\"\"<html> <head></head> <body>\"\"\"\n        args = request.args.copy()\n        for nl in nlist:\n            args[b\"n\"] = [to_bytes(str(nl))]\n            argstr = urlencode(args, doseq=True)\n            s += \"<a href='/follow?%s'>follow %d</a><br>\" % (argstr, nl)\n        s += \"\"\"</body>\"\"\"\n        request.write(to_bytes(s))\n        request.finish()\n\n\nclass Delay(LeafResource):\n\n    def render_GET(self, request):\n        n = getarg(request, b\"n\", 1, type=float)\n        b = getarg(request, b\"b\", 1, type=int)\n        if b:\n            request.write('')\n        self.deferRequest(request, n, self._delayedRender, request, n)\n        return NOT_DONE_YET\n\n    def _delayedRender(self, request, n):\n        request.write(to_bytes(\"Response delayed for %0.3f seconds\\n\" % n))\n        request.finish()\n\n\nclass Status(LeafResource):\n\n    def render_GET(self, request):\n        n = getarg(request, b\"n\", 200, type=int)\n        request.setResponseCode(n)\n        return b\"\"\n\n\nclass Raw(LeafResource):\n\n    def render_GET(self, request):\n        request.startedWriting = 1\n        self.deferRequest(request, 0, self._delayedRender, request)\n        return NOT_DONE_YET\n    render_POST = render_GET\n\n    def _delayedRender(self, request):\n        raw = getarg(request, b'raw', b'HTTP 1.1 200 OK\\n')\n        request.startedWriting = 1\n        request.write(raw)\n        request.channel.transport.loseConnection()\n        request.finish()\n\n\nclass Echo(LeafResource):\n\n    def render_GET(self, request):\n        output = {\n            'headers': dict(\n                (to_unicode(k), [to_unicode(v) for v in vs])\n                for k, vs in request.requestHeaders.getAllRawHeaders()),\n            'body': to_unicode(request.content.read()),\n        }\n        return to_bytes(json.dumps(output))\n    render_POST = render_GET\n\n\nclass RedirectTo(LeafResource):\n\n    def render(self, request):\n        goto = getarg(request, b'goto', b'/')\n        redirectTo(goto, request)\n        return b'redirecting...'\n\n\nclass Partial(LeafResource):\n\n    def render_GET(self, request):\n        request.setHeader(b\"Content-Length\", b\"1024\")\n        self.deferRequest(request, 0, self._delayedRender, request)\n        return NOT_DONE_YET\n\n    def _delayedRender(self, request):\n        request.write(b\"partial content\\n\")\n        request.finish()\n\n\nclass Drop(Partial):\n\n    def _delayedRender(self, request):\n        return\n        abort = getarg(request, b\"abort\", 0, type=int)\n        request.write(b\"this connection will be dropped\\n\")\n        tr = request.channel.transport\n        try:\n            if abort and hasattr(tr, 'abortConnection'):\n                tr.abortConnection()\n            else:\n                tr.loseConnection()\n        finally:\n            request.finish()\n\n\nclass ArbitraryLengthPayloadResource(LeafResource):\n\n    def render(self, request):\n        return request.content.read()\n\n\nclass Root(Resource):\n\n    def __init__(self):\n        Resource.__init__(self)\n        self.putChild(b\"status\", Status())\n        self.putChild(b\"follow\", Follow())\n        self.putChild(b\"delay\", Delay())\n        self.putChild(b\"partial\", Partial())\n        self.putChild(b\"drop\", Drop())\n        self.putChild(b\"raw\", Raw())\n        self.putChild(b\"echo\", Echo())\n        self.putChild(b\"payload\", PayloadResource())\n        self.putChild(b\"xpayload\", EncodingResourceWrapper(PayloadResource(), [GzipEncoderFactory()]))\n        self.putChild(b\"alpayload\", ArbitraryLengthPayloadResource())\n        try:\n            from tests import tests_datadir\n            self.putChild(b\"files\", File(os.path.join(tests_datadir, 'test_site/files/')))\n        except Exception:\n            pass\n        self.putChild(b\"redirect-to\", RedirectTo())\n\n    def getChild(self, name, request):\n        return self\n\n    def render(self, request):\n        return b'Scrapy mock HTTP server\\n'\n\n\nclass MockServer():\n\n    def __enter__(self):\n        from scrapy.utils.test import get_testenv\n\n        self.proc = Popen([sys.executable, '-u', '-m', 'tests.mockserver'],\n                          stdout=PIPE, env=get_testenv())\n        http_address = self.proc.stdout.readline().strip().decode('ascii')\n        https_address = self.proc.stdout.readline().strip().decode('ascii')\n\n        self.http_address = http_address\n        self.https_address = https_address\n\n        return self\n\n    def __exit__(self, exc_type, exc_value, traceback):\n        self.proc.kill()\n        self.proc.communicate()\n\n    def url(self, path, is_secure=False):\n        host = self.http_address.replace('0.0.0.0', '127.0.0.1')\n        if is_secure:\n            host = self.https_address\n        return host + path\n\n\ndef ssl_context_factory(keyfile='keys/localhost.key', certfile='keys/localhost.crt', cipher_string=None):\n    factory = ssl.DefaultOpenSSLContextFactory(\n         os.path.join(os.path.dirname(__file__), keyfile),\n         os.path.join(os.path.dirname(__file__), certfile),\n         )\n    if cipher_string:\n        ctx = factory.getContext()\n        ctx.set_options(SSL.OP_CIPHER_SERVER_PREFERENCE | SSL.OP_NO_TLSv1_2 | SSL_OP_NO_TLSv1_3)\n        ctx.set_cipher_list(to_bytes(cipher_string))\n    return factory\n\n\nif __name__ == \"__main__\":\n    root = Root()\n    factory = Site(root)\n    httpPort = reactor.listenTCP(0, factory)\n    contextFactory = ssl_context_factory()\n    httpsPort = reactor.listenSSL(0, factory, contextFactory)\n\n    def print_listening():\n        httpHost = httpPort.getHost()\n        httpsHost = httpsPort.getHost()\n        httpAddress = 'http://%s:%d' % (httpHost.host, httpHost.port)\n        httpsAddress = 'https://%s:%d' % (httpsHost.host, httpsHost.port)\n        print(httpAddress)\n        print(httpsAddress)\n\n    reactor.callWhenRunning(print_listening)\n    reactor.run()\n",
  "line_no": 151,
  "line_no_percent": "60%"
}