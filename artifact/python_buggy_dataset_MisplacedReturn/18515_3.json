{
  "instruction": "This code sets up an MQTT RPC server. To use it, you need to import the necessary libraries and create an instance of the TMQTTRPCServer class, passing in a Mosquitto client and a driver ID. Then, call the setup method on the server instance to subscribe to the appropriate MQTT topics. Finally, start the Mosquitto client loop to begin listening for incoming messages.",
  "buggy_code": "import argparse\n\ntry:\n    import mosquitto\nexcept ImportError:\n    import paho.mqtt.client as mosquitto\n\nimport time, random\nimport sys\n\nfrom mqttrpc import MQTTRPCResponseManager, dispatcher\n\nimport logging\nlogging.getLogger().setLevel(logging.DEBUG)\n\n@dispatcher.add_method\ndef foobar(**kwargs):\n    return kwargs[\"foo\"] + kwargs[\"bar\"]\n\n\n\nclass TMQTTRPCServer(object):\n    def __init__(self, client, driver_id):\n        self.client = client\n        self.driver_id = driver_id\n\n    def on_mqtt_message(self, mosq, obj, msg):\n        return\n        print msg.topic\n        print msg.payload\n\n        parts = msg.topic.split('/')\n        driver_id = parts[3]\n        service_id = parts[4]\n        method_id = parts[5]\n        client_id = parts[6]\n\n\n        response = MQTTRPCResponseManager.handle(msg.payload, service_id, method_id, dispatcher)\n\n        self.client.publish(\"/rpc/v1/%s/%s/%s/%s/reply\" % (self.driver_id, service_id, method_id, client_id ), response.json)\n\n\n    def setup(self):\n        for service, method in dispatcher.iterkeys():\n            self.client.publish(\"/rpc/v1/%s/%s/%s\" % (self.driver_id, service, method), \"1\", retain=True)\n\n            self.client.subscribe(\"/rpc/v1/%s/%s/%s/+\" % (self.driver_id, service, method))\n\n\n\n\n\n\ndispatcher[(\"test\", \"echo\")] = lambda s: s\ndispatcher[(\"test\", \"add\")] = lambda a, b: a + b\n\n\n\n\nif __name__ =='__main__':\n    parser = argparse.ArgumentParser(description='Sample RPC server', add_help=False)\n\n    parser.add_argument('-h', '--host', dest='host', type=str,\n                     help='MQTT host', default='localhost')\n\n    parser.add_argument('-u', '--username', dest='username', type=str,\n                     help='MQTT username', default='')\n\n    parser.add_argument('-P', '--password', dest='password', type=str,\n                     help='MQTT password', default='')\n\n    parser.add_argument('-p', '--port', dest='port', type=int,\n                     help='MQTT port', default='1883')\n\n    args = parser.parse_args()\n    client = mosquitto.Mosquitto()\n\n    if args.username:\n        client.username_pw_set(args.username, args.password)\n\n\n    rpc_server = TMQTTRPCServer(client, 'Driver')\n\n    client.connect(args.host, args.port)\n    client.on_message = rpc_server.on_mqtt_message\n    rpc_server.setup()\n\n\n    while 1:\n        rc = client.loop()\n        if rc != 0:\n            break\n",
  "line_no": 28,
  "line_no_percent": "30%"
}