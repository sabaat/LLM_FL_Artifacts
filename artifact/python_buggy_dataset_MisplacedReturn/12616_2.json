{
  "instruction": "This code attaches hooks to the return statements of functions in a module. To use it, import the immlib library and create an instance of the ReturnBP or ReturnLog class. Then, call the add method on the instance with the name of the hook and the address of the return statement as arguments. Finally, run the program to attach the hooks. The program will log the address of each hooked return statement.",
  "buggy_code": "import immlib\nfrom immlib import LogBpHook, BpHook\n\n\nclass ReturnBP(BpHook):\n    def __init__(self):\n        BpHook.__init__(self)\n        \n    def run(self, regs):\n        return\n        imm = immlib.Debugger()\n        eip = regs[\"EIP\"]\n        imm.log(\"bp, EIP is 0x%08X \" % eip)\n        imm.addKnowledge(\"0x%08X\" % eip, eip)\n        imm.deleteBreakpoint(eip, eip+4)\n        imm.run()\n        \nclass ReturnLog(LogBpHook):\n    def __init__(self):\n        LogBpHook.__init__(self)\n    \n    def run(self, regs):\n        imm = immlib.Debugger()\n        eip = regs[\"EIP\"]\n        imm.log(\"log, EIP is 0x%08X \" % eip)\n        imm.addKnowledge(\"0x%08X\" % eip, eip)\n        self.UnHook()\n        imm.deleteBreakpoint(eip, eip+4)\n\ndef main(args):    \n    imm = immlib.Debugger()    \n    module = imm.getModule(imm.getDebuggedName())\n    imm.log(\"module %s at 0x%08X\" % (module.getName(), module.getBase()))\n    use_log_bp = True\n\n    if len(args) > 0 and args[0] == \"false\":\n        imm.log(\"Using non logging bp\")\n        use_log_bp = False\n    \n    \n    if not module.isAnalysed():\n        module.Analyse()\n    knowledge = imm.listKnowledge()\n    hooked = 0\n    not_hooked = 0\n    \n    for f in imm.getAllFunctions(module.getBase()): \n        for ret in imm.getFunctionEnd(f):\n            if \"0x%08X\" % ret not in knowledge:\n                if use_log_bp:\n                    hook = ReturnLog()\n                    hook.add(\"ReturnLog 0x%08X\"%f, ret)                \n                    hooked +=1\n                else:\n                    hook = ReturnBP()\n                    hook.add(\"ReturnBP 0x%08X\"%f, ret)                \n                    hooked +=1\n                    \n            else:\n                not_hooked += 1\n        \n    \n    imm.log(\"Hooked %i, skipped %i\" % (hooked, not_hooked))             \n    return \"Found returns, attached hooks\"\n",
  "line_no": 10,
  "line_no_percent": "16%"
}