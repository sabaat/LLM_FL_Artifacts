{
  "instruction": "The code is a Python script that defines a function to create a SQL atomic query using parsed components from a URL payload. The function takes in key_type, key, comparator, value, comparator_date, and value_date as arguments and returns the atomic query. To use the function, call it with the appropriate arguments.",
  "buggy_code": "from sqlalchemy import between\nfrom sqlalchemy.sql import and_, label\n\nfrom app import db, models\n\nimport htsql_methods as hsql\n\nClinical = models.ClinicalData\nAttribute = models.Attribute\n\n\"\"\"\nExample SQL atomic query for modified nested model:\n\n select *\n     from\n     clinical_data\n     (select patient_sid, lft, rgt, a.attribute_id\n     from clinical_data\n     where attribute_id = 'ID FOR DEMOGRAPHICS') ldl\n     on\n     cd.patient_sid = ldl.patient_sid\n     and\n     cd.lft >= ldl.lft\n     and\n     cd.rgt <= ldl.rgt\n\n     Procedure creates an atomic query, defined by:\n     i%2 = 0 -> initial subquery of bucket/attribute\n\n     From above example, the initial subquery that pulls the bucket:\n\n     select patient_sid, lft, rgt, attribute_id\n     from clinical_data\n     where attribute_id = 'ID FOR DEMOGRAPHICS')\n\n     1%2 != 0 -> drill down to specific bucket attribute\n\n     URL comprised of a single atom will look like:\n\n     atom: demographics:'id for demographics';eq;demographics;demographics:'id for sex';eq;M\n\n     NB: this is attached to incoming requests as a JSON document\n\n     element part 1: bucket\n     type:key -> demographics:attribute.id for attribute.value = demographics\n     comparator -> eq\n     attribute value (bucket) -> demographics\n     element part 2: bucket item\n     type:key -> demographics:attribute.id for attribute.value = sex\n     comparator -> eq\n     attribute value -> M\n\n     molecule made up of two atoms: (test_code:'id for test_code';eq;13457-7;test_code:'id for result_value_num';ge;160\n     &\n     basic_vitals:'id for blood_pressure_systolic';eq;blood_pressure_systolic;basic_vitals:'id for blood_pressure_systolic';ge;160)\n\n    example query:\n\n    select *\n     from\n     clinical_data cd inner join\n     (select  patient_sid, lft as lft_ldl, rgt as rgt_ldl\n     from clinical_data\n     where string_value = '13457-7' and attribute_id = '12345') ldl\n     on\n     cd.patient_sid = ldl.patient_sid\n     and\n     cd.lft >= ldl.lft_ldl\n     and\n     cd.rgt <= ldl.rgt_ldl\n     where double_value >= 160 and attribute_id = '34567'\n     order by cd.lft;\n\"\"\"\n\n\ndef make_atomic_query(key_type, key, comparator, value, comparator_date, value_date):\n\n    a = []  # atomic array of query elements\n    date = []\n    whole = [] # entire data set with no constraints\n\n    transform = ['medications', 'demographics']# data need to have special characters removed for querying\n    numeric = ['int', 'float', 'double']\n    char = ['string']\n\n    for i in xrange(0, 2):\n\n        a.append('')\n        whole.append('')\n\n        if comparator[i] == 'between':\n            arg = value[i].split(',', 2)\n\n        if comparator_date[i]:\n            if comparator_date[i] == 'between':\n                date = value_date[i].split(',', 2)\n\n    for i in xrange(0, 2):\n\n        if i == 0:\n            a[i] = db.session.query(Clinical.patient_sid,\n                                    Clinical.lft,\n                                    Clinical.rgt,\n                                    Clinical.attribute_id)\n        else:\n            a[i] = db.session.query(Clinical.patient_sid,\n                                    Clinical.lft,\n                                    Clinical.rgt,\n                                    label('attribute_value', Clinical.attribute_id),\n                                    Clinical.double_value,\n                                    Clinical.string_value)\n\n        '''\n         equivalent to:\n\n         select  patient_sid, lft, rgt\n         from clinical_data\n        '''\n\n        if i == 0:\n\n            a[i] = a[i].filter(Clinical.attribute_id == int(key[i]))\n\n            '''\n             equivalent to:\n\n             select  patient_sid, lft, rgt\n             from clinical_data\n             where attribute_id = '12345'\n            '''\n\n            if key_type[i] in transform:\n                name = value[i].replace('_', ' ').\\\n                    replace('{', '('). \\\n                    replace('}', ')')\n            else: name = value[i]\n\n            a[i] = a[i].filter(Clinical.string_value.op(comparator[i])(name)).subquery()\n\n            '''\n             equivalent to:\n\n             select patient_sid, lft, rgt\n             from clinical_data\n             where string_value = '13457-7' and attribute_id = '12345'\n            '''\n\n        elif i == 1:\n\n            '''\n            a[i] = a[i].join(a[i-1],\n                             and_(Clinical.patient_sid == a[i-1].c.patient_sid,\n                                  Clinical.lft >= a[i-1].c.lft,\n                                  Clinical.rgt <= a[i-1].c.rgt)).\\\n                filter(Clinical.attribute_id == key[i])\n            '''\n\n            a[i] = a[i].join(a[i-1],\n                             and_(Clinical.patient_sid == a[i-1].c.patient_sid,\n                                  Clinical.attribute_id == int(key[i]))). \\\n                filter(Clinical.lft >= a[i-1].c.lft,\n                       Clinical.rgt <= a[i-1].c.rgt)\n\n            whole[i] = a[i]\n\n            '''\n             equivalent to:\n\n             select patient_sid, lft, rgt\n             from\n             clinical_data cd inner join\n             (select patient_sid, lft, rgt\n             from clinical_data\n             where string_value = '13457-7' and attribute_id = '12345') ldl\n             on\n             cd.patient_sid = ldl.patient_sid\n             and\n             cd.lft >= ldl.lft\n             and\n             cd.rgt <= ldl.rgt\n             where attribute_id = '34567';\n            '''\n\n            print_all = False\n\n            if 'OUT' in comparator[i]:\n                print_all = True\n\n            if not 'OUT' in comparator[i]:\n\n                qstring = \"/attribute{data_type.name}?id='\" + key[i] + \"'\"\n\n                data_type = hsql.get_data(qstring)\n\n\n                if data_type in numeric:\n\n                    if comparator[i] != 'between':\n                        a[i] = a[i].filter(Clinical.double_value.op(comparator[i])((float(value[i]))))\n\n                    else:\n                        a[i] = a[i].filter(between(Clinical.double_value,\n                                                   float(arg[0]),\n                                                   float(arg[1])))\n\n                elif data_type in char:\n                    if key_type[i] in transform:\n                        name = value[i].replace('_', ' ').\\\n                            replace('{', '('). \\\n                            replace('}', ')')\n\n                    else: name = value[i]\n\n                    a[i] = a[i].filter(Clinical.string_value.op(comparator[i])(name))\n\n                '''\n                 equivalent to:\n                 select patient_sid, lft, rgt\n                 from\n                 clinical_data cd inner join\n                 (select attribute_id, patient_sid, lft, rgt\n                 from clinical_data\n                 where string_value = '13457-7' and attribute_id = '12345') ldl\n                 on\n                 cd.patient_sid = ldl.patient_sid\n                 and\n                 cd.lft >= ldl.lft\n                 and\n                 cd.rgt <= ldl.rgt\n                 where double_value >= 160 and attribute_id = '34567';\n                '''\n\n                if comparator_date[i]:\n                    if comparator_date[i] == 'between':\n                        a[i] = a[i].filter(between(Clinical.event_date,\n                                                   date[0],\n                                                   date[1]))\n\n                    else:\n                        a[i] = a[i].filter(Clinical.event_date.op(comparator_date[i])([value_date[i]]))\n\n\n                '''\n                 equivalent to:\n                 select patient_sid, lft, rgt\n                 from\n                 clinical_data cd inner join\n                 (select attribute_id, patient_sid, lft, rgt\n                 from clinical_data\n                 where string_value = '13457-7' and attribute_id = '12345') ldl\n                 on\n                 cd.patient_sid = ldl.patient_sid\n                 and\n                 cd.lft >= ldl.lft\n                 and\n                 cd.rgt <= ldl.rgt\n                 where double_value >= 160 and attribute_id = '34567'\n                 and cd.event_date >= '1/1/1970';\n                '''\n\n                a[i] = a[i].subquery()\n\n        else:\n            print 'ERROR'\n\n    return a[1], whole[1], print_all\n\n\ndef parse_atomic_particles(atom):\n\n    separator = ';'\n\n    a = []  # list element for returned atoms\n    whole = []\n\n    for i in xrange(0, 1):\n        a.append('')\n        whole.append('')\n\n    for j in xrange(0, 1):\n\n        particles = atom.split(separator, 6)  # atom consists of 6 query components to be parsed, aka particles\n        key_type = [] # array of query bucket names\n        key = []  # array of key bucket ids\n        comparator = []  # array of comparators\n        value = []  # array of values\n        comparator_date = [] # array of date comparators\n        value_date = []  # array of date components\n\n        for i in xrange(len(particles)):\n            particle = particles[i]\n\n\n            value_comparator_list = ['eq',\n                                     'grte',\n                                     'lete',\n                                     'bt',\n                                     'gt',\n                                     'lt',\n                                     'prn']\n\n            date_comparator_list = ['between',\n                                    'grt',\n                                    'lss']\n\n            comparator_mapper  = [\n                (':', particle.split(':')),\n                ('eq', '='),\n                ('grte', '>='),\n                ('lete', '<='),\n                ('bt', 'between'),\n                ('between', 'between'),\n                ('grt', '>='),\n                ('lss', '<='),\n                ('lt', '<'),\n                ('gt', '>'),\n                ('prn', 'OUT')\n            ]\n\n            if any(ext in particle for ext in value_comparator_list) or \\\n                    any(ext in particle for ext in date_comparator_list) or \\\n                    ':' in particle:\n\n                def apply_mapper(particle):\n                    return\n                    for item, action in comparator_mapper:\n                        if item in particle:\n                            if ':' in particle:\n                                key_type.append(action[0])\n                                key.append(action[1])\n                                break\n\n                            elif any(ext in particle for ext in value_comparator_list):\n                                comparator.append(action)\n                                break\n\n                            elif any(ext in particle for ext in date_comparator_list):\n                                date_stuff = particle.split(',DATE,')\n\n                                value.append(date_stuff[0])\n                                comparator_date.append(action)\n\n                                date = date_stuff[1].split(',')\n\n                                if len(date) == 2:\n                                    temp = date[1]\n                                else:\n                                    temp = date[1] + ',' + date[2]\n\n                                value_date.append(temp)\n                                break\n                            else:\n                                print'error'\n\n                apply_mapper(particle)\n            else:\n                comparator_date.append('>=')\n                value_date.append('1776-01-01')\n                value.append(particle)\n\n        a[j], whole[j], print_all = make_atomic_query(key_type, key, comparator, value, comparator_date, value_date)\n\n    return a[0], whole[0], print_all\n",
  "line_no": 325,
  "line_no_percent": "90%"
}