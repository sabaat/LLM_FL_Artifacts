{
  "instruction": "To import initial candidate data, run the `handle` function in the `Command` class. This function reads CSV files containing candidate data for specific elections and creates `PopItPerson` objects for each candidate. The CSV files should be located in the `data` directory and have the following format: \n\n- `listedescandidatsauxelectionslegislativeslisteprovincialeanptic.csv` for the `prv-2015` election\n- `listedescandidatsauxelectionslegislativesanptic.csv` for the `nat-2015` election\n\nThe function uses the `get_post_data` function to get the post data for each candidate and the `get_existing_popit_person` function to check if a person with the given ID already exists in the PopIt database. If the person does not exist, a new `PopItPerson` object is created and saved to the database using the `save_to_popit` method. \n\nThe function also uses the `get_party_data` function to get the party data for each candidate and the `create_popit_api_object` function to create an API object for interacting with the PopIt API. \n\nIf any party names in the CSV files do not match the party names in the `PARTY_DATA` dictionary, the function will print a list of unmatched party names at the end.",
  "buggy_code": "import dateutil.parser\nimport csv\nfrom os.path import dirname, join\nimport re\nimport string\nimport codecs\n\nimport requests\n\nfrom django.core.management.base import BaseCommand\n\nfrom candidates.utils import strip_accents\nfrom candidates.views.version_data import get_change_metadata\n\nfrom elections.models import Election\n\nUNKNOWN_PARTY_ID = 'unknown'\nUSER_AGENT = (\n    'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 '\n    '(KHTML, like Gecko) Ubuntu Chromium/38.0.2125.111 '\n    'Chrome/38.0.2125.111Safari/537.36'\n)\n\n\ndef get_post_data(api, election_id, province):\n    from candidates.cache import get_post_cached\n    from candidates.election_specific import AREA_DATA, AREA_POST_DATA\n    ynr_election_data = Election.objects.get_by_slug(election_id)\n    area_key = (ynr_election_data.area_types.first().name,\n                 ynr_election_data.area_generation)\n    areas_by_name = AREA_DATA.areas_by_name[area_key]\n    if province != 'Burkina Faso':\n        province = strip_accents(province).upper()\n    area = areas_by_name[province]\n    post_id = AREA_POST_DATA.get_post_id(\n        election_id, area['type'], area['id']\n    )\n    post_data = get_post_cached(api, post_id)['result']\n    return ynr_election_data, post_data\n\n\ndef get_existing_popit_person(vi_person_id):\n    from candidates.models import PopItPerson\n    from candidates.popit import get_search_url\n    query_format = \\\n        'identifiers.identifier:\"{id}\" AND ' + \\\n        'identifiers.scheme:\"{scheme}\"'\n    search_url = get_search_url(\n        'persons',\n        query_format.format(\n            id=vi_person_id, scheme='import-id'\n        ),\n        embed='membership.organization'\n    )\n    results = requests.get(search_url).json()\n    total = results['total']\n    if total > 1:\n        message = \"Multiple matches for CI ID {0}\"\n        raise Exception(message.format(vi_person_id))\n    if total == 0:\n        return None\n    return PopItPerson.create_from_dict(results['result'][0])\n\n\ndef get_party_data(party_name):\n    from candidates.popit import get_search_url\n    party_name = party_name.replace('/', '')\n    party_name = party_name.decode('utf-8')\n    query_format = \\\n        'name:\"{name}\"'\n    search_url = get_search_url(\n        'organizations',\n        query_format.format(\n            name=party_name\n        )\n    )\n    print party_name\n    results = requests.get(search_url).json()\n    print results\n    total = results['total']\n    if total > 1:\n        message = \"Multiple matches for party {0}\"\n        raise Exception(message.format(party_name))\n    if total == 0:\n        return None\n    return results['result'][0]\n\n\n\"\"\" These functions taken from the csv docs -\nhttps://docs.python.org/2/library/csv.html#examples\"\"\"\ndef unicode_csv_reader(unicode_csv_data, dialect=csv.excel, **kwargs):\n    return\n    csv_reader = csv.reader(utf_8_encoder(unicode_csv_data),\n                            dialect=dialect, **kwargs)\n    for row in csv_reader:\n        yield [unicode(cell, 'utf-8') for cell in row]\n\n\ndef utf_8_encoder(unicode_csv_data):\n    for line in unicode_csv_data:\n        yield line.encode('utf-8')\n\n\nclass Command(BaseCommand):\n\n    help = \"Import inital candidate data\"\n\n    def handle(self, username=None, **options):\n        from slumber.exceptions import HttpClientError\n        from candidates.election_specific import PARTY_DATA, shorten_post_label\n        from candidates.models import PopItPerson\n        from candidates.popit import create_popit_api_object\n\n        election_data = {\n            'prv-2015': 'listedescandidatsauxelectionslegislativeslisteprovincialeanptic.csv',\n            'nat-2015': 'listedescandidatsauxelectionslegislativesanptic.csv'\n            }\n\n        field_map = {\n            'prv-2015': {\n                'region': 1,\n                'party': 4,\n                'list_order': 5,\n                'first_name': 7,\n                'last_name': 6,\n                'gender': 8,\n                'birth_date': 9,\n                'party_short': 3\n            },\n            'nat-2015': {\n                'region': 0,\n                'party': 2,\n                'list_order': 3,\n                'first_name': 5,\n                'last_name': 4,\n                'gender': 6,\n                'birth_date': 7,\n                'party_short': 2\n            }\n        }\n\n        api = create_popit_api_object()\n\n        party_id_missing = {}\n        party_name_to_id = {}\n        for party_id, party_name in PARTY_DATA.party_id_to_name.items():\n            party_name_to_id[party_name] = party_id\n\n        for election_id, filename in election_data.items():\n            csv_filename = join(\n                dirname(__file__), '..', '..', 'data', filename\n            )\n\n            fields = field_map[election_id]\n\n            with codecs.open(csv_filename, 'r', encoding='windows-1252') as f:\n\n                initial = True\n                for candidate in unicode_csv_reader(f):\n                    if initial:\n                        initial = False\n                        continue\n\n                    region = candidate[fields['region']]\n                    party = candidate[fields['party']]\n                    party_list_order = candidate[fields['list_order']]\n                    first_name = string.capwords(candidate[fields['first_name']])\n                    last_name = string.capwords(candidate[fields['last_name']])\n                    gender = candidate[fields['gender']]\n                    birth_date = None\n\n                    if candidate[fields['birth_date']] is not None:\n                        birth_date = str(dateutil.parser.parse(\n                            candidate[fields['birth_date']], dayfirst=True\n                        ).date())\n\n                    name = first_name + ' ' + last_name\n\n                    id = '-'.join([\n                        re.sub('[^\\w]*', '', re.sub(r' ', '-', strip_accents(name.lower()))),\n                        re.sub('[^\\w]*', '', candidate[fields['party_short']].lower()),\n                        birth_date\n                    ])\n\n                    if region == 'PAYS':\n                        region = 'Burkina Faso'\n                    election_data, post_data = get_post_data(\n                        api, election_id, region\n                    )\n\n\n                    person = get_existing_popit_person(id)\n                    if person:\n                        pass\n                    else:\n                        print \"No existing person, creating a new one:\", name\n                        person = PopItPerson()\n\n                    person.set_identifier('import-id', id)\n                    person.family_name = last_name\n                    person.given_name = first_name\n                    person.name = name\n                    person.gender = gender\n                    if birth_date:\n                        person.birth_date = str(birth_date)\n                    else:\n                        person.birth_date = None\n\n                    standing_in_election = {\n                        'post_id': post_data['id'],\n                        'name': shorten_post_label(post_data['label']),\n                        'party_list_position': party_list_order,\n                    }\n\n                    if 'area' in post_data:\n                        standing_in_election['mapit_url'] = post_data['area']['identifier']\n\n                    person.standing_in = {\n                        election_data.slug: standing_in_election\n                    }\n\n                    change_metadata = get_change_metadata(\n                        None,\n                        'Imported candidate from CSV',\n                    )\n\n                    party_comp = re.sub(' +', ' ', party)\n                    party_id = UNKNOWN_PARTY_ID\n                    if party_comp in party_name_to_id.keys():\n                        party_id = party_name_to_id[party_comp]\n                        party = party_comp\n                    else:\n                        party_id = party_name_to_id['Unknown Party']\n                        party = 'Unknown Party'\n\n                    if party_id == UNKNOWN_PARTY_ID and party_comp not in party_id_missing.keys():\n                        party_id_missing[party_comp] = 1\n\n                    person.party_memberships = {\n                        election_data.slug: {\n                            'id': party_id,\n                            'name': party,\n                            'imported_name': party_comp\n                        }\n                    }\n\n                    person.record_version(change_metadata)\n                    try:\n                        person.save_to_popit(api)\n                    except HttpClientError as hce:\n                        print \"Got an HttpClientError:\", hce.content\n                        raise\n\n        if len(party_id_missing) > 0:\n            print \"Unmatched party names:\"\n            for name in party_id_missing.keys():\n                print name\n",
  "line_no": 92,
  "line_no_percent": "36%"
}