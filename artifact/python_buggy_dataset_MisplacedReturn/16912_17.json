{
  "instruction": "Copy code to StationA and StationB, and set the hostnames StationA and StationB.",
  "buggy_code": "\"\"\"\n\nWe need two special hostnames to connect to: \n\nStationA\n\nand \n\nStationB\n\n\"\"\"\n\n\nfrom __future__ import with_statement, print_function\nfrom fabric.api import local, settings, abort, run, sudo, cd, hosts, env, execute\nfrom fabric.contrib.console import confirm\nfrom fabric.operations import put, get\nfrom fabric.contrib.project import rsync_project\n\nimport re\nimport subprocess as sp \nimport os.path \nfrom   StringIO import StringIO\n\n\ncurrent_dir = os.path.dirname(os.path.realpath(__file__))\n\n\nVNC_LICENSE = [\n    \"xxxxx-xxxxx-xxxxx-xxxxx-xxxxx\"\n]\n\n\nenv.key_filename = '/home/alcides/.ssh/zunzun_ec2_keypair_0.pem'\n\nStationA_H = 'ubuntu@54.149.116.230'\nStationB_H = 'ubuntu@54.149.116.233'\nBeefy_H    = 'ubuntu@52.11.217.155'\nBeefy_InternalIP = '192.168.112.131'\nStationA_InternalIP = '192.168.112.129'\nStationB_InternalIP = '192.168.112.130'\nHomeDir_Name = \"ubuntu\"\n\n\n@hosts(StationA_H)\ndef StationA():\n    \"\"\"\n    Copies code to StationA \n    \"\"\"\n    rsync_project(\n        local_dir = \"scripts/StationA\",\n        remote_dir = (\"/home/{HomeDir_Name}/\".format(HomeDir_Name=HomeDir_Name))\n        )\n    run(\"ln -sf /home/{HomeDir_Name}/StationA/onstartup.py /home/{HomeDir_Name}/onstartup.py\".format(HomeDir_Name=HomeDir_Name))\n\n\n@hosts(StationB_H)\ndef setup_dns_masq():\n    sudo(\"apt-get install -y dnsmasq\")\n    put(\n        local_path  = StringIO(\"addn-hosts=/home/{HomeDir_Name}/dnsmasq_more.conf\\n\".format(HomeDir_Name=HomeDir_Name)),\n        remote_path = \"/etc/dnsmasq.conf\",\n        use_sudo=True)\n\n\n\n@hosts(StationB_H)\ndef StationB():\n    \"\"\"\n    Copies both the chrome plugin and the DNSMasq watcher \n    \"\"\"\n    rsync_project(\n        local_dir = \"scripts/StationB\",\n        remote_dir = (\"/home/{HomeDir_Name}/\".format(HomeDir_Name=HomeDir_Name))\n        )\n    rsync_project(\n        local_dir = \"scripts/StationA/chrome_captures_hars\",\n        remote_dir = ((\"/home/{HomeDir_Name}/StationB/\".format(HomeDir_Name=HomeDir_Name)).format(HomeDir_Name=HomeDir_Name))\n        )\n    run(\"ln -sf /home/{HomeDir_Name}/StationB/onstartup.py /home/{HomeDir_Name}/onstartup.py\".format(HomeDir_Name=HomeDir_Name))\n\n\n@hosts(StationB_H)\ndef install_updatednsmasq_service():\n    with settings(warn_only=True):\n        sudo(\"service updatednsmasq stop\")\n    put(\n        local_path = \"scripts/StationB/configure_dnsmasq.py\",\n        remote_path = \"/home/{HomeDir_Name}/StationB/configure_dnsmasq.py\".format(HomeDir_Name=HomeDir_Name) ,\n        use_sudo = True\n        )\n    put(\n        local_path = StringIO(\"\"\"\ndescription \"Update dnsmasq\"\n\nstart on runlevel [2345]\nstop on runlevel [!2345]\n\numask 022\n\nconsole log\n\nenv PATH=/opt/openssl-1.0.2/bin/:/usr/bin:/usr/local/bin:/usr/sbin:/bin \nexport PATH\nenv LD_LIBRARY_PATH=/opt/openssl-1.0.2/lib\nexport LD_LIBRARY_PATH\nenv USER={HomeDir_Name}\nexport USER\n\nscript \n    exec /usr/bin/python /home/{HomeDir_Name}/StationB/configure_dnsmasq.py\nend script\n\n\"\"\".format(HomeDir_Name=HomeDir_Name)),\n        remote_path = \"/etc/init/updatednsmasq.conf\",\n        use_sudo=True )\n    sudo(\"service updatednsmasq start\")\n\n\n@hosts(Beefy_H)\ndef Beefy():\n    sudo(\"apt-get update\")\n    sudo(\"apt-get -y install libgmp-dev\")\n\n\n@hosts(Beefy_H)\ndef BeefyRehMimic():\n    with settings(warn_only=True):\n        sudo(\"service mimic stop\")\n    put(\n        local_path  = \"dist/build/reh-mimic/reh-mimic\",\n        remote_path = \"/home/{HomeDir_Name}/reh-mimic\".format(HomeDir_Name=HomeDir_Name)\n        )\n    run(\"chmod ugo+x /home/{HomeDir_Name}/reh-mimic\".format(HomeDir_Name=HomeDir_Name))\n    sudo(\"rm /home/{HomeDir_Name}/mimic -rf\".format(HomeDir_Name=HomeDir_Name) )\n    rsync_project(\n        local_dir  = \"mimic\",\n        remote_dir = \"/home/{HomeDir_Name}/\".format(HomeDir_Name=HomeDir_Name),\n        )\n    put(\n        local_path  = \"scripts/mimic.conf\",\n        remote_path = \"/etc/init/mimic.conf\",\n        use_sudo    = True\n        )\n    sudo(\"touch /root/.rnd\")\n    sudo(\"service mimic start\")\n\n\n\n@hosts(Beefy_H, StationA_H, StationB_H )\ndef configure_logging():\n    if env.host_string == StationA_H:\n        put(\n            local_path = StringIO(\"\"\"$template Logentries,\"199fb2e1-8227-4f73-9150-70a34a5d5e0c %HOSTNAME% %syslogtag%%msg%\\\\n\"\n*.* @@api.logentries.com:10000;Logentries\"\"\"),\n            remote_path = \"/etc/rsyslog.d/70-logentries.conf\",\n            use_sudo = True )\n    elif env.host_string == StationB_H:\n        put(\n            local_path = StringIO(\"\"\"$template Logentries,\"3d2fd756-407a-4764-b130-1dd6f22a1b62 %HOSTNAME% %syslogtag%%msg%\\\\n\"\n*.* @@api.logentries.com:10000;Logentries\"\"\"),\n            remote_path = \"/etc/rsyslog.d/70-logentries.conf\",\n            use_sudo = True )\n    else:\n        put(\n            local_path = StringIO(\"\"\"$template Logentries,\"7551d4e0-fa76-466f-8547-8c9a347a9363 %HOSTNAME% %syslogtag%%msg%\\\\n\"\n*.* @@api.logentries.com:10000;Logentries\"\"\"),\n            remote_path = \"/etc/rsyslog.d/70-logentries.conf\",\n            use_sudo = True )\n        \n    sudo(\"service rsyslog restart\")\n    sudo(\"logger -t test Hello there Logentries\")\n\n\n@hosts (StationA_H, StationB_H)\ndef deploy_specific():\n    if env.host_string == StationA_H:\n        print(\"StationA deploy\")\n        StationA()\n    elif env.host_string == StationB_H:\n        print(\"StationB deploy\")\n        StationB()\n    else: \n        print(\"Beefy station deploy\")\n        Beefy()\n\n\n@hosts(StationA_H, StationB_H)\ndef apt_stations():\n    sudo(\"apt-get update\")\n    sudo(\"apt-get install -y xutils xbase-clients xfonts-base xfonts-75dpi xfonts-100dpi\")\n    sudo(\"apt-get install -y python-pip\")\n    sudo(\"apt-get install -y xdotool\")\n    sudo(\"apt-get install -y xfwm4\") \n\n\n@hosts(StationA_H, StationB_H)\ndef pythonlibs():\n    sudo(\"pip install python-daemon>=2.0\")\n    sudo(\"pip install raven\")\n\n\n@hosts(Beefy_H, StationA_H, StationB_H)\ndef ssl():\n    \"\"\"\n    Copies Openssl and curl to the target hosts...\n    \"\"\"\n    sudo(\"mkdir -p /opt/openssl-1.0.2/\")\n    sudo((\"chown {HomeDir_Name} /opt/openssl-1.0.2/\".format(HomeDir_Name=HomeDir_Name)))\n    rsync_project(\n        local_dir = \"/opt/openssl-1.0.2\",\n        remote_dir = \"/opt/\",\n        extra_opts=\"-avz\"\n        )\n    put(\n        local_path = \"scripts/ca-certificates.crt\",\n        remote_path = \"/etc/ssl/certs/ca-certificates.crt\",\n        use_sudo = True\n        )\n\n\n@hosts(Beefy_H, StationA_H, StationB_H)\ndef ca():\n    \"\"\"\n    Copies the ca certificate to the home...\n    \"\"\"\n    put(\n        local_path = \"mimic-here/config/ca/cacert.pem\",\n        remote_path = (\"/home/{HomeDir_Name}/cacert.pem\".format(HomeDir_Name=HomeDir_Name)),\n        use_sudo = True\n        )\n\n\n@hosts(StationA_H, StationB_H)\ndef install_vnc():\n    \"\"\"\n    \n    \"\"\"\n\n\n    put(\n        local_path = \"scripts/VNC-5.2.3-Linux-x64-ANY.tar.gz\",\n        remote_path = (\"/home/{HomeDir_Name}/VNC-5.2.3-Linux-x64-ANY.tar.gz\".format(HomeDir_Name=HomeDir_Name)),\n        use_sudo = True\n        )\n    run((\"tar -xzf /home/{HomeDir_Name}/VNC-5.2.3-Linux-x64-ANY.tar.gz\".format(HomeDir_Name=HomeDir_Name)))\n    run(\"rm -rf vnc\")\n    run((\"mv /home/{HomeDir_Name}/VNC-5.2.3-Linux-x64 /home/{HomeDir_Name}/vnc\".format(HomeDir_Name=HomeDir_Name)))\n    sudo((\"/home/{HomeDir_Name}/vnc/vnclicense -add {VncLicense}\".format(\n        HomeDir_Name= HomeDir_Name,\n        VncLicense = VNC_LICENSE[0]\n    )))\n    run((\"mkdir -p /home/{HomeDir_Name}/.vnc/\".format(HomeDir_Name=HomeDir_Name)))\n    run((\"mkdir -p /home/{HomeDir_Name}/.vnc/config.d/\".format(HomeDir_Name=HomeDir_Name)))\n    sudo((\"/home/{HomeDir_Name}/vnc/vncpasswd /home/{HomeDir_Name}/.vnc/config.d/Xvnc\".format(HomeDir_Name=HomeDir_Name)))\n    vnc_fix_permissions()\n\n@hosts(StationA_H, StationB_H)\ndef vnc_fix_permissions():\n    sudo((\"chown {HomeDir_Name} /home/{HomeDir_Name}/.vnc -R\").format(HomeDir_Name=HomeDir_Name))\n\n@hosts(StationA_H, StationB_H)\ndef install_vnc_xstartup():\n    run((\"mkdir -p /home/{HomeDir_Name}/.vnc/\".format(HomeDir_Name=HomeDir_Name)))\n    run((\"mkdir -p /home/{HomeDir_Name}/.vnc/config.d/\".format(HomeDir_Name=HomeDir_Name)))\n    put(\n        local_path = \"scripts/vnc-xstartup\",\n        remote_path = (\"/home/{HomeDir_Name}/.vnc/xstartup\".format(HomeDir_Name=HomeDir_Name))\n        )\n    run(\"chmod ugo+x /home/{HomeDir_Name}/.vnc/xstartup\".format(HomeDir_Name=HomeDir_Name))\n    put(\n        local_path = \"scripts/xvncfontpath\",\n        remote_path = (\"/home/{HomeDir_Name}/.vnc/config.d/xvncfontpath\".format(HomeDir_Name=HomeDir_Name))\n        )\n\n\n@hosts(StationA_H, StationB_H)\ndef setup_google_chrome():\n    put(\n        local_path = \"scripts/google-chrome-stable_current_amd64.deb\",\n        remote_path = (\"/home/{HomeDir_Name}/google-chrome-stable_current_amd64.deb\".format(HomeDir_Name=HomeDir_Name)),\n        use_sudo = True\n        )\n    really_setup_google_chrome()\n\n\n@hosts(Beefy_H, StationA_H, StationB_H)\ndef ensure_local_hosts():\n    return\n    local_file = StringIO()\n    get(\n        local_path = local_file,\n        remote_path = \"/etc/hosts\",\n        use_sudo = True \n        )\n    hosts_file = local_file.getvalue()\n    snippet =  \"\"\"# DO NOT EDIT BELOW BY HAND\n{Beefy_InternalIP} instr.httpdos.com\n192.168.112.129 ip-192-168-112-129\n192.168.112.130 ip-192-168-112-130\n192.168.112.131 ip-192-168-112-131\n    StationA_InternalIP = StationA_InternalIP,\n    Beefy_InternalIP    = Beefy_InternalIP\n    )\n    mo = re.search(r\"# DO NOT EDIT BELOW BY HAND\\n(.*?)\\n# END DO NOT EDIT BELOW\", hosts_file, re.MULTILINE)\n    if mo:\n        part_before = hosts_file[:mo.start(0)]\n        part_after = hosts_file[mo.end(0):]\n        hosts_file = part_before + snippet + part_after\n    else:\n        hosts_file += \"\\n\" + snippet\n\n    put(\n        local_path = StringIO(hosts_file),\n        remote_path = \"/etc/hosts\",\n        use_sudo = True\n        )\n\n\n@hosts(StationA_H, StationB_H)\ndef really_setup_google_chrome():\n    sudo(\"apt-get update\")\n    sudo((\"apt-get -f install -y\".format(HomeDir_Name=HomeDir_Name)))\n    sudo(\"apt-get install -y --fix-missing xdg-utils\")\n    sudo((\"dpkg -i --force-depends /home/{HomeDir_Name}/google-chrome-stable_current_amd64.deb\".format(HomeDir_Name=HomeDir_Name)))\n    sudo((\"apt-get -f install -y\".format(HomeDir_Name=HomeDir_Name)))\n\n\n@hosts(StationA_H, StationB_H)\ndef setup_vnc_service():\n    put(\n        local_path = \"scripts/vncserv-{HomeDir_Name}.conf\".format(HomeDir_Name=HomeDir_Name),\n        remote_path = \"/etc/init/vncserv.conf\",\n        use_sudo = True\n        )\n    put(\n        local_path = \"scripts/undaemon.py\",\n        remote_path = \"/home/{HomeDir_Name}/undaemon.py\".format(HomeDir_Name=HomeDir_Name)\n        )\n    run(\"chmod ugo+x /home/{HomeDir_Name}/undaemon.py\".format(HomeDir_Name=HomeDir_Name))\n    with settings(warn_only=True):\n        sudo(\n            \"service vncserv start\"\n            )\n\n\n@hosts(StationA_H, StationB_H)\ndef  disable_lightdm():\n    contents = StringIO(\"manual\")\n    put(\n        local_path = contents, \n        remote_path = \"/etc/init/lightdm.override\",\n        use_sudo=True\n        )\n\n\n@hosts(StationA_H, StationB_H)\ndef touch_xauthority():\n    run(\"touch $HOME/.Xauthority\")\n\n\n@hosts(StationA_H, StationB_H)\ndef deploy():\n    execute(apt_stations)\n    execute(setup_dns_masq)\n    execute(setup_google_chrome)\n    execute(deploy_specific)\n    execute(touch_xauthority)\n    execute(disable_lightdm)\n    execute(StationA)\n    execute(StationB)\n    execute(Beefy)\n    execute(ca)\n    execute(ssl)\n    execute(install_vnc)\n    execute(install_vnc_xstartup)\n    execute(ensure_local_hosts)\n    execute(setup_vnc_service)\n    execute(pythonlibs)\n    execute(BeefyRehMimic)\n    execute(install_updatednsmasq_service)    \n",
  "line_no": 289,
  "line_no_percent": "76%"
}