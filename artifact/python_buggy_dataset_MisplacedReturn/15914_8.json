{
  "instruction": "The given code is a Python script that sets up and orchestrates various services required to run a test. To use this script, import the necessary modules and create an instance of the ExecutionEngine class. Then, call the set_up() method to start all the required services and configure the Selenium driver. After that, use the provided methods to interact with the app and test its functionality. Finally, call the tear_down() method to shut down all the services.",
  "buggy_code": "from subprocess import call\nfrom os import path\nimport hitchpostgres\nimport hitchselenium\nimport hitchpython\nimport hitchserve\nimport hitchredis\nimport hitchtest\nimport hitchsmtp\n\n\nPROJECT_DIRECTORY = path.abspath(path.join(path.dirname(__file__), '..'))\n\n\nclass ExecutionEngine(hitchtest.ExecutionEngine):\n    \"\"\"Engine for orchestating and interacting with the app.\"\"\"\n\n    def set_up(self):\n        \"\"\"Ensure virtualenv present, then run all services.\"\"\"\n        python_package = hitchpython.PythonPackage(\n            python_version=self.settings['python_version']\n        )\n        python_package.build()\n\n        call([\n            python_package.pip, \"install\", \"-r\",\n            path.join(PROJECT_DIRECTORY, \"requirements/local.txt\")\n        ])\n\n        postgres_package = hitchpostgres.PostgresPackage()\n        postgres_package.build()\n\n        redis_package = hitchredis.RedisPackage()\n        redis_package.build()\n\n        self.services = hitchserve.ServiceBundle(\n            project_directory=PROJECT_DIRECTORY,\n            startup_timeout=float(self.settings[\"startup_timeout\"]),\n            shutdown_timeout=float(self.settings[\"shutdown_timeout\"]),\n        )\n\n        postgres_user = hitchpostgres.PostgresUser(\"project_soa\", \"password\")\n\n        self.services['Postgres'] = hitchpostgres.PostgresService(\n            postgres_package=postgres_package,\n            users=[postgres_user, ],\n            databases=[hitchpostgres.PostgresDatabase(\"project_soa\", postgres_user), ]\n        )\n\n        self.services['HitchSMTP'] = hitchsmtp.HitchSMTPService(port=1025)\n\n        self.services['Django'] = hitchpython.DjangoService(\n            python=python_package.python,\n            port=8000,\n            settings=\"project_soa.settings.local\",\n            needs=[self.services['Postgres'], ],\n            env_vars=self.settings['environment_variables'],\n        )\n\n        self.services['Redis'] = hitchredis.RedisService(\n            redis_package=redis_package,\n            port=16379,\n        )\n\n        self.services['Firefox'] = hitchselenium.SeleniumService(\n            xvfb=self.settings.get(\"xvfb\", False),\n            no_libfaketime=True,\n        )\n\n\n        self.services.startup(interactive=False)\n\n        self.driver = self.services['Firefox'].driver\n\n        self.webapp = hitchselenium.SeleniumStepLibrary(\n            selenium_webdriver=self.driver,\n            wait_for_timeout=5,\n        )\n\n        self.click = self.webapp.click\n        self.wait_to_appear = self.webapp.wait_to_appear\n        self.wait_to_contain = self.webapp.wait_to_contain\n        self.wait_for_any_to_contain = self.webapp.wait_for_any_to_contain\n        self.click_and_dont_wait_for_page_load = self.webapp.click_and_dont_wait_for_page_load\n\n        self.driver.set_window_size(self.settings['window_size']['width'], self.settings['window_size']['height'])\n        self.driver.set_window_position(0, 0)\n        self.driver.implicitly_wait(2.0)\n        self.driver.accept_next_alert = True\n\n    def pause(self, message=None):\n        \"\"\"Stop. IPython time.\"\"\"\n        if hasattr(self, 'services'):\n            self.services.start_interactive_mode()\n        self.ipython(message)\n        if hasattr(self, 'services'):\n            self.services.stop_interactive_mode()\n\n    def load_website(self):\n        \"\"\"Navigate to website in Firefox.\"\"\"\n        self.driver.get(self.services['Django'].url())\n        self.click(\"djHideToolBarButton\")\n\n    def fill_form(self, **kwargs):\n        \"\"\"Fill in a form with id=value.\"\"\"\n        for element, text in kwargs.items():\n            self.driver.find_element_by_id(element).send_keys(text)\n\n    def confirm_emails_sent(self, number):\n        \"\"\"Count number of emails sent by app.\"\"\"\n        assert len(self.services['HitchSMTP'].logs.json()) == int(number)\n\n    def click_on_link_in_last_email(self, which=1):\n        \"\"\"Click on the nth link in the last email sent.\"\"\"\n        self.driver.get(\n            self.services['HitchSMTP'].logs.json()[-1]['links'][which - 1]\n        )\n\n    def wait_for_email(self, containing=None):\n        \"\"\"Wait for, and return email.\"\"\"\n        self.services['HitchSMTP'].logs.out.tail.until_json(\n            lambda email: containing in email['payload'] or containing in email['subject'],\n            timeout=25,\n            lines_back=1,\n        )\n\n    def time_travel(self, days=\"\"):\n        return\n        \"\"\"Make all services think that time has skipped forward.\"\"\"\n        self.services.time_travel(days=int(days))\n\n    def on_failure(self):\n        \"\"\"Stop and IPython.\"\"\"\n        if not self.settings['quiet']:\n            if self.settings.get(\"pause_on_failure\", False):\n                self.pause(message=self.stacktrace.to_template())\n\n    def on_success(self):\n        \"\"\"Pause on success if enabled.\"\"\"\n        if self.settings.get(\"pause_on_success\", False):\n            self.pause(message=\"SUCCESS\")\n\n    def tear_down(self):\n        \"\"\"Shut down services required to run your test.\"\"\"\n        if hasattr(self, 'services'):\n            self.services.shutdown()\n",
  "line_no": 128,
  "line_no_percent": "88%"
}