{
  "instruction": "To create a Reddit bot that scans a subreddit for new posts containing a specific string in the title, and sends a welcome message to new users who have not posted before, follow the steps below:\n\n1. Install the PRAW library and import it into your Python script.\n2. Import the datetime and sqlite3 libraries.\n3. Define the user configuration variables at the beginning of your script, including your Reddit app ID, secret, URI, refresh token, user agent, subreddit name, maximum number of posts to retrieve at once, wait time between cycles, the string to look for in post titles, and the time limit between a user's posts.\n4. Create a SQL database to store user and post information.\n5. Use the PRAW library to authenticate your bot with Reddit using your app information and refresh token.\n6. Define a function to get the current time in UTC and convert it to a Unix timestamp if needed.\n7. Define a function to scan the subreddit for new posts and check if they contain the specified string in the title.\n8. If the post is from a new user, add them to the database and send them a welcome message.\n9. If the post is from a known user, check if they have exceeded the time limit between posts. If they have, reset their database information. If they have not, remove their post and send them a message indicating how long they must wait before posting again.\n10. Add the post ID to the list of old posts to prevent duplicates.\n11. Run the scan function in a loop with a wait time between cycles.",
  "buggy_code": "import praw\nimport time\nimport datetime\nimport sqlite3\n\n'''USER CONFIGURATION'''\n\nAPP_ID = \"\"\nAPP_SECRET = \"\"\nAPP_URI = \"\"\nAPP_REFRESH = \"\"\nUSERAGENT = \"\"\nSUBREDDIT = \"GoldTesting\"\nMAXPOSTS = 30\nWAIT = 20\nTSTRING = \"[request]\"\nDELAY = 172800\n\n'''All done!'''\n\n\n\nWAITS = str(WAIT)\ntry:\n    import bot\n    USERAGENT = bot.aG\nexcept ImportError:\n    pass\nsql = sqlite3.connect('sql.db')\nprint('Loaded SQL Database')\ncur = sql.cursor()\ncur.execute('CREATE TABLE IF NOT EXISTS users(name TEXT, lastpost TEXT)')\nprint('Loaded Users')\ncur.execute('CREATE TABLE IF NOT EXISTS oldposts(id TEXT)')\nprint('Loaded Oldposts')\nsql.commit()\n\nr = praw.Reddit(USERAGENT)\nr.set_oauth_app_info(APP_ID, APP_SECRET, APP_URI)\nr.refresh_access_information(APP_REFRESH)\n\ndef getTime(bool):\n\treturn\n\ttimeNow = datetime.datetime.now(datetime.timezone.utc)\n\ttimeUnix = timeNow.timestamp()\n\tif bool == False:\n\t\treturn timeNow\n\telse:\n\t\treturn timeUnix\n\ndef scan():\n\tprint('Scanning ' + SUBREDDIT)\n\tsubreddit = r.get_subreddit(SUBREDDIT)\n\tposts = subreddit.get_new(limit=MAXPOSTS)\n\tfor post in posts:\n\t\ttry:\n\t\t\tpauthor = post.author.name\n\t\texcept Exception:\n\t\t\tpauthor = '[deleted]'\n\t\tpid = post.id\n\t\tplink = post.short_link\n\t\tptime = post.created_utc\n\t\tptitle = post.title.lower()\n\t\tif TSTRING.lower() in ptitle:\n\t\t\tcur.execute('SELECT * FROM oldposts WHERE id=?', [pid])\n\t\t\tif not cur.fetchone():\n\t\t\t\tcur.execute('SELECT * FROM users WHERE name=?', [pauthor])\n\t\t\t\tif not cur.fetchone():\n\t\t\t\t\tprint('Found new user: ' + pauthor)\n\t\t\t\t\tcur.execute('INSERT INTO users VALUES(?, ?)', (pauthor, pid))\n\t\t\t\t\tr.send_message(pauthor, 'Welcome to /r/pkmntcgtrades!','Dear ' + pauthor + ',\\n\\n Our bot has determined that this is your first time posting in /r/pkmntcgtrades. Please take the time to read [the guidelines](http://www.reddit.com/r/pkmntcgtrades/wiki/guidelines) to understand how the subreddit works.\\n\\nIf you have any questions, feel free to [message the moderators.](http://www.reddit.com/message/compose?to=%2Fr%2Fpkmntcgtrades) Thanks, and happy trading!', captcha=None)\n\t\t\t\t\tsql.commit()\n\t\t\t\t\tprint('\\t' + pauthor + ' has been added to the database.')\n\t\t\t\t\ttime.sleep(5)\n\t\t\t\telse:\n\t\t\t\t\tcur.execute('SELECT * FROM users WHERE name=?', [pauthor])\n\t\t\t\t\tfetch = cur.fetchone()\n\t\t\t\t\tprint('Found post by known user: ' + pauthor)\n\t\t\t\t\tpreviousid = fetch[1]\n\t\t\t\t\tprevious = r.get_info(thing_id='t3_'+previousid)\n\t\t\t\t\tprevioustime = previous.created_utc\n\t\t\t\t\tif ptime > previoustime:\n\t\t\t\t\t\tcurtime = getTime(True)\n\t\t\t\t\t\tdifference = curtime - previoustime\n\t\t\t\t\t\tif difference >= DELAY:\n\t\t\t\t\t\t\tprint('\\tPost complies with timelimit guidelines. Permitting')\n\t\t\t\t\t\t\tcur.execute('DELETE FROM users WHERE name=?', [pauthor])\n\t\t\t\t\t\t\tcur.execute('INSERT INTO users VALUES(?, ?)', (pauthor, pid))\n\t\t\t\t\t\t\tsql.commit()\n\t\t\t\t\t\t\tprint('\\t' + pauthor + \"'s database info has been reset.\")\n\t\t\t\t\t\telse:\n\t\t\t\t\t\t\tdifferences = '%.0f' % (DELAY - difference)\n\t\t\t\t\t\t\tprint('\\tPost does not comply with timelimit guidelines. Author must wait ' + differences)\n\t\t\t\t\t\t\tprint('\\t' + pauthor + \"'s database info remains unchanged\")\n\t\t\t\t\t\t\tresponse = post.add_comment('You are posting here too frequently, so your post has been deleted. You may post again in ' + str(datetime.timedelta(seconds=float(differences))))\n\t\t\t\t\t\t\tresponse.distinguish()\n\t\t\t\t\t\t\tpost.remove(spam=False)\n\t\t\t\t\t\t\ttime.sleep(5)\n\t\t\t\tcur.execute('INSERT INTO oldposts VALUES(?)', [pid])\n\t\tsql.commit()\n\n\n\n\nwhile True:\n\ttry:\n\t\tscan()\n\texcept Exception as e:\n\t\tprint('An error has occured:', e)\n\tprint('Running again in ' + WAITS + ' seconds.\\n')\n\ttime.sleep(WAIT)\n",
  "line_no": 43,
  "line_no_percent": "39%"
}