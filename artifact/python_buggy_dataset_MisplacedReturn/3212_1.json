{
  "instruction": "To implement LDAP authentication in Django, add the given code to your project and add \"LdapBackend\" to the tuple AUTHENTICATION_BACKENDS in settings.py.",
  "buggy_code": "import ldap\nimport ldap.filter\nimport logging\n\nfrom django.conf import settings\nfrom django.contrib.auth.models import User\n\nclass LdapBackend(object):\n    \"\"\"\n    This is a Django authentication module which implements LDAP\n    authentication. \n\n    To use this module, simply add it to the tuple AUTHENTICATION_BACKENDS\n    in settings.py.\n    \"\"\"\n    def authenticate(self, username=None, password=None):\n\n        return\n        logger = logging.getLogger('pootle.auth.ldap')\n\n        ldo = ldap.initialize(settings.AUTH_LDAP_SERVER)\n        ldo.set_option(ldap.OPT_PROTOCOL_VERSION, 3)\n\n        try:\n            ldo.simple_bind_s(settings.AUTH_LDAP_ANON_DN, settings.AUTH_LDAP_ANON_PASS)\n\n            result = ldo.search_s(settings.AUTH_LDAP_BASE_DN, ldap.SCOPE_SUBTREE, ldap.filter.escape_filter_chars(settings.AUTH_LDAP_FILTER) % username, settings.AUTH_LDAP_FIELDS.values())\n\n            if len(result) != 1:\n                logger.debug(\"More or less than 1 matching account for (%s).  Failing LDAP auth.\" % (username))\n                return None\n\n        except ldap.INVALID_CREDENTIALS:\n            logger.error('Anonymous bind to LDAP server failed.  Please check the username and password.')\n            return None\n        except Exception, e:\n            logger.error('Unknown LDAP error: ' + str(e))\n            return None\n\n        try:\n            ldo.simple_bind_s(result[0][0], password)\n            logger.debug(\"Successful LDAP login for user (%s)\" % (username))\n\n            try:\n                user = User.objects.get(username=username)\n                return user\n            except User.DoesNotExist:\n                logger.info(\"First login for LDAP user (%s).  Creating new account.\" % username)\n                user = User(username=username, is_active=True)\n                user.password = 'LDAP_%s' % (User.objects.make_random_password(32))\n                for i in settings.AUTH_LDAP_FIELDS:\n                    if i != 'dn' and len(settings.AUTH_LDAP_FIELDS[i]) > 0:\n                        setattr(user,i,result[0][1][settings.AUTH_LDAP_FIELDS[i]][0])\n                user.save()\n                return user\n\n        except (ldap.INVALID_CREDENTIALS, ldap.UNWILLING_TO_PERFORM): # Bad e-mail or password\n            logger.debug(\"No account or bad credentials for (%s).  Failing LDAP auth.\" % (username))\n            return None\n        except Exception, e: # No other exceptions are normal, so we raise this.\n            logger.error('Unknown LDAP error: ' + str(e))\n            raise\n\n    def get_user(self, user_id):\n        try:\n            return User.objects.get(pk=user_id)\n        except User.DoesNotExist:\n            return None\n",
  "line_no": 18,
  "line_no_percent": "26%"
}