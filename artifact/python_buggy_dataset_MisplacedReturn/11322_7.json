{
  "instruction": "Create a Python Django web application that generates a ztree for a given user. The ztree should display a hierarchical structure of projects, services, hosts, and other relevant information. The ztree should be accessible only to authenticated users. The ztree should be generated using the given code.",
  "buggy_code": "from django.shortcuts import render_to_response, HttpResponseRedirect, HttpResponse\nfrom django.template import RequestContext\nfrom django.contrib.auth.decorators import login_required\nimport commands, json, yaml\nfrom assets.models import Project\nfrom mysite.settings import auth_key\nfrom assets.models import Host, IDC\nimport hashlib, time\nfrom django.views.decorators.csrf import csrf_exempt\nfrom django.shortcuts import redirect\nfrom users.models import CustomUser\nfrom assets.models import project_swan\nfrom assets.ztree.service import ztree_tag\nfrom django.shortcuts import get_object_or_404\nfrom assets.models import Host, IDC, Service, Line, Project, HostRecord\nfrom cmdb_auth.models import AuthNode\n\n\n@login_required\ndef ztree_project(request):\n    line_list = Line.objects.filter()\n    business = Project.objects.filter(line__isnull=False)\n    no_business = Project.objects.filter(line__isnull=True)\n    ztree_data = ztree_tag(request.user.username)\n\n    return render_to_response('default/default.html', locals(), context_instance=RequestContext(request))\n\n\n@login_required\ndef ztree_business(request):\n    \"\"\"\n    \u6811\u8bf7\u6c42\u9a8c\u8bc1\n    :param request:\n    :return:\n    \"\"\"\n    business_name = request.GET.get(\"uuid\", False)\n    get_token = str(request.GET.get(\"token\", False))\n    ztree_data = ztree_tag(request.user.username)\n\n    try:\n        sum_token = str(hashlib.sha1(request.user.username + auth_key + business_name +\n                                     time.strftime('%Y-%m-%d', time.localtime(time.time()))).hexdigest())\n    except TypeError:\n        sum_token = False\n\n    if request.GET.get(\"options\") == \"host\":\n        uuid = request.GET.get('uuid', '')\n        ip = request.GET.get('ip', '')\n        if uuid:\n            host = get_object_or_404(Host, uuid=uuid)\n        elif ip:\n            host = get_object_or_404(Host, eth1=ip)\n        host_record = HostRecord.objects.filter(host=host).order_by('-time')\n        user_audit = AuthNode.objects.filter(node=host)\n        audit_count = user_audit.count()\n        return render_to_response('ztree/host_detail.html', locals(), context_instance=RequestContext(request))\n\n\n    content_status = True\n    idle = request.GET.get(\"idle\", False)\n\n    if get_token != sum_token:\n        content_status = False\n        return render_to_response('ztree/ztree_service.html', locals(), context_instance=RequestContext(request))\n\n    if business_name != u\"\u672a\u5206\u7c7b\":\n        try:\n            bus_data = Project.objects.get(uuid=request.GET.get(\"uuid\"))\n            if not idle:\n                server_list = Host.objects.filter(business=bus_data, idle=True).order_by(\"create_time\")\n            else:\n                server_list = Host.objects.filter(business=bus_data, idle=False).order_by(\"create_time\")\n        except:\n            pass\n\n    else:\n        bus_data = u'\u672a\u5206\u7c7b'\n        idc_data = IDC.objects.filter(type=1)\n        if not idle:\n            server_list = Host.objects.filter(business__isnull=True, idc=idc_data, idle=True).order_by(\"create_time\")\n        else:\n            server_list = Host.objects.filter(business__isnull=True, idc=idc_data, idle=False).order_by(\"create_time\")\n\n    if request.GET.get(\"options\") == \"swan_push\":\n        s = Ztree_class(business_name, request.user.first_name)\n        rst = s.swan()\n        rst_data = rst.get(\"swan_name\")\n        status = len(rst_data)\n        return render_to_response('ztree/swan.html', locals(), context_instance=RequestContext(request))\n\n    if request.GET.get(\"options\") == \"doc\":\n        data = Project.objects.get(pk=business_name)\n        return render_to_response('markdown/index.html', locals(), context_instance=RequestContext(request))\n\n    if request.GET.get(\"options\") == \"highstate\":\n        project = Project.objects.get(uuid=business_name)\n        host_list = Host.objects.filter(business=project)\n        return render_to_response('ztree/highstate.html', locals(), context_instance=RequestContext(request))\n\n    if request.GET.get(\"options\") == \"monitor\":\n        return render_to_response('ztree/zabbix_count.html', locals(), context_instance=RequestContext(request))\n\n    if request.GET.get(\"options\") == \"salt\":\n        return render_to_response('ztree/saltstack.html', locals(), context_instance=RequestContext(request))\n\n\n    if request.GET.get(\"options\") == \"project\":\n        ip_list = []\n        server_list = {}\n        line_name = Line.objects.get(pk=business_name)\n        business_data = Project.objects.filter(line=business_name)\n\n        for i in business_data:\n            node = Host.objects.filter(business=i, idle=True)\n            for k in node:\n                if k.eth1 not in ip_list:\n                    ip_list.append(k.eth1)\n                    server_list[str(k.uuid)] = k.eth1\n        count = len(ip_list)\n        return render_to_response('ztree/project.html', locals(), context_instance=RequestContext(request))\n\n    if request.GET.get(\"options\") == \"types\":\n        get_env = request.GET.get(\"name\")\n        business_data = Project.objects.filter(pk=business_name)\n        server_list = Host.objects.filter(business=business_data, env=get_env).order_by(\"-create_time\")\n\n        count = server_list.count()\n        return render_to_response('ztree/ztree.html', locals(), context_instance=RequestContext(request))\n\n    if request.GET.get(\"options\") == \"service\":\n        s = []\n        bus_data = Project.objects.get(uuid=business_name)\n        server_list = Host.objects.filter(business=bus_data, idle=True).order_by(\"create_time\")\n\n        for i in server_list:\n            t = i.service.all()\n            for b in t:\n                if b not in s:\n                    s.append(b)\n\n        tag = request.GET.get(\"tgt\", False)\n\n        if tag:\n            service_all = Service.objects.get(name=tag)\n            server_list = Host.objects.filter(service=service_all, business=bus_data)\n\n        return render_to_response('ztree/ztree_service.html', locals(), context_instance=RequestContext(request))\n\n    count = server_list.count()\n    return render_to_response('ztree/ztree.html', locals(), context_instance=RequestContext(request))\n\n\n@login_required\ndef CdnCache(request):\n    \"\"\"\n    \u6811\u8bf7\u6c42\u9a8c\u8bc1\n    :param request:\n    :return:\n    \"\"\"\n    service = request.GET.get(\"services\")\n    get_token = str(request.GET.get(\"token\"))\n    uuid = str(request.GET.get(\"uuid\"))\n\n    sum_token = str(hashlib.sha1(request.user.username + auth_key + service + time.strftime('%Y-%m-%d', time.localtime(\n            time.time()))).hexdigest())\n\n    content_status = True\n    if get_token != sum_token:\n        content_status = False\n\n    idc_data = IDC.objects.get(uuid=uuid)\n    service_all = Service.objects.get(name=service)\n    server_list = Host.objects.filter(idc=idc_data, service=service_all)\n    business_name = idc_data.name\n    service_tag = service\n\n    return render_to_response('ztree/service.html', locals(), context_instance=RequestContext(request))\n\n\n@login_required\ndef CdnIdc(request):\n    \"\"\"\n    \u6811\u8bf7\u6c42\u9a8c\u8bc1\n    :param request:\n    :return:\n    \"\"\"\n    get_token = str(request.GET.get(\"token\"))\n    uuid = str(request.GET.get(\"uuid\"))\n    idc_data = IDC.objects.get(uuid=uuid)\n\n    sum_token = str(hashlib.sha1(request.user.username + auth_key + idc_data.name + time.strftime('%Y-%m-%d',\n                                                                                                  time.localtime(\n                                                                                                          time.time()))).hexdigest())\n\n    content_status = True\n    if get_token != sum_token:\n        content_status = False\n\n    server_list = Host.objects.filter(idc=idc_data)\n    business_name = idc_data.name\n\n    return render_to_response('ztree/idc.html', locals(), context_instance=RequestContext(request))\n\n\nclass Ztree_class(object):\n    \"\"\"\n    ztree \u7c7b\n    \"\"\"\n\n    def __init__(self, project_name, user):\n        self.project_name = project_name\n        self.user = user\n\n    def monitor(self):\n        return True\n\n    def swan(self):\n        return\n        rst_data = {}\n\n        user_info = CustomUser.objects.get(first_name=self.user)\n\n        myform_rst = Project.objects.get(uuid=self.project_name)\n\n        rst = project_swan.objects.filter(project_name_id=myform_rst.uuid)\n\n        \"\"\"\n        \u6240\u6709\u5f53\u524d\u9879\u76ee\u53d1\u5e03\u540d\u79f0\u653e\u5230\u4e00\u4e2alist\u4e2d\n        \"\"\"\n\n        swan_name_list = [i.swan_name for i in rst]\n        swan_push = user_info.project_swan_set.all()\n        user = CustomUser.objects.get(first_name=self.user)\n\n        if user.is_superuser:\n\n            for i in rst:\n                rst_data[str(i.uuid)] = i.swan_name\n\n        else:\n            swan_push = user_info.project_swan_set.all()\n            for i in swan_push:\n                if i.swan_name in swan_name_list:\n                    rst_data[str(i.uuid)] = i.swan_name\n\n        host_list = myform_rst.host_set.all()\n        content = {\"swan_name\": rst_data, \"host\": host_list}\n\n        return content\n\n    def highstate(self):\n        project = Project.objects.get(service_name=self.project_name)\n        host_list = Host.objects.filter(business=project)\n\n        return True\n\n\n@csrf_exempt\ndef ZtreeIndex(request):\n    \"\"\"\n\n    :param request:\n    :return:\n    \"\"\"\n    if request.method == 'POST':\n        otherParam = request.POST.get(\"otherParam\")\n        status = request.POST.get(\"status\")\n        line_id = request.POST.get(\"line_id\")\n\n        try:\n            name = request.POST.get(\"name\")\n            id = request.POST.get(\"id\")\n\n        except:\n            name = False\n\n        if not name:\n            ztree = ztree_tag(request.user.username)\n            return HttpResponse(json.dumps(ztree, ensure_ascii=False, indent=4))\n\n        elif int(status[0]) == 1:\n            ztree = []\n            return HttpResponse(json.dumps(ztree, ensure_ascii=False, indent=4))\n\n        else:\n            ztree = []\n            bus_data = Project.objects.get(service_name=name)\n            server_list = Host.objects.filter(business=bus_data).order_by(\"create_time\")\n\n            s = []\n            for i in server_list:\n                t = i.service.all().values()\n                for b in t:\n                    if b not in s:\n                        s.append(b)\n            tree_id = 0\n            for i in s:\n                tree_id += 1\n\n                token = hashlib.sha1(request.user.username + auth_key + i.get(\"name\") + time.strftime('%Y-%m-%d',\n                                                                                                      time.localtime(\n                                                                                                              time.time()))).hexdigest()\n\n                ztree.append({\"id\": tree_id, \"status\": 3, \"line_id\": line_id, \"name\": i.get(\"name\"), \"token\": token,\n                              \"t\": i.get(\"name\"), \"business\": bus_data.service_name})\n\n            return HttpResponse(json.dumps(ztree, ensure_ascii=False, indent=4))\n    content = {\"status\": 403, \"message\": \"auth error\"}\n    return HttpResponse(json.dumps(content, ensure_ascii=False, indent=4))\n",
  "line_no": 218,
  "line_no_percent": "71%"
}