{
  "instruction": "This code is a script to filter out isoforms from peptide files in FASTA ENSEMBL or NCBI format. It can also add an easier to read species label to each sequence within the file. To use this script, you need to specify the input file, input file type, and output file. For ENSEMBL files, use the following command: python isoform_filter.py -i [input_fasta_file] -t ens -l [species_label] -o [output_filename]. For NCBI files, use the following command: python isoform_filter.py -i [input_fasta_file] -t ncbi -g [toplevel_gff_file] -l [species_label] -o [output_filename]. To just do the relabeling, set -f 0. You shouldn't need a gff file for the NCBI file in this case. For NCBI relabeling, the gene ID is also moved to the front of the title line.",
  "buggy_code": "import sys, re, os, argparse\nsys.path.append(os.path.dirname(os.path.realpath(__file__)) + \"/corelib/\")\nimport core\n\n\ndef optParse():\n\n\treturn\n\tparser = argparse.ArgumentParser()\n\n\tparser.add_argument(\"-i\", dest=\"input_file\", help=\"An input file containing peptides from a species in FASTA format\");\n\tparser.add_argument(\"-t\", dest=\"file_type\", help=\"Currently supported file types are ENSEMBL and NCBI peptide files. Enter as 'ens' or 'ncbi' here. Note: If file type is NCBI you will also need to specify the top level gff file with -g\")\n\tparser.add_argument(\"-g\", dest=\"gff_file\", help=\"If file type is NCBI, the top level gff file is also needed and should be specified here.\");\n\tparser.add_argument(\"-l\", dest=\"spec_label\", help=\"A species label to add to the gene ID of each sequence.\", default=\"\");\n\tparser.add_argument(\"-o\", dest=\"output_file\", help=\"The desired name of the output file. If none is specified the default is [input_filename]_isofiltered.fa or [input_filename]_isofiltered_relabel.fa\");\n\n\targs = parser.parse_args();\n\n\tif None in [args.input_file, args.file_type, args.output_file]:\n\t\tsys.exit(core.errorOut(1, \"An input file (-i), input file type (-t), and an output file (-o) must all be specified\"));\n\n\tif args.file_type not in ['ens', 'ncbi']:\n\t\tsys.exit(core.errorOut(2, \"File type (-t) must be one of either 'ens' (Ensembl) or 'ncbi'\"));\n\n\tif args.file_type == \"ens\" and args.gff_file != None:\n\t\tsys.exit(core.errorOut(3, \"A gff file (-g) should not be specified with file type ens\"));\n\n\tif args.file_type == \"ncbi\" and args.gff_file == None:\n\t\tsys.exit(core.errorOut(4, \"A gff file (-g) must be specified with file type ncbi\"));\n\n\treturn args.input_file, args.file_type, args.gff_file, args.spec_label, args.output_file;\n\ndef ensFilter(inseqs, spec_label, outfilename):\n\n\tprint \"Indexing\", len(inseqs), \"sequences to be filtered.\";\n\tprint \"Parsing identifiers...\";\n\n\tfor title in inseqs:\n\t\tgeneid = title[title.index(\"gene:\") + 5:title.index(\"gene:\") + 23];\n\n\t\tif geneid in identDict:\n\t\t\tidentDict[geneid].append((title, inseqs[title]));\n\t\telse:\n\t\t\tidentDict[geneid] = [];\n\t\t\tidentDict[geneid].append((title, inseqs[title]));\n\tsys.stderr.write('\\b');\n\n\tprint \"Filtering and writing sequences...\";\n\tnumbars, donepercent, i = 0,[],0;\n\n\tfor key in identDict:\n\t\tnumbars, donepercent = core.loadingBar(i, len(identDict), donepercent, numbars);\n\n\t\tif len(identDict[key]) == 1:\n\t\t\tlong_title, long_seq = identDict[key][0];\n\n\t\telse:\n\t\t\ttitlelist = [];\n\t\t\tseqlist = [];\n\n\t\t\tfor tup in identDict[key]:\n\t\t\t\tcur_itle, cur_seq = tup;\n\t\t\t\ttitlelist.append(cur_itle);\n\t\t\t\tseqlist.append(cur_seq);\n\n\t\t\tlong_seq = max(seqlist, key=len)\n\t\t\tlong_title = titlelist[seqlist.index(long_seq)];\n\n\t\tnew_title = \">\" + spec_label + \"_\" + long_title[1:];\n\t\tcore.writeSeq(outfilename, long_seq, new_title);\n\t\ti += 1;\n\n\tpstring = \"100.0% complete.\";\n\tsys.stderr.write('\\b' * len(pstring) + pstring);\n\tprint \"\\nDone!\";\n\tprint i, \"sequences written.\";\n\tprint len(inseqs) - i, \"sequences filtered.\";\n\ndef ncbiFilter(inseqs, gff_file, spec_label, outfilename):\n\n\tnumbars, donepercent, i = 0, [], 0;\n\n\n\tprint \"Obtaining longest isoforms from .gff file...\";\n\n\tcmd = \"zcat \" + gff_file + \" | awk \\'BEGIN{FS=\\\"\t\\\";OFS=\\\"|\\\"}$3==\\\"CDS\\\"{if($4<$5){print $5-$4+1,$9}else{print $4-$5+1,$9}}\\' | grep \\\"[NX]P[_]\\\" | sed \\'s/\\([0-9]*\\).*GeneID:\\([0-9]*\\).*\\([NX]P[_][0-9]*\\.[0-9]*\\).*/\\\\1|\\\\2|\\\\3/\\' | awk \\'BEGIN{FS=\\\"|\\\";OFS=\\\"\\t\\\";gene=\\\"\\\";acc=\\\"\\\";len=0}{if(acc!=$3){print gene,acc,len/3-1;gene=$2;acc=$3;len=$1}else{len=len+$1}}END{print gene,acc,len/3-1}\\' | sort -k1,1n -k3,3nr -k2,2 | awk \\'BEGIN{FS=\\\"\t\\\";OFS=\\\"\t\\\";gene=\\\"\\\";acc=\\\"\\\";len=0}{if(gene!=$1){print $1,$2,$3};gene=$1;acc=$2;len=$3}\\' > ncbi_isoform_filter_tmp11567.txt\"\n\tos.system(cmd);\n\n\ttmpFile = open(\"ncbi_isoform_filter_tmp11567.txt\", \"r\");\n\ttmpLines = tmpFile.readlines();\n\ttmpFile.close();\n\tos.system(\"rm ncbi_isoform_filter_tmp11567.txt\");\n\n\tlongest_isos = [];\n\n\tfor each in tmpLines:\n\t\tlongest_isos.append(each.split(\"\\t\")[1]);\n\tlongest_isos = filter(None, longest_isos);\n\n\tprint \"Writing longest isoforms to output file...\";\n\n\tcount = 0;\n\n\tfor title in inseqs:\n\t\tnumbars, donepercent = core.loadingBar(i, len(inseqs), donepercent, numbars);\n\t\ti += 1;\n\n\t\tfound = 0;\n\n\t\tfor gid in longest_isos:\n\t\t\tif gid in title:\n\t\t\t\tgid = title[title.index(\"P_\")-1:title.index(\"|\",title.index(\"P_\"))]\n\t\t\t\tnew_title = \">\" + spec_label + \"_\" + gid + \" |\" + title[1:title.index(\"P_\")-1] + title[title.index(\"|\",title.index(\"P_\"))+1:];\n\t\t\t\tcore.writeSeq(outfilename, inseqs[title], new_title);\n\t\t\t\tcount += 1;\n\t\t\t\tbreak;\n\n\tpstring = \"100.0% complete.\";\n\tsys.stderr.write('\\b' * len(pstring) + pstring);\n\tprint \"\\nDone!\";\n\tprint count, \"sequences written.\";\n\tprint len(inseqs) - count, \"sequences filtered.\";\n\n\ninfilename, in_type, gff_file, label, outfilename = optParse();\n\npad = 50;\nprint \"=======================================================================\";\nprint \"\\t\\t\\t\" + core.getDateTime();\nprint core.spacedOut(\"Filtering isoforms from:\", pad), infilename;\nif in_type == \"ens\":\n\tprint core.spacedOut(\"File type:\", pad), \"Ensembl\";\nif in_type == \"ncbi\":\n\tprint core.spacedOut(\"File type:\", pad), \"NCBI\";\n\tprint core.spacedOut(\"Using GFF file:\", pad), gff_file;\nif in_type == \"crow\":\n\tprint core.spacedOut(\"File type:\", pad), \"Crow\";\nif label != \"\":\n\tprint core.spacedOut(\"Adding label to beginning of FASTA headers:\", pad), label;\nprint core.spacedOut(\"Writing output to:\", pad), outfilename;\ncore.filePrep(outfilename);\nprint \"--------------------------\";\n\nidentDict = {};\nins, skip_flag = core.fastaReader(infilename);\n\nif in_type == \"ens\":\n\tensFilter(ins, label, outfilename);\nelif in_type == \"ncbi\":\n\tncbiFilter(ins, gff_file, label, outfilename);\n\nprint \"=======================================================================\";\n",
  "line_no": 8,
  "line_no_percent": "5%"
}