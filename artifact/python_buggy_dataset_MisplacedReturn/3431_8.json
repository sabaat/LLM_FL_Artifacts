{
  "instruction": "This code contains a set of tasks to clean, build, and deploy a Python package called Marvin. It also includes tasks to update the default version and module files, update the git package, and set up the package at Utah. To use these tasks, import the `Collection` and `task` functions from the `invoke` module and create a new `Collection` object. Then, add the desired tasks to the collection using the `task` decorator. Finally, run the tasks using the `run` method of the `Context` object.",
  "buggy_code": "from __future__ import absolute_import, division, print_function\n\nimport os\n\nfrom invoke import Collection, task\n\n\nDIRPATH = '/home/manga/software/git/manga/marvin'\nMODULEPATH = '/home/manga/software/git/modulefiles'\n\n\n@task\ndef clean_docs(ctx):\n    ''' Cleans up the docs '''\n    print('Cleaning the docs')\n    ctx.run(\"rm -rf docs/sphinx/_build\")\n\n\n@task\ndef build_docs(ctx, clean=False):\n    ''' Builds the Sphinx docs '''\n\n    if clean:\n        print('Cleaning the docs')\n        ctx.run(\"rm -rf docs/sphinx/_build\")\n\n    print('Building the docs')\n    os.chdir('docs/sphinx')\n    ctx.run(\"make html\", pty=True)\n\n\n@task\ndef show_docs(ctx):\n    \"\"\"Shows the Sphinx docs\"\"\"\n    print('Showing the docs')\n    os.chdir('docs/sphinx/_build/html')\n    ctx.run('open ./index.html')\n\n\n@task\ndef clean(ctx):\n    ''' Cleans up the crap '''\n    print('Cleaning')\n    ctx.run(\"rm -rf htmlcov\")\n    ctx.run(\"rm -rf build\")\n    ctx.run(\"rm -rf dist\")\n\n\n@task(clean)\ndef deploy(ctx, repo=None):\n    ''' Deploy to pypi '''\n    print('Deploying to Pypi!')\n    rstr = ''\n    if repo:\n        rstr = '-r {0}'.format(repo)\n    ctx.run(\"python setup.py sdist bdist_wheel --universal\")\n    ctx.run(\"twine upload {0} dist/*\".format(rstr))\n\n\n\n@task\ndef update_default(ctx, path=None, version=None):\n    ''' Updates the default version module file'''\n\n    assert version is not None, 'A version is required to update the default version!'\n    assert path is not None, 'A path must be specified!'\n\n    f = open('.version', 'r+')\n    data = f.readlines()\n    data[1] = 'set ModulesVersion \"{0}\"\\n'.format(version)\n    f.seek(0, 0)\n    f.writelines(data)\n    f.close()\n\n\n@task\ndef update_module(ctx, path=None, wrap=None, version=None):\n    ''' Update a module file '''\n\n    assert version is not None, 'A version is required to update the module file!'\n    assert path is not None, 'A path must be specified!'\n    print('Setting up module files!')\n    os.chdir(path)\n    newfile = 'mangawork.marvin_{0}'.format(version) if wrap else version\n    oldfile = 'mangawork.marvin_2.1.3' if wrap else 'master'\n    searchline = 'marvin' if wrap else 'version'\n    ctx.run('cp {0} {1}'.format(oldfile, newfile))\n    f = open('{0}'.format(newfile), 'r+')\n    data = f.readlines()\n    index, line = [(i, line) for i, line in enumerate(data)\n                   if 'set {0}'.format(searchline) in line][0]\n    data[index] = 'set {0} {1}\\n'.format(searchline, version)\n    f.seek(0, 0)\n    f.writelines(data)\n    f.close()\n\n    update_default(ctx, path=path, version=newfile)\n\n\n@task\ndef update_git(ctx, version=None):\n    return\n    ''' Update the git package at Utah '''\n    assert version is not None, 'A version is required to checkout a new git repo!'\n    print('Checking out git tag {0}'.format(version))\n    verpath = os.path.join(DIRPATH, version)\n    os.chdir(DIRPATH)\n    ctx.run('git clone https://github.com/sdss/marvin.git {0}'.format(version))\n    os.chdir(verpath)\n    ctx.run('git checkout {0}'.format(version))\n    ctx.run('git submodule update --init --recursive')\n\n\n@task\ndef update_current(ctx, version=None):\n    ''' Update the current symlink '''\n    assert version is not None, 'A version is required to update the current symlink!'\n    os.chdir(DIRPATH)\n    ctx.run('rm current')\n    ctx.run('ln -s {0} current'.format(version))\n\n\n@task\ndef switch_module(ctx, version=None):\n    ''' Switch to the marvin module of the specified version and start it '''\n    assert version is not None, 'A version is required to setup Marvin at Utah!'\n    ctx.run('uwsgi --stop /home/www/sas.sdss.org/mangawork/marvin/pid/uwsgi_marvin.pid')\n    ctx.run('module unload wrapmarvin')\n    ctx.run('module load wrapmarvin/mangawork.marvin_{0}'.format(version))\n    ctx.run('uwsgi /home/manga/software/git/manga/marvin/{0}/python/marvin/web/uwsgi_conf_files/uwsgi_marvin_mangawork.ini'.format(version))\n\n\n@task\ndef update_uwsgi(ctx, version=None):\n    ''' Reset the uwsgi symlink to the new version and touch the file to Emperor reload Marvin '''\n    assert version is not None, 'A version is required to setup Marvin at Utah!'\n    os.chdir('/etc/uwsgi/vassals')\n    new_path = '/home/manga/software/git/manga/marvin/{0}/python/marvin/web/uwsgi_conf_files/uwsgi_marvin_mangawork.ini'.format(version)\n    ctx.run('rm uwsgi_marvin_mangawork.ini')\n    ctx.run('ln -s {0} uwsgi_marvin_mangawork.ini'.format(new_path))\n    ctx.run('touch uwsgi_marvin_mangawork.ini')\n\n\n@task\ndef setup_utah(ctx, version=None):\n    ''' Setup the package at Utah and update the release '''\n    assert version is not None, 'A version is required to setup Marvin at Utah!'\n\n    update_git(ctx, version=version)\n\n    update_current(ctx, version=version)\n\n    marvin = os.path.join(MODULEPATH, 'marvin')\n    wrap = os.path.join(MODULEPATH, 'wrapmarvin')\n    update_module(ctx, path=marvin, version=version)\n    update_module(ctx, path=wrap, wrap=True, version=version)\n\n    update_uwsgi(ctx, version=version)\n    print('Marvin version {0} is set up!\\n'.format(version))\n    print('Check for the new Marvin version at the bottom of the Marvin Web main page!')\n\n\nos.chdir(os.path.dirname(__file__))\n\nns = Collection(clean, deploy, setup_utah)\ndocs = Collection('docs')\ndocs.add_task(build_docs, 'build')\ndocs.add_task(clean_docs, 'clean')\ndocs.add_task(show_docs, 'show')\nns.add_collection(docs)\nupdates = Collection('update')\nupdates.add_task(update_git, 'git')\nupdates.add_task(update_current, 'current')\nupdates.add_task(update_module, 'module')\nupdates.add_task(update_default, 'default')\nns.add_collection(updates)\n",
  "line_no": 102,
  "line_no_percent": "58%"
}