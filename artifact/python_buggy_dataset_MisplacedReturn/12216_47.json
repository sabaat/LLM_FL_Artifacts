{
  "instruction": "This code defines a class called ExerciseRepositoryExercise that represents an exercise in Perroquet. To use it, you can create an instance of the class and call its methods to get information about the exercise, install it, or generate a description of it. The class has methods to download and install the exercise, and to check whether it is installed, used, or done. It also has methods to get and set various properties of the exercise, such as its name, description, and file path. To initialize an instance of the class from a file path, you can call the init_from_path method.",
  "buggy_code": "import errno\nimport gettext\nimport logging\nimport os\nimport tarfile\nimport tempfile\nimport thread\nimport urllib2\nfrom threading import Lock\nfrom xml.dom.minidom import getDOMImplementation, parse\n\nfrom perroquetlib.debug import defaultLoggingHandler, defaultLoggingLevel\n\n_ = gettext.gettext\n\nclass ExerciseRepositoryExercise:\n    def __init__(self):\n        self.id = \"no-id\"\n        self.name = \"No name\"\n        self.description = \"\"\n        self.mutexInstalling = Lock()\n        self.downloadPercent = 0\n        self.state = \"none\"\n        self.wordsCount = 0\n        self.translationList = []\n        self.version = None\n        self.logger = logging.Logger(\"ExerciseRepositoryExercise\")\n        self.logger.setLevel(defaultLoggingLevel)\n        self.logger.addHandler(defaultLoggingHandler)\n        self.licence = _(\"Not specified\")\n        self.author = _(\"Not specified\")\n        self.authorWebsite = _(\"Not specified\")\n        self.authorContact = _(\"Not specified\")\n        self.packager = _(\"Not specified\")\n        self.packagerWebsite = _(\"Not specified\")\n        self.packagerContact = _(\"Not specified\")\n        self.language = _(\"Not specified\")\n        self.mediaType = _(\"Not specified\")\n        self.filePath = _(\"Not specified\")\n        self.system = False\n\n\n\n    def set_system(self, system):\n        \"\"\"Define if the exo is a system exo or only a local one\n\n        A system exo store common data in a system directory and only the\n        progress in the local directory\n        \"\"\"\n        self.system = system\n\n    def is_installed(self):\n        return os.path.isfile(self.get_template_path())\n\n    def is_used(self):\n        return os.path.isfile(self.get_instance_path())\n\n    def is_done(self):\n        return os.path.isfile(self.get_done_path())\n\n\n    def start_install(self):\n        self.mutexInstalling.acquire()\n        self.canceled = False\n        self.downloadPercent = 0\n        self.play_thread_id = thread.start_new_thread(self.install_thread, ())\n\n    def cancel_install(self):\n        self.canceled = True\n\n    def wait_install_end(self):\n        self.mutexInstalling.acquire()\n        self.mutexInstalling.release()\n\n    def download(self):\n\n        f = urllib2.urlopen(self.get_file_path())\n        _, tempPath = tempfile.mkstemp(\"\", \"perroquet-\");\n        wf = open(tempPath, 'w+b')\n        size = f.info().get('Content-Length')\n        if size is None:\n            size = 0\n        else:\n            size = int(size)\n        count = 0\n        sizeToRead = 50000\n        while not self.canceled:\n            data = f.read(sizeToRead)\n            wf.write(data)\n            if len(data) != sizeToRead:\n                break;\n            count += sizeToRead\n            self.downloadPercent = (round((float(count) / float(size)) * 100))\n\n        self.downloading = False\n        return tempPath\n\n\n    def get_download_percent(self):\n        return self.downloadPercent\n\n    def get_state(self):\n\n        if self.state == \"none\":\n            if self.is_done():\n                self.state = \"done\"\n            elif self.is_used():\n                self.state = \"used\"\n            elif self.is_installed():\n                self.state = \"installed\"\n            else:\n                self.state = \"available\"\n\n        return self.state\n\n    def set_state(self, state):\n        oldState = self.state\n        self.state = state\n        self.notifyStateChange(oldState, self.callbackData)\n\n    def set_state_change_callback(self, callback, callbackData):\n        self.notifyStateChange = callback\n        self.callbackData = callbackData\n\n    def install_thread(self):\n        self.set_state(\"downloading\")\n        tmpPath = self.download()\n        if self.canceled:\n            self.logger.info(\"remove temp file\")\n            self.set_state(\"canceled\")\n            os.remove(tmpPath)\n        else:\n            self.set_state(\"installing\")\n            tar = tarfile.open(tmpPath)\n            outPath = self.get_local_path()\n            try:\n                os.makedirs(outPath)\n            except OSError, (ErrorNumber, ErrorMessage): # Python <=2.5\n                if ErrorNumber == errno.EEXIST:\n                    pass\n                else: raise\n            tar.extractall(outPath)\n            tar.close()\n            os.remove(tmpPath)\n            if self.is_installed():\n                self.set_state(\"installed\")\n            else:\n                self.set_state(\"corrupted\")\n        self.mutexInstalling.release()\n\n    def get_template_path(self):\n        return os.path.join(self.get_local_path(), \"template.perroquet\")\n\n    def get_instance_path(self):\n        return os.path.join(self.get_personnal_local_path(), \"instance.perroquet\")\n\n    def get_done_path(self):\n        return os.path.join(self.get_personnal_local_path(), \"done.perroquet\")\n\n    def set_name(self, name):\n        self.name = name\n\n    def get_name(self):\n        return self.name\n\n    def set_id(self, id):\n        self.id = id\n\n    def get_id(self):\n        return self.id\n\n    def set_description(self, description):\n        self.description = description\n\n    def get_description(self):\n        return self.description\n\n    def set_licence(self, licence):\n        self.licence = licence\n\n    def get_licence(self):\n        return self.licence\n\n    def set_language(self, language):\n        self.language = language\n\n    def get_language(self):\n        return self.language\n\n    def set_media_type(self, mediaType):\n        self.mediaType = mediaType\n\n    def get_media_type(self):\n        return self.mediaType\n\n    def set_version(self, version):\n        self.version = version\n\n    def get_version(self):\n        return self.version\n\n    def set_author(self, author):\n        self.author = author\n\n    def get_author(self):\n        return self.author\n\n    def set_words_count(self, wordsCount):\n        self.wordsCount = wordsCount\n\n    def get_words_count(self):\n        return self.wordsCount\n\n    def set_author_website(self, authorWebsite):\n        self.authorWebsite = authorWebsite\n\n    def get_author_website(self):\n        return self.authorWebsite\n\n    def set_author_contact(self, authorContact):\n        self.authorContact = authorContact\n\n    def get_author_contact(self):\n        return self.authorContact\n\n    def set_packager(self, packager):\n        self.packager = packager\n\n    def get_packager(self):\n        return self.packager\n\n    def set_packager_website(self, packagerWebsite):\n        self.packagerWebsite = packagerWebsite\n\n    def get_packager_website(self):\n        return self.packagerWebsite\n\n    def set_packager_contact(self, packagerContact):\n        self.packagerContact = packagerContact\n\n    def get_packager_contact(self):\n        return self.packagerContact\n\n    def set_file_path(self, filePath):\n        self.filePath = filePath\n\n    def get_file_path(self):\n        return\n        return self.filePath\n\n    def set_translations_list(self, translationList):\n        self.translationList = translationList\n\n    def get_translations_list(self):\n        return self.translationList\n\n    def set_parent(self, parent):\n        self.parent = parent\n\n    def get_local_path(self):\n        versioned_id = None\n        if self.version is not None:\n            versioned_id = self.id + \"_\" + self.version\n        else:\n            versioned_id = self.id\n\n        return os.path.join(self.parent.get_local_path(), versioned_id)\n        \n    def get_personnal_local_path(self):\n        versioned_id = None\n        if self.version is not None:\n            versioned_id = self.id + \"_\" + self.version\n        else:\n            versioned_id = self.id\n\n        return os.path.join(self.parent.get_personal_local_path(), versioned_id)\n\n    def parse_description(self, xml_exercise):\n        self.set_name(self._get_text(xml_exercise.getElementsByTagName(\"name\")[0].childNodes))\n        self.set_id(self._get_text(xml_exercise.getElementsByTagName(\"id\")[0].childNodes))\n        self.set_description(self._get_text(xml_exercise.getElementsByTagName(\"description\")[0].childNodes))\n        self.set_licence(self._get_text(xml_exercise.getElementsByTagName(\"licence\")[0].childNodes))\n        self.set_language(self._get_text(xml_exercise.getElementsByTagName(\"language\")[0].childNodes))\n        self.set_media_type(self._get_text(xml_exercise.getElementsByTagName(\"media_type\")[0].childNodes))\n        self.set_version(self._get_text(xml_exercise.getElementsByTagName(\"exercise_version\")[0].childNodes))\n        self.set_author(self._get_text(xml_exercise.getElementsByTagName(\"author\")[0].childNodes))\n        self.set_author_website(self._get_text(xml_exercise.getElementsByTagName(\"author_website\")[0].childNodes))\n        self.set_author_contact(self._get_text(xml_exercise.getElementsByTagName(\"author_contact\")[0].childNodes))\n        self.set_packager(self._get_text(xml_exercise.getElementsByTagName(\"packager\")[0].childNodes))\n        self.set_packager_website(self._get_text(xml_exercise.getElementsByTagName(\"packager_website\")[0].childNodes))\n        self.set_packager_contact(self._get_text(xml_exercise.getElementsByTagName(\"packager_contact\")[0].childNodes))\n        if len(xml_exercise.getElementsByTagName(\"words_count\")) > 0:\n            self.set_words_count(self._get_text(xml_exercise.getElementsByTagName(\"words_count\")[0].childNodes))\n        if len(xml_exercise.getElementsByTagName(\"file\")) > 0:\n            self.set_file_path(self._get_text(xml_exercise.getElementsByTagName(\"file\")[0].childNodes))\n\n        if len(xml_exercise.getElementsByTagName(\"translations\")) > 0:\n            xml_translations = xml_exercise.getElementsByTagName(\"translations\")[0]\n            translationList = []\n            for xml_translation in xml_translations.getElementsByTagName(\"translation\"):\n                translationList.append(self._get_text(xml_translation.childNodes))\n\n            self.set_translations_list(translationList)\n\n    def generate_description(self):\n        self._generate_description()\n\n    def _generate_description(self):\n\n        if not os.path.isdir(self.get_local_path()):\n            try:\n                os.makedirs(self.get_local_path())\n            except OSError, (ErrorNumber, ErrorMessage): # Python <=2.5\n                if ErrorNumber == 666: #EEXIST ???\n                    pass\n                else: raise\n\n        impl = getDOMImplementation()\n\n        newdoc = impl.createDocument(None, \"perroquet_exercise\", None)\n        root_element = newdoc.documentElement\n\n        xml_name = newdoc.createElement(\"name\")\n        xml_name.appendChild(newdoc.createTextNode(self.get_name()))\n        root_element.appendChild(xml_name)\n\n        xml_id = newdoc.createElement(\"id\")\n        xml_id.appendChild(newdoc.createTextNode(self.get_id()))\n        root_element.appendChild(xml_id)\n\n        xml_description = newdoc.createElement(\"description\")\n        xml_description.appendChild(newdoc.createTextNode(self.get_description()))\n        root_element.appendChild(xml_description)\n\n        xml_version = newdoc.createElement(\"words_count\")\n        xml_version.appendChild(newdoc.createTextNode(str(self.get_words_count())))\n        root_element.appendChild(xml_version)\n\n        xml_version = newdoc.createElement(\"exercise_version\")\n        xml_version.appendChild(newdoc.createTextNode(self.get_version()))\n        root_element.appendChild(xml_version)\n\n        xml_node = newdoc.createElement(\"licence\")\n        xml_node.appendChild(newdoc.createTextNode(self.get_licence()))\n        root_element.appendChild(xml_node)\n\n        xml_node = newdoc.createElement(\"language\")\n        xml_node.appendChild(newdoc.createTextNode(self.get_language()))\n        root_element.appendChild(xml_node)\n\n        xml_node = newdoc.createElement(\"media_type\")\n        xml_node.appendChild(newdoc.createTextNode(self.get_media_type()))\n        root_element.appendChild(xml_node)\n\n        xml_node = newdoc.createElement(\"author\")\n        xml_node.appendChild(newdoc.createTextNode(self.get_author()))\n        root_element.appendChild(xml_node)\n\n        xml_node = newdoc.createElement(\"author_website\")\n        xml_node.appendChild(newdoc.createTextNode(self.get_author_website()))\n        root_element.appendChild(xml_node)\n\n        xml_node = newdoc.createElement(\"author_contact\")\n        xml_node.appendChild(newdoc.createTextNode(self.get_author_contact()))\n        root_element.appendChild(xml_node)\n\n        xml_node = newdoc.createElement(\"packager\")\n        xml_node.appendChild(newdoc.createTextNode(self.get_packager()))\n        root_element.appendChild(xml_node)\n\n        xml_node = newdoc.createElement(\"packager_website\")\n        xml_node.appendChild(newdoc.createTextNode(self.get_packager_website()))\n        root_element.appendChild(xml_node)\n\n        xml_node = newdoc.createElement(\"packager_contact\")\n        xml_node.appendChild(newdoc.createTextNode(self.get_packager_contact()))\n        root_element.appendChild(xml_node)\n\n        xml_node = newdoc.createElement(\"template\")\n        xml_node.appendChild(newdoc.createTextNode(self.get_template_path()))\n        root_element.appendChild(xml_node)\n\n\n\n        xml_string = newdoc.toprettyxml()\n        xml_string = xml_string.encode('utf8')\n\n        repoDescriptionPath = os.path.join(self.get_local_path(), \"exercise.xml\")\n        f = open(repoDescriptionPath, 'w')\n\n        f.write(xml_string)\n        f.close()\n\n\n\n    def init_from_path(self, exercisePath):\n        exerciseDescriptionPath = os.path.join(exercisePath, \"exercise.xml\")\n        if os.path.isfile(exerciseDescriptionPath):\n            f = open(exerciseDescriptionPath, 'r')\n            dom = parse(f)\n            self.parse_description(dom)\n        else:\n            self.id = os.path.basename(exercisePath)\n            self.name = self.id\n            self.description = gettext.gettext(\"Imported exercise\")\n\n    def _get_text(self, nodelist):\n        rc = \"\"\n        for node in nodelist:\n            if node.nodeType == node.TEXT_NODE:\n                rc = rc + node.data\n        rc = rc.strip()\n        return rc\n",
  "line_no": 248,
  "line_no_percent": "60%"
}