{
  "instruction": "This code opens a PDF file and displays its metadata, renders the first page of the PDF with a specified zoom factor and rotation, extracts the text from the page, and displays it in a scrollable window. To use this code, run the Python script with the PDF file name as the first argument and optional arguments for page number, zoom factor, and rotation. The extracted text can be further processed or saved to a file.",
  "buggy_code": "import argparse\nimport sys\n\nimport numpy as np\n\nimport mupdf as cmupdf\nfrom MuPDF import *\n\nfrom PyQt4 import QtCore, QtGui\n\n\ndef show_metadata(ctx, doc):\n\n    for key in (\n        'Title',\n        'Subject',\n        'Author',\n        'Creator',\n        'Producer',\n        'CreationDate',\n        'ModDate',\n        ):\n        print cmupdf.get_meta_info(doc, key, 1024)\n    \n    fz_buffer = cmupdf.pdf_metadata(doc)\n    print cmupdf.fz_buffer_data(fz_buffer)\n    cmupdf.fz_drop_buffer(ctx, fz_buffer)\n\n\ndef show_pdf(np_array):\n\n    application = QtGui.QApplication(sys.argv)\n\n    height, width = np_array.shape[:2]\n    image = QtGui.QImage(np_array.data, width, height, QtGui.QImage.Format_ARGB32)\n\n    label = QtGui.QLabel()\n    label.setPixmap(QtGui.QPixmap.fromImage(image))\n\n    area = QtGui.QScrollArea()\n    area.setWidget(label)\n    area.setWindowTitle(args.filename)\n    area.show()\n\n    application.exec_()\n\n\ndef get_font_name(font):\n\n    font_name = cmupdf.get_font_name(font)\n    i = font_name.find('+')\n    if i:\n        font_name = font_name[i+1:] \n\n    return font_name\n\n\ndef dump_bbox(obj):\n\n    return \"[%g %g %g %g]\" % (obj.bbox.x0, obj.bbox.y0,\n                              obj.bbox.x1, obj.bbox.y1)\n\n\ndef dump_text_style(text_sheet):\n\n    style = text_sheet.style\n    while style:\n        font = style.font\n        message = \"span.s%u{font-family:\\\"%s\\\";font-size:%gpt\" % (style.id, get_font_name(font), style.size)\n        if cmupdf.font_is_italic(font):\n            message += ';font-style:italic'\n        if cmupdf.font_is_bold(font):\n            message += ';font-weight:bold;'\n        message += '}'\n        print message\n        style = style.next\n\n\ndef dump_text_page_xml(text_page):\n\n    print \"<page>\"\n    for block in TextBlockIterator(text_page):\n        print \"<block bbox=\\\"\" + dump_bbox(block) + \"\\\">\"\n        for line in TextLineIterator(block):\n            print \" \"*2 + \"<line bbox=\\\"\" + dump_bbox(line) + \"\\\">\"\n            for span in TextSpanIterator(line):\n                print \" \"*4 + \"<span bbox=\\\"\" + dump_bbox(span) + \"\\\" \\\">\"\n                for ch in TextCharIterator(span):\n                    style = ch.style\n                    font_name = get_font_name(style.font)\n                    print \" \"*6 + \"<char \" + \\\n                        u\" c=\\\"%s\\\" font=\\\"%s\\\" size=\\\"%g\\\"/>\" % (unichr(ch.c), font_name, style.size)\n                print \" \"*4 + \"</span>\"\n            print \" \"*2 + \"</line>\"\n        print \"</block>\"\n    print \"</page>\"\n\n\n\ndef dump_text_page(text_page):\n\n    empty_block = False\n    for block in TextBlockIterator(text_page):\n        if not empty_block:\n            print '\\n<Block>'\n        empty_block = True\n        for line in TextLineIterator(block):\n            line_text = u''\n            for span in TextSpanIterator(line):\n                span_text = u''\n                for ch in TextCharIterator(span):\n                    span_text += unichr(ch.c)\n                span_text = span_text.rstrip()\n                if span_text:\n                    line_text += '<Span>' + span_text + '</Span>'\n                else:\n                    line_text += '<Empty Span>'\n            if line_text:\n                print line_text\n                empty_block = False\n\n\nclass GrowingTextBrowser(QtGui.QTextBrowser):\n\n    _id = 0\n\n\n    def __init__(self, *args, **kwargs):\n\n        GrowingTextBrowser._id += 1\n        self._id = GrowingTextBrowser._id\n\n        super(GrowingTextBrowser, self).__init__(*args, **kwargs)  \n        size_policy = QtGui.QSizePolicy(QtGui.QSizePolicy.Expanding, QtGui.QSizePolicy.Fixed)\n        size_policy.setHeightForWidth(True)\n        self.setSizePolicy(size_policy)\n        self.setVerticalScrollBarPolicy(QtCore.Qt.ScrollBarAlwaysOff)\n\n\n    def setPlainText(self, text):\n\n        super(GrowingTextBrowser, self).setPlainText(text)\n        self._text = text\n\n\n    def print_document_size(self, document=None):\n\n        if document is None:\n            document = self.document()\n        document_size = document.size()\n        print \"Document width\", document_size.width(), 'height', document_size.height()\n\n\n    def sizePolicy(self):\n\n        return\n        size_policy = super(GrowingTextBrowser, self).sizePolicy()\n        print 'GrowingTextBrowser.sizePolicy', self._id, \\\n            size_policy.horizontalPolicy(), size_policy.verticalPolicy()\n        return size_policy\n\n\n    def sizeHint(self):\n\n        size = super(GrowingTextBrowser, self).sizeHint()\n        print 'GrowingTextBrowser.sizeHint', self._id, size.width(), size.height()\n        return QtCore.QSize(0, 0)\n\n\n    def minimumSizeHint(self):\n\n        size = super(GrowingTextBrowser, self).minimumSizeHint()\n        print 'GrowingTextBrowser.minimumSizeHint', self._id, size.width(), size.height()\n        return QtCore.QSize(0, 0)\n\n\n    def heightForWidth(self, width):\n\n        print 'GrowingTextBrowser.heightForWidth', self._id, width\n        document = QtGui.QTextDocument(self._text)\n        document.setPageSize(QtCore.QSizeF(width, -1))\n        height = document.documentLayout().documentSize().toSize().height()\n        self.print_document_size(document)\n        return height + self.font().pointSize()\n\n\n    def resizeEvent(self, event):\n\n        print 'GrowingTextBrowser.resizeEvent', self._id, \\\n            'old', event.oldSize().width(), event.oldSize().height(), \\\n            'new', event.size().width(), event.size().height()\n        self.print_document_size()\n        return super(GrowingTextBrowser, self).resizeEvent(event)\n\n\ndef append_block(parent, vertical_layout, source_text):\n\n    text_browser = GrowingTextBrowser(parent)\n    text_browser.setPlainText(source_text)\n    horizontal_layout = QtGui.QHBoxLayout()\n    horizontal_layout.addWidget(text_browser, 0, QtCore.Qt.AlignTop)\n    vertical_layout.addLayout(horizontal_layout)\n\ndef show_text_page(text_page):\n\n    application = QtGui.QApplication(sys.argv)\n\n    main_window = QtGui.QMainWindow()\n    main_window.resize(1000, 800)\n    main_window.setWindowTitle(args.filename)\n\n    scroll_area = QtGui.QScrollArea(main_window)\n    scroll_area.setWidgetResizable(True)\n    main_window.setCentralWidget(scroll_area)\n\n    container_widget = QtGui.QWidget()\n    vertical_layout = QtGui.QVBoxLayout(container_widget) # Set container_widget layout\n    scroll_area.setWidget(container_widget)\n\n    for block in TextBlockIterator(text_page):\n        block_text = u''\n        for line in TextLineIterator(block):\n            line_text = u''\n            for span in TextSpanIterator(line):\n                span_text = u''\n                for ch in TextCharIterator(span):\n                    span_text += unichr(ch.c)\n                span_text = span_text.rstrip()\n                if span_text: # Append span to line\n                    line_text += span_text\n                else: # Empty span then append a block\n                    if block_text:\n                        append_block(container_widget, vertical_layout, block_text)\n                    block_text = u''\n                    line_text = u''\n            if block_text:\n                block_text += ' '\n            block_text += line_text\n        if block_text:\n            append_block(container_widget, vertical_layout, block_text)\n\n    spacer_item = QtGui.QSpacerItem(0, 0, QtGui.QSizePolicy.Minimum, QtGui.QSizePolicy.Expanding)\n    vertical_layout.addItem(spacer_item)\n\n    print 'Show'\n    main_window.showMaximized()\n    application.exec_()\n\n\nargument_parser = argparse.ArgumentParser(description='Example.')\n\nargument_parser.add_argument('filename', metavar='FILENAME',\n                             help='PDF file')\n\nargument_parser.add_argument('--page', dest='page_number',\n                             type=int,\n                             default=1,\n                             help='Page number')\n\nargument_parser.add_argument('--zoom', dest='zoom',\n                             type=int,\n                             default=100,\n                             help='Zoom factor in %%')\n\nargument_parser.add_argument('--rotation', dest='rotation',\n                             type=int,\n                             default=0,\n                             help='Rotation')\n\nargs = argument_parser.parse_args()\n\n\nctx = cmupdf.fz_new_context(None, None, cmupdf.FZ_STORE_UNLIMITED)\n\n\ndoc = cmupdf.fz_open_document(ctx, args.filename)\n\nshow_metadata(ctx, doc)\n\n\npage_count = cmupdf.fz_count_pages(doc)\n\npage = cmupdf.fz_load_page(doc, args.page_number -1)\n\n\ntransform = cmupdf.fz_matrix_s()\ncmupdf.fz_rotate(transform, args.rotation)\ncmupdf.fz_pre_scale(transform, args.zoom / 100.0, args.zoom / 100.0)\n\nbounds = cmupdf.fz_rect_s()\ncmupdf.fz_bound_page(doc, page, bounds)\ncmupdf.fz_transform_rect(bounds, transform)\n\n\n\n\nbbox = cmupdf.fz_irect_s()\ncmupdf.fz_round_rect(bbox, bounds)\nwidth, height = bbox.x1 - bbox.x0, bbox.y1 - bbox.y0\nnp_array = np.zeros((height, width, 4), dtype=np.uint8)\npixmap = cmupdf.fz_new_pixmap_with_bbox_and_data(ctx, cmupdf.fz_device_rgb(ctx), bbox,\n                                                 cmupdf.numpy_to_pixmap(np_array))\ncmupdf.fz_clear_pixmap_with_value(ctx, pixmap, 0xff)\n\ndevice = cmupdf.fz_new_draw_device(ctx, pixmap)\ncmupdf.fz_set_aa_level(ctx, 8)\ncmupdf.fz_run_page(doc, page, device, transform, None)\ncmupdf.fz_free_device(device)\n\nif True:\n    show_pdf(np_array)\n\nif False:\n    cmupdf.fz_write_png(ctx, pixmap, \"out.png\", 0)\n\n\ntext_sheet = cmupdf.fz_new_text_sheet(ctx)\ntext_page = cmupdf.fz_new_text_page(ctx)\n\ndevice = cmupdf.fz_new_text_device(ctx, text_sheet, text_page)\ncmupdf.fz_run_page(doc, page, device, transform, None)\ncmupdf.fz_free_device(device)\n\nif False:\n    dump_text_style(text_sheet)\n    dump_text_page_xml(text_page)\n\nif True:\n    dump_text_page(text_page)\n    show_text_page(text_page)\n\nif False:\n    file_handler = cmupdf.fz_fopen(\"out.css\", \"w+\")\n    output_file = cmupdf.fz_new_output_with_file(ctx, file_handler)\n    cmupdf.fz_print_text_sheet(ctx, output_file, text_sheet)\n    cmupdf.fz_close_output(output_file)\n    cmupdf.fz_fclose(file_handler)\n\n    output_file = cmupdf.fz_fopen(\"out.txt\", \"w+\")\n    output_file = cmupdf.fz_new_output_with_file(ctx, file_handler)\n    cmupdf.fz_print_text_page_xml(ctx, output_file, text_page)\n    cmupdf.fz_close_output(output_file)\n    cmupdf.fz_fclose(file_handler)\n\n\ncmupdf.fz_free_text_sheet(ctx, text_sheet)\ncmupdf.fz_free_text_page(ctx, text_page)\ncmupdf.fz_drop_pixmap(ctx, pixmap)\ncmupdf.fz_free_page(doc, page)\ncmupdf.fz_close_document(doc)\ncmupdf.fz_free_context(ctx)\n",
  "line_no": 156,
  "line_no_percent": "44%"
}