{
  "instruction": "This code provides a Python API for KB SRU. To use it, you can create an instance of the \"sru\" class and call its \"search\" method, passing in a query string and optionally a collection name, start record number, maximum number of records to return, and record schema. The method will return a \"response\" object containing the results of the search. You can then use the various properties of the \"response\" object to extract specific information from the search results, such as titles, creators, and subjects.",
  "buggy_code": "\"\"\"\nPython API for KB SRU\n\"\"\"\n\nimport sys\nimport urllib\nimport requests\nfrom lxml import etree\n\nSRU_BASEURL = 'http://jsru.kb.nl/sru/sru'\nSRU_BASEURL += '?version=1.2&maximumRecords=%i'\nSRU_BASEURL += '&operation=searchRetrieve'\nSRU_BASEURL += '&startRecord=%i'\nSRU_BASEURL += '&recordSchema=%s'\nSRU_BASEURL += '&x-collection=%s&query=%s'\n\nSETS = {'ANP': {'collection': 'ANP',\n                'description_en': 'Radio Bulletins ANP Press Agency',\n                'description_nl': 'ANP Radiobulletins Digitaal',\n                'metadataPrefix': 'didl',\n                'recordschema': 'dcx',\n                'setname': 'anp',\n                'time_period': [1937, 1989]},\n        'DPO': {'collection': 'DPO_boekdeel',\n                'description_en': 'Early Dutch Books Online',\n                'description_nl': 'Early Dutch Books Online',\n                'metadataPrefix': 'didl',\n                'recordschema': 'ddd',\n                'setname': 'DPO',\n                'time_period': [1781, 1800]},\n        'BYVANCK': {'description_en': 'Medieval Illuminated Manuscripts',\n                    'description_nl': 'Middeleeuwse Verluchte Handschriften',\n                    'metadataPrefix': 'dcx',\n                    'setname': 'BYVANCK',\n                    'time_period': [500, 1500]},\n        'SGD': {'description_en': 'States General Digital',\n                'description_nl': 'Staten-Generaal Digitaal',\n                'metadataPrefix': 'dcx',\n                'setname': 'sgd:register',\n                'time_period': [1962, 1994]},\n        'GGC': {'collection': 'GGC',\n                'description_en': 'General Catalogue KB',\n                'description_nl': 'Algemene Catalogus KB',\n                'metadataPrefix': 'dcx',\n                'recordschema': 'dcx',\n                'setname': 'ggc',\n                'time_period': [1937, 2021]}}  # No idea what to use here?\n\n\nsrw_ns = 'http://www.loc.gov/zing/srw/'\ntel_ns = 'http://krait.kb.nl/coop/tel/handbook/telterms.html'\nxsi_ns = 'http://www.w3.org/2001/XMLSchema-instance'\ndc_ns = 'http://purl.org/dc/elements/1.1/'\ndcterms_ns = 'http://purl.org/dc/terms/'\ndcx_ns = 'http://krait.kb.nl/coop/tel/handbook/telterms.html'\n\nNSMAPGGC = {\"srw\": srw_ns,\n            \"tel\": tel_ns,\n            \"xsi\": xsi_ns,\n            \"dc\":  dc_ns,\n            \"dcterms\": dcterms_ns,\n            \"dcx\": dcx_ns}\n\n\nclass response():\n    def __init__(self, record_data, sru):\n        return\n        self.record_data = record_data\n        self.sru = sru\n\n    def getElementText(self, tagName, attributeName, attributeValue):\n        textFields = []\n        for r in self.record_data.iter():\n            if r.tag == tagName:\n                if attributeName != '':\n                    try:\n                        if r.attrib[attributeName] == attributeValue:\n                            textFields.append(r.text)\n                    except KeyError:\n                        pass\n                else:\n                    textFields.append(r.text)\n        return textFields\n\n    @property\n    def records(self):\n        if self.sru.nr_of_records == 0:\n            record_data = \"<xml></xml>\"\n        else:\n            ns = {'zs': 'http://www.loc.gov/zing/srw/'}\n            record_data = self.record_data.xpath(\"zs:records/zs:record\",\n                                                 namespaces=ns)[0]\n        return record(record_data, self.sru)\n\n\n    @property\n    def typesDutch(self):\n        return(self.getElementText('{http://purl.org/dc/elements/1.1/}type',\n                                   '{http://www.w3.org/XML/1998/namespace}lang',\n                                   'nl'))\n\n    @property\n    def typesDCMI(self):\n        return(self.getElementText('{http://purl.org/dc/elements/1.1/}type',\n                                   '{http://www.w3.org/2001/XMLSchema-instance}type',\n                                   'DCMIType'))\n\n    @property\n    def identifiersISBN(self):\n        return(self.getElementText('{http://purl.org/dc/elements/1.1/}identifier',\n                                   '{http://www.w3.org/2001/XMLSchema-instance}type',\n                                   'dcterms:ISBN'))\n\n    @property\n    def identifiersBrinkman(self):\n        return(self.getElementText('{http://purl.org/dc/elements/1.1/}identifier',\n                                   '{http://www.w3.org/2001/XMLSchema-instance}type',\n                                   'dcx:Brinkman'))\n\n    @property\n    def identifiersURI(self):\n        return(self.getElementText('{http://purl.org/dc/elements/1.1/}identifier',\n                                   '{http://www.w3.org/2001/XMLSchema-instance}type',\n                                   'dcterms:URI'))\n\n    @property\n    def identifiersOCLC(self):\n        return(self.getElementText('{http://purl.org/dc/elements/1.1/}identifier',\n                                   '{http://www.w3.org/2001/XMLSchema-instance}type',\n                                   'OCLC'))\n\n    @property\n    def languagesDutch(self):\n        return(self.getElementText('{http://purl.org/dc/elements/1.1/}language',\n                                   '{http://www.w3.org/XML/1998/namespace}lang',\n                                   'nl'))\n\n    @property\n    def languagesEnglish(self):\n        return(self.getElementText('{http://purl.org/dc/elements/1.1/}language',\n                                   '{http://www.w3.org/XML/1998/namespace}lang',\n                                   'en'))\n\n    @property\n    def languagesFrench(self):\n        return(self.getElementText('{http://purl.org/dc/elements/1.1/}language',\n                                   '{http://www.w3.org/XML/1998/namespace}lang',\n                                   'fr'))\n\n    @property\n    def languagesISO639(self):\n        return(self.getElementText('{http://purl.org/dc/elements/1.1/}language',\n                                   '{http://www.w3.org/2001/XMLSchema-instance}type',\n                                   'dcterms:ISO639-2'))\n\n    @property\n    def dates(self):\n        return(self.getElementText('{http://purl.org/dc/elements/1.1/}date',\n                                   '',\n                                   ''))\n\n    @property\n    def extents(self):\n        return(self.getElementText('{http://purl.org/dc/terms/}extent',\n                                   '',\n                                   ''))\n\n    @property\n    def creators(self):\n        return(self.getElementText('{http://purl.org/dc/elements/1.1/}creator',\n                                   '',\n                                   ''))\n\n    @property\n    def contributors(self):\n        return(self.getElementText('{http://purl.org/dc/elements/1.1/}contributor',\n                                   '',\n                                   ''))\n\n    @property\n    def titles(self):\n        return(self.getElementText('{http://purl.org/dc/elements/1.1/}title',\n                                   '',\n                                   ''))\n\n    @property\n    def titlesMain(self):\n        return(self.getElementText('{http://purl.org/dc/elements/1.1/}title',\n                                   '{http://www.w3.org/2001/XMLSchema-instance}type',\n                                   'dcx:maintitle'))\n\n    @property\n    def titlesIntermediate(self):\n        return(self.getElementText('{http://purl.org/dc/elements/1.1/}title',\n                                   '{http://www.w3.org/2001/XMLSchema-instance}type',\n                                   'dcx:intermediatetitle'))\n\n    @property\n    def publishers(self):\n        return(self.getElementText('{http://purl.org/dc/elements/1.1/}publisher',\n                                   '',\n                                   ''))\n\n    @property\n    def countries(self):\n        return(self.getElementText('{http://purl.org/dc/elements/1.1/}country',\n                                   '',\n                                   ''))\n\n    @property\n    def subjectsBrinkman(self):\n        return(self.getElementText('{http://purl.org/dc/elements/1.1/}subject',\n                                   '{http://www.w3.org/2001/XMLSchema-instance}type',\n                                   'dcx:Brinkman'))\n\n    @property\n    def subjectsISO9707(self):\n        return(self.getElementText('{http://purl.org/dc/elements/1.1/}subject',\n                                   '{http://www.w3.org/2001/XMLSchema-instance}type',\n                                   'ISO_9707_[Brinkman]'))\n\n    @property\n    def subjectsUNESCO(self):\n        return(self.getElementText('{http://purl.org/dc/elements/1.1/}subject',\n                                   '{http://www.w3.org/2001/XMLSchema-instance}type',\n                                   'UNESCO'))\n\n    @property\n    def collectionIdentifiers(self):\n        return(self.getElementText('{http://purl.org/dc/terms/}isPartOf',\n                                   '{http://www.w3.org/2001/XMLSchema-instance}type',\n                                   'dcx:collectionIdentifier'))\n\n    @property\n    def recordIdentifiersURI(self):\n        return(self.getElementText('{http://krait.kb.nl/coop/tel/handbook/telterms.html}recordIdentifier',\n                                   '{http://www.w3.org/2001/XMLSchema-instance}type',\n                                   'dcterms:URI'))\n\n    @property\n    def annotations(self):\n        return(self.getElementText('{http://krait.kb.nl/coop/tel/handbook/telterms.html}annotation',\n                                   '',\n                                   ''))\n\n\nclass record():\n    def __init__(self, record_data, sru):\n        self.record_data = record_data\n        self.sru = sru\n\n    def __iter__(self):\n        return self\n\n    def next(self):\n        if self.sru.nr_of_records == 0:\n            raise StopIteration\n        if self.sru.startrecord < self.sru.nr_of_records + 1:\n            record_data = self.sru.run_query()\n            self.sru.startrecord += 1\n            return response(record_data, self.sru)\n        else:\n            raise StopIteration\n\n    def __next__(self):\n        if self.sru.nr_of_records == 0:\n            raise StopIteration\n        if self.sru.startrecord < self.sru.nr_of_records + 1:\n            record_data = self.sru.run_query()\n            self.sru.startrecord += 1\n            return response(record_data, self.sru)\n        else:\n            raise StopIteration\n\n\nclass sru():\n    DEBUG = False\n\n    collection = False\n    maximumrecords = 50\n    nr_of_records = 0\n    query = \"\"\n    recordschema = False\n    sru_collections = SETS\n    startrecord = 0\n\n    def search(self, query, collection=False,\n               startrecord=1, maximumrecords=1, recordschema=False):\n\n        self.maximumrecords = maximumrecords\n        if sys.version.startswith('3'):\n            self.query = urllib.parse.quote_plus(query)\n        elif sys.version.startswith('2'):\n            self.query = urllib.quote_plus(query)\n        self.startrecord = startrecord\n\n        if collection not in self.sru_collections:\n            raise Exception('Unknown collection')\n\n        self.collection = self.sru_collections[collection]['collection']\n\n        if not self.collection:\n            raise Exception('Error, no collection specified')\n\n        if not recordschema:\n            self.recordschema = self.sru_collections[collection]['recordschema']\n        else:\n            self.recordschema = recordschema\n\n        record_data = self.run_query()\n\n        nr_of_records = [i.text for i in record_data.iter() if\n                         i.tag.endswith('numberOfRecords')][0]\n\n        self.nr_of_records = int(nr_of_records)\n\n        if self.nr_of_records > 0:\n            return response(record_data, self)\n\n        return False\n\n    def run_query(self):\n        url = SRU_BASEURL % (self.maximumrecords, self.startrecord,\n                             self.recordschema, self.collection, self.query)\n        if self.DEBUG:\n            sys.stdout.write(url)\n\n        r = requests.get(url)\n\n        if not r.status_code == 200:\n            raise Exception('Error while getting data from %s' % url)\n\n        record_data = etree.fromstring(r.content)\n\n        return record_data\n",
  "line_no": 67,
  "line_no_percent": "20%"
}