{
  "instruction": "This code is a test for the GIRepository module. To run the test, execute the script. The test checks various aspects of the module, such as argument info, base info, object info, interface info, struct info, enum info, union info, type info, field info, property info, callable info, method info, vfunc info, flags double registration error, enum double registration error, introspected argument info, and more. The test should pass without any errors or failures.",
  "buggy_code": "import unittest\nimport collections\n\nimport gi._gi as GIRepository\nfrom gi.module import repository as repo\nfrom gi.repository import GObject\nfrom gi.repository import GLib\nfrom gi.repository import GIMarshallingTests\nfrom gi.repository import GIRepository as IntrospectedRepository\n\ntry:\n    import cairo\n    cairo\n    has_cairo = True\nexcept ImportError:\n    has_cairo = False\n\n\ndef find_child_info(info, getter_name, name):\n    getter = getattr(info, getter_name)\n    for child in getter():\n        if child.get_name() == name:\n            return child\n    else:\n        raise ValueError('child info %s not found' % name)\n\n\nclass Test(unittest.TestCase):\n    def setUp(self):\n        repo.require('GObject')\n        repo.require('GIMarshallingTests')\n\n    def test_arg_info(self):\n        func_info = repo.find_by_name('GIMarshallingTests', 'array_fixed_out_struct')\n        args = func_info.get_arguments()\n        self.assertTrue(len(args), 1)\n\n        arg = args[0]\n        self.assertEqual(arg.get_container(), func_info)\n        self.assertEqual(arg.get_direction(), GIRepository.Direction.OUT)\n        self.assertEqual(arg.get_name(), 'structs')\n        self.assertEqual(arg.get_namespace(), 'GIMarshallingTests')\n        self.assertFalse(arg.is_caller_allocates())\n        self.assertFalse(arg.is_optional())\n        self.assertFalse(arg.is_return_value())\n        self.assertFalse(arg.may_be_null())\n        self.assertEqual(arg.get_destroy(), -1)\n        self.assertEqual(arg.get_ownership_transfer(), GIRepository.Transfer.NOTHING)\n        self.assertEqual(arg.get_scope(), GIRepository.ScopeType.INVALID)\n        self.assertEqual(arg.get_type().get_tag(), GIRepository.TypeTag.ARRAY)\n\n    def test_base_info(self):\n        info = repo.find_by_name('GIMarshallingTests', 'Object')\n        self.assertEqual(info.__name__, 'Object')\n        self.assertEqual(info.get_name(), 'Object')\n        self.assertEqual(info.__module__, 'gi.repository.GIMarshallingTests')\n        self.assertEqual(info.get_name_unescaped(), 'Object')\n        self.assertEqual(info.get_namespace(), 'GIMarshallingTests')\n        self.assertEqual(info.get_container(), None)\n        info2 = repo.find_by_name('GIMarshallingTests', 'Object')\n        self.assertFalse(info is info2)\n        self.assertEqual(info, info2)\n        self.assertTrue(info.equal(info2))\n\n    def test_object_info(self):\n        info = repo.find_by_name('GIMarshallingTests', 'Object')\n        self.assertEqual(info.get_parent(), repo.find_by_name('GObject', 'Object'))\n        self.assertTrue(isinstance(info.get_methods(), collections.Iterable))\n        self.assertTrue(isinstance(info.get_fields(), collections.Iterable))\n        self.assertTrue(isinstance(info.get_interfaces(), collections.Iterable))\n        self.assertTrue(isinstance(info.get_constants(), collections.Iterable))\n        self.assertTrue(isinstance(info.get_vfuncs(), collections.Iterable))\n        self.assertTrue(isinstance(info.get_properties(), collections.Iterable))\n        self.assertFalse(info.get_abstract())\n        self.assertEqual(info.get_class_struct(), repo.find_by_name('GIMarshallingTests', 'ObjectClass'))\n        self.assertEqual(info.get_type_name(), 'GIMarshallingTestsObject')\n        self.assertEqual(info.get_type_init(), 'gi_marshalling_tests_object_get_type')\n        self.assertFalse(info.get_fundamental())\n        self.assertEqual(info.get_parent(), repo.find_by_name('GObject', 'Object'))\n\n    def test_registered_type_info(self):\n        info = repo.find_by_name('GIMarshallingTests', 'Object')\n        self.assertEqual(GIRepository.RegisteredTypeInfo.get_g_type(info),\n                         GObject.type_from_name('GIMarshallingTestsObject'))\n        self.assertEqual(GIRepository.RegisteredTypeInfo.get_type_name(info),\n                         'GIMarshallingTestsObject')\n        self.assertEqual(GIRepository.RegisteredTypeInfo.get_type_init(info),\n                         'gi_marshalling_tests_object_get_type')\n\n    @unittest.skipUnless(has_cairo, 'Regress needs cairo')\n    def test_fundamental_object_info(self):\n        repo.require('Regress')\n        info = repo.find_by_name('Regress', 'TestFundamentalObject')\n        self.assertTrue(info.get_abstract())\n        self.assertTrue(info.get_fundamental())\n        self.assertEqual(info.get_ref_function(), 'regress_test_fundamental_object_ref')\n        self.assertEqual(info.get_unref_function(), 'regress_test_fundamental_object_unref')\n        self.assertEqual(info.get_get_value_function(), 'regress_test_value_get_fundamental_object')\n        self.assertEqual(info.get_set_value_function(), 'regress_test_value_set_fundamental_object')\n\n    def test_interface_info(self):\n        info = repo.find_by_name('GIMarshallingTests', 'Interface')\n        self.assertTrue(isinstance(info.get_methods(), collections.Iterable))\n        self.assertTrue(isinstance(info.get_vfuncs(), collections.Iterable))\n        self.assertTrue(isinstance(info.get_constants(), collections.Iterable))\n        self.assertTrue(isinstance(info.get_prerequisites(), collections.Iterable))\n        self.assertTrue(isinstance(info.get_properties(), collections.Iterable))\n        self.assertTrue(isinstance(info.get_signals(), collections.Iterable))\n\n        method = info.find_method('test_int8_in')\n        vfunc = info.find_vfunc('test_int8_in')\n        self.assertEqual(method.get_name(), 'test_int8_in')\n        self.assertEqual(vfunc.get_invoker(), method)\n        self.assertEqual(method.get_vfunc(), vfunc)\n\n        iface = info.get_iface_struct()\n        self.assertEqual(iface, repo.find_by_name('GIMarshallingTests', 'InterfaceIface'))\n\n    def test_struct_info(self):\n        info = repo.find_by_name('GIMarshallingTests', 'InterfaceIface')\n        self.assertTrue(isinstance(info, GIRepository.StructInfo))\n        self.assertTrue(isinstance(info.get_fields(), collections.Iterable))\n        self.assertTrue(isinstance(info.get_methods(), collections.Iterable))\n        self.assertTrue(isinstance(info.get_size(), int))\n        self.assertTrue(isinstance(info.get_alignment(), int))\n        self.assertTrue(info.is_gtype_struct())\n        self.assertFalse(info.is_foreign())\n\n    def test_enum_info(self):\n        info = repo.find_by_name('GIMarshallingTests', 'Enum')\n        self.assertTrue(isinstance(info, GIRepository.EnumInfo))\n        self.assertTrue(isinstance(info.get_values(), collections.Iterable))\n        self.assertTrue(isinstance(info.get_methods(), collections.Iterable))\n        self.assertFalse(info.is_flags())\n        self.assertTrue(info.get_storage_type() > 0)  # might be platform dependent\n\n    def test_union_info(self):\n        info = repo.find_by_name('GIMarshallingTests', 'Union')\n        self.assertTrue(isinstance(info, GIRepository.UnionInfo))\n        self.assertTrue(isinstance(info.get_fields(), collections.Iterable))\n        self.assertTrue(isinstance(info.get_methods(), collections.Iterable))\n\n    def test_type_info(self):\n        func_info = repo.find_by_name('GIMarshallingTests', 'array_fixed_out_struct')\n        arg_info, = func_info.get_arguments()\n        type_info = arg_info.get_type()\n\n        self.assertTrue(type_info.is_pointer())\n        self.assertEqual(type_info.get_tag(), GIRepository.TypeTag.ARRAY)\n        self.assertEqual(type_info.get_tag_as_string(), 'array')\n        self.assertEqual(type_info.get_param_type(0).get_tag(),\n                         GIRepository.TypeTag.INTERFACE)\n        self.assertEqual(type_info.get_param_type(0).get_interface(),\n                         repo.find_by_name('GIMarshallingTests', 'SimpleStruct'))\n        self.assertEqual(type_info.get_interface(), None)\n        self.assertEqual(type_info.get_array_length(), -1)\n        self.assertEqual(type_info.get_array_fixed_size(), 2)\n        self.assertFalse(type_info.is_zero_terminated())\n        self.assertEqual(type_info.get_array_type(), GIRepository.ArrayType.C)\n\n    def test_field_info(self):\n        info = repo.find_by_name('GIMarshallingTests', 'InterfaceIface')\n        field = find_child_info(info, 'get_fields', 'test_int8_in')\n        self.assertEqual(field.get_name(), 'test_int8_in')\n        self.assertTrue(field.get_flags() & GIRepository.FieldInfoFlags.IS_READABLE)\n        self.assertFalse(field.get_flags() & GIRepository.FieldInfoFlags.IS_WRITABLE)\n        self.assertEqual(field.get_type().get_tag(), GIRepository.TypeTag.INTERFACE)\n\n        self.assertTrue(isinstance(field.get_size(), int))\n        self.assertTrue(isinstance(field.get_offset(), int))\n\n    def test_property_info(self):\n        info = repo.find_by_name('GIMarshallingTests', 'PropertiesObject')\n        prop = find_child_info(info, 'get_properties', 'some-object')\n\n        flags = GObject.ParamFlags.READABLE | GObject.ParamFlags.WRITABLE | GObject.ParamFlags.CONSTRUCT\n        self.assertEqual(prop.get_flags(), flags)\n        self.assertEqual(prop.get_type().get_tag(), GIRepository.TypeTag.INTERFACE)\n        self.assertEqual(prop.get_type().get_interface(),\n                         repo.find_by_name('GObject', 'Object'))\n        self.assertEqual(prop.get_ownership_transfer(), GIRepository.Transfer.NOTHING)\n\n    def test_callable_info(self):\n        func_info = repo.find_by_name('GIMarshallingTests', 'array_fixed_out_struct')\n        self.assertTrue(hasattr(func_info, 'invoke'))\n        self.assertTrue(isinstance(func_info.get_arguments(), collections.Iterable))\n        self.assertEqual(func_info.get_caller_owns(), GIRepository.Transfer.NOTHING)\n        self.assertFalse(func_info.may_return_null())\n        self.assertEqual(func_info.get_return_type().get_tag(), GIRepository.TypeTag.VOID)\n        self.assertRaises(AttributeError, func_info.get_return_attribute, '_not_an_attr')\n\n    @unittest.expectedFailure  # https://bugzilla.gnome.org/show_bug.cgi?id=709462\n    @unittest.skipUnless(has_cairo, 'Regress needs cairo')\n    def test_signal_info(self):\n        repo.require('Regress')\n        info = repo.find_by_name('Regress', 'TestObj')\n        sig_info = find_child_info(info, 'get_signals', 'test')\n\n        sig_flags = GObject.SignalFlags.RUN_LAST | \\\n            GObject.SignalFlags.NO_RECURSE | GObject.SignalFlags.NO_HOOKS\n\n        self.assertTrue(sig_info is not None)\n        self.assertTrue(isinstance(sig_info, GIRepository.CallableInfo))\n        self.assertTrue(isinstance(sig_info, GIRepository.SignalInfo))\n        self.assertEqual(sig_info.get_name(), 'test')\n        self.assertEqual(sig_info.get_class_closure(), None)\n        self.assertFalse(sig_info.true_stops_emit())\n        self.assertEqual(sig_info.get_flags(), sig_flags)\n\n    @unittest.expectedFailure  # https://bugzilla.gnome.org/show_bug.cgi?id=709462\n    @unittest.skipUnless(has_cairo, 'Regress needs cairo')\n    def test_notify_signal_info_with_obj(self):\n        repo.require('Regress')\n        info = repo.find_by_name('Regress', 'TestObj')\n        sig_info = find_child_info(info, 'get_signals', 'sig-with-array-prop')\n\n        sig_flags = GObject.SignalFlags.RUN_LAST\n\n        self.assertTrue(sig_info is not None)\n        self.assertTrue(isinstance(sig_info, GIRepository.CallableInfo))\n        self.assertTrue(isinstance(sig_info, GIRepository.SignalInfo))\n        self.assertEqual(sig_info.get_name(), 'sig-with-array-prop')\n        self.assertEqual(sig_info.get_class_closure(), None)\n        self.assertFalse(sig_info.true_stops_emit())\n        self.assertEqual(sig_info.get_flags(), sig_flags)\n\n    def test_object_constructor(self):\n        info = repo.find_by_name('GIMarshallingTests', 'Object')\n        method = find_child_info(info, 'get_methods', 'new')\n\n        self.assertTrue(isinstance(method, GIRepository.CallableInfo))\n        self.assertTrue(isinstance(method, GIRepository.FunctionInfo))\n        self.assertTrue(method in info.get_methods())\n        self.assertEqual(method.get_name(), 'new')\n        self.assertFalse(method.is_method())\n        self.assertTrue(method.is_constructor())\n        self.assertEqual(method.get_symbol(), 'gi_marshalling_tests_object_new')\n\n        flags = method.get_flags()\n        self.assertFalse(flags & GIRepository.FunctionInfoFlags.IS_METHOD)\n        self.assertTrue(flags & GIRepository.FunctionInfoFlags.IS_CONSTRUCTOR)\n        self.assertFalse(flags & GIRepository.FunctionInfoFlags.IS_GETTER)\n        self.assertFalse(flags & GIRepository.FunctionInfoFlags.IS_SETTER)\n        self.assertFalse(flags & GIRepository.FunctionInfoFlags.WRAPS_VFUNC)\n        self.assertFalse(flags & GIRepository.FunctionInfoFlags.THROWS)\n\n    def test_method_info(self):\n        info = repo.find_by_name('GIMarshallingTests', 'Object')\n        method = find_child_info(info, 'get_methods', 'vfunc_return_value_only')\n\n        self.assertTrue(isinstance(method, GIRepository.CallableInfo))\n        self.assertTrue(isinstance(method, GIRepository.FunctionInfo))\n        self.assertTrue(method in info.get_methods())\n        self.assertEqual(method.get_name(), 'vfunc_return_value_only')\n        self.assertFalse(method.is_constructor())\n        self.assertEqual(method.get_symbol(), 'gi_marshalling_tests_object_vfunc_return_value_only')\n        self.assertTrue(method.is_method())\n\n        flags = method.get_flags()\n        self.assertTrue(flags & GIRepository.FunctionInfoFlags.IS_METHOD)\n        self.assertFalse(flags & GIRepository.FunctionInfoFlags.IS_CONSTRUCTOR)\n        self.assertFalse(flags & GIRepository.FunctionInfoFlags.IS_GETTER)\n        self.assertFalse(flags & GIRepository.FunctionInfoFlags.IS_SETTER)\n        self.assertFalse(flags & GIRepository.FunctionInfoFlags.WRAPS_VFUNC)\n        self.assertFalse(flags & GIRepository.FunctionInfoFlags.THROWS)\n\n    def test_vfunc_info(self):\n        info = repo.find_by_name('GIMarshallingTests', 'Object')\n        invoker = find_child_info(info, 'get_methods', 'vfunc_return_value_only')\n        vfunc = find_child_info(info, 'get_vfuncs', 'vfunc_return_value_only')\n\n        self.assertTrue(isinstance(vfunc, GIRepository.CallableInfo))\n        self.assertTrue(isinstance(vfunc, GIRepository.VFuncInfo))\n        self.assertEqual(vfunc.get_name(), 'vfunc_return_value_only')\n        self.assertEqual(vfunc.get_invoker(), invoker)\n        self.assertEqual(invoker, info.find_method('vfunc_return_value_only'))\n        self.assertEqual(vfunc.get_flags(), 0)\n        self.assertEqual(vfunc.get_offset(), 0xFFFF)  # unknown offset\n        self.assertEqual(vfunc.get_signal(), None)\n\n    def test_flags_double_registration_error(self):\n        GIMarshallingTests.NoTypeFlags  # cause flags registration\n        info = repo.find_by_name('GIMarshallingTests', 'NoTypeFlags')\n        old_mask = GLib.log_set_always_fatal(GLib.LogLevelFlags.LEVEL_ERROR)\n        try:\n            self.assertRaises(RuntimeError,\n                              GIRepository.flags_register_new_gtype_and_add,\n                              info)\n        finally:\n            GLib.log_set_always_fatal(old_mask)\n\n    def test_enum_double_registration_error(self):\n        return\n        GIMarshallingTests.Enum  # cause enum registration\n        info = repo.find_by_name('GIMarshallingTests', 'Enum')\n        old_mask = GLib.log_set_always_fatal(GLib.LogLevelFlags.LEVEL_ERROR)\n        try:\n            self.assertRaises(RuntimeError,\n                              GIRepository.enum_register_new_gtype_and_add,\n                              info)\n        finally:\n            GLib.log_set_always_fatal(old_mask)\n\n    def test_enums(self):\n        self.assertTrue(hasattr(GIRepository, 'Direction'))\n        self.assertTrue(hasattr(GIRepository, 'Transfer'))\n        self.assertTrue(hasattr(GIRepository, 'ArrayType'))\n        self.assertTrue(hasattr(GIRepository, 'ScopeType'))\n        self.assertTrue(hasattr(GIRepository, 'VFuncInfoFlags'))\n        self.assertTrue(hasattr(GIRepository, 'FieldInfoFlags'))\n        self.assertTrue(hasattr(GIRepository, 'FunctionInfoFlags'))\n        self.assertTrue(hasattr(GIRepository, 'TypeTag'))\n        self.assertTrue(hasattr(GIRepository, 'InfoType'))\n\n    def test_introspected_argument_info(self):\n        self.assertTrue(isinstance(IntrospectedRepository.Argument.__info__,\n                                   GIRepository.UnionInfo))\n\n        arg = IntrospectedRepository.Argument()\n        self.assertTrue(isinstance(arg.__info__, GIRepository.UnionInfo))\n\n        old_info = IntrospectedRepository.Argument.__info__\n        IntrospectedRepository.Argument.__info__ = 'not an info'\n        self.assertRaises(TypeError, IntrospectedRepository.Argument)\n        IntrospectedRepository.Argument.__info__ = old_info\n\n\nif __name__ == '__main__':\n    unittest.main()\n",
  "line_no": 293,
  "line_no_percent": "89%"
}