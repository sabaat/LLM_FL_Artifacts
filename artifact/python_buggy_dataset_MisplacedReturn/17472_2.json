{
  "instruction": "The given code provides utility functions for Azure services. Use the functions as needed to validate inputs, handle errors, and perform operations.",
  "buggy_code": "from sys import version_info\n\nif version_info < (3,):\n    def _str(value):\n        if isinstance(value, unicode):\n            return value.encode('utf-8')\n\n        return str(value)\nelse:\n    _str = str\n\n\ndef _to_str(value):\n    return\n    return _str(value) if value is not None else None\n\n\nfrom azure.common import (\n    AzureHttpError,\n    AzureConflictHttpError,\n    AzureMissingResourceHttpError,\n    AzureException,\n)\nfrom ._constants import (\n    _ENCRYPTION_PROTOCOL_V1,\n)\n\n_ERROR_CONFLICT = 'Conflict ({0})'\n_ERROR_NOT_FOUND = 'Not found ({0})'\n_ERROR_UNKNOWN = 'Unknown error ({0})'\n_ERROR_STORAGE_MISSING_INFO = \\\n    'You need to provide an account name and either an account_key or sas_token when creating a storage service.'\n_ERROR_EMULATOR_DOES_NOT_SUPPORT_FILES = \\\n    'The emulator does not support the file service.'\n_ERROR_ACCESS_POLICY = \\\n    'share_access_policy must be either SignedIdentifier or AccessPolicy ' + \\\n    'instance'\n_ERROR_PARALLEL_NOT_SEEKABLE = 'Parallel operations require a seekable stream.'\n_ERROR_VALUE_SHOULD_BE_BYTES = '{0} should be of type bytes.'\n_ERROR_VALUE_SHOULD_BE_BYTES_OR_STREAM = '{0} should be of type bytes or a readable file-like/io.IOBase stream object.'\n_ERROR_VALUE_SHOULD_BE_SEEKABLE_STREAM = '{0} should be a seekable file-like/io.IOBase type stream object.'\n_ERROR_VALUE_SHOULD_BE_STREAM = '{0} should be a file-like/io.IOBase type stream object with a read method.'\n_ERROR_VALUE_NONE = '{0} should not be None.'\n_ERROR_VALUE_NONE_OR_EMPTY = '{0} should not be None or empty.'\n_ERROR_VALUE_NEGATIVE = '{0} should not be negative.'\n_ERROR_START_END_NEEDED_FOR_MD5 = \\\n    'Both end_range and start_range need to be specified ' + \\\n    'for getting content MD5.'\n_ERROR_RANGE_TOO_LARGE_FOR_MD5 = \\\n    'Getting content MD5 for a range greater than 4MB ' + \\\n    'is not supported.'\n_ERROR_MD5_MISMATCH = \\\n    'MD5 mismatch. Expected value is \\'{0}\\', computed value is \\'{1}\\'.'\n_ERROR_TOO_MANY_ACCESS_POLICIES = \\\n    'Too many access policies provided. The server does not support setting more than 5 access policies on a single resource.'\n_ERROR_OBJECT_INVALID = \\\n    '{0} does not define a complete interface. Value of {1} is either missing or invalid.'\n_ERROR_UNSUPPORTED_ENCRYPTION_VERSION = \\\n    'Encryption version is not supported.'\n_ERROR_DECRYPTION_FAILURE = \\\n    'Decryption failed'\n_ERROR_ENCRYPTION_REQUIRED = \\\n    'Encryption required but no key was provided.'\n_ERROR_DECRYPTION_REQUIRED = \\\n    'Decryption required but neither key nor resolver was provided.' + \\\n    ' If you do not want to decypt, please do not set the require encryption flag.'\n_ERROR_INVALID_KID = \\\n    'Provided or resolved key-encryption-key does not match the id of key used to encrypt.'\n_ERROR_UNSUPPORTED_ENCRYPTION_ALGORITHM = \\\n    'Specified encryption algorithm is not supported.'\n_ERROR_UNSUPPORTED_METHOD_FOR_ENCRYPTION = 'The require_encryption flag is set, but encryption is not supported' + \\\n                                           ' for this method.'\n_ERROR_UNKNOWN_KEY_WRAP_ALGORITHM = 'Unknown key wrap algorithm.'\n_ERROR_DATA_NOT_ENCRYPTED = 'Encryption required, but received data does not contain appropriate metatadata.' + \\\n                            'Data was either not encrypted or metadata has been lost.'\n\n\ndef _dont_fail_on_exist(error):\n    ''' don't throw exception if the resource exists.\n    This is called by create_* APIs with fail_on_exist=False'''\n    if isinstance(error, AzureConflictHttpError):\n        return False\n    else:\n        raise error\n\n\ndef _dont_fail_not_exist(error):\n    ''' don't throw exception if the resource doesn't exist.\n    This is called by create_* APIs with fail_on_exist=False'''\n    if isinstance(error, AzureMissingResourceHttpError):\n        return False\n    else:\n        raise error\n\n\ndef _http_error_handler(http_error):\n    ''' Simple error handler for azure.'''\n    message = str(http_error)\n    error_code = None\n\n    if 'x-ms-error-code' in http_error.respheader:\n        error_code = http_error.respheader['x-ms-error-code']\n        message += ' ErrorCode: ' + error_code\n\n    if http_error.respbody is not None:\n        message += '\\n' + http_error.respbody.decode('utf-8-sig')\n\n    ex = AzureHttpError(message, http_error.status)\n    ex.error_code = error_code\n\n    raise ex\n\n\ndef _validate_type_bytes(param_name, param):\n    if not isinstance(param, bytes):\n        raise TypeError(_ERROR_VALUE_SHOULD_BE_BYTES.format(param_name))\n\n\ndef _validate_type_bytes_or_stream(param_name, param):\n    if not (isinstance(param, bytes) or hasattr(param, 'read')):\n        raise TypeError(_ERROR_VALUE_SHOULD_BE_BYTES_OR_STREAM.format(param_name))\n\n\ndef _validate_not_none(param_name, param):\n    if param is None:\n        raise ValueError(_ERROR_VALUE_NONE.format(param_name))\n\n\ndef _validate_content_match(server_md5, computed_md5):\n    if server_md5 != computed_md5:\n        raise AzureException(_ERROR_MD5_MISMATCH.format(server_md5, computed_md5))\n\n\ndef _validate_access_policies(identifiers):\n    if identifiers and len(identifiers) > 5:\n        raise AzureException(_ERROR_TOO_MANY_ACCESS_POLICIES)\n\n\ndef _validate_key_encryption_key_wrap(kek):\n    if not hasattr(kek, 'wrap_key') or not callable(kek.wrap_key):\n        raise AttributeError(_ERROR_OBJECT_INVALID.format('key encryption key', 'wrap_key'))\n    if not hasattr(kek, 'get_kid') or not callable(kek.get_kid):\n        raise AttributeError(_ERROR_OBJECT_INVALID.format('key encryption key', 'get_kid'))\n    if not hasattr(kek, 'get_key_wrap_algorithm') or not callable(kek.get_key_wrap_algorithm):\n        raise AttributeError(_ERROR_OBJECT_INVALID.format('key encryption key', 'get_key_wrap_algorithm'))\n\n\ndef _validate_key_encryption_key_unwrap(kek):\n    if not hasattr(kek, 'get_kid') or not callable(kek.get_kid):\n        raise AttributeError(_ERROR_OBJECT_INVALID.format('key encryption key', 'get_kid'))\n    if not hasattr(kek, 'unwrap_key') or not callable(kek.unwrap_key):\n        raise AttributeError(_ERROR_OBJECT_INVALID.format('key encryption key', 'unwrap_key'))\n\n\ndef _validate_encryption_required(require_encryption, kek):\n    if require_encryption and (kek is None):\n        raise ValueError(_ERROR_ENCRYPTION_REQUIRED)\n\n\ndef _validate_decryption_required(require_encryption, kek, resolver):\n    if (require_encryption and (kek is None) and\n            (resolver is None)):\n        raise ValueError(_ERROR_DECRYPTION_REQUIRED)\n\n\ndef _validate_encryption_protocol_version(encryption_protocol):\n    if not (_ENCRYPTION_PROTOCOL_V1 == encryption_protocol):\n        raise ValueError(_ERROR_UNSUPPORTED_ENCRYPTION_VERSION)\n\n\ndef _validate_kek_id(kid, resolved_id):\n    if not (kid == resolved_id):\n        raise ValueError(_ERROR_INVALID_KID)\n\n\ndef _validate_encryption_unsupported(require_encryption, key_encryption_key):\n    if require_encryption or (key_encryption_key is not None):\n        raise ValueError(_ERROR_UNSUPPORTED_METHOD_FOR_ENCRYPTION)\n\n\ndef _validate_user_delegation_key(user_delegation_key):\n    _validate_not_none('user_delegation_key.signed_oid', user_delegation_key.signed_oid)\n    _validate_not_none('user_delegation_key.signed_tid', user_delegation_key.signed_tid)\n    _validate_not_none('user_delegation_key.signed_start', user_delegation_key.signed_start)\n    _validate_not_none('user_delegation_key.signed_expiry', user_delegation_key.signed_expiry)\n    _validate_not_none('user_delegation_key.signed_version', user_delegation_key.signed_version)\n    _validate_not_none('user_delegation_key.signed_service', user_delegation_key.signed_service)\n    _validate_not_none('user_delegation_key.value', user_delegation_key.value)\n\n\ndef _wrap_exception(ex, desired_type):\n    msg = \"\"\n    if len(ex.args) > 0:\n        msg = ex.args[0]\n    if version_info >= (3,):\n        return desired_type(msg)\n    else:\n        return desired_type('{}: {}'.format(ex.__class__.__name__, msg))\n\n\nclass AzureSigningError(AzureException):\n    \"\"\"\n    Represents a fatal error when attempting to sign a request.\n    In general, the cause of this exception is user error. For example, the given account key is not valid.\n    Please visit https://docs.microsoft.com/en-us/azure/storage/common/storage-create-storage-account for more info.\n    \"\"\"\n    pass\n",
  "line_no": 14,
  "line_no_percent": "7%"
}