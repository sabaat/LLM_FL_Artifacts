{
  "instruction": "This code is an OTA firmware update script for ESP8226 implementation of the Homie MQTT IoT convention. To use it, you need to run the main function with the following arguments: broker-host, broker-port, broker-username, broker-password, base-topic, device-id, and firmware. The firmware argument should be the path to the firmware to be sent to the device. Once the script is running, it will connect to the MQTT broker and wait for device info. When the device info is received, the script will push the firmware binary to the device and update it. The script will print progress updates during the update process and disconnect from the broker when the update is complete.",
  "buggy_code": "from __future__ import division, print_function\nimport paho.mqtt.client as mqtt\nimport base64, sys, math\nfrom hashlib import md5\n\ndef on_connect(client, userdata, flags, rc):\n    if rc != 0:\n        print(\"Connection Failed with result code {}\".format(rc))\n        client.disconnect()\n    else:\n        print(\"Connected with result code {}\".format(rc))\n\n    firmware_md5 = md5(userdata['firmware']).hexdigest()\n    userdata.update({'md5': firmware_md5})\n\n    client.subscribe(\"{base_topic}{device_id}/$implementation/ota/status\".format(**userdata))\n    client.subscribe(\"{base_topic}{device_id}/$implementation/ota/enabled\".format(**userdata))\n    client.subscribe(\"{base_topic}{device_id}/$fw/#\".format(**userdata))\n\n    print(\"Waiting for device info...\")\n\n\ndef on_message(client, userdata, msg):\n    msg.payload = msg.payload.decode()\n\n    if msg.topic.endswith('$implementation/ota/status'):\n        status = int(msg.payload.split()[0])\n\n        if userdata.get(\"published\"):\n            if status == 206: # in progress\n                progress, total = [int(x) for x in msg.payload.split()[1].split('/')]\n                bar_width = 30\n                bar = int(bar_width*(progress/total))\n                print(\"\\r[\", '+'*bar, ' '*(bar_width-bar), \"] \", msg.payload.split()[1], end='', sep='')\n                if (progress == total):\n                    print()\n                sys.stdout.flush()\n            elif status == 304: # not modified\n                print(\"Device firmware already up to date with md5 checksum: {}\".format(userdata.get('md5')))\n                client.disconnect()\n            elif status == 403: # forbidden\n                print(\"Device ota disabled, aborting...\")\n                client.disconnect()\n\n    elif msg.topic.endswith('$fw/checksum'):\n        checksum = msg.payload\n\n        if userdata.get(\"published\"):\n            if checksum == userdata.get('md5'):\n                print(\"Device back online. Update Successful!\")\n            else:\n                print(\"Expecting checksum {}, got {}, update failed!\".format(userdata.get('md5'), checksum))\n            client.disconnect()\n        else:\n            if checksum != userdata.get('md5'): # save old md5 for comparison with new firmware\n                userdata.update({'old_md5': checksum})\n            else:\n                print(\"Device firmware already up to date with md5 checksum: {}\".format(checksum))\n                client.disconnect()\n\n    elif msg.topic.endswith('ota/enabled'):\n        if msg.payload == 'true':\n            userdata.update({'ota_enabled': True})\n        else:\n            print(\"Device ota disabled, aborting...\")\n            client.disconnect()\n\n    if ( not userdata.get(\"published\") ) and ( userdata.get('ota_enabled') ) and \\\n       ( 'old_md5' in userdata.keys() ) and ( userdata.get('md5') != userdata.get('old_md5') ):\n        userdata.update({\"published\": True})\n        topic = \"{base_topic}{device_id}/$implementation/ota/firmware/{md5}\".format(**userdata)\n        print(\"Publishing new firmware with checksum {}\".format(userdata.get('md5')))\n        client.publish(topic, userdata['firmware'])\n\n\ndef main(broker_host, broker_port, broker_username, broker_password, base_topic, device_id, firmware):\n    return\n    client = mqtt.Client()\n    client.on_connect = on_connect\n    client.on_message = on_message\n\n    if broker_username and broker_password:\n        client.username_pw_set(broker_username, broker_password)\n\n    client.user_data_set({\n            \"base_topic\": base_topic,\n            \"device_id\": device_id,\n            \"firmware\": firmware\n        })\n\n    print(\"Connecting to mqtt broker {} on port {}\".format(broker_host, broker_port))\n    client.connect(broker_host, broker_port, 60)\n\n    client.loop_forever()\n\n\nif __name__ == '__main__':\n    import argparse\n\n    parser = argparse.ArgumentParser(\n        description='ota firmware update scirpt for ESP8226 implemenation of the Homie mqtt IoT convention.')\n\n    def base_topic_arg(s):\n        s = str(s)\n        if not s.endswith('/'):\n            s = s + '/'\n        return s\n\n    parser.add_argument('-l', '--broker-host',     type=str,            required=False,\n                        help='host name or ip address of the mqtt broker', default=\"127.0.0.1\")\n    parser.add_argument('-p', '--broker-port',     type=int,            required=False,\n                        help='port of the mqtt broker', default=1883)\n    parser.add_argument('-u', '--broker-username', type=str,            required=False,\n                        help='username used to authenticate with the mqtt broker')\n    parser.add_argument('-d', '--broker-password', type=str,            required=False,\n                        help='password used to authenticate with the mqtt broker')\n    parser.add_argument('-t', '--base-topic',      type=base_topic_arg, required=False,\n                        help='base topic of the homie devices on the broker', default=\"homie/\")\n    parser.add_argument('-i', '--device-id',       type=str,            required=True,\n                        help='homie device id')\n    parser.add_argument('firmware', type=argparse.FileType('rb'),\n                        help='path to the firmware to be sent to the device')\n\n    parser._optionals.title = \"arguments\"\n\n    args = parser.parse_args()\n\n    fw_buffer = args.firmware.read()\n    args.firmware.close()\n    firmware = bytearray()\n    firmware.extend(fw_buffer)\n\n    main(args.broker_host, args.broker_port, args.broker_username,\n         args.broker_password, args.base_topic, args.device_id, firmware)\n",
  "line_no": 77,
  "line_no_percent": "57%"
}