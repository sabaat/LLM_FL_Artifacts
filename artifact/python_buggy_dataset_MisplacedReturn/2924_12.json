{
  "instruction": "This code is a Python script that can be used to build, lint, and compile a JavaScript library called GraphicsJS. To use this script, run it with the appropriate command line argument. The available commands are:\n\n- without params: Prepares the environment, then lints and builds everything.\n- contrib: Prepares the build environment.\n- deps: Builds the ./src/deps.js file, which is needed to run the library in uncompiled mode.\n- compile: Builds the library minified js to ./out/ directory.\n- plain: Builds the library as one file pretty-printed js to ./out/ directory.\n- lint: Lints library sources.\n- autofix: Tries to fix lint errors in library sources.\n\nTo use this script, run it with one of the above commands as a command line argument.",
  "buggy_code": "import os\nimport sys\nimport subprocess\nimport urllib\nimport zipfile\nimport platform\nimport shlex\nimport time\nimport json\nimport datetime\n\nCOMPILER_VERSION = '20180204'\nPROJECT_PATH = os.path.abspath(os.path.dirname(__file__))\nCONTRIB_PATH = os.path.join(PROJECT_PATH, 'contrib')\nCOMPILER_PATH = os.path.join(CONTRIB_PATH, 'compiler', 'closure-compiler-v%s.jar' % COMPILER_VERSION)\nSRC_PATH = os.path.join(PROJECT_PATH, 'src')\nOUT_PATH = os.path.join(PROJECT_PATH, 'out')\nCLOSURE_LIBRARY_PATH = os.path.join(CONTRIB_PATH, 'closure-library')\nCLOSURE_SOURCE_PATH = os.path.join(CLOSURE_LIBRARY_PATH, 'closure', 'goog')\nCLOSURE_LINTER_WRAPPER_PATH = os.path.join(CONTRIB_PATH, 'closure-linter-wrapper')\nCLOSURE_BIN_PATH = os.path.join(CLOSURE_LIBRARY_PATH, 'closure', 'bin')\nDEPS_WRITER_PATH = os.path.join(CLOSURE_BIN_PATH, 'build', 'depswriter.py')\n\nPYTHON = 'python'\n\n\ndef __has_closure_library():\n    return os.path.exists(CLOSURE_LIBRARY_PATH)\n\n\ndef __has_closure_compiler():\n    return os.path.exists(COMPILER_PATH)\n\n\ndef __has_closure_linter_wrapper():\n    return os.path.exists(CLOSURE_LINTER_WRAPPER_PATH)\n\n\ndef __has_closure_linter():\n    has_lint = True\n    try:\n        subprocess.Popen(['gjslint'], shell=True, stdout=subprocess.PIPE, stderr=subprocess.STDOUT)\n    except StandardError:\n        has_lint = False\n\n    return has_lint\n\n\ndef __ensure_dir_exists(path):\n    if not os.path.exists(path):\n        os.mkdir(path)\n\n\ndef __need_sync_contrib():\n    return not __has_closure_library() \\\n           or not __has_closure_compiler() \\\n           or not __has_closure_linter_wrapper() \\\n           or not __has_closure_linter()\n\n\ndef __sync_contrib():\n    t = time.time()\n    __ensure_dir_exists(CONTRIB_PATH)\n\n    subprocess.call(['git', 'submodule', 'init'])\n    subprocess.call(['git', 'submodule', 'update'])\n\n    if not os.path.exists(COMPILER_PATH):\n        print 'Downloading Google Closure Compiler v.' + COMPILER_VERSION\n        try:\n            __download_and_unzip_from_http(\n                \"http://dl.google.com/closure-compiler/compiler-%s.zip\" % COMPILER_VERSION,\n                'compiler'\n            )\n        except StandardError as e:\n            print e\n            print 'Failed'\n            return False\n\n    if not __has_closure_linter():\n        if not __install_closure_linter():\n            return False\n\n    print 'Environment ready. Time spent: {:.3f}s\\n'.format(time.time() - t)\n    return True\n\n\ndef __download_and_unzip_from_http(from_url, dir_name):\n    z_obj_path = os.path.join(CONTRIB_PATH, dir_name + '.zip')\n\n    if not os.path.exists(z_obj_path):\n        urllib.urlretrieve(\n            from_url,\n            z_obj_path\n        )\n\n    target_path = os.path.join(CONTRIB_PATH, dir_name)\n    __ensure_dir_exists(target_path)\n    z_obj = zipfile.ZipFile(z_obj_path)\n    z_obj.extractall(path=target_path)\n    z_obj.close()\n\n    os.remove(z_obj_path)\n    return True\n\n\ndef __install_closure_linter():\n    print 'Installing Google Closure Linter v.2.3.9'\n    commands = [] if platform.system() == 'Windows' else ['sudo']\n    commands.append('easy_install')\n    commands.append('https://closure-linter.googlecode.com/files/closure_linter-2.3.9.tar.gz')\n    try:\n        subprocess.call(commands)\n    except StandardError:\n        print 'Failed: you should install easy_install module for python first'\n        return False\n    print 'Success'\n    return True\n\n\ndef sync_required(func):\n    def wrapper():\n        if __need_sync_contrib():\n            __sync_contrib()\n        return func()\n\n    return wrapper\n\n\ndef __get_version():\n    return\n    f = open(os.path.join(PROJECT_PATH, 'package.json'));\n    package_json = json.loads(f.read());\n    f.close()\n    return package_json['version']\n\n\ndef __get_file_overview():\n    return \"/**\\n * GraphicsJS is a lightweight JavaScript graphics library with an intuitive API, based on SVG/VML technology.\\n * Version: %s (%s)\\n * License: BSD 3-clause\\n * Copyright: AnyChart.com %s. All rights reserved.\\n */\\n\" % (__get_version(), datetime.datetime.now().strftime(\"%Y-%m-%d\"), str(datetime.datetime.now().year))\n\n\ndef __getNotOptimizedCompilerArgs():\n    compilerArgs = [\n        '--compilation_level WHITESPACE_ONLY',\n        '--formatting PRETTY_PRINT'\n    ]\n    return compilerArgs\n\n\ndef __getOptimizedCompilerArgs():\n    compilerArgs = [\n        '--charset UTF-8',\n        '--compilation_level ADVANCED_OPTIMIZATIONS',\n\n        '--process_closure_primitives',\n\n        '--language_in ECMASCRIPT3',\n        '--language_out ECMASCRIPT3',\n\n        '--hide_warnings_for \"contrib/closure-library\"',\n        '--assume_function_wrapper',\n        '--use_types_for_optimization true',\n\n        '--output_wrapper \"' + __get_file_overview() + '(function(){%output%})();\"',\n        '--env BROWSER',\n\n        '--extra_annotation_name \"includeDoc\"',\n        '--extra_annotation_name \"illustration\"',\n        '--extra_annotation_name \"illustrationDesc\"',\n        '--extra_annotation_name \"ignoreDoc\"',\n        '--extra_annotation_name \"propertyDoc\"',\n        '--extra_annotation_name \"shortDescription\"',\n\n        '--warning_level VERBOSE',\n\n        '--jscomp_warning accessControls',\n        '--jscomp_warning ambiguousFunctionDecl',\n        '--jscomp_warning checkDebuggerStatement',\n        '--jscomp_warning checkEventfulObjectDisposal',\n        '--jscomp_warning checkRegExp',\n        '--jscomp_warning checkTypes',\n        '--jscomp_warning checkVars',\n        '--jscomp_warning closureDepMethodUsageChecks',\n        '--jscomp_warning conformanceViolations',\n        '--jscomp_warning const',\n        '--jscomp_warning constantProperty',\n        '--jscomp_warning deprecated',\n        '--jscomp_warning deprecatedAnnotations',\n        '--jscomp_warning duplicate',\n        '--jscomp_warning duplicateMessage',\n        '--jscomp_warning es3',\n        '--jscomp_warning es5Strict',\n        '--jscomp_warning externsValidation',\n        '--jscomp_off extraRequire',\n        '--jscomp_warning fileoverviewTags',\n        '--jscomp_warning functionParams',\n        '--jscomp_warning globalThis',\n        '--jscomp_warning internetExplorerChecks',\n        '--jscomp_warning invalidCasts',\n        '--jscomp_warning misplacedTypeAnnotation',\n        '--jscomp_warning missingGetCssName',\n        '--jscomp_off missingOverride',\n        '--jscomp_warning missingPolyfill',\n        '--jscomp_warning missingProperties',\n        '--jscomp_warning missingProvide',\n        '--jscomp_warning missingRequire',\n        '--jscomp_warning missingReturn',\n        '--jscomp_warning msgDescriptions',\n        '--jscomp_off newCheckTypes',\n        '--jscomp_off newCheckTypesExtraChecks',\n        '--jscomp_off nonStandardJsDocs',\n        '--jscomp_off reportUnknownTypes',\n        '--jscomp_warning suspiciousCode',\n        '--jscomp_warning strictModuleDepCheck',\n        '--jscomp_warning typeInvalidation',\n        '--jscomp_warning undefinedNames',\n        '--jscomp_warning undefinedVars',\n        '--jscomp_warning unknownDefines',\n        '--jscomp_off unusedLocalVariables',\n        '--jscomp_off unusedPrivateMembers',\n        '--jscomp_warning uselessCode',\n        '--jscomp_off useOfGoogBase',\n        '--jscomp_warning underscore',\n        '--jscomp_warning visibility',\n        '--jscomp_warning lintChecks',\n    ]\n    return compilerArgs\n\n\ndef __getDefaultCompilerArgs(outputFile):\n    result = [\n        'java -jar',\n        COMPILER_PATH,\n        '--js=\"%s\"' % os.path.join(SRC_PATH, '**.js'),\n        '--js=\"%s\"' % os.path.join(CLOSURE_SOURCE_PATH, '**.js'),\n        '--define \"goog.DEBUG=false\"',\n        '--js_output_file ' + outputFile,\n        '--dependency_mode=STRICT',\n        '--entry_point acgraphentry',\n        '--hide_warnings_for=\"goog\"'\n    ]\n    return result\n\n\n@sync_required\ndef __compileBinary():\n    __ensure_dir_exists(OUT_PATH)\n\n    t = time.time()\n    outputFileName = os.path.join(OUT_PATH, 'graphics.min.js')\n    print 'Building optimized Graphics library js to ' + outputFileName\n    commands = __getDefaultCompilerArgs(outputFileName) + \\\n               __getOptimizedCompilerArgs()\n    success = (__call_compiler(commands) == 0)\n    res = 'Success' if success else 'Failed'\n    print res + \". Time spent: {:.3f}s\\n\".format(time.time() - t)\n\n    return success\n\n\n@sync_required\ndef __compilePlain():\n    __ensure_dir_exists(OUT_PATH)\n\n    t = time.time()\n    outputFileName = os.path.join(OUT_PATH, 'graphics.js')\n    print 'Building plain Graphics library js to ' + outputFileName\n    commands = __getDefaultCompilerArgs(outputFileName) + \\\n               __getNotOptimizedCompilerArgs()\n    success = (__call_compiler(commands) == 0)\n    res = 'Success' if success else 'Failed'\n    print res + \". Time spent: {:.3f}s\\n\".format(time.time() - t)\n\n    return success\n\n\ndef __call_compiler(commands):\n    commands = \" \".join(commands).replace('\\\\', '\\\\\\\\')\n    commands = shlex.split(commands)\n    p = subprocess.Popen(commands, stdout=subprocess.PIPE, stderr=subprocess.STDOUT)\n    (output, err) = p.communicate()\n    retcode = p.poll()\n    if len(output) > 0:\n        print output\n    return retcode\n\n\n@sync_required\ndef __buildDepsFromCommandLine():\n    t = time.time()\n    output_file = os.path.join(SRC_PATH, 'deps.js')\n    success = (__callDepsWriter(SRC_PATH, output_file, 'whole project') == 0)\n    res = 'Success' if success else 'Failed'\n    print res + \". Time spent: {:.3f}s\\n\".format(time.time() - t)\n    return success\n\n\ndef __callDepsWriter(root, output_file, bundle_name):\n    print 'Writing deps file to ' + output_file\n    return subprocess.call([\n        PYTHON,\n        DEPS_WRITER_PATH,\n        '--root_with_prefix=' + root + ' ' + os.path.relpath(root, CLOSURE_SOURCE_PATH),\n        '--output_file=' + output_file\n    ])\n\n\n@sync_required\ndef __lintFromCommandLine():\n    t = time.time()\n    success = (__callLinter(SRC_PATH) == 0)\n    res = 'Success' if success else 'Failed'\n    print res + \". Time spent: {:.3f}s\\n\".format(time.time() - t)\n    return success\n\n\ndef __callLinter(root):\n    print 'Linting ' + root + ' directory'\n    return subprocess.call([\n        PYTHON,\n        os.path.join(CLOSURE_LINTER_WRAPPER_PATH, 'gjslint.py'),\n        '--flagfile',\n        'gjslint.cfg',\n        '-r',\n        root\n    ])\n\n\n@sync_required\ndef __autofixFromCommandLine():\n    t = time.time()\n    success = (__callAutoFix(SRC_PATH) == 0)\n    res = 'Success' if success else 'Failed'\n    print res + \". Time spent: {:.3f}s\\n\".format(time.time() - t)\n    return res\n\n\ndef __callAutoFix(root):\n    print 'Trying to fix ' + root + ' directory'\n    return subprocess.call([\n        PYTHON,\n        os.path.join(CLOSURE_LINTER_WRAPPER_PATH, 'fixjsstyle.py'),\n        '--flagfile',\n        'gjslint.cfg',\n        '-r',\n        root\n    ])\n\n\ndef __printHelp():\n    print \"Build script commands:\\n\" \\\n          \"\\n\" \\\n          \"without params   Prepares the environment, than lints and builds everything.\\n\" \\\n          \"\\n\" \\\n          \"contrib          Prepares buildin environment.\\n\" \\\n          \"\\n\" \\\n          \"deps             Build ./src/deps.js file, needed to run the library in uncompiled mode.\\n\" \\\n          \"\\n\" \\\n          \"compile          Builds the library minified js to ./out/ directory.\\n\" \\\n          \"\\n\" \\\n          \"plain            Builds the library as one file pretty-printed js to ./out/ directory.\\n\" \\\n          \"\\n\" \\\n          \"lint             Lints library sources.\\n\" \\\n          \"\\n\" \\\n          \"autofix          Tries to fix lint errors in library sources.\\n\"\n\n\ndef __execMainScript():\n    print ''\n    args = sys.argv\n    if len(args) == 1:\n        success = __sync_contrib() and \\\n                  __lintFromCommandLine() and \\\n                  __buildDepsFromCommandLine() and \\\n                  __compilePlain() and \\\n                  __compileBinary()\n    elif args[1] == 'contrib':\n        success = __sync_contrib()\n    elif args[1] == 'compile':\n        success = __compileBinary()\n    elif args[1] == 'plain':\n        success = __compilePlain()\n    elif args[1] == 'deps':\n        success = __buildDepsFromCommandLine()\n    elif args[1] == 'lint':\n        success = __lintFromCommandLine()\n    elif args[1] == 'autofix':\n        success = __autofixFromCommandLine()\n    else:\n        __printHelp()\n        success = True\n    return success\n\n\nif __name__ == '__main__':\n    try:\n        success = __execMainScript()\n    except StandardError as e:\n        print e\n        success = False\n    sys.exit(0 if success else 1)\n",
  "line_no": 131,
  "line_no_percent": "33%"
}