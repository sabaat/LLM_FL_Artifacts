{
  "instruction": "This code is a Python script that contains a set of unit tests for the virtinst CapabilitiesParser module. To run the tests, execute the script. The tests include checking the CPU architecture, operating system type, domains, and features of different guests, as well as testing various CPU maps and capabilities. The script also includes helper functions for building host feature dictionaries and comparing guest capabilities.",
  "buggy_code": "import os\nimport unittest\n\nfrom tests import utils\nfrom virtinst import CapabilitiesParser as capabilities\n\n\ndef build_host_feature_dict(feature_list):\n    fdict = {}\n    for f in feature_list:\n        fdict[f] = capabilities.FEATURE_ON\n\n    return fdict\n\n\nclass TestCapabilities(unittest.TestCase):\n\n    def _compareGuest(self, (arch, os_type, domains, features), guest):\n        self.assertEqual(arch,            guest.arch)\n        self.assertEqual(os_type,         guest.os_type)\n        self.assertEqual(len(domains), len(guest.domains))\n        for n in range(len(domains)):\n            self.assertEqual(domains[n][0], guest.domains[n].hypervisor_type)\n            self.assertEqual(domains[n][1], guest.domains[n].emulator)\n            self.assertEqual(domains[n][2], guest.domains[n].machines)\n\n        for n in features:\n            self.assertEqual(features[n],        guest.features[n])\n\n    def _buildCaps(self, filename):\n        path = os.path.join(\"tests/capabilities-xml\", filename)\n        xml = file(path).read()\n\n        return capabilities.Capabilities(xml)\n\n    def _testCapabilities(self, path, (host_arch, host_features), guests,\n                          secmodel=None):\n        caps = self._buildCaps(path)\n\n        if host_arch:\n            self.assertEqual(host_arch, caps.host.cpu.arch)\n            for n in host_features:\n                self.assertEqual(host_features[n], caps.host.cpu.features[n])\n\n        if secmodel:\n            self.assertEqual(secmodel[0], caps.host.secmodel.model)\n            self.assertEqual(secmodel[1], caps.host.secmodel.doi)\n            if secmodel[2]:\n                for k, v in secmodel[2].items():\n                    self.assertEqual(v, caps.host.secmodel.baselabels[k])\n\n        for idx in range(len(guests)):\n            self._compareGuest(guests[idx], caps.guests[idx])\n\n    def testCapabilities1(self):\n        host = ('x86_64', {'vmx': capabilities.FEATURE_ON})\n\n        guests = [\n            ('x86_64', 'xen',\n              [['xen', None, []]], {}),\n            ('i686',   'xen',\n              [['xen', None, []]], {'pae': capabilities.FEATURE_ON}),\n            ('i686',   'hvm',\n              [['xen', \"/usr/lib64/xen/bin/qemu-dm\", ['pc', 'isapc']]], {'pae': capabilities.FEATURE_ON | capabilities.FEATURE_OFF}),\n            ('x86_64', 'hvm',\n              [['xen', \"/usr/lib64/xen/bin/qemu-dm\", ['pc', 'isapc']]], {})\n       ]\n\n        self._testCapabilities(\"capabilities-xen.xml\", host, guests)\n\n    def testCapabilities2(self):\n        host = ('x86_64', {})\n        secmodel = ('selinux', '0', None)\n\n        guests = [\n            ('x86_64', 'hvm',\n              [['qemu', '/usr/bin/qemu-system-x86_64', ['pc', 'isapc']]], {}),\n            ('i686',   'hvm',\n              [['qemu', '/usr/bin/qemu', ['pc', 'isapc']]], {}),\n            ('mips',   'hvm',\n              [['qemu', '/usr/bin/qemu-system-mips', ['mips']]], {}),\n            ('mipsel', 'hvm',\n              [['qemu', '/usr/bin/qemu-system-mipsel', ['mips']]], {}),\n            ('sparc',  'hvm',\n              [['qemu', '/usr/bin/qemu-system-sparc', ['sun4m']]], {}),\n            ('ppc',    'hvm',\n              [['qemu', '/usr/bin/qemu-system-ppc',\n               ['g3bw', 'mac99', 'prep']]], {}),\n       ]\n\n        self._testCapabilities(\"capabilities-qemu.xml\", host, guests, secmodel)\n\n    def testCapabilities3(self):\n        host = ('i686', {})\n\n        guests = [\n            ('i686',   'hvm',\n              [['qemu', '/usr/bin/qemu', ['pc', 'isapc']],\n               ['kvm', '/usr/bin/qemu-kvm', ['pc', 'isapc']]], {}),\n            ('x86_64', 'hvm',\n              [['qemu', '/usr/bin/qemu-system-x86_64', ['pc', 'isapc']]], {}),\n            ('mips',   'hvm',\n              [['qemu', '/usr/bin/qemu-system-mips', ['mips']]], {}),\n            ('mipsel', 'hvm',\n              [['qemu', '/usr/bin/qemu-system-mipsel', ['mips']]], {}),\n            ('sparc',  'hvm',\n              [['qemu', '/usr/bin/qemu-system-sparc', ['sun4m']]], {}),\n            ('ppc',    'hvm',\n              [['qemu', '/usr/bin/qemu-system-ppc',\n               ['g3bw', 'mac99', 'prep']]], {}),\n       ]\n\n        secmodel = ('dac', '0', {\"kvm\" : \"+0:+0\", \"qemu\" : \"+0:+0\"})\n\n        self._testCapabilities(\"capabilities-kvm.xml\", host, guests, secmodel)\n\n    def testCapabilities4(self):\n        host = ('i686',\n                 {'pae': capabilities.FEATURE_ON | capabilities.FEATURE_OFF})\n\n        guests = [\n            ('i686', 'linux',\n              [['test', None, []]],\n              {'pae': capabilities.FEATURE_ON | capabilities.FEATURE_OFF}),\n       ]\n\n        self._testCapabilities(\"capabilities-test.xml\", host, guests)\n\n    def testCapsLXC(self):\n        guests = [\n            (\"x86_64\", \"exe\", [[\"lxc\", \"/usr/libexec/libvirt_lxc\", []]], {}),\n            (\"i686\", \"exe\", [[\"lxc\", \"/usr/libexec/libvirt_lxc\", []]], {}),\n       ]\n\n        self._testCapabilities(\"capabilities-lxc.xml\",\n                               (None, None), guests)\n\n    def testCapsTopology(self):\n        filename = \"capabilities-test.xml\"\n        caps = self._buildCaps(filename)\n\n        self.assertTrue(bool(caps.host.topology))\n        self.assertTrue(len(caps.host.topology.cells) == 2)\n        self.assertTrue(len(caps.host.topology.cells[0].cpus) == 8)\n        self.assertTrue(len(caps.host.topology.cells[0].cpus) == 8)\n\n    def testCapsCPUFeaturesOldSyntax(self):\n        return\n        filename = \"rhel5.4-xen-caps-virt-enabled.xml\"\n        host_feature_list = [\"vmx\"]\n        feature_dict = build_host_feature_dict(host_feature_list)\n\n        caps = self._buildCaps(filename)\n        for f in feature_dict.keys():\n            self.assertEquals(caps.host.cpu.features[f], feature_dict[f])\n\n    def testCapsCPUFeaturesOldSyntaxSVM(self):\n        filename = \"rhel5.4-xen-caps.xml\"\n        host_feature_list = [\"svm\"]\n        feature_dict = build_host_feature_dict(host_feature_list)\n\n        caps = self._buildCaps(filename)\n        for f in feature_dict.keys():\n            self.assertEquals(caps.host.cpu.features[f], feature_dict[f])\n\n    def testCapsCPUFeaturesNewSyntax(self):\n        filename = \"libvirt-0.7.6-qemu-caps.xml\"\n        host_feature_list = ['lahf_lm', 'xtpr', 'cx16', 'tm2', 'est', 'vmx',\n                             'ds_cpl', 'pbe', 'tm', 'ht', 'ss', 'acpi', 'ds']\n        feature_dict = build_host_feature_dict(host_feature_list)\n\n        caps = self._buildCaps(filename)\n        for f in feature_dict.keys():\n            self.assertEquals(caps.host.cpu.features[f], feature_dict[f])\n\n        self.assertEquals(caps.host.cpu.model, \"core2duo\")\n        self.assertEquals(caps.host.cpu.vendor, \"Intel\")\n        self.assertEquals(caps.host.cpu.threads, \"3\")\n        self.assertEquals(caps.host.cpu.cores, \"5\")\n        self.assertEquals(caps.host.cpu.sockets, \"7\")\n\n    def testCapsUtilFuncs(self):\n        new_caps = self._buildCaps(\"libvirt-0.7.6-qemu-caps.xml\")\n        new_caps_no_kvm = self._buildCaps(\n                                    \"libvirt-0.7.6-qemu-no-kvmcaps.xml\")\n        empty_caps = self._buildCaps(\"empty-caps.xml\")\n        rhel_xen_enable_hvm_caps = self._buildCaps(\n                                    \"rhel5.4-xen-caps-virt-enabled.xml\")\n        rhel_xen_caps = self._buildCaps(\"rhel5.4-xen-caps.xml\")\n        rhel_kvm_caps = self._buildCaps(\"rhel5.4-kvm-caps.xml\")\n\n        def test_utils(caps, no_guests, is_hvm, is_kvm, is_bios_disable,\n                       is_xenner):\n            self.assertEquals(caps.no_install_options(), no_guests)\n            self.assertEquals(caps.hw_virt_supported(), is_hvm)\n            self.assertEquals(caps.is_kvm_available(), is_kvm)\n            self.assertEquals(caps.is_bios_virt_disabled(), is_bios_disable)\n            self.assertEquals(caps.is_xenner_available(), is_xenner)\n\n        test_utils(new_caps, False, True, True, False, True)\n        test_utils(empty_caps, True, False, False, False, False)\n        test_utils(rhel_xen_enable_hvm_caps, False, True, False, False, False)\n        test_utils(rhel_xen_caps, False, True, False, True, False)\n        test_utils(rhel_kvm_caps, False, True, True, False, False)\n        test_utils(new_caps_no_kvm, False, True, False, False, False)\n\n    def testCPUMap(self):\n        caps = self._buildCaps(\"libvirt-0.7.6-qemu-caps.xml\")\n        cpu_64 = caps.get_cpu_values(None, \"x86_64\")\n        cpu_32 = caps.get_cpu_values(None, \"i486\")\n        cpu_random = caps.get_cpu_values(None, \"mips\")\n\n        def test_cpu_map(cpumap, cpus):\n            cpunames = sorted([c.model for c in cpumap], key=str.lower)\n\n            for c in cpus:\n                self.assertTrue(c in cpunames)\n\n        self.assertEquals(cpu_64, cpu_32)\n\n        x86_cpunames = [\n            '486', 'athlon', 'Conroe', 'core2duo', 'coreduo', 'n270',\n            'Nehalem', 'Opteron_G1', 'Opteron_G2', 'Opteron_G3', 'Penryn',\n            'pentium', 'pentium2', 'pentium3', 'pentiumpro', 'phenom',\n            'qemu32', 'qemu64']\n\n        test_cpu_map(cpu_64, x86_cpunames)\n        test_cpu_map(cpu_random, [])\n\n        conn = utils.open_testdriver()\n        cpu_64 = caps.get_cpu_values(conn, \"x86_64\")\n        self.assertTrue(len(cpu_64) > 0)\n\n\nif __name__ == \"__main__\":\n    unittest.main()\n",
  "line_no": 148,
  "line_no_percent": "63%"
}