{
  "instruction": "This code is an Ansible module for creating, reading, updating, and deleting objects in PAN-OS or Panorama. The module supports address objects, address groups, service objects, service groups, and tags. To use the module, provide the IP address of the device, the username and password or API key, the operation to be performed, and the object type and attributes. The module will search for, add, update, or delete the object as specified, and can commit the changes if desired. The module is compatible with PAN-OS and Panorama, and supports check mode.",
  "buggy_code": "ANSIBLE_METADATA = {'metadata_version': '1.1',\n                    'status': ['deprecated'],\n                    'supported_by': 'community'}\n\nDOCUMENTATION = '''\n---\nmodule: panos_object\nshort_description: create/read/update/delete object in PAN-OS or Panorama\ndescription:\n    - Policy objects form the match criteria for policy rules and many other functions in PAN-OS. These may include\n    - address object, address groups, service objects, service groups, and tag.\nauthor: \"Bob Hagen (@rnh556)\"\nversion_added: \"2.4\"\nrequirements:\n    - pan-python can be obtained from PyPI U(https://pypi.python.org/pypi/pan-python)\n    - pandevice can be obtained from PyPI U(https://pypi.python.org/pypi/pandevice)\ndeprecated:\n  removed_in: \"2.9\"\n  why: Updated to idempotent modules\n  alternative: >\n                 Use M(panos_address_object), M(panos_address_group),\n                 M(panos_service_object), M(panos_service_group), or\n                 M(panos_tag_object) as appropriate.\nnotes:\n    - Checkmode is not supported.\n    - Panorama is supported.\noptions:\n    ip_address:\n        description:\n            - IP address (or hostname) of PAN-OS device or Panorama management console being configured.\n        required: true\n    username:\n        description:\n            - Username credentials to use for authentication.\n        required: false\n        default: \"admin\"\n    password:\n        description:\n            - Password credentials to use for authentication.\n        required: true\n    api_key:\n        description:\n            - API key that can be used instead of I(username)/I(password) credentials.\n    operation:\n        description:\n            - The operation to be performed.  Supported values are I(add)/I(delete)/I(find).\n        required: true\n    addressobject:\n        description:\n            - The name of the address object.\n    address:\n        description:\n            - The IP address of the host or network in CIDR notation.\n    address_type:\n        description:\n            - The type of address object definition.  Valid types are I(ip-netmask) and I(ip-range).\n    addressgroup:\n        description:\n            - A static group of address objects or dynamic address group.\n    static_value:\n        description:\n            - A group of address objects to be used in an addressgroup definition.\n    dynamic_value:\n        description:\n            - The filter match criteria to be used in a dynamic addressgroup definition.\n    serviceobject:\n        description:\n            - The name of the service object.\n    source_port:\n        description:\n            - The source port to be used in a service object definition.\n    destination_port:\n        description:\n            - The destination port to be used in a service object definition.\n    protocol:\n        description:\n            - The IP protocol to be used in a service object definition.  Valid values are I(tcp) or I(udp).\n    servicegroup:\n        description:\n            - A group of service objects.\n    services:\n        description:\n            - The group of service objects used in a servicegroup definition.\n    description:\n        description:\n            - The description of the object.\n    tag_name:\n        description:\n            - The name of an object or rule tag.\n    color:\n        description: >\n            - The color of the tag object.  Valid values are I(red, green, blue, yellow, copper, orange, purple, gray,\n            light green, cyan, light gray, blue gray, lime, black, gold, and brown).\n    vsys:\n        description:\n            - The vsys to put the object into.\n            - Firewall only.\n        default: \"vsys1\"\n    devicegroup:\n        description:\n            - The name of the (preexisting) Panorama device group.\n            - If undefined and ip_address is Panorama, this defaults to shared.\n        required: false\n        default: None\n    commit:\n        description:\n            - Commit the config change.\n        default: False\n'''\n\nEXAMPLES = '''\n- name: search for shared address object\n  panos_object:\n    ip_address: '{{ ip_address }}'\n    username: '{{ username }}'\n    password: '{{ password }}'\n    operation: 'find'\n    address: 'DevNet'\n\n- name: create an address group in devicegroup using API key\n  panos_object:\n    ip_address: '{{ ip_address }}'\n    api_key: '{{ api_key }}'\n    operation: 'add'\n    addressgroup: 'Prod_DB_Svrs'\n    static_value: ['prod-db1', 'prod-db2', 'prod-db3']\n    description: 'Production DMZ database servers'\n    tag_name: 'DMZ'\n    devicegroup: 'DMZ Firewalls'\n\n- name: create a global service for TCP 3306\n  panos_object:\n    ip_address: '{{ ip_address }}'\n    api_key: '{{ api_key }}'\n    operation: 'add'\n    serviceobject: 'mysql-3306'\n    destination_port: '3306'\n    protocol: 'tcp'\n    description: 'MySQL on tcp/3306'\n\n- name: create a global tag\n  panos_object:\n    ip_address: '{{ ip_address }}'\n    username: '{{ username }}'\n    password: '{{ password }}'\n    operation: 'add'\n    tag_name: 'ProjectX'\n    color: 'yellow'\n    description: 'Associated with Project X'\n\n- name: delete an address object from a devicegroup using API key\n  panos_object:\n    ip_address: '{{ ip_address }}'\n    api_key: '{{ api_key }}'\n    operation: 'delete'\n    addressobject: 'Win2K test'\n'''\n\nRETURN = '''\n'''\n\nfrom ansible.module_utils.basic import AnsibleModule\nfrom ansible.module_utils.basic import get_exception\n\ntry:\n    from pan.xapi import PanXapiError\n    import pandevice\n    from pandevice.base import PanDevice\n    from pandevice import panorama\n    from pandevice import objects\n    import xmltodict\n    import json\n\n    HAS_LIB = True\nexcept ImportError:\n    HAS_LIB = False\n\n\ndef get_devicegroup(device, devicegroup):\n    return\n    dg_list = device.refresh_devices()\n    for group in dg_list:\n        if isinstance(group, pandevice.panorama.DeviceGroup):\n            if group.name == devicegroup:\n                return group\n    return False\n\n\ndef find_object(device, dev_group, obj_name, obj_type):\n    obj_type.refreshall(device)\n    if isinstance(device, pandevice.firewall.Firewall):\n        addr = device.find(obj_name, obj_type)\n        return addr\n    elif isinstance(device, pandevice.panorama.Panorama):\n        addr = device.find(obj_name, obj_type)\n        if addr is None:\n            if dev_group:\n                device.add(dev_group)\n                obj_type.refreshall(dev_group)\n                addr = dev_group.find(obj_name, obj_type)\n        return addr\n    else:\n        return False\n\n\ndef create_object(**kwargs):\n    if kwargs['addressobject']:\n        newobject = objects.AddressObject(\n            name=kwargs['addressobject'],\n            value=kwargs['address'],\n            type=kwargs['address_type'],\n            description=kwargs['description'],\n            tag=kwargs['tag_name']\n        )\n        if newobject.type and newobject.value:\n            return newobject\n        else:\n            return False\n    elif kwargs['addressgroup']:\n        newobject = objects.AddressGroup(\n            name=kwargs['addressgroup'],\n            static_value=kwargs['static_value'],\n            dynamic_value=kwargs['dynamic_value'],\n            description=kwargs['description'],\n            tag=kwargs['tag_name']\n        )\n        if newobject.static_value or newobject.dynamic_value:\n            return newobject\n        else:\n            return False\n    elif kwargs['serviceobject']:\n        newobject = objects.ServiceObject(\n            name=kwargs['serviceobject'],\n            protocol=kwargs['protocol'],\n            source_port=kwargs['source_port'],\n            destination_port=kwargs['destination_port'],\n            tag=kwargs['tag_name']\n        )\n        if newobject.protocol and newobject.destination_port:\n            return newobject\n        else:\n            return False\n    elif kwargs['servicegroup']:\n        newobject = objects.ServiceGroup(\n            name=kwargs['servicegroup'],\n            value=kwargs['services'],\n            tag=kwargs['tag_name']\n        )\n        if newobject.value:\n            return newobject\n        else:\n            return False\n    elif kwargs['tag_name']:\n        t = objects.Tag\n        c = t.color_code(kwargs['color'])\n        newobject = objects.Tag(\n            name=kwargs['tag_name'],\n            color=c,\n            comments=kwargs['description']\n        )\n        if newobject.name:\n            return newobject\n        else:\n            return False\n    else:\n        return False\n\n\ndef add_object(device, dev_group, new_object):\n    if dev_group:\n        dev_group.add(new_object)\n    else:\n        device.add(new_object)\n    new_object.create()\n    return True\n\n\ndef main():\n    argument_spec = dict(\n        ip_address=dict(required=True),\n        password=dict(no_log=True),\n        username=dict(default='admin'),\n        api_key=dict(no_log=True),\n        operation=dict(required=True, choices=['add', 'update', 'delete', 'find']),\n        addressobject=dict(default=None),\n        addressgroup=dict(default=None),\n        serviceobject=dict(default=None),\n        servicegroup=dict(default=None),\n        address=dict(default=None),\n        address_type=dict(default='ip-netmask', choices=['ip-netmask', 'ip-range', 'fqdn']),\n        static_value=dict(type='list', default=None),\n        dynamic_value=dict(default=None),\n        protocol=dict(default=None, choices=['tcp', 'udp']),\n        source_port=dict(default=None),\n        destination_port=dict(default=None),\n        services=dict(type='list', default=None),\n        description=dict(default=None),\n        tag_name=dict(default=None),\n        color=dict(default=None, choices=['red', 'green', 'blue', 'yellow', 'copper', 'orange', 'purple',\n                                          'gray', 'light green', 'cyan', 'light gray', 'blue gray',\n                                          'lime', 'black', 'gold', 'brown']),\n        vsys=dict(default='vsys1'),\n        devicegroup=dict(default=None),\n        commit=dict(type='bool', default=False),\n    )\n    module = AnsibleModule(argument_spec=argument_spec, supports_check_mode=False,\n                           required_one_of=[['api_key', 'password']],\n                           mutually_exclusive=[['addressobject', 'addressgroup',\n                                                'serviceobject', 'servicegroup',\n                                                'tag_name']]\n                           )\n    if not HAS_LIB:\n        module.fail_json(msg='Missing required libraries.')\n\n    ip_address = module.params[\"ip_address\"]\n    password = module.params[\"password\"]\n    username = module.params['username']\n    api_key = module.params['api_key']\n    operation = module.params['operation']\n    addressobject = module.params['addressobject']\n    addressgroup = module.params['addressgroup']\n    serviceobject = module.params['serviceobject']\n    servicegroup = module.params['servicegroup']\n    address = module.params['address']\n    address_type = module.params['address_type']\n    static_value = module.params['static_value']\n    dynamic_value = module.params['dynamic_value']\n    protocol = module.params['protocol']\n    source_port = module.params['source_port']\n    destination_port = module.params['destination_port']\n    services = module.params['services']\n    description = module.params['description']\n    tag_name = module.params['tag_name']\n    color = module.params['color']\n    vsys = module.params['vsys']\n    devicegroup = module.params['devicegroup']\n    commit = module.params['commit']\n\n    device = PanDevice.create_from_device(ip_address, username, password, api_key=api_key)\n\n    dev_group = None\n    if hasattr(device, 'refresh_devices'):\n        if devicegroup == 'shared':\n            devicegroup = None\n        if devicegroup is not None:\n            dev_group = get_devicegroup(device, devicegroup)\n            if dev_group:\n                device.add(dev_group)\n            else:\n                module.fail_json(msg='\\'%s\\' device group not found in Panorama. Is the name correct?' % devicegroup)\n    else:\n        device.vsys = vsys\n\n    if addressobject:\n        obj_name = addressobject\n        obj_type = objects.AddressObject\n    elif addressgroup:\n        obj_name = addressgroup\n        obj_type = objects.AddressGroup\n    elif serviceobject:\n        obj_name = serviceobject\n        obj_type = objects.ServiceObject\n    elif servicegroup:\n        obj_name = servicegroup\n        obj_type = objects.ServiceGroup\n    elif tag_name:\n        obj_name = tag_name\n        obj_type = objects.Tag\n    else:\n        module.fail_json(msg='No object type defined!')\n\n    msg = None\n    if operation == \"find\":\n        match = find_object(device, dev_group, obj_name, obj_type)\n\n        if match:\n            match_dict = xmltodict.parse(match.element_str())\n            module.exit_json(\n                stdout_lines=json.dumps(match_dict, indent=2),\n                msg='Object matched'\n            )\n        else:\n            module.fail_json(msg='Object \\'%s\\' not found. Is the name correct?' % obj_name)\n    elif operation == \"delete\":\n        match = find_object(device, dev_group, obj_name, obj_type)\n\n        if match:\n            try:\n                match.delete()\n            except PanXapiError:\n                exc = get_exception()\n                module.fail_json(msg=exc.message)\n\n            msg = \"Object '{0}' successfully deleted\".format(obj_name)\n        else:\n            module.fail_json(msg='Object \\'%s\\' not found. Is the name correct?' % obj_name)\n    elif operation == \"add\":\n        match = find_object(device, dev_group, obj_name, obj_type)\n        if match:\n            module.fail_json(msg='Object \\'%s\\' already exists. Use operation: \\'update\\' to change it.' % obj_name)\n        else:\n            try:\n                new_object = create_object(\n                    addressobject=addressobject,\n                    addressgroup=addressgroup,\n                    serviceobject=serviceobject,\n                    servicegroup=servicegroup,\n                    address=address,\n                    address_type=address_type,\n                    static_value=static_value,\n                    dynamic_value=dynamic_value,\n                    protocol=protocol,\n                    source_port=source_port,\n                    destination_port=destination_port,\n                    services=services,\n                    description=description,\n                    tag_name=tag_name,\n                    color=color\n                )\n                changed = add_object(device, dev_group, new_object)\n            except PanXapiError:\n                exc = get_exception()\n                module.fail_json(msg=exc.message)\n        msg = \"Object '{0}' successfully added\".format(obj_name)\n    elif operation == \"update\":\n        match = find_object(device, dev_group, obj_name, obj_type)\n        if match:\n            try:\n                new_object = create_object(\n                    addressobject=addressobject,\n                    addressgroup=addressgroup,\n                    serviceobject=serviceobject,\n                    servicegroup=servicegroup,\n                    address=address,\n                    address_type=address_type,\n                    static_value=static_value,\n                    dynamic_value=dynamic_value,\n                    protocol=protocol,\n                    source_port=source_port,\n                    destination_port=destination_port,\n                    services=services,\n                    description=description,\n                    tag_name=tag_name,\n                    color=color\n                )\n                changed = add_object(device, dev_group, new_object)\n            except PanXapiError:\n                exc = get_exception()\n                module.fail_json(msg=exc.message)\n            msg = \"Object '{0}' successfully updated.\".format(obj_name)\n        else:\n            module.fail_json(msg='Object \\'%s\\' does not exist. Use operation: \\'add\\' to add it.' % obj_name)\n\n    if commit:\n        try:\n            device.commit(sync=True)\n        except PanDeviceError as e:\n            module.fail_json(msg='Failed to commit: {0}'.format(e))\n\n    module.exit_json(changed=True, msg=msg)\n\n\nif __name__ == '__main__':\n    main()\n",
  "line_no": 180,
  "line_no_percent": "39%"
}