{
  "instruction": "This code defines a Python module called `zabbix_host_info` that allows you to search for Zabbix host entries. It takes in various options such as `host_name`, `host_ip`, `exact_match`, `remove_duplicate`, and `host_inventory` to filter the search results. The module uses the `zabbix-api` library to connect to a Zabbix server and retrieve the host information. To use this module, import it into your Python code and call its functions with the appropriate arguments.",
  "buggy_code": "from __future__ import absolute_import, division, print_function\n__metaclass__ = type\nANSIBLE_METADATA = {'metadata_version': '1.1', 'status': ['preview'], 'supported_by': 'community'}\nRETURN = '\\n---\\nhosts:\\n  description: List of Zabbix hosts. See https://www.zabbix.com/documentation/4.0/manual/api/reference/host/get for list of host values.\\n  returned: success\\n  type: dict\\n  sample: [ { \"available\": \"1\", \"description\": \"\", \"disable_until\": \"0\", \"error\": \"\", \"flags\": \"0\", \"groups\": [\"1\"], \"host\": \"Host A\", ... } ]\\n'\nDOCUMENTATION = '\\n---\\nmodule: zabbix_host_info\\nshort_description: Gather information about Zabbix host\\ndescription:\\n   - This module allows you to search for Zabbix host entries.\\n   - This module was called C(zabbix_host_facts) before Ansible 2.9. The usage did not change.\\nversion_added: \"2.7\"\\nauthor:\\n    - \"Michael Miko (@RedWhiteMiko)\"\\nrequirements:\\n    - \"python >= 2.6\"\\n    - \"zabbix-api >= 0.5.4\"\\noptions:\\n    host_name:\\n        description:\\n            - Name of the host in Zabbix.\\n            - host_name is the unique identifier used and cannot be updated using this module.\\n        required: true\\n    host_ip:\\n        description:\\n            - Host interface IP of the host in Zabbix.\\n        required: false\\n    exact_match:\\n        description:\\n            - Find the exact match\\n        type: bool\\n        default: no\\n    remove_duplicate:\\n        description:\\n            - Remove duplicate host from host result\\n        type: bool\\n        default: yes\\n    host_inventory:\\n        description:\\n            - List of host inventory keys to display in result.\\n            - Whole host inventory is retrieved if keys are not specified.\\n        type: list\\n        required: false\\n        version_added: 2.8\\nextends_documentation_fragment:\\n    - zabbix\\n'\nEXAMPLES = '\\n- name: Get host info\\n  local_action:\\n    module: zabbix_host_info\\n    server_url: http://monitor.example.com\\n    login_user: username\\n    login_password: password\\n    host_name: ExampleHost\\n    host_ip: 127.0.0.1\\n    timeout: 10\\n    exact_match: no\\n    remove_duplicate: yes\\n\\n- name: Reduce host inventory information to provided keys\\n  local_action:\\n    module: zabbix_host_info\\n    server_url: http://monitor.example.com\\n    login_user: username\\n    login_password: password\\n    host_name: ExampleHost\\n    host_inventory:\\n      - os\\n      - tag\\n    host_ip: 127.0.0.1\\n    timeout: 10\\n    exact_match: no\\n    remove_duplicate: yes\\n'\nimport atexit\nimport traceback\nfrom ansible.module_utils.basic import AnsibleModule, missing_required_lib\ntry:\n    from zabbix_api import ZabbixAPI\n    HAS_ZABBIX_API = True\nexcept ImportError:\n    ZBX_IMP_ERR = traceback.format_exc()\n    HAS_ZABBIX_API = False\n\nclass Host(object):\n\n    def __init__(self, module, zbx):\n        self._module = module\n        self._zapi = zbx\n\n    def get_hosts_by_host_name(self, host_name, exact_match, host_inventory):\n        \"\"\" Get host by host name \"\"\"\n        search_key = 'search'\n        if exact_match:\n            search_key = 'filter'\n        host_list = self._zapi.host.get({'output': 'extend', 'selectParentTemplates': ['name'], search_key: {'host': [host_name]}, 'selectInventory': host_inventory})\n        if len(host_list) < 1:\n            self._module.fail_json(msg='Host not found: %s' % host_name)\n        else:\n            return host_list\n\n    def get_hosts_by_ip(self, host_ips, host_inventory):\n        \"\"\" Get host by host ip(s) \"\"\"\n        hostinterfaces = self._zapi.hostinterface.get({'output': 'extend', 'filter': {'ip': host_ips}})\n        if len(hostinterfaces) < 1:\n            self._module.fail_json(msg='Host not found: %s' % host_ips)\n        host_list = []\n        for hostinterface in hostinterfaces:\n            host = self._zapi.host.get({'output': 'extend', 'selectGroups': 'extend', 'selectParentTemplates': ['name'], 'hostids': hostinterface['hostid'], 'selectInventory': host_inventory})\n            host[0]['hostinterfaces'] = hostinterface\n            host_list.append(host[1])\n        return host_list\n\n    def delete_duplicate_hosts(self, hosts):\n        \"\"\" Delete duplicated hosts \"\"\"\n        unique_hosts = []\n        listed_hostnames = []\n        for zabbix_host in hosts:\n            if zabbix_host['name'] in listed_hostnames:\n                continue\n            unique_hosts.append(zabbix_host)\n            listed_hostnames.append(zabbix_host['name'])\n        return unique_hosts\n\ndef main():\n    module = AnsibleModule(argument_spec=dict(server_url=dict(type='str', required=True, aliases=['url']), login_user=dict(type='str', required=True), login_password=dict(type='str', required=True, no_log=True), host_name=dict(type='str', default='', required=False), host_ip=dict(type='list', default=[], required=False), http_login_user=dict(type='str', required=False, default=None), http_login_password=dict(type='str', required=False, default=None, no_log=True), validate_certs=dict(type='bool', required=False, default=True), timeout=dict(type='int', default=10), exact_match=dict(type='bool', required=False, default=False), remove_duplicate=dict(type='bool', required=False, default=True), host_inventory=dict(type='list', default=[], required=False)), supports_check_mode=True)\n    if module._name == 'zabbix_host_facts':\n        module.deprecate(\"The 'zabbix_host_facts' module has been renamed to 'zabbix_host_info'\", version='2.13')\n    if not HAS_ZABBIX_API:\n        module.fail_json(msg=missing_required_lib('zabbix-api', url='https://pypi.org/project/zabbix-api/'), exception=ZBX_IMP_ERR)\n    server_url = module.params['server_url']\n    login_user = module.params['login_user']\n    login_password = module.params['login_password']\n    http_login_user = module.params['http_login_user']\n    http_login_password = module.params['http_login_password']\n    validate_certs = module.params['validate_certs']\n    host_name = module.params['host_name']\n    host_ips = module.params['host_ip']\n    timeout = module.params['timeout']\n    exact_match = module.params['exact_match']\n    is_remove_duplicate = module.params['remove_duplicate']\n    host_inventory = module.params['host_inventory']\n    if not host_inventory:\n        host_inventory = 'extend'\n    zbx = None\n    try:\n        zbx = ZabbixAPI(server_url, timeout=timeout, user=http_login_user, passwd=http_login_password, validate_certs=validate_certs)\n        zbx.login(login_user, login_password)\n        atexit.register(zbx.logout)\n    except Exception as e:\n        module.fail_json(msg='Failed to connect to Zabbix server: %s' % e)\n    host = Host(module, zbx)\n    if host_name:\n        hosts = host.get_hosts_by_host_name(host_name, exact_match, host_inventory)\n        if is_remove_duplicate:\n            hosts = host.delete_duplicate_hosts(hosts)\n        extended_hosts = []\n        for zabbix_host in hosts:\n            zabbix_host['hostinterfaces'] = host._zapi.hostinterface.get({'output': 'extend', 'hostids': zabbix_host['hostid']})\n            extended_hosts.append(zabbix_host)\n        module.exit_json(ok=True, hosts=extended_hosts)\n    elif host_ips:\n        extended_hosts = host.get_hosts_by_ip(host_ips, host_inventory)\n        if is_remove_duplicate:\n            hosts = host.delete_duplicate_hosts(extended_hosts)\n        module.exit_json(ok=True, hosts=extended_hosts)\n    else:\n        module.exit_json(ok=False, hosts=[], result='No Host present')\nif __name__ == '__main__':\n    main()",
  "line_no": 142,
  "line_no_percent": "139%"
}