{
  "instruction": "Connect to a database, retrieve data, and write it to a JSON file named \"extract.json\". The code is written in Python and requires the SQLite3 library.",
  "buggy_code": "import re\nimport os\nimport sys\nimport json\nimport sqlite3 as lite\nimport collections\nimport time\nimport datetime\ndb_file = os.path.expanduser('~/.traces/traces.sqlite')\ncon = lite.connect(db_file)\nwith con:\n    data = []\n    apps = []\n    windows = []\n    urls = []\n    appevents = []\n    windowevents = []\n    urlevents = []\n    exps = []\n    images = []\n    words = []\n    cur = con.cursor()\n    appsSQL = 'SELECT * FROM app'\n    windowsSQL = 'SELECT * FROM window'\n    urlSQL = 'SELECT * FROM url'\n    activeappSQL = \"SELECT a.id, a.app_id, a.event, a.time as startt, min(b.time) AS endt FROM appevent a, appevent b WHERE a.app_id = b.app_id AND a.event = 'Active' AND b.event in ('Inactive', 'Close') AND a.time < b.time AND a.time IS NOT NULL AND b.time IS NOT NULL GROUP BY startt\"\n    activewindowSQL = \"SELECT a.id, a.window_id, a.event, a.time as startt, min(b.time) AS endt FROM windowevent a, windowevent b WHERE a.window_id = b.window_id AND a.event = 'Active' AND b.event in ('Inactive', 'Close') AND a.time < b.time AND a.time IS NOT NULL AND b.time IS NOT NULL GROUP BY startt\"\n    activeurlSQL = \"SELECT a.id, a.url_id, a.app_id, a.window_id, a.event, a.time as startt, min(b.time) AS endt FROM urlevent a, urlevent b WHERE a.url_id = b.url_id AND a.window_id = b.window_id AND a.app_id = b.app_id AND a.event = 'Active' AND b.event in ('Inactive', 'Close') AND a.time < b.time AND a.time IS NOT NULL AND b.time IS NOT NULL GROUP BY startt\"\n    experienceSQL = 'SELECT * FROM experience'\n    wordsSQL = 'SELECT * FROM keys'\n    cur.execute(appsSQL)\n    rows = cur.fetchall()\n    for row in rows:\n        a = collections.OrderedDict()\n        a['id'] = row[0]\n        a['time'] = row[1]\n        a['name'] = row[2]\n        apps.append(a)\n    cur.execute(windowsSQL)\n    rows = cur.fetchall()\n    for row in rows:\n        w = collections.OrderedDict()\n        w['id'] = row[1]\n        w['time'] = row[1]\n        w['name'] = row[2]\n        w['app'] = row[3]\n        windows.append(w)\n    cur.execute(urlSQL)\n    rows = cur.fetchall()\n    for row in rows:\n        u = collections.OrderedDict()\n        u['id'] = row[0]\n        u['time'] = row[1]\n        u['title'] = row[2]\n        u['url'] = row[3]\n        u['host'] = row[4]\n        urls.append(u)\n    cur.execute(activeappSQL)\n    rows = cur.fetchall()\n    for row in rows:\n        a = collections.OrderedDict()\n        a['id'] = row[0]\n        a['appid'] = row[1]\n        a['event'] = row[2]\n        a['start'] = row[3]\n        a['end'] = row[4]\n        appevents.append(a)\n    cur.execute(activewindowSQL)\n    rows = cur.fetchall()\n    for row in rows:\n        w = collections.OrderedDict()\n        w['id'] = row[0]\n        w['windowid'] = row[1]\n        w['appid'] = (item for item in windows if item['id'] == row[1]).next()['app']\n        w['event'] = row[2]\n        w['start'] = row[3]\n        w['end'] = row[4]\n        windowevents.append(w)\n    cur.execute(activeurlSQL)\n    rows = cur.fetchall()\n    for row in rows:\n        u = collections.OrderedDict()\n        u['id'] = row[0]\n        u['urlid'] = row[1]\n        u['appid'] = row[2]\n        u['windowid'] = row[3]\n        u['event'] = row[4]\n        u['start'] = row[5]\n        u['end'] = row[6]\n        urlevents.append(u)\n    cur.execute(experienceSQL)\n    rows = cur.fetchall()\n    for row in rows:\n        a = collections.OrderedDict()\n        a['id'] = row[0]\n        a['text'] = row[2]\n        exps.append(a)\n    image_dir = os.path.expanduser('~/.traces/screenshots')\n    for y in os.listdir(image_dir):\n        y_dir = os.path.join(image_dir, y)\n        if not os.path.isdir(y_dir):\n            continue\n        for m in os.listdir(y_dir):\n            m_dir = os.path.join(y_dir, m)\n            if not os.path.isdir(m_dir):\n                continue\n            for d in os.listdir(m_dir):\n                d_dir = os.path.join(m_dir, d)\n                if not os.path.isdir(d_dir):\n                    continue\n                for h in os.listdir(d_dir):\n                    h_dir = os.path.join(d_dir, h)\n                    if not os.path.isdir(h_dir):\n                        continue\n                    h_images = os.listdir(h_dir)\n                    for image in h_images:\n                        if image[-4:] == '.jpg':\n                            i = collections.OrderedDict()\n                            image_time = datetime.datetime.strptime(image[0:19], '%y%m%d-%H%M%S%f')\n                            i['time'] = (image_time - datetime.datetime(1970, 1, 1)).total_seconds() + time.timezone\n                            i['image'] = os.path.join('screenshots', y, m, d, h, image)\n                            images.append(i)\n    cmd_rows = []\n    newWord = ['Enter', 'Left', 'Right', 'Up', 'Down', 'Tab', 'Escape', ' ']\n    starttime = 0.0\n    app = 0\n    window = 0\n    s = ''\n    cur.execute(wordsSQL)\n    rows = cur.fetchall()\n    for row in rows:\n        if 'Cmd' in row[3]:\n            cmd_rows.append(row)\n        else:\n            text = str(row[2])\n            if text in newWord:\n                if len(s) > 0:\n                    k = collections.OrderedDict()\n                    k['time'] = starttime\n                    k['text'] = s\n                    k['app'] = app\n                    k['window'] = window\n                    words.append(k)\n                starttime = float(row[1])\n                s = ''\n            elif int(row[5]) == window:\n                if text == 'Backspace':\n                    s = s[:-1]\n                else:\n                    s += row[2]\n            else:\n                if len(s) > 0:\n                    k = collections.OrderedDict()\n                    k['time'] = starttime\n                    k['text'] = s\n                    k['app'] = app\n                    k['window'] = window\n                    words.append(k)\n                window = int(row[5])\n                app = int(row[4])\n                starttime = float(row[1])\n                if text in newWord or text == 'Backspace':\n                    s = ''\n                else:\n                    s = row[2]\n    d = collections.OrderedDict()\n    d['apps'] = apps\n    d['window'] = windows\n    d['url'] = urls\n    d['appevents'] = appevents\n    d['windowevents'] = windowevents\n    d['urlevents'] = urlevents\n    d['exps'] = exps\n    d['images'] = images\n    d['words'] = words\n    data = d\n    file = 'extract.json'\n    z = open(file, 'w')\n    z.writelines(json.dumps(data))",
  "line_no": 54,
  "line_no_percent": "30%"
}