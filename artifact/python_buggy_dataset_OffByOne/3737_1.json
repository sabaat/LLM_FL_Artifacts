{
  "instruction": "Set the `settings.base.prepopulate` to 0 in Production to save 1x DAL hit every page. If `pop_list` is not equal to 0, set `table` to `db[auth.settings.table_group_name]`. If `db(table.id > 0).select(table.id, limitby=(0, 1)).first()` is true, set `pop_list` to an empty list. If `pop_list` is not a list or tuple, set `pop_list` to a list containing `pop_list`. If the length of `pop_list` is greater than 0, populate default roles and permissions, configure scheduled tasks, import prepopulate data from CSV, update location tree, and populate stats_demographic_aggregate and vulnerability_aggregate.",
  "buggy_code": "pop_list = settings.get_base_prepopulate()\nif pop_list == 0:\n    pop_list = []\nelse:\n    table = db[auth.settings.table_group_name]\n    if db(table.id > 0).select(table.id, limitby=(0, 1)).first():\n        pop_list = []\n    if not isinstance(pop_list, (list, tuple)):\n        pop_list = [pop_list]\nif len(pop_list) > 0:\n    import sys\n    (print >> sys.stdout, 'Please be patient whilst the database is populated')\n    acl = auth.permission\n    sysroles = auth.S3_SYSTEM_ROLES\n    create_role = auth.s3_create_role\n    create_role('Administrator', 'System Administrator - can access & make changes to any data', uid=sysroles.ADMIN, system=True, protected=True)\n    create_role('Authenticated', 'Authenticated - all logged-in users', uid=sysroles.AUTHENTICATED, protected=True)\n    create_role('Anonymous', 'Unauthenticated users', dict(t='org_organisation', uacl=acl.READ, entity='any'), dict(c='org', f='sites_for_org', uacl=acl.READ, entity='any'), uid=sysroles.ANONYMOUS, protected=True)\n    create_role('Editor', 'Editor - can access & make changes to any unprotected data', uid=sysroles.EDITOR, system=True, protected=True)\n    map_admin = create_role('MapAdmin', 'MapAdmin - allowed access to edit the MapService Catalogue', dict(c='gis', uacl=acl.ALL, oacl=acl.ALL), dict(c='gis', f='location', uacl=acl.ALL, oacl=acl.ALL), uid=sysroles.MAP_ADMIN, system=True, protected=True)\n    create_role('OrgAdmin', 'OrgAdmin - allowed to manage user roles for entity realms', uid=sysroles.ORG_ADMIN, system=True, protected=True)\n    system_roles = auth.get_system_roles()\n    ADMIN = system_roles.ADMIN\n    AUTHENTICATED = system_roles.AUTHENTICATED\n    ANONYMOUS = system_roles.ANONYMOUS\n    EDITOR = system_roles.EDITOR\n    MAP_ADMIN = system_roles.MAP_ADMIN\n    ORG_ADMIN = system_roles.ORG_ADMIN\n    has_module = settings.has_module\n    if has_module('msg'):\n        s3task.schedule_task('msg_process_outbox', vars={'contact_method': 'SMS'}, period=120, timeout=120, repeats=0)\n        s3task.schedule_task('msg_process_outbox', vars={'contact_method': 'EMAIL'}, period=300, timeout=300, repeats=0)\n        s3task.schedule_task('notify_check_subscriptions', period=300, timeout=300, repeats=0)\n    s3task.schedule_task('maintenance', vars={'period': 'daily'}, period=86400, timeout=600, repeats=0)\n    auth.override = True\n    s3db.load_all_models()\n    path_join = os.path.join\n    request_folder = request.folder\n    if settings.get_auth_opt_in_to_email():\n        table = db.pr_group\n        for team in settings.get_auth_opt_in_team_list():\n            table.insert(name=team, group_type=5)\n    db.sync_config.insert()\n    tablename = 'pr_person'\n    field = 'first_name'\n    db.executesql('CREATE INDEX %s__idx on %s(%s);' % (field, tablename, field))\n    field = 'middle_name'\n    db.executesql('CREATE INDEX %s__idx on %s(%s);' % (field, tablename, field))\n    field = 'last_name'\n    db.executesql('CREATE INDEX %s__idx on %s(%s);' % (field, tablename, field))\n    tablename = 'gis_location'\n    field = 'name'\n    db.executesql('CREATE INDEX %s__idx on %s(%s);' % (field, tablename, field))\n    if has_module('msg'):\n        update_super = s3db.update_super\n        table = db.msg_email_channel\n        id = table.insert(server='imap.gmail.com', protocol='imap', use_ssl=True, port=993, username='example-username', password='password', delete_from_server=False)\n        update_super(table, dict(id=id))\n        table = db.msg_sms_outbound_gateway\n        id = table.insert(outgoing_sms_handler='WEB_API')\n        update_super(table, dict(id=id))\n        table = db.msg_sms_modem_channel\n        id = table.insert(modem_baud=115200)\n        update_super(table, dict(id=id))\n        table = db.msg_sms_webapi_channel\n        id = table.insert(to_variable='to')\n        update_super(table, dict(id=id))\n        table = db.msg_sms_smtp_channel\n        id = table.insert(address='changeme')\n        update_super(table, dict(id=id))\n        table = db.msg_tropo_channel\n        id = table.insert(token_messaging='')\n        update_super(table, dict(id=id))\n        table = db.msg_twitter_channel\n        id = table.insert(enabled=False)\n        update_super(table, dict(id=id))\n    if has_module('budget'):\n        db.budget_parameter.insert()\n    if has_module('climate'):\n        s3db.climate_first_run()\n    if has_module('cap'):\n        db.cap_alert.insert(template_title='Default', is_template=True)\n    if has_module('irs'):\n        table = db.irs_icategory\n        table.insert(code='flood')\n        table.insert(code='geophysical.landslide')\n        table.insert(code='roadway.bridgeClosure')\n        table.insert(code='roadway.roadwayClosure')\n        table.insert(code='other.buildingCollapsed')\n        table.insert(code='other.peopleTrapped')\n        table.insert(code='other.powerFailure')\n    if has_module('supply'):\n        db.supply_catalog.insert(name=settings.get_supply_catalog_default())\n    db.commit()\n    bi = s3base.S3BulkImporter()\n    s3.import_role = bi.import_role\n    s3.import_user = bi.import_user\n    s3.import_image = bi.import_image\n    s3.import_remote_csv = bi.import_remote_csv\n    email_required = settings.get_pr_import_update_requires_email()\n    settings.pr.import_update_requires_email = False\n    s3db.configure('auth_user', onaccept=lambda form: auth.s3_approve_user(form.vars))\n    s3db.add_components('auth_user', auth_membership='user_id')\n    s3.asset_import = True\n    if not request.env.request_method:\n        request.env.request_method = 'GET'\n    grandTotalStart = datetime.datetime.now()\n    for pop_setting in pop_list:\n        start = datetime.datetime.now()\n        bi.tasks = []\n        if pop_setting == 1:\n            path = path_join(request_folder, 'private', 'templates', 'default')\n            bi.perform_tasks(path)\n        else:\n            path = path_join(request_folder, 'private', 'templates', pop_setting)\n            if os.path.exists(path):\n                bi.perform_tasks(path)\n            else:\n                (print >> sys.stderr, 'Unable to install data %s no valid directory found' % pop_setting)\n        grandTotalEnd = datetime.datetime.now()\n        duration = grandTotalEnd - grandTotalStart\n        try:\n            duration = '{:.2f}'.format(duration.total_seconds() / 60)\n            (print >> sys.stdout, 'Pre-populate task completed in %s mins' % duration)\n        except AttributeError:\n            (print >> sys.stdout, 'Pre-populate task completed in %s' % duration)\n        bi.resultList = []\n    for errorLine in bi.errorList:\n        try:\n            (print >> sys.stderr, errorLine)\n        except:\n            s3_unicode = s3base.s3_unicode\n            _errorLine = ''\n            for i in range(1, len(errorLine)):\n                try:\n                    _errorLine += s3_unicode(errorline[i])\n                except:\n                    pass\n            (print >> sys.stderr, _errorLine)\n    settings.pr.import_update_requires_email = email_required\n    auth.override = False\n    start = datetime.datetime.now()\n    gis.update_location_tree()\n    end = datetime.datetime.now()\n    (print >> sys.stdout, 'Location Tree update completed in %s' % (end - start))\n    db(db.gis_location.level == 'L0').update(owned_by_group=map_admin)\n    if has_module('stats'):\n        start = datetime.datetime.now()\n        s3db.stats_demographic_rebuild_all_aggregates()\n        end = datetime.datetime.now()\n        (print >> sys.stdout, 'Demographic data aggregation completed in %s' % (end - start))\n    if has_module('vulnerability'):\n        start = datetime.datetime.now()\n        s3db.vulnerability_rebuild_all_aggregates()\n        end = datetime.datetime.now()\n        (print >> sys.stdout, 'Vulnerability data aggregation completed in %s' % (end - start))\n    grandTotalEnd = datetime.datetime.now()\n    duration = grandTotalEnd - grandTotalStart\n    try:\n        duration = '{:.2f}'.format(duration.total_seconds() / 60)\n        (print >> sys.stdout, 'Pre-populate completed in %s mins' % duration)\n    except AttributeError:\n        (print >> sys.stdout, 'Pre-populate completed in %s' % duration)\n    response.view = 'default/index.html'",
  "line_no": 229,
  "line_no_percent": "140%"
}