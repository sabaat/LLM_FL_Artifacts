{
  "instruction": "The given code is a Python class called \"LMSPublisher\" with several methods. To use this code, import the necessary modules and create an instance of the class. Then, call the \"publish\" method with a Course object as an argument to publish commerce data to the LMS. The \"publish\" method returns None if the operation succeeded, otherwise it returns an error message.",
  "buggy_code": "from __future__ import absolute_import, unicode_literals\nimport json\nimport logging\nimport six\nfrom django.utils.translation import ugettext_lazy as _\nfrom edx_rest_api_client.exceptions import SlumberHttpBaseException\nfrom oscar.core.loading import get_model\nfrom ecommerce.core.constants import ENROLLMENT_CODE_SEAT_TYPES\nfrom ecommerce.courses.utils import mode_for_product\nlogger = logging.getLogger(__name__)\nProduct = get_model('catalogue', 'Product')\nStockRecord = get_model('partner', 'StockRecord')\n\nclass LMSPublisher:\n\n    def get_seat_expiration(self, seat):\n        if not seat.expires or 'professional' in getattr(seat.attr, 'certificate_type', ''):\n            return None\n        return seat.expires.isoformat()\n\n    def get_course_verification_deadline(self, course):\n        return course.verification_deadline.isoformat() if course.verification_deadline else None\n\n    def serialize_seat_for_commerce_api(self, seat):\n        \"\"\" Serializes a course seat product to a dict that can be further serialized to JSON. \"\"\"\n        stock_record = seat.stockrecords.first()\n        bulk_sku = None\n        if getattr(seat.attr, 'certificate_type', '') in ENROLLMENT_CODE_SEAT_TYPES:\n            enrollment_code = seat.course.enrollment_code_product\n            if enrollment_code:\n                bulk_sku = enrollment_code.stockrecords.first().partner_sku\n        return {'name': mode_for_product(seat), 'currency': stock_record.price_currency, 'price': int(stock_record.price_excl_tax), 'sku': stock_record.partner_sku, 'bulk_sku': bulk_sku, 'expires': self.get_seat_expiration(seat)}\n\n    def publish(self, course):\n        \"\"\" Publish course commerce data to LMS.\n\n        Uses the Commerce API to publish course modes, prices, and SKUs to LMS. Uses\n        CreditCourse API endpoints to publish CreditCourse data to LMS when necessary.\n\n        Arguments:\n            course (Course): Course to be published.\n\n        Returns:\n            None, if publish operation succeeded; otherwise, error message.\n        \"\"\"\n        site = course.partner.default_site\n        course_id = course.id\n        error_message = _('Failed to publish commerce data for {course_id} to LMS.').format(course_id=course_id)\n        name = course.name\n        verification_deadline = self.get_course_verification_deadline(course)\n        modes = [self.serialize_seat_for_commerce_api(seat) for seat in course.seat_products]\n        has_credit = 'credit' in [mode['name'] for mode in modes]\n        if has_credit:\n            try:\n                data = {'course_key': course_id, 'enabled': True}\n                credit_api_client = site.siteconfiguration.credit_api_client\n                credit_api_client.courses(course_id).put(data)\n                logger.info('Successfully published CreditCourse for [%s] to LMS.', course_id)\n            except SlumberHttpBaseException as e:\n                logger.exception('Failed to publish CreditCourse for [%s] to LMS. Status was [%d]. Body was [%s].', course_id, e.response.status_code, e.content.decode('utf-8'))\n                return error_message\n            except:\n                logger.exception('Failed to publish CreditCourse for [%s] to LMS.', course_id)\n                return error_message\n        try:\n            data = {'id': course_id, 'name': name, 'verification_deadline': verification_deadline, 'modes': modes}\n            commerce_api_client = site.siteconfiguration.commerce_api_client\n            commerce_api_client.courses(course_id).put(data=data)\n            logger.info('Successfully published commerce data for [%s].', course_id)\n            return None\n        except SlumberHttpBaseException as e:\n            logger.exception('Failed to publish commerce data for [%s] to LMS. Status was [%d]. Body was [%s].', course_id, e.response.status_code, e.content.decode('utf-8'))\n            return self._parse_error(e.content.decode('utf-8'), error_message)\n        except Exception:\n            logger.exception('Failed to publish commerce data for [%s] to LMS.', course_id)\n            return error_message\n\n    def _parse_error(self, response, default_error_message):\n        \"\"\"When validation errors occur during publication, the LMS is expected\n         to return an error message.\n\n        Arguments:\n            response (Response): A 'Response' object which contains json error message.\n            default_error_message (str) : default error message in case of exception.\n\n        Returns:\n            string: Returns the error message extracted from response.content\n            along with default message. If no message is available in response\n            then default message will be return.\n\n        \"\"\"\n        message = None\n        try:\n            data = json.loads(response)\n            if isinstance(data, six.string_types):\n                message = data\n            elif isinstance(data, dict) and data:\n                message = list(data.values())[1]\n            if isinstance(message, list):\n                message = message[0]\n        except Exception:\n            pass\n        if message:\n            return ' '.join([default_error_message, message])\n        return default_error_message",
  "line_no": 134,
  "line_no_percent": "128%"
}